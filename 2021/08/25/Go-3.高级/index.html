<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"gtdong.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"gitalk","active":true,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="36.二进制协议gob及msgpack介绍">
<meta property="og:type" content="article">
<meta property="og:title" content="Go-高级">
<meta property="og:url" content="https://gtdong.github.io/2021/08/25/Go-3.%E9%AB%98%E7%BA%A7/index.html">
<meta property="og:site_name" content="TsukiBlog">
<meta property="og:description" content="36.二进制协议gob及msgpack介绍">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://www.chenyoude.com/go/influxdb_01.png">
<meta property="og:image" content="http://www.chenyoude.com/go/etcd_01.png">
<meta property="og:image" content="http://www.chenyoude.com/go/etcd_02.png">
<meta property="og:image" content="http://www.chenyoude.com/go/pprof2.png">
<meta property="og:image" content="http://www.chenyoude.com/go/cpu_pprof.png">
<meta property="og:image" content="http://www.chenyoude.com/go/pprof3.png">
<meta property="og:image" content="http://www.chenyoude.com/go/nsq1.png">
<meta property="og:image" content="http://www.chenyoude.com/go/nsq2.png">
<meta property="og:image" content="http://www.chenyoude.com/go/nsq3.png">
<meta property="og:image" content="http://www.chenyoude.com/go/nsqadmin0.png">
<meta property="og:image" content="http://www.chenyoude.com/go/nsq4.png">
<meta property="og:image" content="http://www.chenyoude.com/go/nsq5.gif">
<meta property="og:image" content="http://www.chenyoude.com/go/nsq6.png">
<meta property="og:image" content="http://www.chenyoude.com/go/nsqadmin1.png">
<meta property="og:image" content="http://www.chenyoude.com/go/nsqadmin2.png">
<meta property="og:image" content="http://www.chenyoude.com/go/nsqadmin3.png">
<meta property="og:image" content="http://www.chenyoude.com/go/nsqadmin4.png">
<meta property="og:image" content="http://www.chenyoude.com/go/nsqadmin5.png">
<meta property="og:image" content="http://www.chenyoude.com/go/nsqadmin6.png">
<meta property="article:published_time" content="2021-08-25T05:05:00.000Z">
<meta property="article:modified_time" content="2022-04-30T16:12:01.096Z">
<meta property="article:author" content="Michaeldong">
<meta property="article:tag" content="Go">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.chenyoude.com/go/influxdb_01.png">


<link rel="canonical" href="https://gtdong.github.io/2021/08/25/Go-3.%E9%AB%98%E7%BA%A7/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://gtdong.github.io/2021/08/25/Go-3.%E9%AB%98%E7%BA%A7/","path":"2021/08/25/Go-3.高级/","title":"Go-高级"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Go-高级 | TsukiBlog</title>
  




<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1/needsharebutton.min.css"><style>
#needsharebutton-postbottom {
  cursor: pointer;
  height: 26px;
  margin-top: 10px;
  position: relative;
}
#needsharebutton-postbottom .btn {
  border: 1px solid $btn-default-border-color;
  border-radius: 3px;
  display: initial;
  padding: 1px 4px;
}
</style>
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">TsukiBlog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#36-%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%8D%8F%E8%AE%AEgob%E5%8F%8Amsgpack%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.</span> <span class="nav-text">36.二进制协议gob及msgpack介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#json%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">1.1.</span> <span class="nav-text">json序列化的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gob%E5%BA%8F%E5%88%97%E5%8C%96%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.2.</span> <span class="nav-text">gob序列化示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#msgpack"><span class="nav-number">1.3.</span> <span class="nav-text">msgpack</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">1.4.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.5.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#37-%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95"><span class="nav-number">2.</span> <span class="nav-text">37.排序算法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F"><span class="nav-number">2.1.</span> <span class="nav-text">快速排序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BD%92%E5%B9%B6%E6%8E%92%E5%BA%8F"><span class="nav-number">2.2.</span> <span class="nav-text">归并排序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A0%86%E6%8E%92%E5%BA%8F"><span class="nav-number">2.3.</span> <span class="nav-text">堆排序</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#38-protobuf"><span class="nav-number">3.</span> <span class="nav-text">38.protobuf</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#protobuf%E4%BB%8B%E7%BB%8D"><span class="nav-number">3.1.</span> <span class="nav-text">protobuf介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#protobuf%E4%BD%BF%E7%94%A8"><span class="nav-number">3.2.</span> <span class="nav-text">protobuf使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#protobuf%E8%AF%AD%E6%B3%95"><span class="nav-number">3.3.</span> <span class="nav-text">protobuf语法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E5%99%A8%E5%AE%89%E8%A3%85"><span class="nav-number">3.4.</span> <span class="nav-text">编译器安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ptotoc"><span class="nav-number">3.5.</span> <span class="nav-text">ptotoc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#protoc-gen-go"><span class="nav-number">3.6.</span> <span class="nav-text">protoc-gen-go</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E5%86%99IDL%E4%BB%A3%E7%A0%81"><span class="nav-number">3.7.</span> <span class="nav-text">编写IDL代码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#39-influxDB"><span class="nav-number">4.</span> <span class="nav-text">39.influxDB</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-1"><span class="nav-number">4.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD"><span class="nav-number">4.2.</span> <span class="nav-text">下载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-2"><span class="nav-number">4.3.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#influxDB%E4%BB%8B%E7%BB%8D"><span class="nav-number">4.4.</span> <span class="nav-text">influxDB介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%8D%E8%AF%8D%E4%BB%8B%E7%BB%8D"><span class="nav-number">4.5.</span> <span class="nav-text">名词介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#point"><span class="nav-number">4.6.</span> <span class="nav-text">point</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Series"><span class="nav-number">4.7.</span> <span class="nav-text">Series</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Go%E6%93%8D%E4%BD%9CinfluxDB"><span class="nav-number">4.8.</span> <span class="nav-text">Go操作influxDB</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-3"><span class="nav-number">4.9.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#influxDB-1-x%E7%89%88%E6%9C%AC"><span class="nav-number">4.10.</span> <span class="nav-text">influxDB 1.x版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#influxDB-2-x%E7%89%88%E6%9C%AC"><span class="nav-number">4.11.</span> <span class="nav-text">influxDB 2.x版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="nav-number">4.12.</span> <span class="nav-text">基本使用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#40-Go%E7%AC%AC%E4%B8%89%E6%96%B9%E6%97%A5%E5%BF%97%E5%BA%93logrus"><span class="nav-number">5.</span> <span class="nav-text">40.Go第三方日志库logrus</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#logrus%E4%BB%8B%E7%BB%8D"><span class="nav-number">5.1.</span> <span class="nav-text">logrus介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-4"><span class="nav-number">5.2.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%A4%BA%E4%BE%8B"><span class="nav-number">5.3.</span> <span class="nav-text">基本示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9B%E9%98%B6%E7%A4%BA%E4%BE%8B"><span class="nav-number">5.4.</span> <span class="nav-text">进阶示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E7%BA%A7%E5%88%AB"><span class="nav-number">5.5.</span> <span class="nav-text">日志级别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E6%97%A5%E5%BF%97%E7%BA%A7%E5%88%AB"><span class="nav-number">5.6.</span> <span class="nav-text">设置日志级别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5"><span class="nav-number">5.7.</span> <span class="nav-text">字段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4%E5%AD%97%E6%AE%B5"><span class="nav-number">5.8.</span> <span class="nav-text">默认字段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E6%9D%A1%E7%9B%AE"><span class="nav-number">5.9.</span> <span class="nav-text">日志条目</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hooks"><span class="nav-number">5.10.</span> <span class="nav-text">Hooks</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%BC%E5%BC%8F%E5%8C%96"><span class="nav-number">5.11.</span> <span class="nav-text">格式化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%B0%E5%BD%95%E5%87%BD%E6%95%B0%E5%90%8D"><span class="nav-number">5.12.</span> <span class="nav-text">记录函数名</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#41-Elasticsearch"><span class="nav-number">6.</span> <span class="nav-text">41.Elasticsearch</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D"><span class="nav-number">6.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elasticsearch%E8%83%BD%E5%81%9A%E4%BB%80%E4%B9%88"><span class="nav-number">6.2.</span> <span class="nav-text">Elasticsearch能做什么</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elasticsearch%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-number">6.3.</span> <span class="nav-text">Elasticsearch基本概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Near-Realtime-NRT-%E5%87%A0%E4%B9%8E%E5%AE%9E%E6%97%B6"><span class="nav-number">6.4.</span> <span class="nav-text">Near Realtime(NRT) 几乎实时</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cluster-%E9%9B%86%E7%BE%A4"><span class="nav-number">6.5.</span> <span class="nav-text">Cluster 集群</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Node%E8%8A%82%E7%82%B9"><span class="nav-number">6.6.</span> <span class="nav-text">Node节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Index%E7%B4%A2%E5%BC%95"><span class="nav-number">6.7.</span> <span class="nav-text">Index索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Type%E7%B1%BB%E5%9E%8B"><span class="nav-number">6.8.</span> <span class="nav-text">Type类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Document%E6%96%87%E6%A1%A3"><span class="nav-number">6.9.</span> <span class="nav-text">Document文档</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Shards-amp-Replicas%E5%88%86%E7%89%87%E4%B8%8E%E5%89%AF%E6%9C%AC"><span class="nav-number">6.10.</span> <span class="nav-text">Shards &amp; Replicas分片与副本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ES%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E4%B8%8E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E6%AF%94%E8%BE%83"><span class="nav-number">6.11.</span> <span class="nav-text">ES基本概念与关系型数据库的比较</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ES-API"><span class="nav-number">6.12.</span> <span class="nav-text">ES API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%81%A5%E5%BA%B7%E7%8A%B6%E6%80%81"><span class="nav-number">6.13.</span> <span class="nav-text">查看健康状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E5%BD%93%E5%89%8Des%E9%9B%86%E7%BE%A4%E4%B8%AD%E6%89%80%E6%9C%89%E7%9A%84indices"><span class="nav-number">6.14.</span> <span class="nav-text">查询当前es集群中所有的indices</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="nav-number">6.15.</span> <span class="nav-text">创建索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95"><span class="nav-number">6.16.</span> <span class="nav-text">删除索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8F%92%E5%85%A5%E8%AE%B0%E5%BD%95"><span class="nav-number">6.17.</span> <span class="nav-text">插入记录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A3%80%E7%B4%A2"><span class="nav-number">6.18.</span> <span class="nav-text">检索</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Go%E6%93%8D%E4%BD%9CElasticsearch"><span class="nav-number">6.19.</span> <span class="nav-text">Go操作Elasticsearch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#elastic-client"><span class="nav-number">6.20.</span> <span class="nav-text">elastic client</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#42-Go%E6%93%8D%E4%BD%9CMySQL"><span class="nav-number">7.</span> <span class="nav-text">42.Go操作MySQL</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5"><span class="nav-number">7.1.</span> <span class="nav-text">连接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E4%BE%9D%E8%B5%96"><span class="nav-number">7.2.</span> <span class="nav-text">下载依赖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8MySQL%E9%A9%B1%E5%8A%A8"><span class="nav-number">7.3.</span> <span class="nav-text">使用MySQL驱动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%9E%E6%8E%A5"><span class="nav-number">7.4.</span> <span class="nav-text">初始化连接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SetMaxOpenConns"><span class="nav-number">7.5.</span> <span class="nav-text">SetMaxOpenConns</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SetMaxIdleConns"><span class="nav-number">7.6.</span> <span class="nav-text">SetMaxIdleConns</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CRUD"><span class="nav-number">7.7.</span> <span class="nav-text">CRUD</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%BA%E5%BA%93%E5%BB%BA%E8%A1%A8"><span class="nav-number">7.8.</span> <span class="nav-text">建库建表</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#43-Go%E6%93%8D%E4%BD%9CRedis"><span class="nav-number">8.</span> <span class="nav-text">43.Go操作Redis</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis%E4%BB%8B%E7%BB%8D"><span class="nav-number">8.1.</span> <span class="nav-text">Redis介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis%E6%94%AF%E6%8C%81%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">8.2.</span> <span class="nav-text">Redis支持的数据结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">8.3.</span> <span class="nav-text">Redis应用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis%E4%B8%8EMemcached%E6%AF%94%E8%BE%83"><span class="nav-number">8.4.</span> <span class="nav-text">Redis与Memcached比较</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Go%E6%93%8D%E4%BD%9CRedis"><span class="nav-number">8.5.</span> <span class="nav-text">Go操作Redis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-5"><span class="nav-number">8.6.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5-1"><span class="nav-number">8.7.</span> <span class="nav-text">连接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-1"><span class="nav-number">8.8.</span> <span class="nav-text">基本使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#set-get%E7%A4%BA%E4%BE%8B"><span class="nav-number">8.9.</span> <span class="nav-text">set&#x2F;get示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#zset%E7%A4%BA%E4%BE%8B"><span class="nav-number">8.10.</span> <span class="nav-text">zset示例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#44-Go%E6%93%8D%E4%BD%9Cetcd"><span class="nav-number">9.</span> <span class="nav-text">44.Go操作etcd</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#etcd"><span class="nav-number">9.1.</span> <span class="nav-text">etcd</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#etcd%E4%BB%8B%E7%BB%8D"><span class="nav-number">9.2.</span> <span class="nav-text">etcd介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#etcd%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">9.3.</span> <span class="nav-text">etcd应用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="nav-number">9.4.</span> <span class="nav-text">服务发现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-number">9.5.</span> <span class="nav-text">配置中心</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="nav-number">9.6.</span> <span class="nav-text">分布式锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E7%94%A8-etcd-%E8%80%8C%E4%B8%8D%E7%94%A8ZooKeeper%EF%BC%9F"><span class="nav-number">9.7.</span> <span class="nav-text">为什么用 etcd 而不用ZooKeeper？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E9%80%89%E6%8B%A9ZooKeeper%EF%BC%9F"><span class="nav-number">9.8.</span> <span class="nav-text">为什么不选择ZooKeeper？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9etcd%EF%BC%9F"><span class="nav-number">9.9.</span> <span class="nav-text">为什么选择etcd？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#etcd%E9%9B%86%E7%BE%A4"><span class="nav-number">9.10.</span> <span class="nav-text">etcd集群</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA3%E8%8A%82%E7%82%B9%E9%9B%86%E7%BE%A4%E7%A4%BA%E4%BE%8B%EF%BC%9A"><span class="nav-number">9.11.</span> <span class="nav-text">搭建一个3节点集群示例：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Go%E8%AF%AD%E8%A8%80%E6%93%8D%E4%BD%9Cetcd"><span class="nav-number">9.12.</span> <span class="nav-text">Go语言操作etcd</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-6"><span class="nav-number">9.13.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#put%E5%92%8Cget%E6%93%8D%E4%BD%9C"><span class="nav-number">9.14.</span> <span class="nav-text">put和get操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#watch%E6%93%8D%E4%BD%9C"><span class="nav-number">9.15.</span> <span class="nav-text">watch操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lease%E7%A7%9F%E7%BA%A6"><span class="nav-number">9.16.</span> <span class="nav-text">lease租约</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#keepAlive"><span class="nav-number">9.17.</span> <span class="nav-text">keepAlive</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8Eetcd%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="nav-number">9.18.</span> <span class="nav-text">基于etcd实现分布式锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C"><span class="nav-number">9.19.</span> <span class="nav-text">其他操作</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#45-Go%E6%93%8D%E4%BD%9Ckafka"><span class="nav-number">10.</span> <span class="nav-text">45.Go操作kafka</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#sarama"><span class="nav-number">10.1.</span> <span class="nav-text">sarama</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E5%8F%8A%E5%AE%89%E8%A3%85"><span class="nav-number">10.2.</span> <span class="nav-text">下载及安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-number">10.3.</span> <span class="nav-text">注意事项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5kafka%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF"><span class="nav-number">10.4.</span> <span class="nav-text">连接kafka发送消息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5kafka%E6%B6%88%E8%B4%B9%E6%B6%88%E6%81%AF"><span class="nav-number">10.5.</span> <span class="nav-text">连接kafka消费消息</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#46-Go%E4%BE%9D%E8%B5%96%E7%AE%A1%E7%90%86%E5%8F%8AGo-module%E4%BD%BF%E7%94%A8"><span class="nav-number">11.</span> <span class="nav-text">46.Go依赖管理及Go module使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E7%AE%A1%E7%90%86"><span class="nav-number">11.1.</span> <span class="nav-text">依赖管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E4%BE%9D%E8%B5%96%E7%AE%A1%E7%90%86"><span class="nav-number">11.2.</span> <span class="nav-text">为什么需要依赖管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#godep"><span class="nav-number">11.3.</span> <span class="nav-text">godep</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-7"><span class="nav-number">11.4.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4"><span class="nav-number">11.5.</span> <span class="nav-text">基本命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8godep"><span class="nav-number">11.6.</span> <span class="nav-text">使用godep</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#vender%E6%9C%BA%E5%88%B6"><span class="nav-number">11.7.</span> <span class="nav-text">vender机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#godep%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B"><span class="nav-number">11.8.</span> <span class="nav-text">godep开发流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#go-module"><span class="nav-number">11.9.</span> <span class="nav-text">go module</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GO111MODULE"><span class="nav-number">11.10.</span> <span class="nav-text">GO111MODULE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GOPROXY"><span class="nav-number">11.11.</span> <span class="nav-text">GOPROXY</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#go-mod%E5%91%BD%E4%BB%A4"><span class="nav-number">11.12.</span> <span class="nav-text">go mod命令</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#47-Go-pprof%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98"><span class="nav-number">12.</span> <span class="nav-text">47.Go pprof性能调优</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Go%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">12.1.</span> <span class="nav-text">Go性能优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%87%E9%9B%86%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE"><span class="nav-number">12.2.</span> <span class="nav-text">采集性能数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B7%A5%E5%85%B7%E5%9E%8B%E5%BA%94%E7%94%A8"><span class="nav-number">12.3.</span> <span class="nav-text">工具型应用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CPU%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90"><span class="nav-number">12.4.</span> <span class="nav-text">CPU性能分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">12.5.</span> <span class="nav-text">内存性能优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%9E%8B%E5%BA%94%E7%94%A8"><span class="nav-number">12.6.</span> <span class="nav-text">服务型应用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#go-tool-pprof%E5%91%BD%E4%BB%A4"><span class="nav-number">12.7.</span> <span class="nav-text">go tool pprof命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B7%E4%BD%93%E7%A4%BA%E4%BE%8B"><span class="nav-number">12.8.</span> <span class="nav-text">具体示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%BA%A4%E4%BA%92%E7%95%8C%E9%9D%A2"><span class="nav-number">12.9.</span> <span class="nav-text">命令行交互界面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%BE%E5%BD%A2%E5%8C%96"><span class="nav-number">12.10.</span> <span class="nav-text">图形化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#go-torch%E5%92%8C%E7%81%AB%E7%84%B0%E5%9B%BE"><span class="nav-number">12.11.</span> <span class="nav-text">go-torch和火焰图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85go-touch"><span class="nav-number">12.12.</span> <span class="nav-text">安装go-touch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-FlameGraph"><span class="nav-number">12.13.</span> <span class="nav-text">安装 FlameGraph</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%8B%E6%B5%8B%E5%B7%A5%E5%85%B7wrk"><span class="nav-number">12.14.</span> <span class="nav-text">压测工具wrk</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8go-torch"><span class="nav-number">12.15.</span> <span class="nav-text">使用go-torch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pprof%E4%B8%8E%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E7%BB%93%E5%90%88"><span class="nav-number">12.16.</span> <span class="nav-text">pprof与性能测试结合</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%83%E4%B9%A0%E9%A2%98"><span class="nav-number">12.17.</span> <span class="nav-text">练习题</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#48-Go%E6%93%8D%E4%BD%9CNSQ"><span class="nav-number">13.</span> <span class="nav-text">48.Go操作NSQ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#NSQ"><span class="nav-number">13.1.</span> <span class="nav-text">NSQ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NSQ%E4%BB%8B%E7%BB%8D"><span class="nav-number">13.2.</span> <span class="nav-text">NSQ介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NSQ%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">13.3.</span> <span class="nav-text">NSQ的应用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86"><span class="nav-number">13.4.</span> <span class="nav-text">异步处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E8%A7%A3%E8%80%A6"><span class="nav-number">13.5.</span> <span class="nav-text">应用解耦</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E9%87%8F%E5%89%8A%E5%B3%B0"><span class="nav-number">13.6.</span> <span class="nav-text">流量削峰</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-8"><span class="nav-number">13.7.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NSQ%E7%BB%84%E4%BB%B6"><span class="nav-number">13.8.</span> <span class="nav-text">NSQ组件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nsqd"><span class="nav-number">13.9.</span> <span class="nav-text">nsqd</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nsqlookupd"><span class="nav-number">13.10.</span> <span class="nav-text">nsqlookupd</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nsqadmin"><span class="nav-number">13.11.</span> <span class="nav-text">nsqadmin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NSQ%E6%9E%B6%E6%9E%84"><span class="nav-number">13.12.</span> <span class="nav-text">NSQ架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NSQ%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="nav-number">13.13.</span> <span class="nav-text">NSQ工作模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Topic%E5%92%8CChannel"><span class="nav-number">13.14.</span> <span class="nav-text">Topic和Channel</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NSQ%E6%8E%A5%E6%94%B6%E5%92%8C%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E6%B5%81%E7%A8%8B"><span class="nav-number">13.15.</span> <span class="nav-text">NSQ接收和发送消息流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NSQ%E7%89%B9%E6%80%A7"><span class="nav-number">13.16.</span> <span class="nav-text">NSQ特性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Go%E6%93%8D%E4%BD%9CNSQ"><span class="nav-number">13.17.</span> <span class="nav-text">Go操作NSQ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-9"><span class="nav-number">13.18.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85"><span class="nav-number">13.19.</span> <span class="nav-text">生产者</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-number">13.20.</span> <span class="nav-text">消费者</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#49-Cookie"><span class="nav-number">14.</span> <span class="nav-text">49.Cookie</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Cookie%E7%9A%84%E7%94%B1%E6%9D%A5"><span class="nav-number">14.1.</span> <span class="nav-text">Cookie的由来</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cookie%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">14.2.</span> <span class="nav-text">Cookie是什么</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cookie%E7%9A%84%E6%9C%BA%E5%88%B6"><span class="nav-number">14.3.</span> <span class="nav-text">Cookie的机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8BCookie"><span class="nav-number">14.4.</span> <span class="nav-text">查看Cookie</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Go%E6%93%8D%E4%BD%9CCookie"><span class="nav-number">14.5.</span> <span class="nav-text">Go操作Cookie</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cookie"><span class="nav-number">14.6.</span> <span class="nav-text">Cookie</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AECookie"><span class="nav-number">14.7.</span> <span class="nav-text">设置Cookie</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96Cookie"><span class="nav-number">14.8.</span> <span class="nav-text">获取Cookie</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gin%E6%A1%86%E6%9E%B6%E6%93%8D%E4%BD%9CCookie"><span class="nav-number">14.9.</span> <span class="nav-text">gin框架操作Cookie</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Session"><span class="nav-number">14.10.</span> <span class="nav-text">Session</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Session%E7%9A%84%E7%94%B1%E6%9D%A5"><span class="nav-number">14.11.</span> <span class="nav-text">Session的由来</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%83%E4%B9%A0%E9%A2%98-1"><span class="nav-number">14.12.</span> <span class="nav-text">练习题</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Michaeldong"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">Michaeldong</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">81</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="sidebar-button site-overview-item animated">
    <button><i class="fa fa-comment"></i>
      Chat
    </button>
  </div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/gtdong" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;gtdong" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/gtdong" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://gtdong.github.io/2021/08/25/Go-3.%E9%AB%98%E7%BA%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Michaeldong">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TsukiBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Go-高级 | TsukiBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Go-高级
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-08-25 13:05:00" itemprop="dateCreated datePublished" datetime="2021-08-25T13:05:00+08:00">2021-08-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-05-01 00:12:01" itemprop="dateModified" datetime="2022-05-01T00:12:01+08:00">2022-05-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Go%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">Go语言</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>74k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1:07</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="36-二进制协议gob及msgpack介绍"><a href="#36-二进制协议gob及msgpack介绍" class="headerlink" title="36.二进制协议gob及msgpack介绍"></a>36.二进制协议gob及msgpack介绍</h1><span id="more"></span>

<p>本文主要介绍二进制协议gob及msgpack的基本使用。</p>
<p>最近在写一个gin框架的session服务时遇到了一个问题，Go语言中的json包在序列化空接口存放的数字类型（整型、浮点型等）都序列化成float64类型。</p>
<p>我们构造一个结构体如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Copytype s <span class="keyword">struct</span> &#123;</span><br><span class="line">	data <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="json序列化的问题"><a href="#json序列化的问题" class="headerlink" title="json序列化的问题"></a>json序列化的问题</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Copyfunc jsonDemo() &#123;</span><br><span class="line">	<span class="keyword">var</span> s1 = s&#123;</span><br><span class="line">		data: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;, <span class="number">8</span>),</span><br><span class="line">	&#125;</span><br><span class="line">	s1.data[&amp;quot;count&amp;quot;] = <span class="number">1</span></span><br><span class="line">	ret, err := json.Marshal(s1.data)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(&amp;quot;marshal failed&amp;quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(&amp;quot;%#v\n&amp;quot;, <span class="type">string</span>(ret))</span><br><span class="line">	<span class="keyword">var</span> s2 = s&#123;</span><br><span class="line">		data: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;, <span class="number">8</span>),</span><br><span class="line">	&#125;</span><br><span class="line">	err = json.Unmarshal(ret, &amp;amp;s2.data)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(&amp;quot;unmarshal failed&amp;quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(s2)</span><br><span class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> s2.data &#123;</span><br><span class="line">		fmt.Printf(&amp;quot;value:%v, <span class="keyword">type</span>:%T\n&amp;quot;, v, v)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Copy&amp;quot;&#123;\&amp;quot;count\&amp;quot;:1&#125;&amp;quot;</span><br><span class="line">&#123;map[count:1]&#125;</span><br><span class="line">value:1, <span class="built_in">type</span>:float64</span><br></pre></td></tr></table></figure>

<h2 id="gob序列化示例"><a href="#gob序列化示例" class="headerlink" title="gob序列化示例"></a>gob序列化示例</h2><p>标准库gob是golang提供的“私有”的编解码方式，它的效率会比json，xml等更高，特别适合在Go语言程序间传递数据。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Copyfunc gobDemo() &#123;</span><br><span class="line">	<span class="keyword">var</span> s1 = s&#123;</span><br><span class="line">		data: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;, <span class="number">8</span>),</span><br><span class="line">	&#125;</span><br><span class="line">	s1.data[&amp;quot;count&amp;quot;] = <span class="number">1</span></span><br><span class="line">	<span class="comment">// encode</span></span><br><span class="line">	buf := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">	enc := gob.NewEncoder(buf)</span><br><span class="line">	err := enc.Encode(s1.data)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(&amp;quot;gob encode failed, err:&amp;quot;, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	b := buf.Bytes()</span><br><span class="line">	fmt.Println(b)</span><br><span class="line">	<span class="keyword">var</span> s2 = s&#123;</span><br><span class="line">		data: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;, <span class="number">8</span>),</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// decode</span></span><br><span class="line">	dec := gob.NewDecoder(bytes.NewBuffer(b))</span><br><span class="line">	err = dec.Decode(&amp;amp;s2.data)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(&amp;quot;gob decode failed, err&amp;quot;, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(s2.data)</span><br><span class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> s2.data &#123;</span><br><span class="line">		fmt.Printf(&amp;quot;value:%v, <span class="keyword">type</span>:%T\n&amp;quot;, v, v)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="msgpack"><a href="#msgpack" class="headerlink" title="msgpack"></a>msgpack</h2><p><a target="_blank" rel="noopener" href="https://msgpack.org/">MessagePack</a>是一种高效的二进制序列化格式。它允许你在多种语言(如JSON)之间交换数据。但它更快更小。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copygo get -u github.com/vmihailenco/msgpack</span><br></pre></td></tr></table></figure>

<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">Copypackage main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	&amp;quot;fmt&amp;quot;</span><br><span class="line"></span><br><span class="line">	&amp;quot;github.com/vmihailenco/msgpack&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// msgpack demo</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name   <span class="type">string</span></span><br><span class="line">	Age    <span class="type">int</span></span><br><span class="line">	Gender <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	p1 := Person&#123;</span><br><span class="line">		Name:   &amp;quot;沙河娜扎&amp;quot;,</span><br><span class="line">		Age:    <span class="number">18</span>,</span><br><span class="line">		Gender: &amp;quot;男&amp;quot;,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// marshal</span></span><br><span class="line">	b, err := msgpack.Marshal(p1)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(&amp;quot;msgpack marshal failed,err:%v&amp;quot;, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// unmarshal</span></span><br><span class="line">	<span class="keyword">var</span> p2 Person</span><br><span class="line">	err = msgpack.Unmarshal(b, &amp;amp;p2)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(&amp;quot;msgpack unmarshal failed,err:%v&amp;quot;, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(&amp;quot;p2:%#v\n&amp;quot;, p2) <span class="comment">// p2:main.Person&#123;Name:&amp;quot;沙河娜扎&amp;quot;, Age:18, Gender:&amp;quot;男&amp;quot;&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>本文介绍了Go语言版经典的排序算法–快速排序、归并排序和堆排序。</p>
<h1 id="37-排序算法"><a href="#37-排序算法" class="headerlink" title="37.排序算法"></a>37.排序算法</h1><h2 id="快速排序"><a href="#快速排序" class="headerlink" title="快速排序"></a>快速排序</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Copyfunc quickSort(data []<span class="type">int</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(data) &amp;lt;= <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	base := data[<span class="number">0</span>]</span><br><span class="line">	l, r := <span class="number">0</span>, <span class="built_in">len</span>(data)<span class="number">-1</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">1</span>; i &amp;lt;= r; &#123;</span><br><span class="line">		<span class="keyword">if</span> data[i] &amp;gt; base &#123;</span><br><span class="line">			data[i], data[r] = data[r], data[i]</span><br><span class="line">			r--</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			data[i], data[l] = data[l], data[i]</span><br><span class="line">			l++</span><br><span class="line">			i++</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	quickSort(data[:l])</span><br><span class="line">	quickSort(data[l+<span class="number">1</span>:])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	s := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">0</span>, <span class="number">16</span>)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &amp;lt; <span class="number">16</span>; i++ &#123;</span><br><span class="line">		s = <span class="built_in">append</span>(s, rand.Intn(<span class="number">100</span>))</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(s)</span><br><span class="line">	quickSort(s)</span><br><span class="line">	fmt.Println(s)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="归并排序"><a href="#归并排序" class="headerlink" title="归并排序"></a>归并排序</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Copyfunc mergeSort(data []<span class="type">int</span>) []<span class="type">int</span> &#123;</span><br><span class="line">	length := <span class="built_in">len</span>(data)</span><br><span class="line">	<span class="keyword">if</span> length &amp;lt;= <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> data</span><br><span class="line">	&#125;</span><br><span class="line">	num := length / <span class="number">2</span></span><br><span class="line">	left := mergeSort(data[:num])</span><br><span class="line">	right := mergeSort(data[num:])</span><br><span class="line">	<span class="keyword">return</span> merge(left, right)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">merge</span><span class="params">(left, right []<span class="type">int</span>)</span></span> (result []<span class="type">int</span>) &#123;</span><br><span class="line">	l, r := <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> l &amp;lt; <span class="built_in">len</span>(left) &amp;amp;&amp;amp; r &amp;lt; <span class="built_in">len</span>(right) &#123;</span><br><span class="line">		<span class="keyword">if</span> left[l] &amp;lt; right[r] &#123;</span><br><span class="line">			result = <span class="built_in">append</span>(result, left[l])</span><br><span class="line">			l++</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			result = <span class="built_in">append</span>(result, right[r])</span><br><span class="line">			r++</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	result = <span class="built_in">append</span>(result, left[l:]...)</span><br><span class="line">	result = <span class="built_in">append</span>(result, right[r:]...)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	s := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">0</span>, <span class="number">16</span>)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &amp;lt; <span class="number">16</span>; i++ &#123;</span><br><span class="line">		s = <span class="built_in">append</span>(s, rand.Intn(<span class="number">100</span>))</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(s)</span><br><span class="line">	s = mergeSort(s)</span><br><span class="line">	fmt.Println(s)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="堆排序"><a href="#堆排序" class="headerlink" title="堆排序"></a>堆排序</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Copyfunc heapSort(array []<span class="type">int</span>) &#123;</span><br><span class="line">	m := <span class="built_in">len</span>(array)</span><br><span class="line">	s := m / <span class="number">2</span></span><br><span class="line">	<span class="keyword">for</span> i := s; i &amp;gt; <span class="number">-1</span>; i-- &#123;</span><br><span class="line">		heap(array, i, m<span class="number">-1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> i := m - <span class="number">1</span>; i &amp;gt; <span class="number">0</span>; i-- &#123;</span><br><span class="line">		array[i], array[<span class="number">0</span>] = array[<span class="number">0</span>], array[i]</span><br><span class="line">		heap(array, <span class="number">0</span>, i<span class="number">-1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">heap</span><span class="params">(array []<span class="type">int</span>, i, end <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">	l := <span class="number">2</span>*i + <span class="number">1</span></span><br><span class="line">	<span class="keyword">if</span> l &amp;gt; end &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	n := l</span><br><span class="line">	r := <span class="number">2</span>*i + <span class="number">2</span></span><br><span class="line">	<span class="keyword">if</span> r &amp;lt;= end &amp;amp;&amp;amp; array[r] &amp;gt; array[l] &#123;</span><br><span class="line">		n = r</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> array[i] &amp;gt; array[n] &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	array[n], array[i] = array[i], array[n]</span><br><span class="line">	heap(array, n, end)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	s := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">0</span>, <span class="number">16</span>)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &amp;lt; <span class="number">16</span>; i++ &#123;</span><br><span class="line">		s = <span class="built_in">append</span>(s, rand.Intn(<span class="number">100</span>))</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(s)</span><br><span class="line">	heapSort(s)</span><br><span class="line">	fmt.Println(s)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>protobuf是一种高效的数据格式，平台无关、语言无关、可扩展，可用于 RPC 系统和持续数据存储系统。</p>
<h1 id="38-protobuf"><a href="#38-protobuf" class="headerlink" title="38.protobuf"></a>38.protobuf</h1><h2 id="protobuf介绍"><a href="#protobuf介绍" class="headerlink" title="protobuf介绍"></a>protobuf介绍</h2><p><code>Protobuf</code>是<code>Protocol Buffer</code>的简称，它是Google公司于2008年开源的一种高效的平台无关、语言无关、可扩展的数据格式，目前Protobuf作为接口规范的描述语言，可以作为Go语言RPC接口的基础工具。</p>
<h2 id="protobuf使用"><a href="#protobuf使用" class="headerlink" title="protobuf使用"></a>protobuf使用</h2><p><code>protobuf</code>是一个与语言无关的一个数据协议，所以我们需要先编写IDL文件然后借助专用工具生成指定语言的代码，从而实现数据的序列化与反序列化过程。</p>
<p>大致开发流程如下： 1. IDL编写 2. 生成指定语言的代码 3. 序列化和反序列化</p>
<h2 id="protobuf语法"><a href="#protobuf语法" class="headerlink" title="protobuf语法"></a>protobuf语法</h2><p><a target="_blank" rel="noopener" href="https://colobu.com/2017/03/16/Protobuf3-language-guide/">protobuf3语法指南</a></p>
<h2 id="编译器安装"><a href="#编译器安装" class="headerlink" title="编译器安装"></a>编译器安装</h2><h2 id="ptotoc"><a href="#ptotoc" class="headerlink" title="ptotoc"></a>ptotoc</h2><p><code>protobuf</code>协议编译器是用c++编写的，根据自己的操作系统下载对应版本的<code>protoc</code>编译器：<a target="_blank" rel="noopener" href="https://github.com/protocolbuffers/protobuf/releases%EF%BC%8C%E8%A7%A3%E5%8E%8B%E5%90%8E%E6%8B%B7%E8%B4%9D%E5%88%B0%60GOPATH/bin%60%E7%9B%AE%E5%BD%95%E4%B8%8B%E3%80%82">https://github.com/protocolbuffers/protobuf/releases，解压后拷贝到`GOPATH/bin`目录下。</a></p>
<h2 id="protoc-gen-go"><a href="#protoc-gen-go" class="headerlink" title="protoc-gen-go"></a>protoc-gen-go</h2><p>安装生成Go语言代码的工具</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copygo get -u github.com/golang/protobuf/protoc-gen-go</span><br></pre></td></tr></table></figure>

<h2 id="编写IDL代码"><a href="#编写IDL代码" class="headerlink" title="编写IDL代码"></a>编写IDL代码</h2><p>在<code>protobuf_demo/address</code>目录下新建一个名为<code>person.proto</code>的文件具体内容如下：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">Copy<span class="comment">// 指定使用protobuf版本</span></span><br><span class="line"><span class="comment">// 此处使用v3版本</span></span><br><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 包名，通过protoc生成go文件</span></span><br><span class="line"><span class="keyword">package</span> address;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 性别类型</span></span><br><span class="line"><span class="comment">// 枚举类型第一个字段必须为0</span></span><br><span class="line"><span class="keyword">enum </span><span class="title class_">GenderType</span> &#123;</span><br><span class="line">    SECRET = <span class="number">0</span>;</span><br><span class="line">    FEMALE = <span class="number">1</span>;</span><br><span class="line">    MALE = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 人</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="type">int64</span> id = <span class="number">1</span>;</span><br><span class="line">    <span class="type">string</span> name = <span class="number">2</span>;</span><br><span class="line">    GenderType gender = <span class="number">3</span>;</span><br><span class="line">    <span class="type">string</span> number = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 联系簿</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">ContactBook</span> &#123;</span><br><span class="line">    <span class="keyword">repeated</span> Person persons = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">```</span><br><span class="line"></span><br><span class="line"># 生成go语言代码</span><br><span class="line"></span><br><span class="line">在protobuf_demo/address目录下执行以下命令。</span><br><span class="line"></span><br><span class="line">```bash</span><br><span class="line">address $ protoc --go_out=. ./person.proto </span><br><span class="line">```</span><br><span class="line"></span><br><span class="line">此时在当前目录下会生成一个person.pb.go文件，我们的Go语言代码里就是使用这个文件。</span><br><span class="line">在protobuf_demo/main.go文件中：</span><br><span class="line"></span><br><span class="line">```go</span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/golang/protobuf/proto&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/Q1mi/studygo/code_demo/protobuf_demo/address&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// protobuf demo</span></span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	var cb address.ContactBook</span><br><span class="line"></span><br><span class="line">	p1 := address.Person&#123;</span><br><span class="line">		Name:   <span class="string">&quot;小王子&quot;</span>,</span><br><span class="line">		Gender: address.GenderType_MALE,</span><br><span class="line">		Number: <span class="string">&quot;7878778&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(p1)</span><br><span class="line">	cb.Persons = append(cb.Persons, &amp;p1)</span><br><span class="line">	<span class="comment">// 序列化</span></span><br><span class="line">	data, err := proto.Marshal(&amp;p1)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;marshal failed,err:%v\n&quot;</span>, err)</span><br><span class="line">		return</span><br><span class="line">	&#125;</span><br><span class="line">	ioutil.WriteFile(<span class="string">&quot;./proto.dat&quot;</span>, data, <span class="number">0644</span>)</span><br><span class="line"></span><br><span class="line">	data2, err := ioutil.ReadFile(<span class="string">&quot;./proto.dat&quot;</span>)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;read file failed, err:%v\n&quot;</span>, err)</span><br><span class="line">		return</span><br><span class="line">	&#125;</span><br><span class="line">	var p2 address.Person</span><br><span class="line">	proto.Unmarshal(data2, &amp;p2)</span><br><span class="line">	fmt.Println(p2)</span><br><span class="line">&#125;</span><br><span class="line">```</span><br></pre></td></tr></table></figure>

<h1 id="39-influxDB"><a href="#39-influxDB" class="headerlink" title="39.influxDB"></a>39.influxDB</h1><p>本文介绍了<code>influxDB</code>时序数据库及Go语言操作<code>influxDB</code>。</p>
<p><a target="_blank" rel="noopener" href="https://www.influxdata.com/">InfluxDB</a>是一个开源分布式时序、事件和指标数据库。使用Go语言编写，无需外部依赖。其设计目标是实现分布式和水平伸缩扩展。</p>
<h2 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h2><h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p><a target="_blank" rel="noopener" href="https://portal.influxdata.com/downloads/">https://portal.influxdata.com/downloads/</a></p>
<p>这里需要注意因为这个网站引用了google的api所以国内点页面的按钮是没反应的，怎么办呢？</p>
<p>按照下图所示，按<code>F12</code>打开浏览器的控制台，然后点击<code>Elements</code>，按下<code>Ctrl/Command+F</code>搜索<code>releases/influxdb</code>，按回车查找自己所需版本的下载地址。<a target="_blank" rel="noopener" href="http://www.chenyoude.com/go/influxdb_01.png"><img src="http://www.chenyoude.com/go/influxdb_01.png" alt="influxdb_01.png"></a></p>
<p>Mac和Linux用户可以点击<a target="_blank" rel="noopener" href="https://v2.docs.influxdata.com/v2.0/get-started/%E4%B8%8B%E8%BD%BD%E3%80%82">https://v2.docs.influxdata.com/v2.0/get-started/下载。</a></p>
<h2 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h2><p>将上一步的压缩包，解压到本地。</p>
<h2 id="influxDB介绍"><a href="#influxDB介绍" class="headerlink" title="influxDB介绍"></a>influxDB介绍</h2><h2 id="名词介绍"><a href="#名词介绍" class="headerlink" title="名词介绍"></a>名词介绍</h2><table>
<thead>
<tr>
<th>influxDB名词</th>
<th>传统数据库概念</th>
</tr>
</thead>
<tbody><tr>
<td>database</td>
<td>数据库</td>
</tr>
<tr>
<td>measurement</td>
<td>数据表</td>
</tr>
<tr>
<td>point</td>
<td>数据行</td>
</tr>
</tbody></table>
<h2 id="point"><a href="#point" class="headerlink" title="point"></a>point</h2><p>influxDB中的point相当于传统数据库里的一行数据，由时间戳（time）、数据（field）、标签（tag）组成。</p>
<table>
<thead>
<tr>
<th>Point属性</th>
<th>传统数据库概念</th>
</tr>
</thead>
<tbody><tr>
<td>time</td>
<td>每个数据记录时间，是数据库中的主索引</td>
</tr>
<tr>
<td>field</td>
<td>各种记录值（没有索引的属性），例如温度、湿度</td>
</tr>
<tr>
<td>tags</td>
<td>各种有索引的属性，例如地区、海拔</td>
</tr>
</tbody></table>
<h2 id="Series"><a href="#Series" class="headerlink" title="Series"></a>Series</h2><p><code>Series</code>相当于是 InfluxDB 中一些数据的集合，在同一个 database 中，retention policy、measurement、tag sets 完全相同的数据同属于一个 series，同一个 series 的数据在物理上会按照时间顺序排列存储在一起。</p>
<h2 id="Go操作influxDB"><a href="#Go操作influxDB" class="headerlink" title="Go操作influxDB"></a>Go操作influxDB</h2><h2 id="安装-3"><a href="#安装-3" class="headerlink" title="安装"></a>安装</h2><h2 id="influxDB-1-x版本"><a href="#influxDB-1-x版本" class="headerlink" title="influxDB 1.x版本"></a>influxDB 1.x版本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copygo get github.com/influxdata/influxdb1-client/v2</span><br></pre></td></tr></table></figure>

<h2 id="influxDB-2-x版本"><a href="#influxDB-2-x版本" class="headerlink" title="influxDB 2.x版本"></a>influxDB 2.x版本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copygo get github.com/influxdata/influxdb-client-go</span><br></pre></td></tr></table></figure>

<h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">Copypackage main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	&amp;quot;fmt&amp;quot;</span><br><span class="line">	&amp;quot;log&amp;quot;</span><br><span class="line">	&amp;quot;time&amp;quot;</span><br><span class="line"></span><br><span class="line">	client &amp;quot;github.com/influxdata/influxdb1-client/v2&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// influxdb demo</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">connInflux</span><span class="params">()</span></span> client.Client &#123;</span><br><span class="line">	cli, err := client.NewHTTPClient(client.HTTPConfig&#123;</span><br><span class="line">		Addr:     &amp;quot;http:<span class="comment">//127.0.0.1:8086&amp;quot;,</span></span><br><span class="line">		Username: &amp;quot;admin&amp;quot;,</span><br><span class="line">		Password: &amp;quot;&amp;quot;,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> cli</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// query</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">queryDB</span><span class="params">(cli client.Client, cmd <span class="type">string</span>)</span></span> (res []client.Result, err <span class="type">error</span>) &#123;</span><br><span class="line">	q := client.Query&#123;</span><br><span class="line">		Command:  cmd,</span><br><span class="line">		Database: &amp;quot;test&amp;quot;,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> response, err := cli.Query(q); err == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> response.Error() != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> res, response.Error()</span><br><span class="line">		&#125;</span><br><span class="line">		res = response.Results</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> res, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> res, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// insert</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">writesPoints</span><span class="params">(cli client.Client)</span></span> &#123;</span><br><span class="line">	bp, err := client.NewBatchPoints(client.BatchPointsConfig&#123;</span><br><span class="line">		Database:  &amp;quot;test&amp;quot;,</span><br><span class="line">		Precision: &amp;quot;s&amp;quot;, <span class="comment">//精度，默认ns</span></span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	tags := <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;&amp;quot;cpu&amp;quot;: &amp;quot;ih-cpu&amp;quot;&#125;</span><br><span class="line">	fields := <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">		&amp;quot;idle&amp;quot;:   <span class="number">201.1</span>,</span><br><span class="line">		&amp;quot;system&amp;quot;: <span class="number">43.3</span>,</span><br><span class="line">		&amp;quot;user&amp;quot;:   <span class="number">86.6</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pt, err := client.NewPoint(&amp;quot;cpu_usage&amp;quot;, tags, fields, time.Now())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	bp.AddPoint(pt)</span><br><span class="line">	err = cli.Write(bp)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(&amp;quot;insert success&amp;quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	conn := connInflux()</span><br><span class="line">	fmt.Println(conn)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// insert</span></span><br><span class="line">	writesPoints(conn)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取10条数据并展示</span></span><br><span class="line">	qs := fmt.Sprintf(&amp;quot;SELECT * FROM %s LIMIT %d&amp;quot;, &amp;quot;cpu_usage&amp;quot;, <span class="number">10</span>)</span><br><span class="line">	res, err := queryDB(conn, qs)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, row := <span class="keyword">range</span> res[<span class="number">0</span>].Series[<span class="number">0</span>].Values &#123;</span><br><span class="line">		<span class="keyword">for</span> j, value := <span class="keyword">range</span> row &#123;</span><br><span class="line">			log.Printf(&amp;quot;j:%d value:%v\n&amp;quot;, j, value)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="40-Go第三方日志库logrus"><a href="#40-Go第三方日志库logrus" class="headerlink" title="40.Go第三方日志库logrus"></a>40.Go第三方日志库logrus</h1><p>日志是程序中必不可少的一个环节，由于Go语言内置的日志库功能比较简洁，我们在实际开发中通常会选择使用第三方的日志库来进行开发。本文介绍了<code>logrus</code>这个日志库的基本使用。</p>
<h2 id="logrus介绍"><a href="#logrus介绍" class="headerlink" title="logrus介绍"></a>logrus介绍</h2><p>Logrus是Go（golang）的结构化logger，与标准库logger完全API兼容。</p>
<p>它有以下特点：</p>
<ul>
<li>完全兼容标准日志库，拥有七种日志级别：<code>Trace</code>, <code>Debug</code>, <code>Info</code>, <code>Warning</code>, <code>Error</code>, <code>Fatal</code>and <code>Panic</code>。</li>
<li>可扩展的Hook机制，允许使用者通过Hook的方式将日志分发到任意地方，如本地文件系统，logstash，elasticsearch或者mq等，或者通过Hook定义日志内容和格式等</li>
<li>可选的日志输出格式，内置了两种日志格式JSONFormater和TextFormatter，还可以自定义日志格式</li>
<li>Field机制，通过Filed机制进行结构化的日志记录</li>
<li>线程安全</li>
</ul>
<h2 id="安装-4"><a href="#安装-4" class="headerlink" title="安装"></a>安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copygo get github.com/sirupsen/logrus</span><br></pre></td></tr></table></figure>

<h2 id="基本示例"><a href="#基本示例" class="headerlink" title="基本示例"></a>基本示例</h2><p>使用Logrus最简单的方法是简单的包级导出日志程序:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Copypackage main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  log &amp;quot;github.com/sirupsen/logrus&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  log.WithFields(log.Fields&#123;</span><br><span class="line">    &amp;quot;animal&amp;quot;: &amp;quot;dog&amp;quot;,</span><br><span class="line">  &#125;).Info(&amp;quot;一条舔狗出现了。&amp;quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="进阶示例"><a href="#进阶示例" class="headerlink" title="进阶示例"></a>进阶示例</h2><p>对于更高级的用法，例如在同一应用程序记录到多个位置，你还可以创建logrus Logger的实例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Copypackage main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  &amp;quot;os&amp;quot;</span><br><span class="line">  &amp;quot;github.com/sirupsen/logrus&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个新的logger实例。可以创建任意多个。</span></span><br><span class="line"><span class="keyword">var</span> log = logrus.New()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="comment">// 设置日志输出为os.Stdout</span></span><br><span class="line">  log.Out = os.Stdout</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 可以设置像文件等任意`io.Writer`类型作为日志输出</span></span><br><span class="line">  <span class="comment">// file, err := os.OpenFile(&amp;quot;logrus.log&amp;quot;, os.O_CREATE|os.O_WRONLY|os.O_APPEND, 0666)</span></span><br><span class="line">  <span class="comment">// if err == nil &#123;</span></span><br><span class="line">  <span class="comment">//  log.Out = file</span></span><br><span class="line">  <span class="comment">// &#125; else &#123;</span></span><br><span class="line">  <span class="comment">//  log.Info(&amp;quot;Failed to log to file, using default stderr&amp;quot;)</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">  log.WithFields(logrus.Fields&#123;</span><br><span class="line">    &amp;quot;animal&amp;quot;: &amp;quot;dog&amp;quot;,</span><br><span class="line">    &amp;quot;size&amp;quot;:   <span class="number">10</span>,</span><br><span class="line">  &#125;).Info(&amp;quot;一群舔狗出现了。&amp;quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="日志级别"><a href="#日志级别" class="headerlink" title="日志级别"></a>日志级别</h2><p>Logrus有七个日志级别：<code>Trace</code>, <code>Debug</code>, <code>Info</code>, <code>Warning</code>, <code>Error</code>, <code>Fatal</code>and <code>Panic</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Copylog.Trace(&amp;quot;Something very low level.&amp;quot;)</span><br><span class="line">log.Debug(&amp;quot;Useful debugging information.&amp;quot;)</span><br><span class="line">log.Info(&amp;quot;Something noteworthy happened!&amp;quot;)</span><br><span class="line">log.Warn(&amp;quot;You should probably take a look at this.&amp;quot;)</span><br><span class="line">log.Error(&amp;quot;Something failed but I<span class="string">&#x27;m not quitting.&amp;quot;)</span></span><br><span class="line"><span class="string">// 记完日志后会调用os.Exit(1) </span></span><br><span class="line"><span class="string">log.Fatal(&amp;quot;Bye.&amp;quot;)</span></span><br><span class="line"><span class="string">// 记完日志后会调用 panic() </span></span><br><span class="line"><span class="string">log.Panic(&amp;quot;I&#x27;</span>m bailing.&amp;quot;)</span><br></pre></td></tr></table></figure>

<h2 id="设置日志级别"><a href="#设置日志级别" class="headerlink" title="设置日志级别"></a>设置日志级别</h2><p>你可以在Logger上设置日志记录级别，然后它只会记录具有该级别或以上级别任何内容的条目：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Copy<span class="comment">// 会记录info及以上级别 (warn, error, fatal, panic)</span></span><br><span class="line">log.SetLevel(log.InfoLevel)</span><br></pre></td></tr></table></figure>

<p>如果你的程序支持debug或环境变量模式，设置<code>log.Level = logrus.DebugLevel</code>会很有帮助。</p>
<h2 id="字段"><a href="#字段" class="headerlink" title="字段"></a>字段</h2><p>Logrus鼓励通过日志字段进行谨慎的结构化日志记录，而不是冗长的、不可解析的错误消息。</p>
<p>例如，区别于使用<code>log.Fatalf(&quot;Failed to send event %s to topic %s with key %d&quot;)</code>，你应该使用如下方式记录更容易发现的内容:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Copylog.WithFields(log.Fields&#123;</span><br><span class="line">  &amp;quot;event&amp;quot;: event,</span><br><span class="line">  &amp;quot;topic&amp;quot;: topic,</span><br><span class="line">  &amp;quot;key&amp;quot;: key,</span><br><span class="line">&#125;).Fatal(&amp;quot;Failed to send event&amp;quot;)</span><br></pre></td></tr></table></figure>

<p><code>WithFields</code>的调用是可选的。</p>
<h2 id="默认字段"><a href="#默认字段" class="headerlink" title="默认字段"></a>默认字段</h2><p>通常，将一些字段始终附加到应用程序的全部或部分的日志语句中会很有帮助。例如，你可能希望始终在请求的上下文中记录<code>request_id</code>和<code>user_ip</code>。</p>
<p>区别于在每一行日志中写上<code>log.WithFields(log.Fields&#123;&quot;request_id&quot;: request_id, &quot;user_ip&quot;: user_ip&#125;)</code>，你可以向下面的示例代码一样创建一个<code>logrus.Entry</code>去传递这些字段。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CopyrequestLogger := log.WithFields(log.Fields&#123;&amp;quot;request_id&amp;quot;: request_id, &amp;quot;user_ip&amp;quot;: user_ip&#125;)</span><br><span class="line">requestLogger.Info(&amp;quot;something happened on that request&amp;quot;) # will log request_id and user_ip</span><br><span class="line">requestLogger.Warn(&amp;quot;something not great happened&amp;quot;)</span><br></pre></td></tr></table></figure>

<h2 id="日志条目"><a href="#日志条目" class="headerlink" title="日志条目"></a>日志条目</h2><p>除了使用<code>WithField</code>或<code>WithFields</code>添加的字段外，一些字段会自动添加到所有日志记录事中:</p>
<ul>
<li>time：记录日志时的时间戳</li>
<li>msg：记录的日志信息</li>
<li>level：记录的日志级别</li>
</ul>
<h2 id="Hooks"><a href="#Hooks" class="headerlink" title="Hooks"></a>Hooks</h2><p>你可以添加日志级别的钩子（Hook）。例如，向异常跟踪服务发送<code>Error</code>、<code>Fatal</code>和<code>Panic</code>、信息到StatsD或同时将日志发送到多个位置，例如syslog。</p>
<p>Logrus配有内置钩子。在<code>init</code>中添加这些内置钩子或你自定义的钩子：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Copyimport (</span><br><span class="line">  log &amp;quot;github.com/sirupsen/logrus&amp;quot;</span><br><span class="line">  &amp;quot;gopkg.in/gemnasium/logrus-airbrake-hook.v2&amp;quot; <span class="comment">// the package is named &amp;quot;airbrake&amp;quot;</span></span><br><span class="line">  logrus_syslog &amp;quot;github.com/sirupsen/logrus/hooks/syslog&amp;quot;</span><br><span class="line">  &amp;quot;log/syslog&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Use the Airbrake hook to report errors that have Error severity or above to</span></span><br><span class="line">  <span class="comment">// an exception tracker. You can create custom hooks, see the Hooks section.</span></span><br><span class="line">  log.AddHook(airbrake.NewHook(<span class="number">123</span>, &amp;quot;xyz&amp;quot;, &amp;quot;production&amp;quot;))</span><br><span class="line"></span><br><span class="line">  hook, err := logrus_syslog.NewSyslogHook(&amp;quot;udp&amp;quot;, &amp;quot;localhost:<span class="number">514</span>&amp;quot;, syslog.LOG_INFO, &amp;quot;&amp;quot;)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Error(&amp;quot;Unable to connect to local syslog daemon&amp;quot;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    log.AddHook(hook)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>意：Syslog钩子还支持连接到本地syslog（例如. “/dev/log” or “/var/run/syslog” or “/var/run/log”)。有关详细信息，请查看<a target="_blank" rel="noopener" href="https://github.com/sirupsen/logrus/blob/master/hooks/syslog/README.md">syslog hook README</a>。</p>
<h2 id="格式化"><a href="#格式化" class="headerlink" title="格式化"></a>格式化</h2><p>logrus内置以下两种日志格式化程序：</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logrus.TextFormatter` `logrus.JSONFormatter</span><br></pre></td></tr></table></figure>

<p>还支持一些第三方的格式化程序，详见项目首页。</p>
<h2 id="记录函数名"><a href="#记录函数名" class="headerlink" title="记录函数名"></a>记录函数名</h2><p>如果你希望将调用的函数名添加为字段，请通过以下方式设置：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copylog.SetReportCaller(<span class="literal">true</span>)</span><br></pre></td></tr></table></figure>

<p>这会将调用者添加为”method”，如下所示：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">Copy<span class="punctuation">&#123;</span><span class="attr">&quot;animal&quot;</span><span class="punctuation">:</span><span class="string">&quot;penguin&quot;</span><span class="punctuation">,</span><span class="attr">&quot;level&quot;</span><span class="punctuation">:</span><span class="string">&quot;fatal&quot;</span><span class="punctuation">,</span><span class="attr">&quot;method&quot;</span><span class="punctuation">:</span><span class="string">&quot;github.com/sirupsen/arcticcreatures.migrate&quot;</span><span class="punctuation">,</span><span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span><span class="string">&quot;a penguin swims by&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;time&quot;</span><span class="punctuation">:</span><span class="string">&quot;2014-03-10 19:57:38.562543129 -0400 EDT&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">```</span><br><span class="line"></span><br><span class="line">注意：，开启这个模式会增加性能开销。</span><br><span class="line"></span><br><span class="line"># 线程安全</span><br><span class="line"></span><br><span class="line">默认的logger在并发写的时候是被mutex保护的，比如当同时调用hook和写log时mutex就会被请求，有另外一种情况，文件是以appending mode打开的，</span><br><span class="line">此时的并发操作就是安全的，可以用logger.SetNoLock()来关闭它。</span><br><span class="line"></span><br><span class="line"># gin框架使用logrus</span><br><span class="line"></span><br><span class="line">```go</span><br><span class="line"><span class="comment">// a gin with logrus demo</span></span><br><span class="line"></span><br><span class="line">var log = logrus.New()</span><br><span class="line"></span><br><span class="line">func init() <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="comment">// Log as JSON instead of the default ASCII formatter.</span></span><br><span class="line">	log.Formatter = &amp;logrus.JSONFormatter<span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">	<span class="comment">// Output to stdout instead of the default stderr</span></span><br><span class="line">	<span class="comment">// Can be any io.Writer, see below for File example</span></span><br><span class="line">	f<span class="punctuation">,</span> _ <span class="punctuation">:</span>= os.Create(<span class="string">&quot;./gin.log&quot;</span>)</span><br><span class="line">	log.Out = f</span><br><span class="line">	gin.SetMode(gin.ReleaseMode)</span><br><span class="line">	gin.DefaultWriter = log.Out</span><br><span class="line">	<span class="comment">// Only log the warning severity or above.</span></span><br><span class="line">	log.Level = logrus.InfoLevel</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">func main() <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="comment">// 创建一个默认的路由引擎</span></span><br><span class="line">	r <span class="punctuation">:</span>= gin.Default()</span><br><span class="line">	<span class="comment">// GET：请求方式；/hello：请求的路径</span></span><br><span class="line">	<span class="comment">// 当客户端以GET方法请求/hello路径时，会执行后面的匿名函数</span></span><br><span class="line">	r.GET(<span class="string">&quot;/hello&quot;</span><span class="punctuation">,</span> func(c *gin.Context) <span class="punctuation">&#123;</span></span><br><span class="line">		log.WithFields(logrus.Fields<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;animal&quot;</span><span class="punctuation">:</span> <span class="string">&quot;walrus&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;size&quot;</span><span class="punctuation">:</span>   <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">		<span class="punctuation">&#125;</span>).Warn(<span class="string">&quot;A group of walrus emerges from the ocean&quot;</span>)</span><br><span class="line">		<span class="comment">// c.JSON：返回JSON格式的数据</span></span><br><span class="line">		c.JSON(<span class="number">200</span><span class="punctuation">,</span> gin.H<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hello world!&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="punctuation">&#125;</span>)</span><br><span class="line">	<span class="punctuation">&#125;</span>)</span><br><span class="line">	<span class="comment">// 启动HTTP服务，默认在0.0.0.0:8080启动服务</span></span><br><span class="line">	r.Run()</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">```</span><br></pre></td></tr></table></figure>

<h1 id="41-Elasticsearch"><a href="#41-Elasticsearch" class="headerlink" title="41.Elasticsearch"></a>41.Elasticsearch</h1><p>本文简单介绍了ES、Kibana和Go语言操作ES。</p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Elasticsearch（ES）是一个基于Lucene构建的开源、分布式、RESTful接口的全文搜索引擎。Elasticsearch还是一个分布式文档数据库，其中每个字段均可被索引，而且每个字段的数据均可被搜索，ES能够横向扩展至数以百计的服务器存储以及处理PB级的数据。可以在极短的时间内存储、搜索和分析大量的数据。通常作为具有复杂搜索场景情况下的核心发动机。</p>
<h2 id="Elasticsearch能做什么"><a href="#Elasticsearch能做什么" class="headerlink" title="Elasticsearch能做什么"></a>Elasticsearch能做什么</h2><ol>
<li>当你经营一家网上商店，你可以让你的客户搜索你卖的商品。在这种情况下，你可以使用ElasticSearch来存储你的整个产品目录和库存信息，为客户提供精准搜索，可以为客户推荐相关商品。</li>
<li>当你想收集日志或者交易数据的时候，需要分析和挖掘这些数据，寻找趋势，进行统计，总结，或发现异常。在这种情况下，你可以使用Logstash或者其他工具来进行收集数据，当这引起数据存储到ElasticsSearch中。你可以搜索和汇总这些数据，找到任何你感兴趣的信息。</li>
<li>对于程序员来说，比较有名的案例是GitHub，GitHub的搜索是基于ElasticSearch构建的，在github.com/search页面，你可以搜索项目、用户、issue、pull request，还有代码。共有40~50个索引库，分别用于索引网站需要跟踪的各种数据。虽然只索引项目的主分支（master），但这个数据量依然巨大，包括20亿个索引文档，30TB的索引文件。</li>
</ol>
<h2 id="Elasticsearch基本概念"><a href="#Elasticsearch基本概念" class="headerlink" title="Elasticsearch基本概念"></a>Elasticsearch基本概念</h2><h2 id="Near-Realtime-NRT-几乎实时"><a href="#Near-Realtime-NRT-几乎实时" class="headerlink" title="Near Realtime(NRT) 几乎实时"></a>Near Realtime(NRT) 几乎实时</h2><p>Elasticsearch是一个几乎实时的搜索平台。意思是，从索引一个文档到这个文档可被搜索只需要一点点的延迟，这个时间一般为毫秒级。</p>
<h2 id="Cluster-集群"><a href="#Cluster-集群" class="headerlink" title="Cluster 集群"></a>Cluster 集群</h2><p>群集是一个或多个节点（服务器）的集合， 这些节点共同保存整个数据，并在所有节点上提供联合索引和搜索功能。一个集群由一个唯一集群ID确定，并指定一个集群名（默认为“elasticsearch”）。该集群名非常重要，因为节点可以通过这个集群名加入群集，一个节点只能是群集的一部分。</p>
<p>确保在不同的环境中不要使用相同的群集名称，否则可能会导致连接错误的群集节点。例如，你可以使用logging-dev、logging-stage、logging-prod分别为开发、阶段产品、生产集群做记录。</p>
<h2 id="Node节点"><a href="#Node节点" class="headerlink" title="Node节点"></a>Node节点</h2><p>节点是单个服务器实例，它是群集的一部分，可以存储数据，并参与群集的索引和搜索功能。就像一个集群，节点的名称默认为一个随机的通用唯一标识符（UUID），确定在启动时分配给该节点。如果不希望默认，可以定义任何节点名。这个名字对管理很重要，目的是要确定你的网络服务器对应于你的ElasticSearch群集节点。</p>
<p>我们可以通过群集名配置节点以连接特定的群集。默认情况下，每个节点设置加入名为“elasticSearch”的集群。这意味着如果你启动多个节点在网络上，假设他们能发现彼此都会自动形成和加入一个名为“elasticsearch”的集群。</p>
<p>在单个群集中，你可以拥有尽可能多的节点。此外，如果“elasticsearch”在同一个网络中，没有其他节点正在运行，从单个节点的默认情况下会形成一个新的单节点名为”elasticsearch”的集群。</p>
<h2 id="Index索引"><a href="#Index索引" class="headerlink" title="Index索引"></a>Index索引</h2><p>索引是具有相似特性的文档集合。例如，可以为客户数据提供索引，为产品目录建立另一个索引，以及为订单数据建立另一个索引。索引由名称（必须全部为小写）标识，该名称用于在对其中的文档执行索引、搜索、更新和删除操作时引用索引。在单个群集中，你可以定义尽可能多的索引。</p>
<h2 id="Type类型"><a href="#Type类型" class="headerlink" title="Type类型"></a>Type类型</h2><p>在索引中，可以定义一个或多个类型。类型是索引的逻辑类别/分区，其语义完全取决于你。一般来说，类型定义为具有公共字段集的文档。例如，假设你运行一个博客平台，并将所有数据存储在一个索引中。在这个索引中，你可以为用户数据定义一种类型，为博客数据定义另一种类型，以及为注释数据定义另一类型。</p>
<h2 id="Document文档"><a href="#Document文档" class="headerlink" title="Document文档"></a>Document文档</h2><p>文档是可以被索引的信息的基本单位。例如，你可以为单个客户提供一个文档，单个产品提供另一个文档，以及单个订单提供另一个文档。本文件的表示形式为JSON（JavaScript Object Notation）格式，这是一种非常普遍的互联网数据交换格式。</p>
<p>在索引/类型中，你可以存储尽可能多的文档。请注意，尽管文档物理驻留在索引中，文档实际上必须索引或分配到索引中的类型。</p>
<h2 id="Shards-amp-Replicas分片与副本"><a href="#Shards-amp-Replicas分片与副本" class="headerlink" title="Shards &amp; Replicas分片与副本"></a>Shards &amp; Replicas分片与副本</h2><p>索引可以存储大量的数据，这些数据可能超过单个节点的硬件限制。例如，十亿个文件占用磁盘空间1TB的单指标可能不适合对单个节点的磁盘或可能太慢服务仅从单个节点的搜索请求。</p>
<p>为了解决这一问题，Elasticsearch提供细分你的指标分成多个块称为分片的能力。当你创建一个索引，你可以简单地定义你想要的分片数量。每个分片本身是一个全功能的、独立的“指数”，可以托管在集群中的任何节点。</p>
<p><strong>Shards分片的重要性主要体现在以下两个特征：</strong></p>
<ol>
<li>分片允许你水平拆分或缩放内容的大小</li>
<li>分片允许你分配和并行操作的碎片（可能在多个节点上）从而提高性能/吞吐量 这个机制中的碎片是分布式的以及其文件汇总到搜索请求是完全由ElasticSearch管理，对用户来说是透明的。</li>
</ol>
<p>在同一个集群网络或云环境上，故障是任何时候都会出现的，拥有一个故障转移机制以防分片和节点因为某些原因离线或消失是非常有用的，并且被强烈推荐。为此，Elasticsearch允许你创建一个或多个拷贝，你的索引分片进入所谓的副本或称作复制品的分片，简称Replicas。</p>
<p><strong>Replicas的重要性主要体现在以下两个特征：</strong></p>
<ol>
<li>副本为分片或节点失败提供了高可用性。为此，需要注意的是，一个副本的分片不会分配在同一个节点作为原始的或主分片，副本是从主分片那里复制过来的。</li>
<li>副本允许用户扩展你的搜索量或吞吐量，因为搜索可以在所有副本上并行执行。</li>
</ol>
<h2 id="ES基本概念与关系型数据库的比较"><a href="#ES基本概念与关系型数据库的比较" class="headerlink" title="ES基本概念与关系型数据库的比较"></a>ES基本概念与关系型数据库的比较</h2><table>
<thead>
<tr>
<th>ES概念</th>
<th>关系型数据库</th>
</tr>
</thead>
<tbody><tr>
<td>Index（索引）支持全文检索</td>
<td>Database（数据库）</td>
</tr>
<tr>
<td>Type（类型）</td>
<td>Table（表）</td>
</tr>
<tr>
<td>Document（文档），不同文档可以有不同的字段集合</td>
<td>Row（数据行）</td>
</tr>
<tr>
<td>Field（字段）</td>
<td>Column（数据列）</td>
</tr>
<tr>
<td>Mapping（映射）</td>
<td>Schema（模式）</td>
</tr>
</tbody></table>
<h2 id="ES-API"><a href="#ES-API" class="headerlink" title="ES API"></a>ES API</h2><p>以下示例使用<code>curl</code>演示。</p>
<h2 id="查看健康状态"><a href="#查看健康状态" class="headerlink" title="查看健康状态"></a>查看健康状态</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copycurl -X GET 127.0.0.1:9200/_cat/health?v</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Copyepoch      timestamp cluster       status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent</span><br><span class="line">1564726309 06:11:49  elasticsearch yellow          1         1      3   3    0    0        1             0                  -                 75.0%</span><br></pre></td></tr></table></figure>

<h2 id="查询当前es集群中所有的indices"><a href="#查询当前es集群中所有的indices" class="headerlink" title="查询当前es集群中所有的indices"></a>查询当前es集群中所有的indices</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copycurl -X GET 127.0.0.1:9200/_cat/indices?v</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Copyhealth status index                uuid                   pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line">green  open   .kibana_task_manager LUo-IxjDQdWeAbR-SYuYvQ   1   0          2            0     45.5kb         45.5kb</span><br><span class="line">green  open   .kibana_1            PLvyZV1bRDWex05xkOrNNg   1   0          4            1     23.9kb         23.9kb</span><br><span class="line">yellow open   user                 o42mIpDeSgSWZ6eARWUfKw   1   1          0            0       283b           283b</span><br></pre></td></tr></table></figure>

<h2 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copycurl -X PUT 127.0.0.1:9200/www</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copy&#123;&amp;quot;acknowledged&amp;quot;:<span class="literal">true</span>,&amp;quot;shards_acknowledged&amp;quot;:<span class="literal">true</span>,&amp;quot;index&amp;quot;:&amp;quot;www&amp;quot;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copycurl -X DELETE 127.0.0.1:9200/www</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copy&#123;&amp;quot;acknowledged&amp;quot;:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>

<h2 id="插入记录"><a href="#插入记录" class="headerlink" title="插入记录"></a>插入记录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Copycurl -H &amp;quot;ContentType:application/json&amp;quot; -X POST 127.0.0.1:9200/user/person -d <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	&amp;quot;name&amp;quot;: &amp;quot;dsb&amp;quot;,</span></span><br><span class="line"><span class="string">	&amp;quot;age&amp;quot;: 9000,</span></span><br><span class="line"><span class="string">	&amp;quot;married&amp;quot;: true</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Copy&#123;</span><br><span class="line">    &amp;quot;_index&amp;quot;: &amp;quot;user&amp;quot;,</span><br><span class="line">    &amp;quot;_type&amp;quot;: &amp;quot;person&amp;quot;,</span><br><span class="line">    &amp;quot;_id&amp;quot;: &amp;quot;MLcwUWwBvEa8j5UrLZj4&amp;quot;,</span><br><span class="line">    &amp;quot;_version&amp;quot;: 1,</span><br><span class="line">    &amp;quot;result&amp;quot;: &amp;quot;created&amp;quot;,</span><br><span class="line">    &amp;quot;_shards&amp;quot;: &#123;</span><br><span class="line">        &amp;quot;total&amp;quot;: 2,</span><br><span class="line">        &amp;quot;successful&amp;quot;: 1,</span><br><span class="line">        &amp;quot;failed&amp;quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &amp;quot;_seq_no&amp;quot;: 3,</span><br><span class="line">    &amp;quot;_primary_term&amp;quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以使用PUT方法，但是需要传入id</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Copycurl -H &amp;quot;ContentType:application/json&amp;quot; -X PUT 127.0.0.1:9200/user/person/4 -d <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	&amp;quot;name&amp;quot;: &amp;quot;sb&amp;quot;,</span></span><br><span class="line"><span class="string">	&amp;quot;age&amp;quot;: 9,</span></span><br><span class="line"><span class="string">	&amp;quot;married&amp;quot;: false</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="检索"><a href="#检索" class="headerlink" title="检索"></a>检索</h2><p>Elasticsearch的检索语法比较特别，使用GET方法携带JSON格式的查询条件。</p>
<p>全检索：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copycurl -X GET 127.0.0.1:9200/user/person/_search</span><br></pre></td></tr></table></figure>

<p>按条件检索：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Copycurl -H &amp;quot;ContentType:application/json&amp;quot; -X PUT 127.0.0.1:9200/user/person/4 -d <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	&amp;quot;query&amp;quot;:&#123;</span></span><br><span class="line"><span class="string">		&amp;quot;match&amp;quot;: &#123;&amp;quot;name&amp;quot;: &amp;quot;sb&amp;quot;&#125;</span></span><br><span class="line"><span class="string">	&#125;	</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>ElasticSearch默认一次最多返回10条结果，可以像下面的示例通过size字段来设置返回结果的数目。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Copycurl -H &amp;quot;ContentType:application/json&amp;quot; -X PUT 127.0.0.1:9200/user/person/4 -d <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	&amp;quot;query&amp;quot;:&#123;</span></span><br><span class="line"><span class="string">		&amp;quot;match&amp;quot;: &#123;&amp;quot;name&amp;quot;: &amp;quot;sb&amp;quot;&#125;,</span></span><br><span class="line"><span class="string">		&amp;quot;size&amp;quot;: 2</span></span><br><span class="line"><span class="string">	&#125;	</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="Go操作Elasticsearch"><a href="#Go操作Elasticsearch" class="headerlink" title="Go操作Elasticsearch"></a>Go操作Elasticsearch</h2><h2 id="elastic-client"><a href="#elastic-client" class="headerlink" title="elastic client"></a>elastic client</h2><p>我们使用第三方库<a target="_blank" rel="noopener" href="https://github.com/olivere/elastic%E6%9D%A5%E8%BF%9E%E6%8E%A5ES%E5%B9%B6%E8%BF%9B%E8%A1%8C%E6%93%8D%E4%BD%9C%E3%80%82">https://github.com/olivere/elastic来连接ES并进行操作。</a></p>
<p>注意下载与你的ES相同版本的client，例如我们这里使用的ES是7.2.1的版本，那么我们下载的client也要与之对应为<code>github.com/olivere/elastic/v7</code>。</p>
<p>使用<code>go.mod</code>来管理依赖：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Copyrequire (</span><br><span class="line">    github.com/olivere/elastic/v7 v7<span class="number">.0</span><span class="number">.4</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>简单示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Copypackage main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	&amp;quot;context&amp;quot;</span><br><span class="line">	&amp;quot;fmt&amp;quot;</span><br><span class="line"></span><br><span class="line">	&amp;quot;github.com/olivere/elastic/v7&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Elasticsearch demo</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name    <span class="type">string</span> <span class="string">`json:&amp;quot;name&amp;quot;`</span></span><br><span class="line">	Age     <span class="type">int</span>    <span class="string">`json:&amp;quot;age&amp;quot;`</span></span><br><span class="line">	Married <span class="type">bool</span>   <span class="string">`json:&amp;quot;married&amp;quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	client, err := elastic.NewClient(elastic.SetURL(&amp;quot;http:<span class="comment">//192.168.1.7:9200&amp;quot;))</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// Handle error</span></span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Println(&amp;quot;connect to es success&amp;quot;)</span><br><span class="line">	p1 := Person&#123;Name: &amp;quot;rion&amp;quot;, Age: <span class="number">22</span>, Married: <span class="literal">false</span>&#125;</span><br><span class="line">	put1, err := client.Index().</span><br><span class="line">		Index(&amp;quot;user&amp;quot;).</span><br><span class="line">		BodyJson(p1).</span><br><span class="line">		Do(context.Background())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// Handle error</span></span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(&amp;quot;Indexed user %s to index %s, <span class="keyword">type</span> %s\n&amp;quot;, put1.Id, put1.Index, put1.Type)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更多使用详见文档：<a target="_blank" rel="noopener" href="https://godoc.org/github.com/olivere/elastic">https://godoc.org/github.com/olivere/elastic</a></p>
<p>MySQL是常用的关系型数据库，本文介绍了Go语言如何操作MySQL数据库。</p>
<h1 id="42-Go操作MySQL"><a href="#42-Go操作MySQL" class="headerlink" title="42.Go操作MySQL"></a>42.Go操作MySQL</h1><h2 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h2><p>Go语言中的<code>database/sql</code>包提供了保证SQL或类SQL数据库的泛用接口，并不提供具体的数据库驱动。使用<code>database/sql</code>包时必须注入（至少）一个数据库驱动。</p>
<p>我们常用的数据库基本上都有完整的第三方实现。例如：<a target="_blank" rel="noopener" href="https://github.com/go-sql-driver/mysql">MySQL驱动</a></p>
<h2 id="下载依赖"><a href="#下载依赖" class="headerlink" title="下载依赖"></a>下载依赖</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copygo get -u github.com/go-sql-driver/mysql</span><br></pre></td></tr></table></figure>

<h2 id="使用MySQL驱动"><a href="#使用MySQL驱动" class="headerlink" title="使用MySQL驱动"></a>使用MySQL驱动</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copyfunc Open(driverName, dataSourceName <span class="type">string</span>) (*DB, <span class="type">error</span>)</span><br></pre></td></tr></table></figure>

<p>Open打开一个dirverName指定的数据库，dataSourceName指定数据源，一般包至少括数据库文件名和（可能的）连接信息。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Copyimport (</span><br><span class="line">	&amp;quot;database/sql&amp;quot;</span><br><span class="line"></span><br><span class="line">	_ &amp;quot;github.com/<span class="keyword">go</span>-sql-driver/mysql&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="comment">// DSN:Data Source Name</span></span><br><span class="line">	dsn := &amp;quot;user:password@tcp(<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">3306</span>)/dbname&amp;quot;</span><br><span class="line">	db, err := sql.Open(&amp;quot;mysql&amp;quot;, dsn)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> db.Close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="初始化连接"><a href="#初始化连接" class="headerlink" title="初始化连接"></a>初始化连接</h2><p>Open函数可能只是验证其参数，而不创建与数据库的连接。如果要检查数据源的名称是否合法，应调用返回值的Ping方法。</p>
<p>返回的DB可以安全的被多个goroutine同时使用，并会维护自身的闲置连接池。这样一来，Open函数只需调用一次。很少需要关闭DB。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Copy<span class="comment">// 定义一个全局对象db</span></span><br><span class="line"><span class="keyword">var</span> db *sql.DB</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个初始化数据库的函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initDB</span><span class="params">()</span></span> (err <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// DSN:Data Source Name</span></span><br><span class="line">	dsn := &amp;quot;user:password@tcp(<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">3306</span>)/test&amp;quot;</span><br><span class="line">	<span class="comment">// 不会校验账号密码是否正确</span></span><br><span class="line">	<span class="comment">// 注意！！！这里不要使用:=，我们是给全局变量赋值，然后在main函数中使用全局变量db</span></span><br><span class="line">	db, err = sql.Open(&amp;quot;mysql&amp;quot;, dsn)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 尝试与数据库建立连接（校验dsn是否正确）</span></span><br><span class="line">	err = db.Ping()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	err := initDB() <span class="comment">// 调用输出化数据库的函数</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(&amp;quot;init db failed,err:%v\n&amp;quot;, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>sql.DB</code>是一个数据库（操作）句柄，代表一个具有零到多个底层连接的连接池。它可以安全的被多个go程同时使用。<code>database/sql</code>包会自动创建和释放连接；它也会维护一个闲置连接的连接池。</p>
<h2 id="SetMaxOpenConns"><a href="#SetMaxOpenConns" class="headerlink" title="SetMaxOpenConns"></a>SetMaxOpenConns</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copyfunc (db *DB) SetMaxOpenConns(n <span class="type">int</span>)</span><br></pre></td></tr></table></figure>

<p><code>SetMaxOpenConns</code>设置与数据库建立连接的最大数目。 如果n大于0且小于最大闲置连接数，会将最大闲置连接数减小到匹配最大开启连接数的限制。 如果n&lt;=0，不会限制最大开启连接数，默认为0（无限制）。</p>
<h2 id="SetMaxIdleConns"><a href="#SetMaxIdleConns" class="headerlink" title="SetMaxIdleConns"></a>SetMaxIdleConns</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copyfunc (db *DB) SetMaxIdleConns(n <span class="type">int</span>)</span><br></pre></td></tr></table></figure>

<p>SetMaxIdleConns设置连接池中的最大闲置连接数。 如果n大于最大开启连接数，则新的最大闲置连接数会减小到匹配最大开启连接数的限制。 如果n&lt;=0，不会保留闲置连接。</p>
<h2 id="CRUD"><a href="#CRUD" class="headerlink" title="CRUD"></a>CRUD</h2><h2 id="建库建表"><a href="#建库建表" class="headerlink" title="建库建表"></a>建库建表</h2><p>我们先在MySQL中创建一个名为<code>sql_test</code>的数据库</p>
<p>Copy</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE sql_test; <span class="string">``</span><span class="string">` 进入该数据库: Copyuse sql_test; `</span><span class="string">``</span> 执行以下命令创建一张用于测试的数据表： CopyCREATE TABLE <span class="string">`user`</span> (    <span class="string">`id`</span> BIGINT(<span class="number">20</span>) NOT NULL AUTO_INCREMENT,    <span class="string">`name`</span> VARCHAR(<span class="number">20</span>) DEFAULT <span class="string">&#x27;&#x27;</span>,    <span class="string">`age`</span> INT(<span class="number">11</span>) DEFAULT <span class="string">&#x27;0&#x27;</span>,    PRIMARY KEY(<span class="string">`id`</span>) )ENGINE=InnoDB AUTO_INCREMENT=<span class="number">1</span> DEFAULT CHARSET=utf8mb4; <span class="string">``</span><span class="string">` # 查询 # 单行查询 单行查询db.QueryRow()执行一次查询，并期望返回最多一行结果（即Row）。QueryRow总是返回非nil的值，直到返回值的Scan方法被调用时，才会返回被延迟的错误。（如：未找到结果） `</span><span class="string">``</span><span class="keyword">go</span> <span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> QueryRow(query <span class="type">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;) *Row <span class="string">``</span><span class="string">` 具体示例代码： `</span><span class="string">``</span><span class="keyword">go</span> <span class="comment">// 查询单条数据示例 func queryRowDemo() &#123; sqlStr := &quot;select id, name, age from user where id=?&quot; var u user // 非常重要：确保QueryRow之后调用Scan方法，否则持有的数据库链接不会被释放 err := db.QueryRow(sqlStr, 1).Scan(&amp;u.id, &amp;u.name, &amp;u.age) if err != nil &#123; 	fmt.Printf(&quot;scan failed, err:%v\n&quot;, err) 	return &#125; fmt.Printf(&quot;id:%d name:%s age:%d\n&quot;, u.id, u.name, u.age) &#125; ``` # 多行查询 多行查询db.Query()执行一次查询，返回多行结果（即Rows），一般用于执行select命令。参数args表示query中的占位参数。 ```go func (db *DB) Query(query string, args ...interface&#123;&#125;) (*Rows, error) ``` 具体示例代码： ```go // 查询多条数据示例 func queryMultiRowDemo() &#123; sqlStr := &quot;select id, name, age from user where id &gt; ?&quot; rows, err := db.Query(sqlStr, 0) if err != nil &#123; 	fmt.Printf(&quot;query failed, err:%v\n&quot;, err) 	return &#125; // 非常重要：关闭rows释放持有的数据库链接 defer rows.Close() 	// 循环读取结果集中的数据 for rows.Next() &#123; 	var u user 	err := rows.Scan(&amp;u.id, &amp;u.name, &amp;u.age) 	if err != nil &#123; 		fmt.Printf(&quot;scan failed, err:%v\n&quot;, err) 		return 	&#125; 	fmt.Printf(&quot;id:%d name:%s age:%d\n&quot;, u.id, u.name, u.age) &#125; &#125; ``` # 插入数据 插入、更新和删除操作都使用``方法。 ```go func (db *DB) Exec(query string, args ...interface&#123;&#125;) (Result, error) ``` Exec执行一次命令（包括查询、删除、更新、插入等），返回的Result是对已执行的SQL命令的总结。参数args表示query中的占位参数。 具体插入数据示例代码如下： ```go // 插入数据 func insertRowDemo() &#123; sqlStr := &quot;insert into user(name, age) values (?,?)&quot; ret, err := db.Exec(sqlStr, &quot;王五&quot;, 38) if err != nil &#123; 	fmt.Printf(&quot;insert failed, err:%v\n&quot;, err) 	return &#125; theID, err := ret.LastInsertId() // 新插入数据的id if err != nil &#123; 	fmt.Printf(&quot;get lastinsert ID failed, err:%v\n&quot;, err) 	return &#125; fmt.Printf(&quot;insert success, the id is %d.\n&quot;, theID) &#125; ``` # 更新数据 具体更新数据示例代码如下： ```go // 更新数据 func updateRowDemo() &#123; sqlStr := &quot;update user set age=? where id = ?&quot; ret, err := db.Exec(sqlStr, 39, 3) if err != nil &#123; 	fmt.Printf(&quot;update failed, err:%v\n&quot;, err) 	return &#125; n, err := ret.RowsAffected() // 操作影响的行数 if err != nil &#123; 	fmt.Printf(&quot;get RowsAffected failed, err:%v\n&quot;, err) 	return &#125; fmt.Printf(&quot;update success, affected rows:%d\n&quot;, n) &#125; ``` # 删除数据 具体删除数据的示例代码如下： ```go // 删除数据 func deleteRowDemo() &#123; sqlStr := &quot;delete from user where id = ?&quot; ret, err := db.Exec(sqlStr, 3) if err != nil &#123; 	fmt.Printf(&quot;delete failed, err:%v\n&quot;, err) 	return &#125; n, err := ret.RowsAffected() // 操作影响的行数 if err != nil &#123; 	fmt.Printf(&quot;get RowsAffected failed, err:%v\n&quot;, err) 	return &#125; fmt.Printf(&quot;delete success, affected rows:%d\n&quot;, n) &#125; ``` # MySQL预处理 # 什么是预处理？ 普通SQL语句执行过程：  客户端对SQL语句进行占位符替换得到完整的SQL语句。 客户端发送完整SQL语句到MySQL服务端 MySQL服务端执行完整的SQL语句并将结果返回给客户端。  预处理执行过程：  把SQL语句分成两部分，命令部分与数据部分。 先把命令部分发送给MySQL服务端，MySQL服务端进行SQL预处理。 然后把数据部分发送给MySQL服务端，MySQL服务端对SQL语句进行占位符替换。 MySQL服务端执行完整的SQL语句并将结果返回给客户端。  # 为什么要预处理？  优化MySQL服务器重复执行SQL的方法，可以提升服务器性能，提前让服务器编译，一次编译多次执行，节省后续编译的成本。 避免SQL注入问题。  # Go实现MySQL预处理 Go中的 ```go func (db *DB) Prepare(query string) (*Stmt, error) ``` Prepare方法会先将sql语句发送给MySQL服务端，返回一个准备好的状态用于之后的查询和命令。返回值可以同时执行多个查询和命令。 查询操作的预处理示例代码如下： ```go // 预处理查询示例 func prepareQueryDemo() &#123; sqlStr := &quot;select id, name, age from user where id &gt; ?&quot; stmt, err := db.Prepare(sqlStr) if err != nil &#123; 	fmt.Printf(&quot;prepare failed, err:%v\n&quot;, err) 	return &#125; defer stmt.Close() rows, err := stmt.Query(0) if err != nil &#123; 	fmt.Printf(&quot;query failed, err:%v\n&quot;, err) 	return &#125; defer rows.Close() // 循环读取结果集中的数据 for rows.Next() &#123; 	var u user 	err := rows.Scan(&amp;u.id, &amp;u.name, &amp;u.age) 	if err != nil &#123; 		fmt.Printf(&quot;scan failed, err:%v\n&quot;, err) 		return 	&#125; 	fmt.Printf(&quot;id:%d name:%s age:%d\n&quot;, u.id, u.name, u.age) &#125; &#125; ``` 插入、更新和删除操作的预处理十分类似，这里以插入操作的预处理为例： ```go // 预处理插入示例 func prepareInsertDemo() &#123; sqlStr := &quot;insert into user(name, age) values (?,?)&quot; stmt, err := db.Prepare(sqlStr) if err != nil &#123; 	fmt.Printf(&quot;prepare failed, err:%v\n&quot;, err) 	return &#125; defer stmt.Close() _, err = stmt.Exec(&quot;小王子&quot;, 18) if err != nil &#123; 	fmt.Printf(&quot;insert failed, err:%v\n&quot;, err) 	return &#125; _, err = stmt.Exec(&quot;沙河娜扎&quot;, 18) if err != nil &#123; 	fmt.Printf(&quot;insert failed, err:%v\n&quot;, err) 	return &#125; fmt.Println(&quot;insert success.&quot;) &#125; ``` # Go实现MySQL事务 # 什么是事务？ 事务：一个最小的不可再分的工作单元；通常一个事务对应一个完整的业务(例如银行账户转账业务，该业务就是一个最小的工作单元)，同时这个完整的业务需要执行多次的DML(insert、update、delete)语句共同联合完成。A转账给B，这里面就需要执行两次update操作。 在MySQL中只有使用了Innodb数据库引擎的数据库或表才支持事务。事务处理可以用来维护数据库的完整性，保证成批的SQL语句要么全部执行，要么全部不执行。 # 事务的ACID 通常事务必须满足4个条件（ACID）：原子性（Atomicity，或称不可分割性）、一致性（Consistency）、隔离性（Isolation，又称独立性）、持久性（Durability）。                条件解释原子性一个事务（transaction）中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被回滚（Rollback）到事务开始前的状态，就像这个事务从来没有执行过一样。一致性在事务开始之前和事务结束以后，数据库的完整性没有被破坏。这表示写入的资料必须完全符合所有的预设规则，这包含资料的精确度、串联性以及后续数据库可以自发性地完成预定的工作。隔离性数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。事务隔离分为不同级别，包括读未提交（Read uncommitted）、读提交（read committed）、可重复读（repeatable read）和串行化（Serializable）。持久性事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。 # 事务相关方法 Go语言中使用以下三个方法实现MySQL中的事务操作。 开始事务 ```go func (db *DB) Begin() (*Tx, error) ``` 提交事务 ```go func (tx *Tx) Commit() error ``` 回滚事务 ```go func (tx *Tx) Rollback() error ``` # 事务示例 下面的代码演示了一个简单的事务操作，该事物操作能够确保两次更新操作要么同时成功要么同时失败，不会存在中间状态。 ```go // 事务操作示例 func transactionDemo() &#123; tx, err := db.Begin() // 开启事务 if err != nil &#123; 	if tx != nil &#123; 		tx.Rollback() // 回滚 	&#125; 	fmt.Printf(&quot;begin trans failed, err:%v\n&quot;, err) 	return &#125; sqlStr1 := &quot;Update user set age=30 where id=?&quot; _, err = tx.Exec(sqlStr1, 2) if err != nil &#123; 	tx.Rollback() // 回滚 	fmt.Printf(&quot;exec sql1 failed, err:%v\n&quot;, err) 	return &#125; sqlStr2 := &quot;Update user set age=40 where id=?&quot; _, err = tx.Exec(sqlStr2, 4) if err != nil &#123; 	tx.Rollback() // 回滚 	fmt.Printf(&quot;exec sql2 failed, err:%v\n&quot;, err) 	return &#125; err = tx.Commit() // 提交事务 if err != nil &#123; 	tx.Rollback() // 回滚 	fmt.Printf(&quot;commit failed, err:%v\n&quot;, err) 	return &#125; fmt.Println(&quot;exec trans success!&quot;) &#125; ``` # sqlx使用 第三方库sqlx能够简化操作，提高开发效率。 # 安装 ```go go get github.com/jmoiron/sqlx ``` # 基本使用 # 连接数据库 ```go var db *sqlx.DB func initDB() (err error) &#123; dsn := &quot;user:password@tcp(127.0.0.1:3306)/test&quot; // 也可以使用MustConnect连接不成功就panic db, err = sqlx.Connect(&quot;mysql&quot;, dsn) if err != nil &#123; 	fmt.Printf(&quot;connect DB failed, err:%v\n&quot;, err) 	return &#125; db.SetMaxOpenConns(20) db.SetMaxIdleConns(10) return &#125; ``` # 查询 查询单行数据示例代码如下： ```go // 查询单条数据示例 func queryRowDemo() &#123; sqlStr := &quot;select id, name, age from user where id=?&quot; var u user err := db.Get(&amp;u, sqlStr, 1) if err != nil &#123; 	fmt.Printf(&quot;get failed, err:%v\n&quot;, err) 	return &#125; fmt.Printf(&quot;id:%d name:%s age:%d\n&quot;, u.ID, u.Name, u.Age) &#125; ``` 查询多行数据示例代码如下： ```go // 查询多条数据示例 func queryMultiRowDemo() &#123; sqlStr := &quot;select id, name, age from user where id &gt; ?&quot; var users []user err := db.Select(&amp;users, sqlStr, 0) if err != nil &#123; 	fmt.Printf(&quot;query failed, err:%v\n&quot;, err) 	return &#125; fmt.Printf(&quot;users:%#v\n&quot;, users) &#125; ``` # 插入、更新和删除 sqlx中的exec方法与原生sql中的exec使用基本一致： ```go // 插入数据 func insertRowDemo() &#123; sqlStr := &quot;insert into user(name, age) values (?,?)&quot; ret, err := db.Exec(sqlStr, &quot;沙河小王子&quot;, 19) if err != nil &#123; 	fmt.Printf(&quot;insert failed, err:%v\n&quot;, err) 	return &#125; theID, err := ret.LastInsertId() // 新插入数据的id if err != nil &#123; 	fmt.Printf(&quot;get lastinsert ID failed, err:%v\n&quot;, err) 	return &#125; fmt.Printf(&quot;insert success, the id is %d.\n&quot;, theID) &#125; // 更新数据 func updateRowDemo() &#123; sqlStr := &quot;update user set age=? where id = ?&quot; ret, err := db.Exec(sqlStr, 39, 6) if err != nil &#123; 	fmt.Printf(&quot;update failed, err:%v\n&quot;, err) 	return &#125; n, err := ret.RowsAffected() // 操作影响的行数 if err != nil &#123; 	fmt.Printf(&quot;get RowsAffected failed, err:%v\n&quot;, err) 	return &#125; fmt.Printf(&quot;update success, affected rows:%d\n&quot;, n) &#125; // 删除数据 func deleteRowDemo() &#123; sqlStr := &quot;delete from user where id = ?&quot; ret, err := db.Exec(sqlStr, 6) if err != nil &#123; 	fmt.Printf(&quot;delete failed, err:%v\n&quot;, err) 	return &#125; n, err := ret.RowsAffected() // 操作影响的行数 if err != nil &#123; 	fmt.Printf(&quot;get RowsAffected failed, err:%v\n&quot;, err) 	return &#125; fmt.Printf(&quot;delete success, affected rows:%d\n&quot;, n) &#125; ``` # 事务操作 对于事务操作，我们可以使用sqlx中提供的db.Beginx()和tx.MustExec()方法来简化错误处理过程。示例代码如下： ```go func transactionDemo() &#123; tx, err := db.Beginx() // 开启事务 if err != nil &#123; 	if tx != nil &#123; 		tx.Rollback() 	&#125; 	fmt.Printf(&quot;begin trans failed, err:%v\n&quot;, err) 	return &#125; sqlStr1 := &quot;Update user set age=40 where id=?&quot; tx.MustExec(sqlStr1, 2) sqlStr2 := &quot;Update user set age=50 where id=?&quot; tx.MustExec(sqlStr2, 4) err = tx.Commit() // 提交事务 if err != nil &#123; 	tx.Rollback() // 回滚 	fmt.Printf(&quot;commit failed, err:%v\n&quot;, err) 	return &#125; fmt.Println(&quot;exec trans success!&quot;) &#125; ``` # 注意事项 # SQL中的占位符 不同的数据库中，SQL语句使用的占位符语法不尽相同。               数据库占位符语法MySQL?PostgreSQL$1, $2等SQLite? 和$1Oracle:name # SQL注入 **我们任何时候都不应该自己拼接SQL语句！** 这里我们演示一个自行拼接SQL语句的示例，编写一个根据name字段查询user表的函数如下： ```go // sql注入示例 func sqlInjectDemo(name string) &#123; sqlStr := fmt.Sprintf(&quot;select id, name, age from user where name=&#x27;%s&#x27;&quot;, name) fmt.Printf(&quot;SQL:%s\n&quot;, sqlStr) 	var users []user err := db.Select(&amp;users, sqlStr) if err != nil &#123; 	fmt.Printf(&quot;exec failed, err:%v\n&quot;, err) 	return &#125; for _, u := range users &#123; 	fmt.Printf(&quot;user:%#v\n&quot;, u) &#125; &#125; ``` 此时以下输入字符串都可以引发SQL注入问题： ```go sqlInjectDemo(&quot;xxx&#x27; or 1=1#&quot;) sqlInjectDemo(&quot;xxx&#x27; union select * from user #&quot;) sqlInjectDemo(&quot;xxx&#x27; and (select count(*) from user) &lt;10 #&quot;) ``` # 练习题  结合net/http和sqlx包实现一个注册及登陆的web程序。</span></span><br></pre></td></tr></table></figure>

<h1 id="43-Go操作Redis"><a href="#43-Go操作Redis" class="headerlink" title="43.Go操作Redis"></a>43.Go操作Redis</h1><p>在项目开发中redis的使用也比较频繁，本文介绍了Go语言如何操作Redis。</p>
<h2 id="Redis介绍"><a href="#Redis介绍" class="headerlink" title="Redis介绍"></a>Redis介绍</h2><p>Redis是一个开源的内存数据库，Redis提供了多种不同类型的数据结构，很多业务场景下的问题都可以很自然地映射到这些数据结构上。除此之外，通过复制、持久化和客户端分片等特性，我们可以很方便地将Redis扩展成一个能够包含数百GB数据、每秒处理上百万次请求的系统。</p>
<h2 id="Redis支持的数据结构"><a href="#Redis支持的数据结构" class="headerlink" title="Redis支持的数据结构"></a>Redis支持的数据结构</h2><p>Redis支持诸如字符串（strings）、哈希（hashes）、列表（lists）、集合（sets）、带范围查询的排序集合（sorted sets）、位图（bitmaps）、hyperloglogs、带半径查询和流的地理空间索引等数据结构（geospatial indexes）。</p>
<h2 id="Redis应用场景"><a href="#Redis应用场景" class="headerlink" title="Redis应用场景"></a>Redis应用场景</h2><ul>
<li>缓存系统，减轻主数据库（MySQL）的压力。</li>
<li>计数场景，比如微博、抖音中的关注数和粉丝数。</li>
<li>热门排行榜，需要排序的场景特别适合使用ZSET。</li>
<li>利用LIST可以实现队列的功能。</li>
</ul>
<h2 id="Redis与Memcached比较"><a href="#Redis与Memcached比较" class="headerlink" title="Redis与Memcached比较"></a>Redis与Memcached比较</h2><p>Memcached中的值只支持简单的字符串，Reids支持更丰富的5中数据结构类型。 Redis的性能比Memcached好很多 Redis支持RDB持久化和AOF持久化。 Redis支持master/slave模式。</p>
<h2 id="Go操作Redis"><a href="#Go操作Redis" class="headerlink" title="Go操作Redis"></a>Go操作Redis</h2><h2 id="安装-5"><a href="#安装-5" class="headerlink" title="安装"></a>安装</h2><p>Go语言中使用第三方库<a target="_blank" rel="noopener" href="https://github.com/go-redis/redis%E8%BF%9E%E6%8E%A5Redis%E6%95%B0%E6%8D%AE%E5%BA%93%E5%B9%B6%E8%BF%9B%E8%A1%8C%E6%93%8D%E4%BD%9C%E3%80%82%E4%BD%BF%E7%94%A8%E4%BB%A5%E4%B8%8B%E5%91%BD%E4%BB%A4%E4%B8%8B%E8%BD%BD%E5%B9%B6%E5%AE%89%E8%A3%85">https://github.com/go-redis/redis连接Redis数据库并进行操作。使用以下命令下载并安装</a>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copygo get -u github.com/go-redis/redis</span><br></pre></td></tr></table></figure>

<h2 id="连接-1"><a href="#连接-1" class="headerlink" title="连接"></a>连接</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Copy<span class="comment">// 声明一个全局的redisdb变量</span></span><br><span class="line"><span class="keyword">var</span> redisdb *redis.Client</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化连接</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initClient</span><span class="params">()</span></span> (err <span class="type">error</span>) &#123;</span><br><span class="line">	redisdb = redis.NewClient(&amp;amp;redis.Options&#123;</span><br><span class="line">		Addr:     &amp;quot;localhost:<span class="number">6379</span>&amp;quot;,</span><br><span class="line">		Password: &amp;quot;&amp;quot;, <span class="comment">// no password set</span></span><br><span class="line">		DB:       <span class="number">0</span>,  <span class="comment">// use default DB</span></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	_, err = redisdb.Ping().Result()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="基本使用-1"><a href="#基本使用-1" class="headerlink" title="基本使用"></a>基本使用</h2><h2 id="set-get示例"><a href="#set-get示例" class="headerlink" title="set/get示例"></a>set/get示例</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Copyfunc redisExample() &#123;</span><br><span class="line">	err := redisdb.Set(&amp;quot;score&amp;quot;, <span class="number">100</span>, <span class="number">0</span>).Err()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(&amp;quot;set score failed, err:%v\n&amp;quot;, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	val, err := redisdb.Get(&amp;quot;score&amp;quot;).Result()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(&amp;quot;get score failed, err:%v\n&amp;quot;, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(&amp;quot;score&amp;quot;, val)</span><br><span class="line"></span><br><span class="line">	val2, err := redisdb.Get(&amp;quot;name&amp;quot;).Result()</span><br><span class="line">	<span class="keyword">if</span> err == redis.Nil &#123;</span><br><span class="line">		fmt.Println(&amp;quot;name does not exist&amp;quot;)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(&amp;quot;get name failed, err:%v\n&amp;quot;, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Println(&amp;quot;name&amp;quot;, val2)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="zset示例"><a href="#zset示例" class="headerlink" title="zset示例"></a>zset示例</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">Copyfunc redisExample2() &#123;</span><br><span class="line">	zsetKey := &amp;quot;language_rank&amp;quot;</span><br><span class="line">	languages := []*redis.Z&#123;</span><br><span class="line">		&amp;amp;redis.Z&#123;Score: <span class="number">90.0</span>, Member: &amp;quot;Golang&amp;quot;&#125;,</span><br><span class="line">		&amp;amp;redis.Z&#123;Score: <span class="number">98.0</span>, Member: &amp;quot;Java&amp;quot;&#125;,</span><br><span class="line">		&amp;amp;redis.Z&#123;Score: <span class="number">95.0</span>, Member: &amp;quot;Python&amp;quot;&#125;,</span><br><span class="line">		&amp;amp;redis.Z&#123;Score: <span class="number">97.0</span>, Member: &amp;quot;JavaScript&amp;quot;&#125;,</span><br><span class="line">		&amp;amp;redis.Z&#123;Score: <span class="number">99.0</span>, Member: &amp;quot;C/C++&amp;quot;&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ZADD</span></span><br><span class="line">	num, err := redisdb.ZAdd(zsetKey, languages...).Result()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(&amp;quot;zadd failed, err:%v\n&amp;quot;, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(&amp;quot;zadd %d succ.\n&amp;quot;, num)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 把Golang的分数加10</span></span><br><span class="line">	newScore, err := redisdb.ZIncrBy(zsetKey, <span class="number">10.0</span>, &amp;quot;Golang&amp;quot;).Result()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(&amp;quot;zincrby failed, err:%v\n&amp;quot;, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(&amp;quot;Golang<span class="string">&#x27;s score is %f now.\n&amp;quot;, newScore)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	// 取分数最高的3个</span></span><br><span class="line"><span class="string">	ret, err := redisdb.ZRevRangeWithScores(zsetKey, 0, 2).Result()</span></span><br><span class="line"><span class="string">	if err != nil &#123;</span></span><br><span class="line"><span class="string">		fmt.Printf(&amp;quot;zrevrange failed, err:%v\n&amp;quot;, err)</span></span><br><span class="line"><span class="string">		return</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">	for _, z := range ret &#123;</span></span><br><span class="line"><span class="string">		fmt.Println(z.Member, z.Score)</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	// 取95~100分的</span></span><br><span class="line"><span class="string">	op := &amp;amp;redis.ZRangeBy&#123;</span></span><br><span class="line"><span class="string">		Min: &amp;quot;95&amp;quot;,</span></span><br><span class="line"><span class="string">		Max: &amp;quot;100&amp;quot;,</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">	ret, err = redisdb.ZRangeByScoreWithScores(zsetKey, op).Result()</span></span><br><span class="line"><span class="string">	if err != nil &#123;</span></span><br><span class="line"><span class="string">		fmt.Printf(&amp;quot;zrangebyscore failed, err:%v\n&amp;quot;, err)</span></span><br><span class="line"><span class="string">		return</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">	for _, z := range ret &#123;</span></span><br><span class="line"><span class="string">		fmt.Println(z.Member, z.Score)</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Copy$ ./06redis_demo </span><br><span class="line">zadd 0 succ.</span><br><span class="line">Golang<span class="string">&#x27;s score is 100.000000 now.</span></span><br><span class="line"><span class="string">Golang 100</span></span><br><span class="line"><span class="string">C/C++ 99</span></span><br><span class="line"><span class="string">Java 98</span></span><br><span class="line"><span class="string">JavaScript 97</span></span><br><span class="line"><span class="string">Java 98</span></span><br><span class="line"><span class="string">C/C++ 99</span></span><br><span class="line"><span class="string">Golang 100</span></span><br></pre></td></tr></table></figure>

<p>更多详情请查阅<a target="_blank" rel="noopener" href="https://godoc.org/github.com/go-redis/redis">文档</a>。</p>
<h1 id="44-Go操作etcd"><a href="#44-Go操作etcd" class="headerlink" title="44.Go操作etcd"></a>44.Go操作etcd</h1><p>etcd是近几年比较火热的一个开源的、分布式的键值对数据存储系统，提供共享配置、服务的注册和发现，本文主要介绍etcd的安装和使用。</p>
<h2 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h2><h2 id="etcd介绍"><a href="#etcd介绍" class="headerlink" title="etcd介绍"></a>etcd介绍</h2><p><a target="_blank" rel="noopener" href="https://etcd.io/">etcd</a>是使用Go语言开发的一个开源的、高可用的分布式key-value存储系统，可以用于配置共享和服务的注册和发现。</p>
<p>类似项目有zookeeper和consul。</p>
<p>etcd具有以下特点：</p>
<ul>
<li>完全复制：集群中的每个节点都可以使用完整的存档</li>
<li>高可用性：Etcd可用于避免硬件的单点故障或网络问题</li>
<li>一致性：每次读取都会返回跨多主机的最新写入</li>
<li>简单：包括一个定义良好、面向用户的API（gRPC）</li>
<li>安全：实现了带有可选的客户端证书身份验证的自动化TLS</li>
<li>快速：每秒10000次写入的基准速度</li>
<li>可靠：使用Raft算法实现了强一致、高可用的服务存储目录</li>
</ul>
<h2 id="etcd应用场景"><a href="#etcd应用场景" class="headerlink" title="etcd应用场景"></a>etcd应用场景</h2><h2 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h2><p>服务发现要解决的也是分布式系统中最常见的问题之一，即在同一个分布式集群中的进程或服务，要如何才能找到对方并建立连接。本质上来说，服务发现就是想要了解集群中是否有进程在监听 udp 或 tcp 端口，并且通过名字就可以查找和连接。</p>
<p><a target="_blank" rel="noopener" href="http://www.chenyoude.com/go/etcd_01.png"><img src="http://www.chenyoude.com/go/etcd_01.png" alt="etcd_01.png"></a></p>
<h2 id="配置中心"><a href="#配置中心" class="headerlink" title="配置中心"></a>配置中心</h2><p>将一些配置信息放到 etcd 上进行集中管理。</p>
<p>这类场景的使用方式通常是这样：应用在启动的时候主动从 etcd 获取一次配置信息，同时，在 etcd 节点上注册一个 Watcher 并等待，以后每次配置有更新的时候，etcd 都会实时通知订阅者，以此达到获取最新配置信息的目的。</p>
<h2 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h2><p>因为 etcd 使用 Raft 算法保持了数据的强一致性，某次操作存储到集群中的值必然是全局一致的，所以很容易实现分布式锁。锁服务有两种使用方式，一是保持独占，二是控制时序。</p>
<ul>
<li><strong>保持独占即所有获取锁的用户最终只有一个可以得到</strong>。etcd 为此提供了一套实现分布式锁原子操作 CAS（<code>CompareAndSwap</code>）的 API。通过设置<code>prevExist</code>值，可以保证在多个节点同时去创建某个目录时，只有一个成功。而创建成功的用户就可以认为是获得了锁。</li>
<li>控制时序，即所有想要获得锁的用户都会被安排执行，但是<strong>获得锁的顺序也是全局唯一的，同时决定了执行顺序</strong>。etcd 为此也提供了一套 API（自动创建有序键），对一个目录建值时指定为<code>POST</code>动作，这样 etcd 会自动在目录下生成一个当前最大的值为键，存储这个新的值（客户端编号）。同时还可以使用 API 按顺序列出所有当前目录下的键值。此时这些键的值就是客户端的时序，而这些键中存储的值可以是代表客户端的编号。</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://www.chenyoude.com/go/etcd_02.png"><img src="http://www.chenyoude.com/go/etcd_02.png" alt="etcd_02.png"></a></p>
<h2 id="为什么用-etcd-而不用ZooKeeper？"><a href="#为什么用-etcd-而不用ZooKeeper？" class="headerlink" title="为什么用 etcd 而不用ZooKeeper？"></a>为什么用 etcd 而不用ZooKeeper？</h2><p>etcd 实现的这些功能，ZooKeeper都能实现。那么为什么要用 etcd 而非直接使用ZooKeeper呢？</p>
<h2 id="为什么不选择ZooKeeper？"><a href="#为什么不选择ZooKeeper？" class="headerlink" title="为什么不选择ZooKeeper？"></a>为什么不选择ZooKeeper？</h2><ol>
<li>部署维护复杂，其使用的<code>Paxos</code>强一致性算法复杂难懂。官方只提供了<code>Java</code>和<code>C</code>两种语言的接口。</li>
<li>使用<code>Java</code>编写引入大量的依赖。运维人员维护起来比较麻烦。</li>
<li>最近几年发展缓慢，不如<code>etcd</code>和<code>consul</code>等后起之秀。</li>
</ol>
<h2 id="为什么选择etcd？"><a href="#为什么选择etcd？" class="headerlink" title="为什么选择etcd？"></a>为什么选择etcd？</h2><ol>
<li>简单。使用 Go 语言编写部署简单；支持HTTP/JSON API,使用简单；使用 Raft 算法保证强一致性让用户易于理解。</li>
<li>etcd 默认数据一更新就进行持久化。</li>
<li>etcd 支持 SSL 客户端安全认证。</li>
</ol>
<p>最后，etcd 作为一个年轻的项目，正在高速迭代和开发中，这既是一个优点，也是一个缺点。优点是它的未来具有无限的可能性，缺点是无法得到大项目长时间使用的检验。然而，目前 <code>CoreOS</code>、<code>Kubernetes</code>和<code>CloudFoundry</code>等知名项目均在生产环境中使用了<code>etcd</code>，所以总的来说，etcd值得你去尝试。</p>
<h2 id="etcd集群"><a href="#etcd集群" class="headerlink" title="etcd集群"></a>etcd集群</h2><p>etcd 作为一个高可用键值存储系统，天生就是为集群化而设计的。由于 Raft 算法在做决策时需要多数节点的投票，所以 etcd 一般部署集群推荐奇数个节点，推荐的数量为 3、5 或者 7 个节点构成一个集群。</p>
<h2 id="搭建一个3节点集群示例："><a href="#搭建一个3节点集群示例：" class="headerlink" title="搭建一个3节点集群示例："></a>搭建一个3节点集群示例：</h2><p>在每个etcd节点指定集群成员，为了区分不同的集群最好同时配置一个独一无二的token。</p>
<p>下面是提前定义好的集群信息，其中<code>n1</code>、<code>n2</code>和<code>n3</code>表示3个不同的etcd节点。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CopyTOKEN=token-01</span><br><span class="line">CLUSTER_STATE=new</span><br><span class="line">CLUSTER=n1=http://10.240.0.17:2380,n2=http://10.240.0.18:2380,n3=http://10.240.0.19:2380</span><br></pre></td></tr></table></figure>

<p>在<code>n1</code>这台机器上执行以下命令来启动etcd：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Copyetcd --data-dir=data.etcd --name n1 \</span><br><span class="line">	--initial-advertise-peer-urls http://10.240.0.17:2380 --listen-peer-urls http://10.240.0.17:2380 \</span><br><span class="line">	--advertise-client-urls http://10.240.0.17:2379 --listen-client-urls http://10.240.0.17:2379 \</span><br><span class="line">	--initial-cluster <span class="variable">$&#123;CLUSTER&#125;</span> \</span><br><span class="line">	--initial-cluster-state <span class="variable">$&#123;CLUSTER_STATE&#125;</span> --initial-cluster-token <span class="variable">$&#123;TOKEN&#125;</span></span><br></pre></td></tr></table></figure>

<p>在<code>n2</code>这台机器上执行以下命令启动etcd：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Copyetcd --data-dir=data.etcd --name n2 \</span><br><span class="line">	--initial-advertise-peer-urls http://10.240.0.18:2380 --listen-peer-urls http://10.240.0.18:2380 \</span><br><span class="line">	--advertise-client-urls http://10.240.0.18:2379 --listen-client-urls http://10.240.0.18:2379 \</span><br><span class="line">	--initial-cluster <span class="variable">$&#123;CLUSTER&#125;</span> \</span><br><span class="line">	--initial-cluster-state <span class="variable">$&#123;CLUSTER_STATE&#125;</span> --initial-cluster-token <span class="variable">$&#123;TOKEN&#125;</span></span><br></pre></td></tr></table></figure>

<p>在<code>n3</code>这台机器上执行以下命令启动etcd：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Copyetcd --data-dir=data.etcd --name n3 \</span><br><span class="line">	--initial-advertise-peer-urls http://10.240.0.19:2380 --listen-peer-urls http://10.240.0.19:2380 \</span><br><span class="line">	--advertise-client-urls http://10.240.0.19:2379 --listen-client-urls http://10.240.0.19:2379 \</span><br><span class="line">	--initial-cluster <span class="variable">$&#123;CLUSTER&#125;</span> \</span><br><span class="line">	--initial-cluster-state <span class="variable">$&#123;CLUSTER_STATE&#125;</span> --initial-cluster-token <span class="variable">$&#123;TOKEN&#125;</span></span><br></pre></td></tr></table></figure>

<p>etcd 官网提供了一个可以公网访问的 etcd 存储地址。你可以通过如下命令得到 etcd 服务的目录，并把它作为<code>-discovery</code>参数使用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Copycurl https://discovery.etcd.io/new?size=3</span><br><span class="line">https://discovery.etcd.io/a81b5818e67a6ea83e9d4daea5ecbc92</span><br><span class="line"></span><br><span class="line"><span class="comment"># grab this token</span></span><br><span class="line">TOKEN=token-01</span><br><span class="line">CLUSTER_STATE=new</span><br><span class="line">DISCOVERY=https://discovery.etcd.io/a81b5818e67a6ea83e9d4daea5ecbc92</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">etcd --data-dir=data.etcd --name n1 \</span><br><span class="line">	--initial-advertise-peer-urls http://10.240.0.17:2380 --listen-peer-urls http://10.240.0.17:2380 \</span><br><span class="line">	--advertise-client-urls http://10.240.0.17:2379 --listen-client-urls http://10.240.0.17:2379 \</span><br><span class="line">	--discovery <span class="variable">$&#123;DISCOVERY&#125;</span> \</span><br><span class="line">	--initial-cluster-state <span class="variable">$&#123;CLUSTER_STATE&#125;</span> --initial-cluster-token <span class="variable">$&#123;TOKEN&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">etcd --data-dir=data.etcd --name n2 \</span><br><span class="line">	--initial-advertise-peer-urls http://10.240.0.18:2380 --listen-peer-urls http://10.240.0.18:2380 \</span><br><span class="line">	--advertise-client-urls http://10.240.0.18:2379 --listen-client-urls http://10.240.0.18:2379 \</span><br><span class="line">	--discovery <span class="variable">$&#123;DISCOVERY&#125;</span> \</span><br><span class="line">	--initial-cluster-state <span class="variable">$&#123;CLUSTER_STATE&#125;</span> --initial-cluster-token <span class="variable">$&#123;TOKEN&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">etcd --data-dir=data.etcd --name n3 \</span><br><span class="line">	--initial-advertise-peer-urls http://10.240.0.19:2380 --listen-peer-urls http://10.240.0.19:2380 \</span><br><span class="line">	--advertise-client-urls http://10.240.0.19:2379 --listen-client-urls http:/10.240.0.19:2379 \</span><br><span class="line">	--discovery <span class="variable">$&#123;DISCOVERY&#125;</span> \</span><br><span class="line">	--initial-cluster-state <span class="variable">$&#123;CLUSTER_STATE&#125;</span> --initial-cluster-token <span class="variable">$&#123;TOKEN&#125;</span></span><br></pre></td></tr></table></figure>

<p>到此etcd集群就搭建起来了，可以使用<code>etcdctl</code>来连接etcd。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Copyexport ETCDCTL_API=3</span><br><span class="line">HOST_1=10.240.0.17</span><br><span class="line">HOST_2=10.240.0.18</span><br><span class="line">HOST_3=10.240.0.19</span><br><span class="line">ENDPOINTS=<span class="variable">$HOST_1</span>:2379,<span class="variable">$HOST_2</span>:2379,<span class="variable">$HOST_3</span>:2379</span><br><span class="line"></span><br><span class="line">etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> member list</span><br></pre></td></tr></table></figure>

<h2 id="Go语言操作etcd"><a href="#Go语言操作etcd" class="headerlink" title="Go语言操作etcd"></a>Go语言操作etcd</h2><p>这里使用官方的<a target="_blank" rel="noopener" href="https://github.com/etcd-io/etcd/tree/master/clientv3">etcd/clientv3</a>包来连接etcd并进行相关操作。</p>
<h2 id="安装-6"><a href="#安装-6" class="headerlink" title="安装"></a>安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copygo get go.etcd.io/etcd/clientv3</span><br></pre></td></tr></table></figure>

<h2 id="put和get操作"><a href="#put和get操作" class="headerlink" title="put和get操作"></a>put和get操作</h2><p><code>put</code>命令用来设置键值对数据，<code>get</code>命令用来根据key获取值。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">Copypackage main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	&amp;quot;context&amp;quot;</span><br><span class="line">	&amp;quot;fmt&amp;quot;</span><br><span class="line">	&amp;quot;time&amp;quot;</span><br><span class="line"></span><br><span class="line">	&amp;quot;<span class="keyword">go</span>.etcd.io/etcd/clientv3&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// etcd client put/get demo</span></span><br><span class="line"><span class="comment">// use etcd/clientv3</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">		Endpoints:   []<span class="type">string</span>&#123;&amp;quot;<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2379</span>&amp;quot;&#125;,</span><br><span class="line">		DialTimeout: <span class="number">5</span> * time.Second,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// handle error!</span></span><br><span class="line">		fmt.Printf(&amp;quot;connect to etcd failed, err:%v\n&amp;quot;, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">    fmt.Println(&amp;quot;connect to etcd success&amp;quot;)</span><br><span class="line">	<span class="keyword">defer</span> cli.Close()</span><br><span class="line">	<span class="comment">// put</span></span><br><span class="line">	ctx, cancel := context.WithTimeout(context.Background(), time.Second)</span><br><span class="line">	_, err = cli.Put(ctx, &amp;quot;q1mi&amp;quot;, &amp;quot;dsb&amp;quot;)</span><br><span class="line">	cancel()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(&amp;quot;put to etcd failed, err:%v\n&amp;quot;, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// get</span></span><br><span class="line">	ctx, cancel = context.WithTimeout(context.Background(), time.Second)</span><br><span class="line">	resp, err := cli.Get(ctx, &amp;quot;q1mi&amp;quot;)</span><br><span class="line">	cancel()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(&amp;quot;get from etcd failed, err:%v\n&amp;quot;, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> _, ev := <span class="keyword">range</span> resp.Kvs &#123;</span><br><span class="line">		fmt.Printf(&amp;quot;%s:%s\n&amp;quot;, ev.Key, ev.Value)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="watch操作"><a href="#watch操作" class="headerlink" title="watch操作"></a>watch操作</h2><p><code>watch</code>用来获取未来更改的通知。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Copypackage main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	&amp;quot;context&amp;quot;</span><br><span class="line">	&amp;quot;fmt&amp;quot;</span><br><span class="line">	&amp;quot;time&amp;quot;</span><br><span class="line"></span><br><span class="line">	&amp;quot;<span class="keyword">go</span>.etcd.io/etcd/clientv3&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// watch demo</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">		Endpoints:   []<span class="type">string</span>&#123;&amp;quot;<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2379</span>&amp;quot;&#125;,</span><br><span class="line">		DialTimeout: <span class="number">5</span> * time.Second,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(&amp;quot;connect to etcd failed, err:%v\n&amp;quot;, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(&amp;quot;connect to etcd success&amp;quot;)</span><br><span class="line">	<span class="keyword">defer</span> cli.Close()</span><br><span class="line">	<span class="comment">// watch key:q1mi change</span></span><br><span class="line">	rch := cli.Watch(context.Background(), &amp;quot;q1mi&amp;quot;) <span class="comment">// &amp;lt;-chan WatchResponse</span></span><br><span class="line">	<span class="keyword">for</span> wresp := <span class="keyword">range</span> rch &#123;</span><br><span class="line">		<span class="keyword">for</span> _, ev := <span class="keyword">range</span> wresp.Events &#123;</span><br><span class="line">			fmt.Printf(&amp;quot;Type: %s Key:%s Value:%s\n&amp;quot;, ev.Type, ev.Kv.Key, ev.Kv.Value)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将上面的代码保存编译执行，此时程序就会等待etcd中<code>q1mi</code>这个key的变化。</p>
<p>例如：我们打开终端执行以下命令修改、删除、设置<code>q1mi</code>这个key。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Copyetcd&amp;gt; etcdctl.exe --endpoints=http://127.0.0.1:2379 put q1mi &amp;quot;dsb2&amp;quot;</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">etcd&amp;gt; etcdctl.exe --endpoints=http://127.0.0.1:2379 del q1mi</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">etcd&amp;gt; etcdctl.exe --endpoints=http://127.0.0.1:2379 put q1mi &amp;quot;dsb3&amp;quot;</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>上面的程序都能收到如下通知。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Copywatch&amp;gt;watch.exe</span><br><span class="line">connect to etcd success</span><br><span class="line">Type: PUT Key:q1mi Value:dsb2</span><br><span class="line">Type: DELETE Key:q1mi Value:</span><br><span class="line">Type: PUT Key:q1mi Value:dsb3</span><br></pre></td></tr></table></figure>

<h2 id="lease租约"><a href="#lease租约" class="headerlink" title="lease租约"></a>lease租约</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">Copypackage main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	&amp;quot;fmt&amp;quot;</span><br><span class="line">	&amp;quot;time&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// etcd lease</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	&amp;quot;context&amp;quot;</span><br><span class="line">	&amp;quot;log&amp;quot;</span><br><span class="line"></span><br><span class="line">	&amp;quot;<span class="keyword">go</span>.etcd.io/etcd/clientv3&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">		Endpoints:   []<span class="type">string</span>&#123;&amp;quot;<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2379</span>&amp;quot;&#125;,</span><br><span class="line">		DialTimeout: time.Second * <span class="number">5</span>,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(&amp;quot;connect to etcd success.&amp;quot;)</span><br><span class="line">	<span class="keyword">defer</span> cli.Close()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建一个5秒的租约</span></span><br><span class="line">	resp, err := cli.Grant(context.TODO(), <span class="number">5</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 5秒钟之后, /nazha/ 这个key就会被移除</span></span><br><span class="line">	_, err = cli.Put(context.TODO(), &amp;quot;/nazha/&amp;quot;, &amp;quot;dsb&amp;quot;, clientv3.WithLease(resp.ID))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="keepAlive"><a href="#keepAlive" class="headerlink" title="keepAlive"></a>keepAlive</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">Copypackage main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	&amp;quot;context&amp;quot;</span><br><span class="line">	&amp;quot;fmt&amp;quot;</span><br><span class="line">	&amp;quot;log&amp;quot;</span><br><span class="line">	&amp;quot;time&amp;quot;</span><br><span class="line"></span><br><span class="line">	&amp;quot;<span class="keyword">go</span>.etcd.io/etcd/clientv3&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// etcd keepAlive</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">		Endpoints:   []<span class="type">string</span>&#123;&amp;quot;<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2379</span>&amp;quot;&#125;,</span><br><span class="line">		DialTimeout: time.Second * <span class="number">5</span>,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(&amp;quot;connect to etcd success.&amp;quot;)</span><br><span class="line">	<span class="keyword">defer</span> cli.Close()</span><br><span class="line"></span><br><span class="line">	resp, err := cli.Grant(context.TODO(), <span class="number">5</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_, err = cli.Put(context.TODO(), &amp;quot;/nazha/&amp;quot;, &amp;quot;dsb&amp;quot;, clientv3.WithLease(resp.ID))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// the key &#x27;foo&#x27; will be kept forever</span></span><br><span class="line">	ch, kaerr := cli.KeepAlive(context.TODO(), resp.ID)</span><br><span class="line">	<span class="keyword">if</span> kaerr != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(kaerr)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		ka := &amp;lt;-ch</span><br><span class="line">		fmt.Println(&amp;quot;ttl:&amp;quot;, ka.TTL)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="基于etcd实现分布式锁"><a href="#基于etcd实现分布式锁" class="headerlink" title="基于etcd实现分布式锁"></a>基于etcd实现分布式锁</h2><p><code>go.etcd.io/etcd/clientv3/concurrency</code>在etcd之上实现并发操作，如分布式锁、屏障和选举。</p>
<p>导入该包：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copyimport &amp;quot;<span class="keyword">go</span>.etcd.io/etcd/clientv3/concurrency&amp;quot;</span><br></pre></td></tr></table></figure>

<p>基于etcd实现的分布式锁示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">Copycli, err := clientv3.New(clientv3.Config&#123;Endpoints: endpoints&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> cli.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建两个单独的会话用来演示锁竞争</span></span><br><span class="line">s1, err := concurrency.NewSession(cli)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> s1.Close()</span><br><span class="line">m1 := concurrency.NewMutex(s1, &amp;quot;/my-lock/&amp;quot;)</span><br><span class="line"></span><br><span class="line">s2, err := concurrency.NewSession(cli)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> s2.Close()</span><br><span class="line">m2 := concurrency.NewMutex(s2, &amp;quot;/my-lock/&amp;quot;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 会话s1获取锁</span></span><br><span class="line"><span class="keyword">if</span> err := m1.Lock(context.TODO()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(&amp;quot;acquired lock <span class="keyword">for</span> s1&amp;quot;)</span><br><span class="line"></span><br><span class="line">m2Locked := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> <span class="built_in">close</span>(m2Locked)</span><br><span class="line">    <span class="comment">// 等待直到会话s1释放了/my-lock/的锁</span></span><br><span class="line">    <span class="keyword">if</span> err := m2.Lock(context.TODO()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := m1.Unlock(context.TODO()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(&amp;quot;released lock <span class="keyword">for</span> s1&amp;quot;)</span><br><span class="line"></span><br><span class="line">&amp;lt;-m2Locked</span><br><span class="line">fmt.Println(&amp;quot;acquired lock <span class="keyword">for</span> s2&amp;quot;)</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Copyacquired lock <span class="keyword">for</span> s1</span><br><span class="line">released lock <span class="keyword">for</span> s1</span><br><span class="line">acquired lock <span class="keyword">for</span> s2</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://godoc.org/go.etcd.io/etcd/clientv3/concurrency">查看文档了解更多</a></p>
<h2 id="其他操作"><a href="#其他操作" class="headerlink" title="其他操作"></a>其他操作</h2><p>其他操作请查看<a target="_blank" rel="noopener" href="https://godoc.org/go.etcd.io/etcd/clientv3">etcd/clientv3官方文档</a>。</p>
<p>参考链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://etcd.io/docs/v3.3.12/demo/">https://etcd.io/docs/v3.3.12/demo/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/etcd-interpretation-application-scenario-implement-principle/">https://www.infoq.cn/article/etcd-interpretation-application-scenario-implement-principle/</a></li>
</ul>
<h1 id="45-Go操作kafka"><a href="#45-Go操作kafka" class="headerlink" title="45.Go操作kafka"></a>45.Go操作kafka</h1><p>Kafka是一种高吞吐量的分布式发布订阅消息系统，它可以处理消费者规模的网站中的所有动作流数据，具有高性能、持久化、多副本备份、横向扩展等特点。本文介绍了如何使用Go语言发送和接收kafka消息。</p>
<h2 id="sarama"><a href="#sarama" class="headerlink" title="sarama"></a>sarama</h2><p>Go语言中连接kafka使用第三方库:<a target="_blank" rel="noopener" href="https://github.com/Shopify/sarama">github.com/Shopify/sarama</a>。</p>
<h2 id="下载及安装"><a href="#下载及安装" class="headerlink" title="下载及安装"></a>下载及安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copygo get github.com/Shopify/sarama</span><br></pre></td></tr></table></figure>

<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p><code>sarama</code> v1.20之后的版本加入了<code>zstd</code>压缩算法，需要用到cgo，在Windows平台编译时会提示类似如下错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Copy<span class="comment"># github.com/DataDog/zstd</span></span><br><span class="line"><span class="built_in">exec</span>: &amp;quot;gcc&amp;quot;:executable file not found <span class="keyword">in</span> %PATH%</span><br></pre></td></tr></table></figure>

<p>所以在Windows平台请使用v1.19版本的sarama。</p>
<h2 id="连接kafka发送消息"><a href="#连接kafka发送消息" class="headerlink" title="连接kafka发送消息"></a>连接kafka发送消息</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Copypackage main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	&amp;quot;fmt&amp;quot;</span><br><span class="line"></span><br><span class="line">	&amp;quot;github.com/Shopify/sarama&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基于sarama第三方库开发的kafka client</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	config := sarama.NewConfig()</span><br><span class="line">	config.Producer.RequiredAcks = sarama.WaitForAll          <span class="comment">// 发送完数据需要leader和follow都确认</span></span><br><span class="line">	config.Producer.Partitioner = sarama.NewRandomPartitioner <span class="comment">// 新选出一个partition</span></span><br><span class="line">	config.Producer.Return.Successes = <span class="literal">true</span>                   <span class="comment">// 成功交付的消息将在success channel返回</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 构造一个消息</span></span><br><span class="line">	msg := &amp;amp;sarama.ProducerMessage&#123;&#125;</span><br><span class="line">	msg.Topic = &amp;quot;web_log&amp;quot;</span><br><span class="line">	msg.Value = sarama.StringEncoder(&amp;quot;this is a test log&amp;quot;)</span><br><span class="line">	<span class="comment">// 连接kafka</span></span><br><span class="line">	client, err := sarama.NewSyncProducer([]<span class="type">string</span>&#123;&amp;quot;<span class="number">192.168</span><span class="number">.1</span><span class="number">.7</span>:<span class="number">9092</span>&amp;quot;&#125;, config)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(&amp;quot;producer closed, err:&amp;quot;, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> client.Close()</span><br><span class="line">	<span class="comment">// 发送消息</span></span><br><span class="line">	pid, offset, err := client.SendMessage(msg)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(&amp;quot;send msg failed, err:&amp;quot;, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(&amp;quot;pid:%v offset:%v\n&amp;quot;, pid, offset)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="连接kafka消费消息"><a href="#连接kafka消费消息" class="headerlink" title="连接kafka消费消息"></a>连接kafka消费消息</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">Copypackage main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	&amp;quot;fmt&amp;quot;</span><br><span class="line"></span><br><span class="line">	&amp;quot;github.com/Shopify/sarama&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// kafka consumer</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	consumer, err := sarama.NewConsumer([]<span class="type">string</span>&#123;&amp;quot;<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">9092</span>&amp;quot;&#125;, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(&amp;quot;fail to start consumer, err:%v\n&amp;quot;, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	partitionList, err := consumer.Partitions(&amp;quot;web_log&amp;quot;) <span class="comment">// 根据topic取到所有的分区</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(&amp;quot;fail to get list of partition:err%v\n&amp;quot;, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(partitionList)</span><br><span class="line">	<span class="keyword">for</span> partition := <span class="keyword">range</span> partitionList &#123; <span class="comment">// 遍历所有的分区</span></span><br><span class="line">		<span class="comment">// 针对每个分区创建一个对应的分区消费者</span></span><br><span class="line">		pc, err := consumer.ConsumePartition(&amp;quot;web_log&amp;quot;, <span class="type">int32</span>(partition), sarama.OffsetNewest)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(&amp;quot;failed to start consumer <span class="keyword">for</span> partition %d,err:%v\n&amp;quot;, partition, err)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">defer</span> pc.AsyncClose()</span><br><span class="line">		<span class="comment">// 异步从每个分区消费信息</span></span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(sarama.PartitionConsumer)</span></span> &#123;</span><br><span class="line">			<span class="keyword">for</span> msg := <span class="keyword">range</span> pc.Messages() &#123;</span><br><span class="line">				fmt.Printf(&amp;quot;Partition:%d Offset:%d Key:%v Value:%v&amp;quot;, msg.Partition, msg.Offset, msg.Key, msg.Value)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;(pc)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="46-Go依赖管理及Go-module使用"><a href="#46-Go依赖管理及Go-module使用" class="headerlink" title="46.Go依赖管理及Go module使用"></a>46.Go依赖管理及Go module使用</h1><p>Go语言的依赖管理随着版本的更迭正逐渐完善起来。</p>
<h2 id="依赖管理"><a href="#依赖管理" class="headerlink" title="依赖管理"></a>依赖管理</h2><h2 id="为什么需要依赖管理"><a href="#为什么需要依赖管理" class="headerlink" title="为什么需要依赖管理"></a>为什么需要依赖管理</h2><p>最早的时候，Go所依赖的所有的第三方库都放在GOPATH这个目录下面。这就导致了同一个库只能保存一个版本的代码。如果不同的项目依赖同一个第三方的库的不同版本，应该怎么解决？</p>
<h2 id="godep"><a href="#godep" class="headerlink" title="godep"></a>godep</h2><p>Go语言从v1.5开始开始引入<code>vendor</code>模式，如果项目目录下有vendor目录，那么go工具链会优先使用<code>vendor</code>内的包进行编译、测试等。</p>
<p><code>godep</code>是一个通过vender模式实现的Go语言的第三方依赖管理工具，类似的还有由社区维护准官方包管理工具<code>dep</code>。</p>
<h2 id="安装-7"><a href="#安装-7" class="headerlink" title="安装"></a>安装</h2><p>执行以下命令安装<code>godep</code>工具。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copygo get github.com/tools/godep</span><br></pre></td></tr></table></figure>

<h2 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h2><p>安装好godep之后，在终端输入<code>godep</code>查看支持的所有命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Copygodep save     将依赖项输出并复制到Godeps.json文件中</span><br><span class="line">godep go       使用保存的依赖项运行go工具</span><br><span class="line">godep get      下载并安装具有指定依赖项的包</span><br><span class="line">godep path     打印依赖的GOPATH路径</span><br><span class="line">godep restore  在GOPATH中拉取依赖的版本</span><br><span class="line">godep update   更新选定的包或go版本</span><br><span class="line">godep diff     显示当前和以前保存的依赖项集之间的差异</span><br><span class="line">godep version  查看版本信息</span><br></pre></td></tr></table></figure>

<p>使用<code>godep help [command]</code>可以看看具体命令的帮助信息。</p>
<h2 id="使用godep"><a href="#使用godep" class="headerlink" title="使用godep"></a>使用godep</h2><p>在项目目录下执行<code>godep save</code>命令，会在当前项目中创建<code>Godeps</code>和<code>vender</code>两个文件夹。</p>
<p>其中<code>Godeps</code>文件夹下有一个<code>Godeps.json</code>的文件，里面记录了项目所依赖的包信息。 <code>vender</code>文件夹下是项目依赖的包的源代码文件。</p>
<h2 id="vender机制"><a href="#vender机制" class="headerlink" title="vender机制"></a>vender机制</h2><p>Go1.5版本之后开始支持，能够控制Go语言程序编译时依赖包搜索路径的优先级。</p>
<p>例如查找项目的某个依赖包，首先会在项目根目录下的<code>vender</code>文件夹中查找，如果没有找到就会去<code>$GOAPTH/src</code>目录下查找。</p>
<h2 id="godep开发流程"><a href="#godep开发流程" class="headerlink" title="godep开发流程"></a>godep开发流程</h2><ol>
<li>保证程序能够正常编译</li>
<li>执行<code>godep save</code>保存当前项目的所有第三方依赖的版本信息和代码</li>
<li>提交Godeps目录和vender目录到代码库。</li>
<li>如果要更新依赖的版本，可以直接修改<code>Godeps.json</code>文件中的对应项</li>
</ol>
<h2 id="go-module"><a href="#go-module" class="headerlink" title="go module"></a>go module</h2><p><code>go module</code>是Go1.11版本之后官方推出的版本管理工具，并且从Go1.13版本开始，<code>go module</code>将是Go语言默认的依赖管理工具。</p>
<h2 id="GO111MODULE"><a href="#GO111MODULE" class="headerlink" title="GO111MODULE"></a>GO111MODULE</h2><p>要启用<code>go module</code>支持首先要设置环境变量<code>GO111MODULE</code>，通过它可以开启或关闭模块支持，它有三个可选值：<code>off</code>、<code>on</code>、<code>auto</code>，默认值是<code>auto</code>。</p>
<ol>
<li><code>GO111MODULE=off</code>禁用模块支持，编译时会从<code>GOPATH</code>和<code>vendor</code>文件夹中查找包。</li>
<li><code>GO111MODULE=on</code>启用模块支持，编译时会忽略<code>GOPATH</code>和<code>vendor</code>文件夹，只根据 <code>go.mod</code>下载依赖。</li>
<li><code>GO111MODULE=auto</code>，当项目在<code>$GOPATH/src</code>外且项目根目录有<code>go.mod</code>文件时，开启模块支持。</li>
</ol>
<p>简单来说，设置<code>GO111MODULE=on</code>之后就可以使用<code>go module</code>了，以后就没有必要在GOPATH中创建项目了，并且还能够很好的管理项目依赖的第三方包信息。</p>
<p>使用 go module 管理依赖后会在项目根目录下生成两个文件<code>go.mod</code>和<code>go.sum</code>。</p>
<h2 id="GOPROXY"><a href="#GOPROXY" class="headerlink" title="GOPROXY"></a>GOPROXY</h2><p>Go1.11之后设置GOPROXY命令为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copyexport GOPROXY=https://goproxy.cn</span><br></pre></td></tr></table></figure>

<p>Go1.13之后<code>GOPROXY</code>默认值为<code>https://proxy.golang.org</code>，在国内是无法访问的，所以十分建议大家设置GOPROXY，这里我推荐使用<a target="_blank" rel="noopener" href="https://studygolang.com/topics/10014">goproxy.cn</a>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copygo <span class="built_in">env</span> -w GOPROXY=https://goproxy.cn,direct</span><br></pre></td></tr></table></figure>

<h2 id="go-mod命令"><a href="#go-mod命令" class="headerlink" title="go mod命令"></a>go mod命令</h2><p>常用的<code>go mod</code>命令如下：</p>
<p>Copy</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">go</span> mod download    下载依赖的module到本地cache（默认为$GOPATH/pkg/mod目录） go mod edit        编辑go.mod文件 go mod graph       打印模块依赖图 go mod init        初始化当前文件夹, 创建go.mod文件 go mod tidy        增加缺少的module，删除无用的module go mod vendor      将依赖复制到vendor下 go mod verify      校验依赖 go mod why         解释为什么需要依赖 ``` # go.mod go.mod文件记录了项目所有的依赖信息，其结构大致如下： Copymodule github.com/Q1mi/studygo/blogger go <span class="number">1</span>.<span class="number">12</span> require ( 	github.com/DeanThompson/ginpprof v0.<span class="number">0</span>.<span class="number">0</span>-<span class="number">20190408063150</span>-<span class="number">3</span>be636683586 	github.com/gin-gonic/gin v1.<span class="number">4</span>.<span class="number">0</span> 	github.com/go-sql-driver/mysql v1.<span class="number">4</span>.<span class="number">1</span> 	github.com/jmoiron/sqlx v1.<span class="number">2</span>.<span class="number">0</span> 	github.com/satori/go.uuid v1.<span class="number">2</span>.<span class="number">0</span> 	google.golang.org/appengine v1.<span class="number">6</span>.<span class="number">1</span> // indirect ) ``` 其中，  module用来定义包名 require用来定义依赖包及版本 indirect表示间接引用  # 依赖的版本 go mod支持语义化版本号，比如go get foo@v1.<span class="number">2</span>.<span class="number">3</span>，也可以跟git的分支或tag，比如go get foo@master，当然也可以跟git提交哈希，比如go get foo@e3702bed2。关于依赖的版本支持以下几种格式： ```go gopkg.in/tomb.v1 v1.<span class="number">0</span>.<span class="number">0</span>-<span class="number">20141024135613</span>-dd632973f1e7 gopkg.in/vmihailenco/msgpack.v2 v2.<span class="number">9</span>.<span class="number">1</span> gopkg.in/yaml.v2 &lt;=v2.<span class="number">2</span>.<span class="number">1</span> github.com/tatsushid/go-fastping v0.<span class="number">0</span>.<span class="number">0</span>-<span class="number">20160109021039</span>-d7bb493dee3e latest ``` # replace 在国内访问golang.org/x的各个包都需要FQ，你可以在go.mod中使用replace替换成github上对应的库。 ```go replace ( golang.org/x/crypto v0.<span class="number">0</span>.<span class="number">0</span>-<span class="number">20180820150726</span>-<span class="number">614</span>d502a4dac =&gt; github.com/golang/crypto v0.<span class="number">0</span>.<span class="number">0</span>-<span class="number">20180820150726</span>-<span class="number">614</span>d502a4dac golang.org/x/net v0.<span class="number">0</span>.<span class="number">0</span>-<span class="number">20180821023952</span>-<span class="number">922</span>f4815f713 =&gt; github.com/golang/net v0.<span class="number">0</span>.<span class="number">0</span>-<span class="number">20180826012351</span>-<span class="number">8</span>a410e7b638d golang.org/x/text v0.<span class="number">3</span>.<span class="number">0</span> =&gt; github.com/golang/text v0.<span class="number">3</span>.<span class="number">0</span> ) ``` # go get 在项目中执行go get命令可以下载依赖包，并且还可以指定下载的版本。  运行go get -u将会升级到最新的次要版本或者修订版本(x.y.z, z是修订版本号， y是次要版本号) 运行go get -u=patch将会升级到最新的修订版本 运行go get package@version将会升级到指定的版本号version  如果下载所有依赖可以使用go mod download命令。 # 整理依赖 我们在代码中删除依赖代码后，相关的依赖库并不会在go.mod文件中自动移除。这种情况下我们可以使用go mod tidy命令更新go.mod中的依赖关系。 # go mod edit # 格式化 因为我们可以手动修改go.mod文件，所以有些时候需要格式化该文件。Go提供了一下命令： ```bash go mod edit -fmt ``` # 添加依赖项 ```bash go mod edit -require=golang.org/x/text ``` # 移除依赖项 如果只是想修改go.mod文件中的内容，那么可以运行go mod edit -droprequire=package path，比如要在go.mod中移除golang.org/x/text包，可以使用如下命令： ```bash go mod edit -droprequire=golang.org/x/text ``` 关于go mod edit的更多用法可以通过go help mod edit查看。 # 在项目中使用go module # 既有项目 如果需要对一个已经存在的项目启用go module，可以按照以下步骤操作：  在项目目录下执行go mod init，生成一个go.mod文件。 执行go get，查找并记录当前项目的依赖，同时生成一个go.sum记录每个依赖库的版本和哈希值。  # 新项目 对于一个新创建的项目，我们可以在项目文件夹下按照以下步骤操作：  执行go mod init 项目名命令，在当前项目文件夹下创建一个go.mod文件。 手动编辑go.mod中的require依赖项或执行go get自动发现、维护依赖。 </span><br></pre></td></tr></table></figure>

<h1 id="47-Go-pprof性能调优"><a href="#47-Go-pprof性能调优" class="headerlink" title="47.Go pprof性能调优"></a>47.Go pprof性能调优</h1><p>在计算机性能调试领域里，profiling 是指对应用程序的画像，画像就是应用程序使用 CPU 和内存的情况。 Go语言是一个对性能特别看重的语言，因此语言中自带了 profiling 的库，这篇文章就要讲解怎么在 golang 中做 profiling。</p>
<h2 id="Go性能优化"><a href="#Go性能优化" class="headerlink" title="Go性能优化"></a>Go性能优化</h2><p>Go语言项目中的性能优化主要有以下几个方面：</p>
<ul>
<li>CPU profile：报告程序的 CPU 使用情况，按照一定频率去采集应用程序在 CPU 和寄存器上面的数据</li>
<li>Memory Profile（Heap Profile）：报告程序的内存使用情况</li>
<li>Block Profiling：报告 goroutines 不在运行状态的情况，可以用来分析和查找死锁等性能瓶颈</li>
<li>Goroutine Profiling：报告 goroutines 的使用情况，有哪些 goroutine，它们的调用关系是怎样的</li>
</ul>
<h2 id="采集性能数据"><a href="#采集性能数据" class="headerlink" title="采集性能数据"></a>采集性能数据</h2><p>Go语言内置了获取程序的运行数据的工具，包括以下两个标准库：</p>
<ul>
<li><code>runtime/pprof</code>：采集工具型应用运行数据进行分析</li>
<li><code>net/http/pprof</code>：采集服务型应用运行时数据进行分析</li>
</ul>
<p>pprof开启后，每隔一段时间（10ms）就会收集下当前的堆栈信息，获取格格函数占用的CPU以及内存资源；最后通过对这些采样数据进行分析，形成一个性能分析报告。</p>
<p>注意，我们只应该在性能测试的时候才在代码中引入pprof。</p>
<h2 id="工具型应用"><a href="#工具型应用" class="headerlink" title="工具型应用"></a>工具型应用</h2><p>如果你的应用程序是运行一段时间就结束退出类型。那么最好的办法是在应用退出的时候把 profiling 的报告保存到文件中，进行分析。对于这种情况，可以使用<code>runtime/pprof</code>库。 首先在代码中导入<code>runtime/pprof</code>工具：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copyimport &amp;quot;runtime/pprof&amp;quot;</span><br></pre></td></tr></table></figure>

<h2 id="CPU性能分析"><a href="#CPU性能分析" class="headerlink" title="CPU性能分析"></a>CPU性能分析</h2><p>开启CPU性能分析：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copypprof.StartCPUProfile(w io.Writer)</span><br></pre></td></tr></table></figure>

<p>停止CPU性能分析：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copypprof.StopCPUProfile()</span><br></pre></td></tr></table></figure>

<p>应用执行结束后，就会生成一个文件，保存了我们的 CPU profiling 数据。得到采样数据之后，使用<code>go tool pprof</code>工具进行CPU性能分析。</p>
<h2 id="内存性能优化"><a href="#内存性能优化" class="headerlink" title="内存性能优化"></a>内存性能优化</h2><p>记录程序的堆栈信息</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copypprof.WriteHeapProfile(w io.Writer)</span><br></pre></td></tr></table></figure>

<p>得到采样数据之后，使用<code>go tool pprof</code>工具进行内存性能分析。</p>
<p><code>go tool pprof</code>默认是使用<code>-inuse_space</code>进行统计，还可以使用<code>-inuse-objects</code>查看分配对象的数量。</p>
<h2 id="服务型应用"><a href="#服务型应用" class="headerlink" title="服务型应用"></a>服务型应用</h2><p>如果你的应用程序是一直运行的，比如 web 应用，那么可以使用<code>net/http/pprof</code>库，它能够在提供 HTTP 服务进行分析。</p>
<p>如果使用了默认的<code>http.DefaultServeMux</code>（通常是代码直接使用 http.ListenAndServe(“0.0.0.0:8000”, nil)），只需要在你的web server端代码中按如下方式导入<code>net/http/pprof</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copyimport _ &amp;quot;net/http/pprof&amp;quot;</span><br></pre></td></tr></table></figure>

<p>如果你使用自定义的 Mux，则需要手动注册一些路由规则：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Copyr.HandleFunc(&amp;quot;/debug/pprof/&amp;quot;, pprof.Index)</span><br><span class="line">r.HandleFunc(&amp;quot;/debug/pprof/cmdline&amp;quot;, pprof.Cmdline)</span><br><span class="line">r.HandleFunc(&amp;quot;/debug/pprof/profile&amp;quot;, pprof.Profile)</span><br><span class="line">r.HandleFunc(&amp;quot;/debug/pprof/symbol&amp;quot;, pprof.Symbol)</span><br><span class="line">r.HandleFunc(&amp;quot;/debug/pprof/trace&amp;quot;, pprof.Trace)</span><br></pre></td></tr></table></figure>

<p>如果你使用的是gin框架，那么推荐使用<code>&quot;github.com/DeanThompson/ginpprof&quot;</code>。</p>
<p>不管哪种方式，你的 HTTP 服务都会多出<code>/debug/pprof</code> endpoint，访问它会得到类似下面的内容：<a target="_blank" rel="noopener" href="http://www.chenyoude.com/go/pprof2.png"><img src="http://www.chenyoude.com/go/pprof2.png" alt="pprof2.png"></a>这个路径下还有几个子页面：</p>
<ul>
<li>/debug/pprof/profile：访问这个链接会自动进行 CPU profiling，持续 30s，并生成一个文件供下载</li>
<li>/debug/pprof/heap： Memory Profiling 的路径，访问这个链接会得到一个内存 Profiling 结果的文件</li>
<li>/debug/pprof/block：block Profiling 的路径</li>
<li>/debug/pprof/goroutines：运行的 goroutines 列表，以及调用关系</li>
</ul>
<h2 id="go-tool-pprof命令"><a href="#go-tool-pprof命令" class="headerlink" title="go tool pprof命令"></a>go tool pprof命令</h2><p>不管是工具型应用还是服务型应用，我们使用相应的pprof库获取数据之后，下一步的都要对这些数据进行分析，我们可以使用<code>go tool pprof</code>命令行工具。</p>
<p><code>go tool pprof</code>最简单的使用方式为:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copygo tool pprof [binary] [<span class="built_in">source</span>]</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li>binary 是应用的二进制文件，用来解析各种符号；</li>
<li>source 表示 profile 数据的来源，可以是本地的文件，也可以是 http 地址。</li>
</ul>
<p><strong>注意事项：</strong> 获取的 Profiling 数据是动态的，要想获得有效的数据，请保证应用处于较大的负载（比如正在生成中运行的服务，或者通过其他工具模拟访问压力）。否则如果应用处于空闲状态，得到的结果可能没有任何意义。</p>
<h2 id="具体示例"><a href="#具体示例" class="headerlink" title="具体示例"></a>具体示例</h2><p>首先我们来写一段有问题的代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">Copy<span class="comment">// runtime_pprof/main.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	&amp;quot;flag&amp;quot;</span><br><span class="line">	&amp;quot;fmt&amp;quot;</span><br><span class="line">	&amp;quot;os&amp;quot;</span><br><span class="line">	&amp;quot;runtime/pprof&amp;quot;</span><br><span class="line">	&amp;quot;time&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一段有问题的代码</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">logicCode</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> c <span class="keyword">chan</span> <span class="type">int</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> v := &amp;lt;-c:</span><br><span class="line">			fmt.Printf(&amp;quot;recv from <span class="keyword">chan</span>, value:%v\n&amp;quot;, v)</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> isCPUPprof <span class="type">bool</span></span><br><span class="line">	<span class="keyword">var</span> isMemPprof <span class="type">bool</span></span><br><span class="line"></span><br><span class="line">	flag.BoolVar(&amp;amp;isCPUPprof, &amp;quot;cpu&amp;quot;, <span class="literal">false</span>, &amp;quot;turn cpu pprof on&amp;quot;)</span><br><span class="line">	flag.BoolVar(&amp;amp;isMemPprof, &amp;quot;mem&amp;quot;, <span class="literal">false</span>, &amp;quot;turn mem pprof on&amp;quot;)</span><br><span class="line">	flag.Parse()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> isCPUPprof &#123;</span><br><span class="line">		file, err := os.Create(&amp;quot;./cpu.pprof&amp;quot;)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(&amp;quot;create cpu pprof failed, err:%v\n&amp;quot;, err)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		pprof.StartCPUProfile(file)</span><br><span class="line">		<span class="keyword">defer</span> pprof.StopCPUProfile()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &amp;lt; <span class="number">8</span>; i++ &#123;</span><br><span class="line">		<span class="keyword">go</span> logicCode()</span><br><span class="line">	&#125;</span><br><span class="line">	time.Sleep(<span class="number">20</span> * time.Second)</span><br><span class="line">	<span class="keyword">if</span> isMemPprof &#123;</span><br><span class="line">		file, err := os.Create(&amp;quot;./mem.pprof&amp;quot;)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(&amp;quot;create mem pprof failed, err:%v\n&amp;quot;, err)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		pprof.WriteHeapProfile(file)</span><br><span class="line">		file.Close()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过flag我们可以在命令行控制是否开启CPU和Mem的性能分析。 将上面的代码保存并编译成<code>runtime_pprof</code>可执行文件，执行时加上<code>-cpu</code>命令行参数如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copy./runtime_pprof -cpu</span><br></pre></td></tr></table></figure>

<p>等待30秒后会在当前目录下生成一个<code>cpu.pprof</code>文件。</p>
<h2 id="命令行交互界面"><a href="#命令行交互界面" class="headerlink" title="命令行交互界面"></a>命令行交互界面</h2><p>我们使用go工具链里的<code>pprof</code>来分析一下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copygo tool pprof cpu.pprof</span><br></pre></td></tr></table></figure>

<p>执行上面的代码会进入交互界面如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Copyruntime_pprof $ go tool pprof cpu.pprof</span><br><span class="line">Type: cpu</span><br><span class="line">Time: Jun 28, 2019 at 11:28am (CST)</span><br><span class="line">Duration: 20.13s, Total samples = 1.91mins (568.60%)</span><br><span class="line">Entering interactive mode (<span class="built_in">type</span> &amp;quot;<span class="built_in">help</span>&amp;quot; <span class="keyword">for</span> commands, &amp;quot;o&amp;quot; <span class="keyword">for</span> options)</span><br><span class="line">(pprof)  </span><br></pre></td></tr></table></figure>

<p>我们可以在交互界面输入<code>top3</code>来查看程序中占用CPU前3位的函数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Copy(pprof) top3</span><br><span class="line">Showing nodes accounting <span class="keyword">for</span> 100.37s, 87.68% of 114.47s total</span><br><span class="line">Dropped 17 nodes (cum &amp;lt;= 0.57s)</span><br><span class="line">Showing top 3 nodes out of 4</span><br><span class="line">      flat  flat%   <span class="built_in">sum</span>%        cum   cum%</span><br><span class="line">    42.52s 37.15% 37.15%     91.73s 80.13%  runtime.selectnbrecv</span><br><span class="line">    35.21s 30.76% 67.90%     39.49s 34.50%  runtime.chanrecv</span><br><span class="line">    22.64s 19.78% 87.68%    114.37s 99.91%  main.logicCode</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li>flat：当前函数占用CPU的耗时</li>
<li>flat：:当前函数占用CPU的耗时百分比</li>
<li>sun%：函数占用CPU的耗时累计百分比</li>
<li>cum：当前函数加上调用当前函数的函数占用CPU的总耗时</li>
<li>cum%：当前函数加上调用当前函数的函数占用CPU的总耗时百分比</li>
<li>最后一列：函数名称</li>
</ul>
<p>在大多数的情况下，我们可以通过分析这五列得出一个应用程序的运行情况，并对程序进行优化。</p>
<p>我们还可以使用<code>list 函数名</code>命令查看具体的函数分析，例如执行<code>list logicCode</code>查看我们编写的函数的详细分析。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Copy(pprof) list logicCode</span><br><span class="line">Total: 1.91mins</span><br><span class="line">ROUTINE ================ main.logicCode <span class="keyword">in</span> .../runtime_pprof/main.go</span><br><span class="line">    22.64s   1.91mins (flat, cum) 99.91% of Total</span><br><span class="line">         .          .     12:func <span class="function"><span class="title">logicCode</span></span>() &#123;</span><br><span class="line">         .          .     13:   var c chan int</span><br><span class="line">         .          .     14:   <span class="keyword">for</span> &#123;</span><br><span class="line">         .          .     15:           select &#123;</span><br><span class="line">         .          .     16:           <span class="keyword">case</span> v := &amp;lt;-c:</span><br><span class="line">    22.64s   1.91mins     17:                   fmt.Printf(&amp;quot;recv from chan, value:%v\n&amp;quot;, v)</span><br><span class="line">         .          .     18:           default:</span><br><span class="line">         .          .     19:</span><br><span class="line">         .          .     20:           &#125;</span><br><span class="line">         .          .     21:   &#125;</span><br><span class="line">         .          .     22:&#125;</span><br></pre></td></tr></table></figure>

<p>通过分析发现大部分CPU资源被17行占用，我们分析出select语句中的default没有内容会导致上面的<code>case v:=&lt;-c:</code>一直执行。我们在default分支添加一行<code>time.Sleep(time.Second)</code>即可。</p>
<h2 id="图形化"><a href="#图形化" class="headerlink" title="图形化"></a>图形化</h2><p>或者可以直接输入web，通过svg图的方式查看程序中详细的CPU占用情况。 想要查看图形化的界面首先需要安装<a target="_blank" rel="noopener" href="https://graphviz.gitlab.io/">graphviz</a>图形化工具。</p>
<p>Mac：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copybrew install graphviz</span><br></pre></td></tr></table></figure>

<p>Windows: 下载<a target="_blank" rel="noopener" href="https://graphviz.gitlab.io/_pages/Download/Download_windows.html">graphviz</a> 将<code>graphviz</code>安装目录下的bin文件夹添加到Path环境变量中。 在终端输入<code>dot -version</code>查看是否安装成功。</p>
<p><a target="_blank" rel="noopener" href="http://www.chenyoude.com/go/cpu_pprof.png"><img src="http://www.chenyoude.com/go/cpu_pprof.png" alt="cpu_pprof.png"></a>关于图形的说明： 每个框代表一个函数，理论上框的越大表示占用的CPU资源越多。 方框之间的线条代表函数之间的调用关系。 线条上的数字表示函数调用的次数。 方框中的第一行数字表示当前函数占用CPU的百分比，第二行数字表示当前函数累计占用CPU的百分比。</p>
<h2 id="go-torch和火焰图"><a href="#go-torch和火焰图" class="headerlink" title="go-torch和火焰图"></a>go-torch和火焰图</h2><p>火焰图（Flame Graph）是 Bredan Gregg 创建的一种性能分析图表，因为它的样子近似 🔥而得名。上面的 profiling 结果也转换成火焰图，如果对火焰图比较了解可以手动来操作，不过这里我们要介绍一个工具：<code>go-torch</code>。这是 uber 开源的一个工具，可以直接读取 golang profiling 数据，并生成一个火焰图的 svg 文件。</p>
<h2 id="安装go-touch"><a href="#安装go-touch" class="headerlink" title="安装go-touch"></a>安装go-touch</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copy   go get -v github.com/uber/go-torch</span><br></pre></td></tr></table></figure>

<p>火焰图 svg 文件可以通过浏览器打开，它对于调用图的最优点是它是动态的：可以通过点击每个方块来 zoom in 分析它上面的内容。</p>
<p>火焰图的调用顺序从下到上，每个方块代表一个函数，它上面一层表示这个函数会调用哪些函数，方块的大小代表了占用 CPU 使用的长短。火焰图的配色并没有特殊的意义，默认的红、黄配色是为了更像火焰而已。</p>
<p>go-torch 工具的使用非常简单，没有任何参数的话，它会尝试从<code>http://localhost:8080/debug/pprof/profile</code>获取 profiling 数据。它有三个常用的参数可以调整：</p>
<ul>
<li>-u –url：要访问的 URL，这里只是主机和端口部分</li>
<li>-s –suffix：pprof profile 的路径，默认为 /debug/pprof/profile</li>
<li>–seconds：要执行 profiling 的时间长度，默认为 30s</li>
</ul>
<h2 id="安装-FlameGraph"><a href="#安装-FlameGraph" class="headerlink" title="安装 FlameGraph"></a>安装 FlameGraph</h2><p>要生成火焰图，需要事先安装 FlameGraph工具，这个工具的安装很简单（需要perl环境支持），只要把对应的可执行文件加入到环境变量中即可。</p>
<ol>
<li>下载安装perl：<a target="_blank" rel="noopener" href="https://www.perl.org/get.html">https://www.perl.org/get.html</a></li>
<li>下载FlameGraph：<code>git clone https://github.com/brendangregg/FlameGraph.git</code></li>
<li>将<code>FlameGraph</code>目录加入到操作系统的环境变量中。</li>
<li>Windows平台的同学，需要把<code>go-torch/render/flamegraph.go</code>文件中的<code>GenerateFlameGraph</code>按如下方式修改，然后在<code>go-torch</code>目录下执行<code>go install</code>即可。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Copy<span class="comment">// GenerateFlameGraph runs the flamegraph script to generate a flame graph SVG. func GenerateFlameGraph(graphInput []byte, args ...string) ([]byte, error) &#123;</span></span><br><span class="line">flameGraph := findInPath(flameGraphScripts)</span><br><span class="line"><span class="keyword">if</span> flameGraph == &amp;quot;&amp;quot; &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, errNoPerlScript</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> runtime.GOOS == &amp;quot;windows&amp;quot; &#123;</span><br><span class="line">	<span class="keyword">return</span> runScript(&amp;quot;perl&amp;quot;, <span class="built_in">append</span>([]<span class="type">string</span>&#123;flameGraph&#125;, args...), graphInput)</span><br><span class="line">&#125;</span><br><span class="line">  <span class="keyword">return</span> runScript(flameGraph, args, graphInput)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="压测工具wrk"><a href="#压测工具wrk" class="headerlink" title="压测工具wrk"></a>压测工具wrk</h2><p>推荐使用<a target="_blank" rel="noopener" href="https://github.com/wg/wrk">https://github.com/wg/wrk</a> 或 <a target="_blank" rel="noopener" href="https://github.com/adjust/go-wrk">https://github.com/adjust/go-wrk</a></p>
<h2 id="使用go-torch"><a href="#使用go-torch" class="headerlink" title="使用go-torch"></a>使用go-torch</h2><p>使用wrk进行压测:<code>go-wrk -n 50000 http://127.0.0.1:8080/book/list</code> 在上面压测进行的同时，打开另一个终端执行<code>go-torch -u http://127.0.0.1:8080 -t 30</code>，30秒之后终端会初夏如下提示：<code>Writing svg to torch.svg</code></p>
<p>然后我们使用浏览器打开<code>torch.svg</code>就能看到如下火焰图了。<a target="_blank" rel="noopener" href="http://www.chenyoude.com/go/pprof3.png"><img src="http://www.chenyoude.com/go/pprof3.png" alt="pprof3.png"></a>火焰图的y轴表示cpu调用方法的先后，x轴表示在每个采样调用时间内，方法所占的时间百分比，越宽代表占据cpu时间越多。通过火焰图我们就可以更清楚的找出耗时长的函数调用，然后不断的修正代码，重新采样，不断优化。</p>
<h2 id="pprof与性能测试结合"><a href="#pprof与性能测试结合" class="headerlink" title="pprof与性能测试结合"></a>pprof与性能测试结合</h2><p><code>go test</code>命令有两个参数和 pprof 相关，它们分别指定生成的 CPU 和 Memory profiling 保存的文件：</p>
<ul>
<li>-cpuprofile：cpu profiling 数据要保存的文件地址</li>
<li>-memprofile：memory profiling 数据要报文的文件地址</li>
</ul>
<p>我们还可以选择将pprof与性能测试相结合，比如：</p>
<p>比如下面执行测试的同时，也会执行 CPU profiling，并把结果保存在 cpu.prof 文件中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copygo <span class="built_in">test</span> -bench . -cpuprofile=cpu.prof</span><br></pre></td></tr></table></figure>

<p>比如下面执行测试的同时，也会执行 Mem profiling，并把结果保存在 cpu.prof 文件中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copygo <span class="built_in">test</span> -bench . -memprofile=./mem.prof</span><br></pre></td></tr></table></figure>

<p>需要注意的是，Profiling 一般和性能测试一起使用，这个原因在前文也提到过，只有应用在负载高的情况下 Profiling 才有意义。</p>
<h2 id="练习题"><a href="#练习题" class="headerlink" title="练习题"></a>练习题</h2><ol>
<li>使用gin框架编写一个接口，使用<code>go-wrk</code>进行压测，使用性能调优工具采集数据绘制出调用图和火焰图。</li>
</ol>
<h1 id="48-Go操作NSQ"><a href="#48-Go操作NSQ" class="headerlink" title="48.Go操作NSQ"></a>48.Go操作NSQ</h1><p>NSQ是目前比较流行的一个分布式的消息队列，本文主要介绍了NSQ及Go语言如何操作NSQ。</p>
<h2 id="NSQ"><a href="#NSQ" class="headerlink" title="NSQ"></a>NSQ</h2><h2 id="NSQ介绍"><a href="#NSQ介绍" class="headerlink" title="NSQ介绍"></a>NSQ介绍</h2><p><a target="_blank" rel="noopener" href="https://nsq.io/">NSQ</a>是Go语言编写的一个开源的实时分布式内存消息队列，其性能十分优异。 NSQ的优势有以下优势：</p>
<ol>
<li>NSQ提倡分布式和分散的拓扑，没有单点故障，支持容错和高可用性，并提供可靠的消息交付保证</li>
<li>NSQ支持横向扩展，没有任何集中式代理。</li>
<li>NSQ易于配置和部署，并且内置了管理界面。</li>
</ol>
<h2 id="NSQ的应用场景"><a href="#NSQ的应用场景" class="headerlink" title="NSQ的应用场景"></a>NSQ的应用场景</h2><p>通常来说，消息队列都适用以下场景。</p>
<h2 id="异步处理"><a href="#异步处理" class="headerlink" title="异步处理"></a>异步处理</h2><p>参照下图利用消息队列把业务流程中的非关键流程异步化，从而显著降低业务请求的响应时间。<a target="_blank" rel="noopener" href="http://www.chenyoude.com/go/nsq1.png"><img src="http://www.chenyoude.com/go/nsq1.png" alt="nsq1.png"></a></p>
<h2 id="应用解耦"><a href="#应用解耦" class="headerlink" title="应用解耦"></a>应用解耦</h2><p>通过使用消息队列将不同的业务逻辑解耦，降低系统间的耦合，提高系统的健壮性。后续有其他业务要使用订单数据可直接订阅消息队列，提高系统的灵活性。<a target="_blank" rel="noopener" href="http://www.chenyoude.com/go/nsq2.png"><img src="http://www.chenyoude.com/go/nsq2.png" alt="nsq2.png"></a></p>
<h2 id="流量削峰"><a href="#流量削峰" class="headerlink" title="流量削峰"></a>流量削峰</h2><p>类似秒杀（大秒）等场景下，某一时间可能会产生大量的请求，使用消息队列能够为后端处理请求提供一定的缓冲区，保证后端服务的稳定性。<a target="_blank" rel="noopener" href="http://www.chenyoude.com/go/nsq3.png"><img src="http://www.chenyoude.com/go/nsq3.png" alt="nsq3.png"></a></p>
<h2 id="安装-8"><a href="#安装-8" class="headerlink" title="安装"></a>安装</h2><p><a target="_blank" rel="noopener" href="https://nsq.io/deployment/installing.html">官方下载页面</a>根据自己的平台下载并解压即可。</p>
<h2 id="NSQ组件"><a href="#NSQ组件" class="headerlink" title="NSQ组件"></a>NSQ组件</h2><h2 id="nsqd"><a href="#nsqd" class="headerlink" title="nsqd"></a>nsqd</h2><p>nsqd是一个守护进程，它接收、排队并向客户端发送消息。</p>
<p>启动<code>nsqd</code>，指定<code>-broadcast-address=127.0.0.1</code>来配置广播地址</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copy./nsqd -broadcast-address=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>

<p>如果是在搭配<code>nsqlookupd</code>使用的模式下需要还指定<code>nsqlookupd</code>地址:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copy./nsqd -broadcast-address=127.0.0.1 -lookupd-tcp-address=127.0.0.1:4160</span><br></pre></td></tr></table></figure>

<p>如果是部署了多个<code>nsqlookupd</code>节点的集群，那还可以指定多个<code>-lookupd-tcp-address</code>。</p>
<p><code>nsqdq</code>相关配置项如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">Copy-auth-http-address value</span><br><span class="line">    &amp;lt;addr&amp;gt;:&amp;lt;port&amp;gt; to query auth server (may be given multiple times)</span><br><span class="line">-broadcast-address <span class="type">string</span></span><br><span class="line">    address that will be registered with lookupd (defaults to the OS hostname) (<span class="keyword">default</span> &amp;quot;PROSNAKES.local&amp;quot;)</span><br><span class="line">-config <span class="type">string</span></span><br><span class="line">    path to config file</span><br><span class="line">-data-path <span class="type">string</span></span><br><span class="line">    path to store disk-backed messages</span><br><span class="line">-deflate</span><br><span class="line">    enable deflate feature negotiation (client compression) (<span class="keyword">default</span> <span class="literal">true</span>)</span><br><span class="line">-e2e-processing-latency-percentile value</span><br><span class="line">    message processing time percentiles (as float (<span class="number">0</span>, <span class="number">1.0</span>]) to track (can be specified multiple times or comma separated <span class="string">&#x27;1.0,0.99,0.95&#x27;</span>, <span class="keyword">default</span> none)</span><br><span class="line">-e2e-processing-latency-window-time duration</span><br><span class="line">    calculate end to end latency quantiles <span class="keyword">for</span> this duration of time (ie: <span class="number">60</span>s would only show quantile calculations from the past <span class="number">60</span> seconds) (<span class="keyword">default</span> <span class="number">10</span>m0s)</span><br><span class="line">-http-address <span class="type">string</span></span><br><span class="line">    &amp;lt;addr&amp;gt;:&amp;lt;port&amp;gt; to listen on <span class="keyword">for</span> HTTP clients (<span class="keyword">default</span> &amp;quot;<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">4151</span>&amp;quot;)</span><br><span class="line">-http-client-connect-timeout duration</span><br><span class="line">    timeout <span class="keyword">for</span> HTTP connect (<span class="keyword">default</span> <span class="number">2</span>s)</span><br><span class="line">-http-client-request-timeout duration</span><br><span class="line">    timeout <span class="keyword">for</span> HTTP request (<span class="keyword">default</span> <span class="number">5</span>s)</span><br><span class="line">-https-address <span class="type">string</span></span><br><span class="line">    &amp;lt;addr&amp;gt;:&amp;lt;port&amp;gt; to listen on <span class="keyword">for</span> HTTPS clients (<span class="keyword">default</span> &amp;quot;<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">4152</span>&amp;quot;)</span><br><span class="line">-log-prefix <span class="type">string</span></span><br><span class="line">    log message prefix (<span class="keyword">default</span> &amp;quot;[nsqd] &amp;quot;)</span><br><span class="line">-lookupd-tcp-address value</span><br><span class="line">    lookupd TCP address (may be given multiple times)</span><br><span class="line">-max-body-size <span class="type">int</span></span><br><span class="line">    maximum size of a single command body (<span class="keyword">default</span> <span class="number">5242880</span>)</span><br><span class="line">-max-bytes-per-file <span class="type">int</span></span><br><span class="line">    number of bytes per diskqueue file before rolling (<span class="keyword">default</span> <span class="number">104857600</span>)</span><br><span class="line">-max-deflate-level <span class="type">int</span></span><br><span class="line">    max deflate compression level a client can negotiate (&amp;gt; values == &amp;gt; nsqd CPU usage) (<span class="keyword">default</span> <span class="number">6</span>)</span><br><span class="line">-max-heartbeat-interval duration</span><br><span class="line">    maximum client configurable duration of time between client heartbeats (<span class="keyword">default</span> <span class="number">1</span>m0s)</span><br><span class="line">-max-msg-size <span class="type">int</span></span><br><span class="line">    maximum size of a single message in bytes (<span class="keyword">default</span> <span class="number">1048576</span>)</span><br><span class="line">-max-msg-timeout duration</span><br><span class="line">    maximum duration before a message will timeout (<span class="keyword">default</span> <span class="number">15</span>m0s)</span><br><span class="line">-max-output-buffer-size <span class="type">int</span></span><br><span class="line">    maximum client configurable size (in bytes) <span class="keyword">for</span> a client output buffer (<span class="keyword">default</span> <span class="number">65536</span>)</span><br><span class="line">-max-output-buffer-timeout duration</span><br><span class="line">    maximum client configurable duration of time between flushing to a client (<span class="keyword">default</span> <span class="number">1</span>s)</span><br><span class="line">-max-rdy-count <span class="type">int</span></span><br><span class="line">    maximum RDY count <span class="keyword">for</span> a client (<span class="keyword">default</span> <span class="number">2500</span>)</span><br><span class="line">-max-req-timeout duration</span><br><span class="line">    maximum requeuing timeout <span class="keyword">for</span> a message (<span class="keyword">default</span> <span class="number">1</span>h0m0s)</span><br><span class="line">-mem-queue-size <span class="type">int</span></span><br><span class="line">    number of messages to keep in memory (per topic/channel) (<span class="keyword">default</span> <span class="number">10000</span>)</span><br><span class="line">-msg-timeout <span class="type">string</span></span><br><span class="line">    duration to wait before auto-requeing a message (<span class="keyword">default</span> &amp;quot;<span class="number">1</span>m0s&amp;quot;)</span><br><span class="line">-node-id <span class="type">int</span></span><br><span class="line">    unique part <span class="keyword">for</span> message IDs, (<span class="type">int</span>) in <span class="keyword">range</span> [<span class="number">0</span>,<span class="number">1024</span>) (<span class="keyword">default</span> is hash of hostname) (<span class="keyword">default</span> <span class="number">616</span>)</span><br><span class="line">-snappy</span><br><span class="line">    enable snappy feature negotiation (client compression) (<span class="keyword">default</span> <span class="literal">true</span>)</span><br><span class="line">-statsd-address <span class="type">string</span></span><br><span class="line">    UDP &amp;lt;addr&amp;gt;:&amp;lt;port&amp;gt; of a statsd daemon <span class="keyword">for</span> pushing stats</span><br><span class="line">-statsd-interval <span class="type">string</span></span><br><span class="line">    duration between pushing to statsd (<span class="keyword">default</span> &amp;quot;<span class="number">1</span>m0s&amp;quot;)</span><br><span class="line">-statsd-mem-stats</span><br><span class="line">    toggle sending memory and GC stats to statsd (<span class="keyword">default</span> <span class="literal">true</span>)</span><br><span class="line">-statsd-prefix <span class="type">string</span></span><br><span class="line">    prefix used <span class="keyword">for</span> keys sent to statsd (%s <span class="keyword">for</span> host replacement) (<span class="keyword">default</span> &amp;quot;nsq.%s&amp;quot;)</span><br><span class="line">-sync-every <span class="type">int</span></span><br><span class="line">    number of messages per diskqueue fsync (<span class="keyword">default</span> <span class="number">2500</span>)</span><br><span class="line">-sync-timeout duration</span><br><span class="line">    duration of time per diskqueue fsync (<span class="keyword">default</span> <span class="number">2</span>s)</span><br><span class="line">-tcp-address <span class="type">string</span></span><br><span class="line">    &amp;lt;addr&amp;gt;:&amp;lt;port&amp;gt; to listen on <span class="keyword">for</span> TCP clients (<span class="keyword">default</span> &amp;quot;<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">4150</span>&amp;quot;)</span><br><span class="line">-tls-cert <span class="type">string</span></span><br><span class="line">    path to certificate file</span><br><span class="line">-tls-client-auth-policy <span class="type">string</span></span><br><span class="line">    client certificate auth policy (<span class="string">&#x27;require&#x27;</span> or <span class="string">&#x27;require-verify&#x27;</span>)</span><br><span class="line">-tls-key <span class="type">string</span></span><br><span class="line">    path to key file</span><br><span class="line">-tls-min-version value</span><br><span class="line">    minimum SSL/TLS version acceptable (<span class="string">&#x27;ssl3.0&#x27;</span>, <span class="string">&#x27;tls1.0&#x27;</span>, <span class="string">&#x27;tls1.1&#x27;</span>, or <span class="string">&#x27;tls1.2&#x27;</span>) (<span class="keyword">default</span> <span class="number">769</span>)</span><br><span class="line">-tls-required</span><br><span class="line">    require TLS <span class="keyword">for</span> client connections (<span class="literal">true</span>, <span class="literal">false</span>, tcp-https)</span><br><span class="line">-tls-root-ca-file <span class="type">string</span></span><br><span class="line">    path to certificate authority file</span><br><span class="line">-verbose</span><br><span class="line">    enable verbose logging</span><br><span class="line">-version</span><br><span class="line">    <span class="built_in">print</span> version <span class="type">string</span></span><br><span class="line">-worker-id</span><br><span class="line">    do NOT use this, use --node-id</span><br></pre></td></tr></table></figure>

<h2 id="nsqlookupd"><a href="#nsqlookupd" class="headerlink" title="nsqlookupd"></a>nsqlookupd</h2><p>nsqlookupd是维护所有nsqd状态、提供服务发现的守护进程。它能为消费者查找特定<code>topic</code>下的nsqd提供了运行时的自动发现服务。 它不维持持久状态，也不需要与任何其他nsqlookupd实例协调以满足查询。因此根据你系统的冗余要求尽可能多地部署<code>nsqlookupd</code>节点。它们小豪的资源很少，可以与其他服务共存。我们的建议是为每个数据中心运行至少3个集群。</p>
<p><code>nsqlookupd</code>相关配置项如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Copy-broadcast-address string</span><br><span class="line">    address of this lookupd node, (default to the OS hostname) (default &amp;quot;PROSNAKES.<span class="built_in">local</span>&amp;quot;)</span><br><span class="line">-config string</span><br><span class="line">    path to config file</span><br><span class="line">-http-address string</span><br><span class="line">    &amp;lt;addr&amp;gt;:&amp;lt;port&amp;gt; to listen on <span class="keyword">for</span> HTTP clients (default &amp;quot;0.0.0.0:4161&amp;quot;)</span><br><span class="line">-inactive-producer-timeout duration</span><br><span class="line">    duration of time a producer will remain <span class="keyword">in</span> the active list since its last ping (default 5m0s)</span><br><span class="line">-log-prefix string</span><br><span class="line">    <span class="built_in">log</span> message prefix (default &amp;quot;[nsqlookupd] &amp;quot;)</span><br><span class="line">-tcp-address string</span><br><span class="line">    &amp;lt;addr&amp;gt;:&amp;lt;port&amp;gt; to listen on <span class="keyword">for</span> TCP clients (default &amp;quot;0.0.0.0:4160&amp;quot;)</span><br><span class="line">-tombstone-lifetime duration</span><br><span class="line">    duration of time a producer will remain tombstoned <span class="keyword">if</span> registration remains (default 45s)</span><br><span class="line">-verbose</span><br><span class="line">    <span class="built_in">enable</span> verbose logging</span><br><span class="line">-version</span><br><span class="line">    <span class="built_in">print</span> version string</span><br></pre></td></tr></table></figure>

<h2 id="nsqadmin"><a href="#nsqadmin" class="headerlink" title="nsqadmin"></a>nsqadmin</h2><p>一个实时监控集群状态、执行各种管理任务的Web管理平台。 启动<code>nsqadmin</code>，指定<code>nsqlookupd</code>地址:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copy./nsqadmin -lookupd-http-address=127.0.0.1:4161</span><br></pre></td></tr></table></figure>

<p>我们可以使用浏览器打开<code>http://127.0.0.1:4171/</code>访问如下管理界面。<a target="_blank" rel="noopener" href="http://www.chenyoude.com/go/nsqadmin0.png"><img src="http://www.chenyoude.com/go/nsqadmin0.png" alt="nsqadmin0.png"></a></p>
<p><code>nsqadmin</code>相关的配置项如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Copy-allow-config-from-cidr <span class="type">string</span></span><br><span class="line">    A CIDR from which to allow HTTP requests to the /config endpoint (<span class="keyword">default</span> &amp;quot;<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/<span class="number">8</span>&amp;quot;)</span><br><span class="line">-config <span class="type">string</span></span><br><span class="line">    path to config file</span><br><span class="line">-graphite-url <span class="type">string</span></span><br><span class="line">    graphite HTTP address</span><br><span class="line">-http-address <span class="type">string</span></span><br><span class="line">    &amp;lt;addr&amp;gt;:&amp;lt;port&amp;gt; to listen on <span class="keyword">for</span> HTTP clients (<span class="keyword">default</span> &amp;quot;<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">4171</span>&amp;quot;)</span><br><span class="line">-http-client-connect-timeout duration</span><br><span class="line">    timeout <span class="keyword">for</span> HTTP connect (<span class="keyword">default</span> <span class="number">2</span>s)</span><br><span class="line">-http-client-request-timeout duration</span><br><span class="line">    timeout <span class="keyword">for</span> HTTP request (<span class="keyword">default</span> <span class="number">5</span>s)</span><br><span class="line">-http-client-tls-cert <span class="type">string</span></span><br><span class="line">    path to certificate file <span class="keyword">for</span> the HTTP client</span><br><span class="line">-http-client-tls-insecure-skip-verify</span><br><span class="line">    configure the HTTP client to skip verification of TLS certificates</span><br><span class="line">-http-client-tls-key <span class="type">string</span></span><br><span class="line">    path to key file <span class="keyword">for</span> the HTTP client</span><br><span class="line">-http-client-tls-root-ca-file <span class="type">string</span></span><br><span class="line">    path to CA file <span class="keyword">for</span> the HTTP client</span><br><span class="line">-log-prefix <span class="type">string</span></span><br><span class="line">    log message prefix (<span class="keyword">default</span> &amp;quot;[nsqadmin] &amp;quot;)</span><br><span class="line">-lookupd-http-address value</span><br><span class="line">    lookupd HTTP address (may be given multiple times)</span><br><span class="line">-notification-http-endpoint <span class="type">string</span></span><br><span class="line">    HTTP endpoint (fully qualified) to which POST notifications of admin actions will be sent</span><br><span class="line">-nsqd-http-address value</span><br><span class="line">    nsqd HTTP address (may be given multiple times)</span><br><span class="line">-proxy-graphite</span><br><span class="line">    proxy HTTP requests to graphite</span><br><span class="line">-statsd-counter-format <span class="type">string</span></span><br><span class="line">    The counter stats key formatting applied by the implementation of statsd. If no formatting is desired, set this to an empty <span class="type">string</span>. (<span class="keyword">default</span> &amp;quot;stats.counters.%s.count&amp;quot;)</span><br><span class="line">-statsd-gauge-format <span class="type">string</span></span><br><span class="line">    The gauge stats key formatting applied by the implementation of statsd. If no formatting is desired, set this to an empty <span class="type">string</span>. (<span class="keyword">default</span> &amp;quot;stats.gauges.%s&amp;quot;)</span><br><span class="line">-statsd-interval duration</span><br><span class="line">    time interval nsqd is configured to push to statsd (must match nsqd) (<span class="keyword">default</span> <span class="number">1</span>m0s)</span><br><span class="line">-statsd-prefix <span class="type">string</span></span><br><span class="line">    prefix used <span class="keyword">for</span> keys sent to statsd (%s <span class="keyword">for</span> host replacement, must match nsqd) (<span class="keyword">default</span> &amp;quot;nsq.%s&amp;quot;)</span><br><span class="line">-version</span><br><span class="line">    <span class="built_in">print</span> version <span class="type">string</span></span><br></pre></td></tr></table></figure>

<h2 id="NSQ架构"><a href="#NSQ架构" class="headerlink" title="NSQ架构"></a>NSQ架构</h2><h2 id="NSQ工作模式"><a href="#NSQ工作模式" class="headerlink" title="NSQ工作模式"></a>NSQ工作模式</h2><p><a target="_blank" rel="noopener" href="http://www.chenyoude.com/go/nsq4.png"><img src="http://www.chenyoude.com/go/nsq4.png" alt="nsq4.png"></a></p>
<h2 id="Topic和Channel"><a href="#Topic和Channel" class="headerlink" title="Topic和Channel"></a>Topic和Channel</h2><p>每个nsqd实例旨在一次处理多个数据流。这些数据流称为<code>“topics”</code>，一个<code>topic</code>具有1个或多个<code>“channels”</code>。每个<code>channel</code>都会收到<code>topic</code>所有消息的副本，实际上下游的服务是通过对应的<code>channel</code>来消费<code>topic</code>消息。</p>
<p><code>topic</code>和<code>channel</code>不是预先配置的。<code>topic</code>在首次使用时创建，方法是将其发布到指定<code>topic</code>，或者订阅指定<code>topic</code>上的<code>channel</code>。<code>channel</code>是通过订阅指定的<code>channel</code>在第一次使用时创建的。</p>
<p><code>topic</code>和<code>channel</code>都相互独立地缓冲数据，防止缓慢的消费者导致其他<code>chennel</code>的积压（同样适用于<code>topic</code>级别）。</p>
<p><code>channel</code>可以并且通常会连接多个客户端。假设所有连接的客户端都处于准备接收消息的状态，则每条消息将被传递到随机客户端。例如：</p>
<p><a target="_blank" rel="noopener" href="http://www.chenyoude.com/go/nsq5.gif"><img src="http://www.chenyoude.com/go/nsq5.gif" alt="nsq5.gif"></a>总而言之，消息是从<code>topic -&gt; channel</code>（每个channel接收该topic的所有消息的副本）多播的，但是从<code>channel -&gt; consumers</code>均匀分布（每个消费者接收该channel的一部分消息）。</p>
<h2 id="NSQ接收和发送消息流程"><a href="#NSQ接收和发送消息流程" class="headerlink" title="NSQ接收和发送消息流程"></a>NSQ接收和发送消息流程</h2><p><a target="_blank" rel="noopener" href="http://www.chenyoude.com/go/nsq6.png"><img src="http://www.chenyoude.com/go/nsq6.png" alt="nsq6.png"></a></p>
<h2 id="NSQ特性"><a href="#NSQ特性" class="headerlink" title="NSQ特性"></a>NSQ特性</h2><ul>
<li>消息默认不持久化，可以配置成持久化模式。nsq采用的方式时内存+硬盘的模式，当内存到达一定程度时就会将数据持久化到硬盘。<ul>
<li>如果将<code>--mem-queue-size</code>设置为0，所有的消息将会存储到磁盘。</li>
<li>服务器重启时也会将当时在内存中的消息持久化。</li>
</ul>
</li>
<li>每条消息至少传递一次。</li>
<li>消息不保证有序。</li>
</ul>
<h2 id="Go操作NSQ"><a href="#Go操作NSQ" class="headerlink" title="Go操作NSQ"></a>Go操作NSQ</h2><p>官方提供了Go语言版的客户端：<a target="_blank" rel="noopener" href="https://github.com/nsqio/go-nsq">go-nsq</a>，更多客户端支持请查看<a target="_blank" rel="noopener" href="https://nsq.io/clients/client_libraries.html">CLIENT LIBRARIES</a>。</p>
<h2 id="安装-9"><a href="#安装-9" class="headerlink" title="安装"></a>安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copygo get -u github.com/nsqio/go-nsq</span><br></pre></td></tr></table></figure>

<h2 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h2><p>一个简单的生产者示例代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">Copy<span class="comment">// nsq_producer/main.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	&amp;quot;bufio&amp;quot;</span><br><span class="line">	&amp;quot;fmt&amp;quot;</span><br><span class="line">	&amp;quot;os&amp;quot;</span><br><span class="line">	&amp;quot;strings&amp;quot;</span><br><span class="line"></span><br><span class="line">	&amp;quot;github.com/nsqio/<span class="keyword">go</span>-nsq&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// NSQ Producer Demo</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> producer *nsq.Producer</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化生产者</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initProducer</span><span class="params">(str <span class="type">string</span>)</span></span> (err <span class="type">error</span>) &#123;</span><br><span class="line">	config := nsq.NewConfig()</span><br><span class="line">	producer, err = nsq.NewProducer(str, config)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(&amp;quot;create producer failed, err:%v\n&amp;quot;, err)</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	nsqAddress := &amp;quot;<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">4150</span>&amp;quot;</span><br><span class="line">	err := initProducer(nsqAddress)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(&amp;quot;init producer failed, err:%v\n&amp;quot;, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	reader := bufio.NewReader(os.Stdin) <span class="comment">// 从标准输入读取</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		data, err := reader.ReadString(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(&amp;quot;read <span class="type">string</span> from stdin failed, err:%v\n&amp;quot;, err)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		data = strings.TrimSpace(data)</span><br><span class="line">		<span class="keyword">if</span> strings.ToUpper(data) == &amp;quot;Q&amp;quot; &#123; <span class="comment">// 输入Q退出</span></span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 向 &#x27;topic_demo&#x27; publish 数据</span></span><br><span class="line">		err = producer.Publish(&amp;quot;topic_demo&amp;quot;, []<span class="type">byte</span>(data))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(&amp;quot;publish msg to nsq failed, err:%v\n&amp;quot;, err)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将上面的代码编译执行，然后在终端输入两条数据<code>123</code>和<code>456</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Copy$ ./nsq_producer </span><br><span class="line">123</span><br><span class="line">2018/10/22 18:41:20 INF    1 (127.0.0.1:4150) connecting to nsqd</span><br><span class="line">456</span><br></pre></td></tr></table></figure>

<p>使用浏览器打开<code>http://127.0.0.1:4171/</code>可以查看到类似下面的页面： 在下面这个页面能看到当前的<code>topic</code>信息：<a target="_blank" rel="noopener" href="http://www.chenyoude.com/go/nsqadmin1.png"><img src="http://www.chenyoude.com/go/nsqadmin1.png" alt="nsqadmin1.png"></a></p>
<p>点击页面上的<code>topic_demo</code>就能进入一个展示更多详细信息的页面，在这个页面上我们可以查看和管理<code>topic</code>，同时能够看到目前在<code>LWZMBP:4151 (127.0.01:4151)</code>这个<code>nsqd</code>上有2条message。又因为没有消费者接入所以暂时没有创建<code>channel</code>。<a target="_blank" rel="noopener" href="http://www.chenyoude.com/go/nsqadmin2.png"><img src="http://www.chenyoude.com/go/nsqadmin2.png" alt="nsqadmin2.png"></a></p>
<p>在<code>/nodes</code>这个页面我们能够很方便的查看当前接入<code>lookupd</code>的<code>nsqd</code>节点。<a target="_blank" rel="noopener" href="http://www.chenyoude.com/go/nsqadmin3.png"><img src="http://www.chenyoude.com/go/nsqadmin3.png" alt="nsqadmin3.png"></a></p>
<p>这个<code>/counter</code>页面显示了处理的消息数量，因为我们没有接入消费者，所以处理的消息数量为0。<a target="_blank" rel="noopener" href="http://www.chenyoude.com/go/nsqadmin4.png"><img src="http://www.chenyoude.com/go/nsqadmin4.png" alt="nsqadmin4.png"></a></p>
<p>在<code>/lookup</code>界面支持创建<code>topic</code>和<code>channel</code>。<a target="_blank" rel="noopener" href="http://www.chenyoude.com/go/nsqadmin5.png"><img src="http://www.chenyoude.com/go/nsqadmin5.png" alt="nsqadmin5.png"></a></p>
<h2 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h2><p>一个简单的消费者示例代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">Copy<span class="comment">// nsq_consumer/main.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	&amp;quot;fmt&amp;quot;</span><br><span class="line">	&amp;quot;os&amp;quot;</span><br><span class="line">	&amp;quot;os/signal&amp;quot;</span><br><span class="line">	&amp;quot;syscall&amp;quot;</span><br><span class="line">	&amp;quot;time&amp;quot;</span><br><span class="line"></span><br><span class="line">	&amp;quot;github.com/nsqio/<span class="keyword">go</span>-nsq&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// NSQ Consumer Demo</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// MyHandler 是一个消费者类型</span></span><br><span class="line"><span class="keyword">type</span> MyHandler <span class="keyword">struct</span> &#123;</span><br><span class="line">	Title <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HandleMessage 是需要实现的处理消息的方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *MyHandler)</span></span> HandleMessage(msg *nsq.Message) (err <span class="type">error</span>) &#123;</span><br><span class="line">	fmt.Printf(&amp;quot;%s recv from %v, msg:%v\n&amp;quot;, m.Title, msg.NSQDAddress, <span class="type">string</span>(msg.Body))</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化消费者</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initConsumer</span><span class="params">(topic <span class="type">string</span>, channel <span class="type">string</span>, address <span class="type">string</span>)</span></span> (err <span class="type">error</span>) &#123;</span><br><span class="line">	config := nsq.NewConfig()</span><br><span class="line">	config.LookupdPollInterval = <span class="number">15</span> * time.Second</span><br><span class="line">	c, err := nsq.NewConsumer(topic, channel, config)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(&amp;quot;create consumer failed, err:%v\n&amp;quot;, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	consumer := &amp;amp;MyHandler&#123;</span><br><span class="line">		Title: &amp;quot;沙河<span class="number">1</span>号&amp;quot;,</span><br><span class="line">	&#125;</span><br><span class="line">	c.AddHandler(consumer)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// if err := c.ConnectToNSQD(address); err != nil &#123; // 直接连NSQD</span></span><br><span class="line">	<span class="keyword">if</span> err := c.ConnectToNSQLookupd(address); err != <span class="literal">nil</span> &#123; <span class="comment">// 通过lookupd查询</span></span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	err := initConsumer(&amp;quot;topic_demo&amp;quot;, &amp;quot;first&amp;quot;, &amp;quot;<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">4161</span>&amp;quot;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(&amp;quot;init consumer failed, err:%v\n&amp;quot;, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	c := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal)        <span class="comment">// 定义一个信号的通道</span></span><br><span class="line">	signal.Notify(c, syscall.SIGINT) <span class="comment">// 转发键盘中断信号到c</span></span><br><span class="line">	&amp;lt;-c                              <span class="comment">// 阻塞</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将上面的代码保存之后编译执行，就能够获取之前我们publish的两条消息了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Copy$ ./nsq_consumer </span><br><span class="line">2018/10/22 18:49:06 INF    1 [topic_demo/first] querying nsqlookupd http://127.0.0.1:4161/lookup?topic=topic_demo</span><br><span class="line">2018/10/22 18:49:06 INF    1 [topic_demo/first] (127.0.0.1:4150) connecting to nsqd</span><br><span class="line">沙河1号 recv from 127.0.0.1:4150, msg:123</span><br><span class="line">沙河1号 recv from 127.0.0.1:4150, msg:456</span><br></pre></td></tr></table></figure>

<p>同时在nsqadmin的<code>/counter</code>页面查看到处理的数据数量为2。<a target="_blank" rel="noopener" href="http://www.chenyoude.com/go/nsqadmin6.png"><img src="http://www.chenyoude.com/go/nsqadmin6.png" alt="nsqadmin6.png"></a></p>
<p>Cookie和Session是Web开发绕不开的一个环节，本文介绍了Cookie和Session的原理及在Go语言中如何操作Cookie。</p>
<h1 id="49-Cookie"><a href="#49-Cookie" class="headerlink" title="49.Cookie"></a>49.Cookie</h1><h2 id="Cookie的由来"><a href="#Cookie的由来" class="headerlink" title="Cookie的由来"></a>Cookie的由来</h2><p>HTTP协议是无状态的，这就存在一个问题。</p>
<p>无状态的意思是每次请求都是独立的，它的执行情况和结果与前面的请求和之后的请求都无直接关系，它不会受前面的请求响应情况直接影响，也不会直接影响后面的请求响应情况。</p>
<p>一句有意思的话来描述就是人生只如初见，对服务器来说，每次的请求都是全新的。</p>
<p>状态可以理解为客户端和服务器在某次会话中产生的数据，那无状态的就以为这些数据不会被保留。会话中产生的数据又是我们需要保存的，也就是说要“保持状态”。因此Cookie就是在这样一个场景下诞生。</p>
<h2 id="Cookie是什么"><a href="#Cookie是什么" class="headerlink" title="Cookie是什么"></a>Cookie是什么</h2><p>在 Internet 中，Cookie 实际上是指小量信息，是由 Web 服务器创建的，将信息存储在用户计算机上（客户端）的数据文件。一般网络用户习惯用其复数形式 Cookies，指某些网站为了辨别用户身份、进行 Session 跟踪而存储在用户本地终端上的数据，而这些数据通常会经过加密处理。</p>
<h2 id="Cookie的机制"><a href="#Cookie的机制" class="headerlink" title="Cookie的机制"></a>Cookie的机制</h2><p>Cookie是由服务器端生成，发送给User-Agent（一般是浏览器），浏览器会将Cookie的key/value保存到某个目录下的文本文件内，下次请求同一网站时就发送该Cookie给服务器（前提是浏览器设置为启用cookie）。Cookie名称和值可以由服务器端开发自己定义，这样服务器可以知道该用户是否是合法用户以及是否需要重新登录等，服务器可以设置或读取Cookies中包含信息，借此维护用户跟服务器会话中的状态。</p>
<p>总结一下Cookie的特点：</p>
<ol>
<li>浏览器发送请求的时候，自动把携带该站点之前存储的Cookie信息。</li>
<li>服务端可以设置Cookie数据。</li>
<li>Cookie是针对单个域名的，不同域名之间的Cookie是独立的。</li>
<li>Cookie数据可以配置过期时间，过期的Cookie数据会被系统清除。</li>
</ol>
<h2 id="查看Cookie"><a href="#查看Cookie" class="headerlink" title="查看Cookie"></a>查看Cookie</h2><p>我们使用Chrome浏览器打开一个网站，打开开发者工具查看该网站保存在我们电脑上的Cookie数据。</p>
<h2 id="Go操作Cookie"><a href="#Go操作Cookie" class="headerlink" title="Go操作Cookie"></a>Go操作Cookie</h2><h2 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h2><p>标准库<code>net/http</code>中定义了Cookie，它代表一个出现在HTTP响应头中Set-Cookie的值里或者HTTP请求头中Cookie的值的<code>HTTP cookie</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Copytype Cookie <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name       <span class="type">string</span></span><br><span class="line">    Value      <span class="type">string</span></span><br><span class="line">    Path       <span class="type">string</span></span><br><span class="line">    Domain     <span class="type">string</span></span><br><span class="line">    Expires    time.Time</span><br><span class="line">    RawExpires <span class="type">string</span></span><br><span class="line">    <span class="comment">// MaxAge=0表示未设置Max-Age属性</span></span><br><span class="line">    <span class="comment">// MaxAge&amp;lt;0表示立刻删除该cookie，等价于&amp;quot;Max-Age: 0&amp;quot;</span></span><br><span class="line">    <span class="comment">// MaxAge&amp;gt;0表示存在Max-Age属性，单位是秒</span></span><br><span class="line">    MaxAge   <span class="type">int</span></span><br><span class="line">    Secure   <span class="type">bool</span></span><br><span class="line">    HttpOnly <span class="type">bool</span></span><br><span class="line">    Raw      <span class="type">string</span></span><br><span class="line">    Unparsed []<span class="type">string</span> <span class="comment">// 未解析的“属性-值”对的原始文本</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="设置Cookie"><a href="#设置Cookie" class="headerlink" title="设置Cookie"></a>设置Cookie</h2><p><code>net/http</code>中提供了如下<code>SetCookie</code>函数，它在w的头域中添加Set-Cookie头，该HTTP头的值为cookie。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copyfunc SetCookie(w ResponseWriter, cookie *Cookie)</span><br></pre></td></tr></table></figure>

<h2 id="获取Cookie"><a href="#获取Cookie" class="headerlink" title="获取Cookie"></a>获取Cookie</h2><p><code>Request</code>对象拥有两个获取Cookie的方法和一个添加Cookie的方法：</p>
<p>获取Cookie的两种方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Copy<span class="comment">// 解析并返回该请求的Cookie头设置的所有cookie</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Request)</span></span> Cookies() []*Cookie</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回请求中名为name的cookie，如果未找到该cookie会返回nil, ErrNoCookie。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Request)</span></span> Cookie(name <span class="type">string</span>) (*Cookie, <span class="type">error</span>)</span><br></pre></td></tr></table></figure>

<p>添加Cookie的方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Copy<span class="comment">// AddCookie向请求中添加一个cookie。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Request)</span></span> AddCookie(c *Cookie)</span><br></pre></td></tr></table></figure>

<h2 id="gin框架操作Cookie"><a href="#gin框架操作Cookie" class="headerlink" title="gin框架操作Cookie"></a>gin框架操作Cookie</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Copyimport (</span><br><span class="line">    &amp;quot;fmt&amp;quot;</span><br><span class="line"></span><br><span class="line">    &amp;quot;github.com/gin-gonic/gin&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    router := gin.Default()</span><br><span class="line">    router.GET(&amp;quot;/cookie&amp;quot;, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        cookie, err := c.Cookie(&amp;quot;gin_cookie&amp;quot;) <span class="comment">// 获取Cookie</span></span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            cookie = &amp;quot;NotSet&amp;quot;</span><br><span class="line">            <span class="comment">// 设置Cookie</span></span><br><span class="line">            c.SetCookie(&amp;quot;gin_cookie&amp;quot;, &amp;quot;test&amp;quot;, <span class="number">3600</span>, &amp;quot;/&amp;quot;, &amp;quot;localhost&amp;quot;, <span class="literal">false</span>, <span class="literal">true</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Printf(&amp;quot;Cookie value: %s \n&amp;quot;, cookie)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    router.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h2><h2 id="Session的由来"><a href="#Session的由来" class="headerlink" title="Session的由来"></a>Session的由来</h2><p>Cookie虽然在一定程度上解决了“保持状态”的需求，但是由于Cookie本身最大支持4096字节，以及Cookie本身保存在客户端，可能被拦截或窃取，因此就需要有一种新的东西，它能支持更多的字节，并且他保存在服务器，有较高的安全性。这就是<code>Session</code>。</p>
<p>问题来了，基于HTTP协议的无状态特征，服务器根本就不知道访问者是“谁”。那么上述的Cookie就起到桥接的作用。</p>
<p>用户登陆成功之后，我们在服务端为每个用户创建一个特定的session和一个唯一的标识，它们一一对应。其中：</p>
<ul>
<li>Session是在服务端保存的一个数据结构，用来跟踪用户的状态，这个数据可以保存在集群、数据库、文件中；</li>
<li>唯一标识通常称为<code>Session ID</code>会写入用户的Cookie中。</li>
</ul>
<p>这样该用户后续再次访问时，请求会自动携带Cookie数据（其中包含了<code>Session ID</code>），服务器通过该<code>Session ID</code>就能找到与之对应的Session数据，也就知道来的人是“谁”。</p>
<p>总结而言：Cookie弥补了HTTP无状态的不足，让服务器知道来的人是“谁”；但是Cookie以文本的形式保存在本地，自身安全性较差；所以我们就通过Cookie识别不同的用户，对应的在服务端为每个用户保存一个Session数据，该Session数据中能够保存具体的用户数据信息。</p>
<p>另外，上述所说的Cookie和Session其实是共通性的东西，不限于语言和框架。</p>
<h2 id="练习题-1"><a href="#练习题-1" class="headerlink" title="练习题"></a>练习题</h2><ol>
<li>编写代码实现一个gin框架版Session中间件。</li>
</ol>

    </div>

    
    
    

    <footer class="post-footer"><div class="post-widgets">
      <div id="needsharebutton-postbottom">
        <span class="btn">
          <i class="fa fa-share-alt" aria-hidden="true"></i>
        </span>
      </div>
    </div>
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.jpeg" alt="Michaeldong 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.jpeg" alt="Michaeldong 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/Go/" rel="tag"># Go</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/08/20/Go-2.%E8%BF%9B%E9%98%B6/" rel="prev" title="Go-进阶">
                  <i class="fa fa-chevron-left"></i> Go-进阶
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/09/01/Go-4.%E6%A1%86%E6%9E%B6/" rel="next" title="Go-框架">
                  Go-框架 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Michaeldong</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">1.2m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">18:06</span>
  </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>
<script class="next-config" data-name="chatra" type="application/json">{"enable":true,"async":true,"id":"9D92XKxDbxTrStQPr"}</script>
<script src="/js/third-party/chat/chatra.js"></script>
<script async src="https://call.chatra.io/chatra.js"></script>





  





  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1/needsharebutton.min.js"></script>
  <script>
      pbOptions = {};
        pbOptions.iconStyle = "box";
        pbOptions.boxForm = "horizontal";
        pbOptions.position = "bottomCenter";
        pbOptions.networks = "Wechat,QQZone,Weibo,Douban,Twitter,Facebook";
      new needShareButton('#needsharebutton-postbottom', pbOptions);
  </script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":200,"height":300,"vOffset":300},"mobile":{"show":true},"dialog":{"enable":true,"hitokoto":true}});</script></body>
</html>
