<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"gtdong.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"gitalk","active":true,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="8-模型层-单表操作">
<meta property="og:type" content="article">
<meta property="og:title" content="Django进阶-模型层">
<meta property="og:url" content="https://gtdong.github.io/2018/05/19/3.Django%E8%BF%9B%E9%98%B6-%E6%A8%A1%E5%9E%8B%E5%B1%82/index.html">
<meta property="og:site_name" content="TsukiBlog">
<meta property="og:description" content="8-模型层-单表操作">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/gtdong/images/raw/master/blog/007S8ZIlgy1gj1wrzhtrsj30jk0fiq4u-20210824203817829.jpg">
<meta property="og:image" content="https://gitee.com/gtdong/images/raw/master/blog/007S8ZIlgy1gj1wsfg8wkj314e0i24bb.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gj1wt64t3tj30cy0f4t98.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gj6qcrj0acj30q80pygqi.jpg">
<meta property="article:published_time" content="2018-05-19T05:05:00.000Z">
<meta property="article:modified_time" content="2022-04-30T16:12:01.080Z">
<meta property="article:author" content="Michaeldong">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="Django">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/gtdong/images/raw/master/blog/007S8ZIlgy1gj1wrzhtrsj30jk0fiq4u-20210824203817829.jpg">


<link rel="canonical" href="https://gtdong.github.io/2018/05/19/3.Django%E8%BF%9B%E9%98%B6-%E6%A8%A1%E5%9E%8B%E5%B1%82/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://gtdong.github.io/2018/05/19/3.Django%E8%BF%9B%E9%98%B6-%E6%A8%A1%E5%9E%8B%E5%B1%82/","path":"2018/05/19/3.Django进阶-模型层/","title":"Django进阶-模型层"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Django进阶-模型层 | TsukiBlog</title>
  




<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1/needsharebutton.min.css"><style>
#needsharebutton-postbottom {
  cursor: pointer;
  height: 26px;
  margin-top: 10px;
  position: relative;
}
#needsharebutton-postbottom .btn {
  border: 1px solid $btn-default-border-color;
  border-radius: 3px;
  display: initial;
  padding: 1px 4px;
}
</style>
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">TsukiBlog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#8-%E6%A8%A1%E5%9E%8B%E5%B1%82-%E5%8D%95%E8%A1%A8%E6%93%8D%E4%BD%9C"><span class="nav-number">1.</span> <span class="nav-text">8-模型层-单表操作</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80-ORM%E7%AE%80%E4%BB%8B"><span class="nav-number">1.1.</span> <span class="nav-text">一 ORM简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C-%E5%8D%95%E8%A1%A8%E6%93%8D%E4%BD%9C"><span class="nav-number">1.2.</span> <span class="nav-text">二 单表操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E5%88%9B%E5%BB%BA%E8%A1%A8"><span class="nav-number">1.2.1.</span> <span class="nav-text">2.1 创建表</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%88%9B%E5%BB%BA%E6%A8%A1%E5%9E%8B"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">1 创建模型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%9B%B4%E5%A4%9A%E5%AD%97%E6%AE%B5"><span class="nav-number">1.2.1.2.</span> <span class="nav-text">2 更多字段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E6%9B%B4%E5%A4%9A%E5%8F%82%E6%95%B0"><span class="nav-number">1.2.1.3.</span> <span class="nav-text">3 更多参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-settings%E9%85%8D%E7%BD%AE"><span class="nav-number">1.2.1.4.</span> <span class="nav-text">4 settings配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-%E5%A2%9E%E5%8A%A0%EF%BC%8C%E5%88%A0%E9%99%A4%E5%AD%97%E6%AE%B5"><span class="nav-number">1.2.1.5.</span> <span class="nav-text">5 增加，删除字段</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E6%B7%BB%E5%8A%A0%E8%A1%A8%E7%BA%AA%E5%BD%95"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.2 添加表纪录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E6%9F%A5%E8%AF%A2%E8%A1%A8%E7%BA%AA%E5%BD%95"><span class="nav-number">1.2.3.</span> <span class="nav-text">2.3 查询表纪录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E5%8F%8C%E4%B8%8B%E5%88%92%E7%BA%BF%E7%9A%84%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.2.4.</span> <span class="nav-text">基于双下划线的模糊查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-%E5%88%A0%E9%99%A4%E8%A1%A8%E7%BA%AA%E5%BD%95"><span class="nav-number">1.2.5.</span> <span class="nav-text">2.5 删除表纪录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-%E4%BF%AE%E6%94%B9%E8%A1%A8%E7%BA%AA%E5%BD%95"><span class="nav-number">1.2.6.</span> <span class="nav-text">2.6 修改表纪录</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89-%E5%9C%A8Python%E8%84%9A%E6%9C%AC%E4%B8%AD%E8%B0%83%E7%94%A8Django%E7%8E%AF%E5%A2%83"><span class="nav-number">1.3.</span> <span class="nav-text">三 在Python脚本中调用Django环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B-Django%E7%BB%88%E7%AB%AF%E6%89%93%E5%8D%B0SQL%E8%AF%AD%E5%8F%A5"><span class="nav-number">1.4.</span> <span class="nav-text">四 Django终端打印SQL语句</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AB%A0%E8%8A%82%E4%BD%9C%E4%B8%9A"><span class="nav-number">1.5.</span> <span class="nav-text">章节作业</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%9B%BE%E4%B9%A6%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F"><span class="nav-number">1.5.1.</span> <span class="nav-text">1 图书管理系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%9F%A5%E8%AF%A2%E6%93%8D%E4%BD%9C%E7%BB%83%E4%B9%A0"><span class="nav-number">1.5.2.</span> <span class="nav-text">2 查询操作练习</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#9-%E6%A8%A1%E5%9E%8B%E5%B1%82-%E5%A4%9A%E8%A1%A8%E6%93%8D%E4%BD%9C"><span class="nav-number">2.</span> <span class="nav-text">9-模型层-多表操作</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80-%E5%88%9B%E5%BB%BA%E6%A8%A1%E5%9E%8B"><span class="nav-number">2.1.</span> <span class="nav-text">一 创建模型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C-%E6%B7%BB%E5%8A%A0%E8%A1%A8%E8%AE%B0%E5%BD%95"><span class="nav-number">2.2.</span> <span class="nav-text">二 添加表记录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E5%AF%B9%E5%A4%9A%E7%9A%84"><span class="nav-number">2.2.1.</span> <span class="nav-text">一对多的</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A"><span class="nav-number">2.2.2.</span> <span class="nav-text">多对多</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89-%E5%9F%BA%E4%BA%8E%E5%AF%B9%E8%B1%A1%E7%9A%84%E8%B7%A8%E8%A1%A8%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.3.</span> <span class="nav-text">三 基于对象的跨表查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E5%AF%B9%E5%A4%9A%E6%9F%A5%E8%AF%A2%EF%BC%88publish%E4%B8%8Ebook%EF%BC%89"><span class="nav-number">2.3.1.</span> <span class="nav-text">一对多查询（publish与book）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E5%AF%B9%E4%B8%80%E6%9F%A5%E8%AF%A2%EF%BC%88Author-%E4%B8%8E-AuthorDetail%EF%BC%89"><span class="nav-number">2.3.2.</span> <span class="nav-text">一对一查询（Author 与 AuthorDetail）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A%E6%9F%A5%E8%AF%A2-Author-%E4%B8%8E-Book"><span class="nav-number">2.3.3.</span> <span class="nav-text">多对多查询 (Author 与 Book)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B-%E5%9F%BA%E4%BA%8E%E5%8F%8C%E4%B8%8B%E5%88%92%E7%BA%BF%E7%9A%84%E8%B7%A8%E8%A1%A8%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.4.</span> <span class="nav-text">四 基于双下划线的跨表查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E5%AF%B9%E5%A4%9A%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.4.1.</span> <span class="nav-text">一对多查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.4.2.</span> <span class="nav-text">多对多查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E5%AF%B9%E4%B8%80%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.4.3.</span> <span class="nav-text">一对一查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E9%98%B6%E7%BB%83%E4%B9%A0-%E8%BF%9E%E7%BB%AD%E8%B7%A8%E8%A1%A8"><span class="nav-number">2.4.4.</span> <span class="nav-text">进阶练习(连续跨表)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#related-name"><span class="nav-number">2.4.5.</span> <span class="nav-text">related_name</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94-%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2%E4%B8%8E%E5%88%86%E7%BB%84%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.5.</span> <span class="nav-text">五 聚合查询与分组查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%81%9A%E5%90%88"><span class="nav-number">2.5.1.</span> <span class="nav-text">聚合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E7%BB%84"><span class="nav-number">2.5.2.</span> <span class="nav-text">分组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E7%BB%83%E4%B9%A0"><span class="nav-number">2.5.3.</span> <span class="nav-text">查询练习</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD-F%E6%9F%A5%E8%AF%A2%E4%B8%8EQ%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.6.</span> <span class="nav-text">六 F查询与Q查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#F%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.6.1.</span> <span class="nav-text">F查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Q%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.6.2.</span> <span class="nav-text">Q查询</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%83-%E6%9F%A5%E8%AF%A2%E7%BB%83%E4%B9%A0"><span class="nav-number">2.7.</span> <span class="nav-text">七 查询练习</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#10-%E6%A8%A1%E5%9E%8B%E5%B1%82%E5%B8%B8%E7%94%A8%E9%9D%9E%E5%B8%B8%E7%94%A8%E5%AD%97%E6%AE%B5%E5%92%8C%E5%8F%82%E6%95%B0"><span class="nav-number">3.</span> <span class="nav-text">10-模型层常用非常用字段和参数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-ORM%E5%AD%97%E6%AE%B5"><span class="nav-number">3.1.</span> <span class="nav-text">1 ORM字段</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#AutoField"><span class="nav-number">3.1.0.1.</span> <span class="nav-text">AutoField</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IntegerField"><span class="nav-number">3.1.0.2.</span> <span class="nav-text">IntegerField</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CharField"><span class="nav-number">3.1.0.3.</span> <span class="nav-text">CharField</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DateField"><span class="nav-number">3.1.0.4.</span> <span class="nav-text">DateField</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DateTimeField"><span class="nav-number">3.1.0.5.</span> <span class="nav-text">DateTimeField</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%92%8C%E9%9D%9E%E5%B8%B8%E7%94%A8%E5%AD%97%E6%AE%B5"><span class="nav-number">3.1.1.</span> <span class="nav-text">常用和非常用字段</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-ORM%E5%AD%97%E6%AE%B5%E5%8F%82%E6%95%B0"><span class="nav-number">3.2.</span> <span class="nav-text">2 ORM字段参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%85%B3%E7%B3%BB%E5%AD%97%E6%AE%B5"><span class="nav-number">3.3.</span> <span class="nav-text">3 关系字段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ForeignKey"><span class="nav-number">3.3.1.</span> <span class="nav-text">ForeignKey</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#to"><span class="nav-number">3.3.1.1.</span> <span class="nav-text">to</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#to-field"><span class="nav-number">3.3.1.2.</span> <span class="nav-text">to_field</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#related-name-1"><span class="nav-number">3.3.1.3.</span> <span class="nav-text">related_name</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#related-query-name"><span class="nav-number">3.3.1.4.</span> <span class="nav-text">related_query_name</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#on-delete"><span class="nav-number">3.3.1.5.</span> <span class="nav-text">on_delete</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#db-constraint"><span class="nav-number">3.3.1.6.</span> <span class="nav-text">db_constraint</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OneToOneField"><span class="nav-number">3.3.2.</span> <span class="nav-text">OneToOneField</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#to-1"><span class="nav-number">3.3.2.1.</span> <span class="nav-text">to</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#to-field-1"><span class="nav-number">3.3.2.2.</span> <span class="nav-text">to_field</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#on-delete-1"><span class="nav-number">3.3.2.3.</span> <span class="nav-text">on_delete</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ManyToManyField"><span class="nav-number">3.3.3.</span> <span class="nav-text">ManyToManyField</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#to-2"><span class="nav-number">3.3.3.1.</span> <span class="nav-text">to</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#related-name-2"><span class="nav-number">3.3.3.2.</span> <span class="nav-text">related_name</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#related-query-name-1"><span class="nav-number">3.3.3.3.</span> <span class="nav-text">related_query_name</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#symmetrical"><span class="nav-number">3.3.3.4.</span> <span class="nav-text">symmetrical</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#through"><span class="nav-number">3.3.3.5.</span> <span class="nav-text">through</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#through-fields"><span class="nav-number">3.3.3.6.</span> <span class="nav-text">through_fields</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#db-table"><span class="nav-number">3.3.3.7.</span> <span class="nav-text">db_table</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%A4%9A%E5%AF%B9%E5%A4%9A%E5%85%B3%E8%81%94%E5%85%B3%E7%B3%BB%E7%9A%84%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="nav-number">3.4.</span> <span class="nav-text">4 多对多关联关系的三种方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E5%BC%8F%E4%B8%80%EF%BC%9A%E8%87%AA%E8%A1%8C%E5%88%9B%E5%BB%BA%E7%AC%AC%E4%B8%89%E5%BC%A0%E8%A1%A8"><span class="nav-number">3.4.1.</span> <span class="nav-text">方式一：自行创建第三张表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E5%BC%8F%E4%BA%8C%EF%BC%9A%E9%80%9A%E8%BF%87ManyToManyField%E8%87%AA%E5%8A%A8%E5%88%9B%E5%BB%BA%E7%AC%AC%E4%B8%89%E5%BC%A0%E8%A1%A8"><span class="nav-number">3.4.2.</span> <span class="nav-text">方式二：通过ManyToManyField自动创建第三张表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E5%BC%8F%E4%B8%89%EF%BC%9A%E8%AE%BE%E7%BD%AEManyTomanyField%E5%B9%B6%E6%8C%87%E5%AE%9A%E8%87%AA%E8%A1%8C%E5%88%9B%E5%BB%BA%E7%9A%84%E7%AC%AC%E4%B8%89%E5%BC%A0%E8%A1%A8"><span class="nav-number">3.4.3.</span> <span class="nav-text">方式三：设置ManyTomanyField并指定自行创建的第三张表</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E5%85%83%E4%BF%A1%E6%81%AF"><span class="nav-number">3.5.</span> <span class="nav-text">5 元信息</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#db-table-1"><span class="nav-number">3.5.0.1.</span> <span class="nav-text">db_table</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#index-together"><span class="nav-number">3.5.0.2.</span> <span class="nav-text">index_together</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#unique-together"><span class="nav-number">3.5.0.3.</span> <span class="nav-text">unique_together</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ordering"><span class="nav-number">3.5.0.4.</span> <span class="nav-text">ordering</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AD%97%E6%AE%B5%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="nav-number">3.6.</span> <span class="nav-text">6 自定义字段（了解）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#11-%E6%A8%A1%E5%9E%8B%E5%B1%82-%E6%A8%A1%E5%9E%8B%E5%B1%82%E8%BF%9B%E9%98%B6"><span class="nav-number">4.</span> <span class="nav-text">11-模型层-模型层进阶</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80-QuerySet%E5%AF%B9%E8%B1%A1"><span class="nav-number">4.1.</span> <span class="nav-text">一 QuerySet对象</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1%E5%8F%AF%E5%88%87%E7%89%87"><span class="nav-number">4.1.1.</span> <span class="nav-text">1.1可切片</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2%E5%8F%AF%E8%BF%AD%E4%BB%A3"><span class="nav-number">4.1.2.</span> <span class="nav-text">1.2可迭代</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3%E6%83%B0%E6%80%A7%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.1.3.</span> <span class="nav-text">1.3惰性查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6"><span class="nav-number">4.1.4.</span> <span class="nav-text">1.4缓存机制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%95%E6%97%B6%E6%9F%A5%E8%AF%A2%E9%9B%86%E4%B8%8D%E4%BC%9A%E8%A2%AB%E7%BC%93%E5%AD%98"><span class="nav-number">4.1.4.1.</span> <span class="nav-text">何时查询集不会被缓存?</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-exists-%E4%B8%8Eiterator-%E6%96%B9%E6%B3%95"><span class="nav-number">4.1.5.</span> <span class="nav-text">1.5 exists()与iterator()方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#exists%EF%BC%9A"><span class="nav-number">4.1.5.1.</span> <span class="nav-text">exists：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#iterator"><span class="nav-number">4.1.5.2.</span> <span class="nav-text">iterator:</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C-%E4%B8%AD%E4%BB%8B%E6%A8%A1%E5%9E%8B"><span class="nav-number">4.2.</span> <span class="nav-text">二 中介模型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89-%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="nav-number">4.3.</span> <span class="nav-text">三 查询优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1%E8%A1%A8%E6%95%B0%E6%8D%AE"><span class="nav-number">4.3.1.</span> <span class="nav-text">3.1表数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-select-related"><span class="nav-number">4.3.2.</span> <span class="nav-text">3.2 select_related</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-1%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="nav-number">4.3.2.1.</span> <span class="nav-text">3.2.1简单使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-2-%E5%A4%9A%E5%A4%96%E9%94%AE%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.3.2.2.</span> <span class="nav-text">**3.2.2 多外键查询 **</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-3-%E6%B7%B1%E5%B1%82%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.3.2.3.</span> <span class="nav-text">3.2.3 深层查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-4-%E6%80%BB%E7%BB%93"><span class="nav-number">4.3.2.4.</span> <span class="nav-text">3.2.4 总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-prefetch-related"><span class="nav-number">4.3.3.</span> <span class="nav-text">3.3 prefetch_related()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B-extra"><span class="nav-number">4.4.</span> <span class="nav-text">四 extra</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1%E5%8F%82%E6%95%B0%E4%B9%8Bselect"><span class="nav-number">4.4.1.</span> <span class="nav-text">4.1参数之select</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2%E5%8F%82%E6%95%B0%E4%B9%8Bwhere-tables"><span class="nav-number">4.4.2.</span> <span class="nav-text">4.2参数之where &#x2F; tables</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94-%E5%8E%9F%E7%94%9Fsql"><span class="nav-number">4.5.</span> <span class="nav-text">五 原生sql</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD-%E6%95%B4%E4%BD%93%E6%8F%92%E5%85%A5"><span class="nav-number">4.6.</span> <span class="nav-text">六 整体插入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%83-%E4%BA%8B%E5%8A%A1%E6%93%8D%E4%BD%9C"><span class="nav-number">4.7.</span> <span class="nav-text">七 事务操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AB-defer%E5%92%8Conly"><span class="nav-number">4.8.</span> <span class="nav-text">八 defer和only</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Michaeldong"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">Michaeldong</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">82</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="sidebar-button site-overview-item animated">
    <button><i class="fa fa-comment"></i>
      Chat
    </button>
  </div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/gtdong" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;gtdong" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/gtdong" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://gtdong.github.io/2018/05/19/3.Django%E8%BF%9B%E9%98%B6-%E6%A8%A1%E5%9E%8B%E5%B1%82/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Michaeldong">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TsukiBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Django进阶-模型层 | TsukiBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Django进阶-模型层
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-05-19 13:05:00" itemprop="dateCreated datePublished" datetime="2018-05-19T13:05:00+08:00">2018-05-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-05-01 00:12:01" itemprop="dateModified" datetime="2022-05-01T00:12:01+08:00">2022-05-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python%E4%B9%8B%E8%B7%AF/" itemprop="url" rel="index"><span itemprop="name">Python之路</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python%E4%B9%8B%E8%B7%AF/Django/" itemprop="url" rel="index"><span itemprop="name">Django</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>72k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1:05</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="8-模型层-单表操作"><a href="#8-模型层-单表操作" class="headerlink" title="8-模型层-单表操作"></a>8-模型层-单表操作</h1><span id="more"></span>

<h2 id="一-ORM简介"><a href="#一-ORM简介" class="headerlink" title="一 ORM简介"></a>一 ORM简介</h2><p>查询数据层次图解：如果操作mysql，ORM是在pymysq之上又进行了一层封装</p>
<p><img src="https://gitee.com/gtdong/images/raw/master/blog/007S8ZIlgy1gj1wrzhtrsj30jk0fiq4u-20210824203817829.jpg" alt="image-20200924181833097"></p>
<ul>
<li>MVC或者MTV框架中包括一个重要的部分，就是ORM，它实现了数据模型与数据库的解耦，即数据模型的设计不需要依赖于特定的数据库，通过简单的配置就可以轻松更换数据库，这极大的减轻了开发人员的工作量，不需要面对因数据库变更而导致的无效劳动</li>
<li>ORM是“对象-关系-映射”的简称。</li>
</ul>
<p><img src="https://gitee.com/gtdong/images/raw/master/blog/007S8ZIlgy1gj1wsfg8wkj314e0i24bb.jpg" alt="image-20200924181858413"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">sql</span>中的表                                                      </span><br><span class="line"></span><br><span class="line"> #创建表:</span><br><span class="line">     <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> employee(                                     </span><br><span class="line">                id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY auto_increment ,                    </span><br><span class="line">                name <span class="type">VARCHAR</span> (<span class="number">20</span>),                                      </span><br><span class="line">                gender BIT <span class="keyword">default</span> <span class="number">1</span>,                                  </span><br><span class="line">                birthday DATA ,                                         </span><br><span class="line">                department <span class="type">VARCHAR</span> (<span class="number">20</span>),                                </span><br><span class="line">                salary <span class="type">DECIMAL</span> (<span class="number">8</span>,<span class="number">2</span>) unsigned,                          </span><br><span class="line">              );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  #<span class="keyword">sql</span>中的表纪录                                                  </span><br><span class="line"></span><br><span class="line">  #添加一条表纪录:                                                          </span><br><span class="line">      <span class="keyword">INSERT</span> employee (name,gender,birthday,salary,department)            </span><br><span class="line">             <span class="keyword">VALUES</span>   (&quot;alex&quot;,<span class="number">1</span>,&quot;1985-12-12&quot;,<span class="number">8000</span>,&quot;保洁部&quot;);               </span><br><span class="line"></span><br><span class="line">  #查询一条表纪录:                                                           </span><br><span class="line">      <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employee <span class="keyword">WHERE</span> age<span class="operator">=</span><span class="number">24</span>;                               </span><br><span class="line"></span><br><span class="line">  #更新一条表纪录:                                                           </span><br><span class="line">      <span class="keyword">UPDATE</span> employee <span class="keyword">SET</span> birthday<span class="operator">=</span>&quot;1989-10-24&quot; <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span>;              </span><br><span class="line"></span><br><span class="line">  #删除一条表纪录:                                                          </span><br><span class="line">      <span class="keyword">DELETE</span> <span class="keyword">FROM</span> employee <span class="keyword">WHERE</span> name<span class="operator">=</span>&quot;alex&quot;                             </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#python的类</span><br><span class="line">class Employee(models.Model):</span><br><span class="line">     id<span class="operator">=</span>models.AutoField(primary_key<span class="operator">=</span><span class="literal">True</span>)</span><br><span class="line">     name<span class="operator">=</span>models.CharField(max_length<span class="operator">=</span><span class="number">32</span>)</span><br><span class="line">     gender<span class="operator">=</span>models.BooleanField()</span><br><span class="line">     birthday<span class="operator">=</span>models.DateField()</span><br><span class="line">     department<span class="operator">=</span>models.CharField(max_length<span class="operator">=</span><span class="number">32</span>)</span><br><span class="line">     salary<span class="operator">=</span>models.DecimalField(max_digits<span class="operator">=</span><span class="number">8</span>,decimal_places<span class="operator">=</span><span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> #python的类对象</span><br><span class="line">      #添加一条表纪录:</span><br><span class="line">          emp<span class="operator">=</span>Employee(name<span class="operator">=</span>&quot;alex&quot;,gender<span class="operator">=</span><span class="literal">True</span>,birthday<span class="operator">=</span>&quot;1985-12-12&quot;,epartment<span class="operator">=</span>&quot;保洁部&quot;)</span><br><span class="line">          emp.save()</span><br><span class="line">      #查询一条表纪录:</span><br><span class="line">          Employee.objects.filter(age<span class="operator">=</span><span class="number">24</span>)</span><br><span class="line">      #更新一条表纪录:</span><br><span class="line">          Employee.objects.filter(id<span class="operator">=</span><span class="number">1</span>).<span class="keyword">update</span>(birthday<span class="operator">=</span>&quot;1989-10-24&quot;)</span><br><span class="line">      #删除一条表纪录:</span><br><span class="line">          Employee.objects.filter(name<span class="operator">=</span>&quot;alex&quot;).<span class="keyword">delete</span>()</span><br></pre></td></tr></table></figure>

<h2 id="二-单表操作"><a href="#二-单表操作" class="headerlink" title="二 单表操作"></a>二 单表操作</h2><h3 id="2-1-创建表"><a href="#2-1-创建表" class="headerlink" title="2.1 创建表"></a>2.1 创建表</h3><h4 id="1-创建模型"><a href="#1-创建模型" class="headerlink" title="1 创建模型"></a>1 创建模型</h4><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gj1wt64t3tj30cy0f4t98.jpg" alt="image-20200924181936140"></p>
<p>创建名为book的app，在book下的models.py中创建模型：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Book</span>(models.Model):</span><br><span class="line">    <span class="built_in">id</span> = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = models.CharField(max_length=<span class="number">64</span>)</span><br><span class="line">    pub_data = models.DateField()</span><br><span class="line">    price = models.DecimalField(max_digits=<span class="number">5</span>, decimal_places=<span class="number">2</span>)</span><br><span class="line">    publish = models.CharField(max_length=<span class="number">12</span>)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.name</span><br></pre></td></tr></table></figure>

<h4 id="2-更多字段"><a href="#2-更多字段" class="headerlink" title="2 更多字段"></a>2 更多字段</h4><p>每个字段有一些特有的参数，例如，CharField需要max_length参数来指定<code>VARCHAR</code>数据库字段的大小。还有一些适用于所有字段的通用参数。 这些参数在文档中有详细定义，这里我们只简单介绍一些最常用的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">AutoField(Field)</span><br><span class="line">    - <span class="built_in">int</span>自增列，必须填入参数 primary_key=<span class="literal">True</span></span><br><span class="line"></span><br><span class="line">BigAutoField(AutoField)</span><br><span class="line">    - bigint自增列，必须填入参数 primary_key=<span class="literal">True</span></span><br><span class="line">    注：当model中如果没有自增列，则自动会创建一个列名为<span class="built_in">id</span>的列</span><br><span class="line">    <span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">UserInfo</span>(models.Model):</span><br><span class="line">        <span class="comment"># 自动创建一个列名为id的且为自增的整数列</span></span><br><span class="line">        username = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Group</span>(models.Model):</span><br><span class="line">        <span class="comment"># 自定义自增列</span></span><br><span class="line">        nid = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">        name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">SmallIntegerField(IntegerField):</span><br><span class="line">    - 小整数 -<span class="number">32768</span> ～ <span class="number">32767</span></span><br><span class="line"></span><br><span class="line">PositiveSmallIntegerField(PositiveIntegerRelDbTypeMixin, IntegerField)</span><br><span class="line">    - 正小整数 <span class="number">0</span> ～ <span class="number">32767</span></span><br><span class="line">IntegerField(Field)</span><br><span class="line">    - 整数列(有符号的) -<span class="number">2147483648</span> ～ <span class="number">2147483647</span></span><br><span class="line"></span><br><span class="line">PositiveIntegerField(PositiveIntegerRelDbTypeMixin, IntegerField)</span><br><span class="line">    - 正整数 <span class="number">0</span> ～ <span class="number">2147483647</span></span><br><span class="line"></span><br><span class="line">BigIntegerField(IntegerField):</span><br><span class="line">    - 长整型(有符号的) -<span class="number">9223372036854775808</span> ～ <span class="number">9223372036854775807</span></span><br><span class="line"></span><br><span class="line">自定义无符号整数字段</span><br><span class="line">	<span class="keyword">class</span> <span class="title class_">UnsignedIntegerField</span>(models.IntegerField):</span><br><span class="line"> 	    <span class="keyword">def</span> <span class="title function_">db_type</span>(<span class="params">self, connection</span>):</span><br><span class="line">	        <span class="keyword">return</span> <span class="string">&#x27;integer UNSIGNED&#x27;</span></span><br><span class="line"></span><br><span class="line">    PS: 返回值为字段在数据库中的属性，Django字段默认的值为：</span><br><span class="line">        <span class="string">&#x27;AutoField&#x27;</span>: <span class="string">&#x27;integer AUTO_INCREMENT&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;BigAutoField&#x27;</span>: <span class="string">&#x27;bigint AUTO_INCREMENT&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;BinaryField&#x27;</span>: <span class="string">&#x27;longblob&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;BooleanField&#x27;</span>: <span class="string">&#x27;bool&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;CharField&#x27;</span>: <span class="string">&#x27;varchar(%(max_length)s)&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;CommaSeparatedIntegerField&#x27;</span>: <span class="string">&#x27;varchar(%(max_length)s)&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;DateField&#x27;</span>: <span class="string">&#x27;date&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;DateTimeField&#x27;</span>: <span class="string">&#x27;datetime&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;DecimalField&#x27;</span>: <span class="string">&#x27;numeric(%(max_digits)s, %(decimal_places)s)&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;DurationField&#x27;</span>: <span class="string">&#x27;bigint&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;FileField&#x27;</span>: <span class="string">&#x27;varchar(%(max_length)s)&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;FilePathField&#x27;</span>: <span class="string">&#x27;varchar(%(max_length)s)&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;FloatField&#x27;</span>: <span class="string">&#x27;double precision&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;IntegerField&#x27;</span>: <span class="string">&#x27;integer&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;BigIntegerField&#x27;</span>: <span class="string">&#x27;bigint&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;IPAddressField&#x27;</span>: <span class="string">&#x27;char(15)&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;GenericIPAddressField&#x27;</span>: <span class="string">&#x27;char(39)&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;NullBooleanField&#x27;</span>: <span class="string">&#x27;bool&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;OneToOneField&#x27;</span>: <span class="string">&#x27;integer&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PositiveIntegerField&#x27;</span>: <span class="string">&#x27;integer UNSIGNED&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PositiveSmallIntegerField&#x27;</span>: <span class="string">&#x27;smallint UNSIGNED&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;SlugField&#x27;</span>: <span class="string">&#x27;varchar(%(max_length)s)&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;SmallIntegerField&#x27;</span>: <span class="string">&#x27;smallint&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;TextField&#x27;</span>: <span class="string">&#x27;longtext&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;TimeField&#x27;</span>: <span class="string">&#x27;time&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;UUIDField&#x27;</span>: <span class="string">&#x27;char(32)&#x27;</span>,</span><br><span class="line"></span><br><span class="line">BooleanField(Field)</span><br><span class="line">    - 布尔值类型</span><br><span class="line"></span><br><span class="line">NullBooleanField(Field):</span><br><span class="line">    - 可以为空的布尔值</span><br><span class="line"></span><br><span class="line">CharField(Field)</span><br><span class="line">    - 字符类型</span><br><span class="line">    - 必须提供max_length参数， max_length表示字符长度</span><br><span class="line"></span><br><span class="line">TextField(Field)</span><br><span class="line">    - 文本类型</span><br><span class="line"></span><br><span class="line">EmailField(CharField)：</span><br><span class="line">    - 字符串类型，Django Admin以及ModelForm中提供验证机制</span><br><span class="line"></span><br><span class="line">IPAddressField(Field)</span><br><span class="line">    - 字符串类型，Django Admin以及ModelForm中提供验证 IPV4 机制</span><br><span class="line"></span><br><span class="line">GenericIPAddressField(Field)</span><br><span class="line">    - 字符串类型，Django Admin以及ModelForm中提供验证 Ipv4和Ipv6</span><br><span class="line">    - 参数：</span><br><span class="line">        protocol，用于指定Ipv4或Ipv6， <span class="string">&#x27;both&#x27;</span>,<span class="string">&quot;ipv4&quot;</span>,<span class="string">&quot;ipv6&quot;</span></span><br><span class="line">        unpack_ipv4， 如果指定为<span class="literal">True</span>，则输入::ffff:<span class="number">192.0</span><span class="number">.2</span><span class="number">.1</span>时候，可解析为<span class="number">192.0</span><span class="number">.2</span><span class="number">.1</span>，开启刺功能，需要protocol=<span class="string">&quot;both&quot;</span></span><br><span class="line"></span><br><span class="line">URLField(CharField)</span><br><span class="line">    - 字符串类型，Django Admin以及ModelForm中提供验证 URL</span><br><span class="line"></span><br><span class="line">SlugField(CharField)</span><br><span class="line">    - 字符串类型，Django Admin以及ModelForm中提供验证支持 字母、数字、下划线、连接符（减号）</span><br><span class="line"></span><br><span class="line">CommaSeparatedIntegerField(CharField)</span><br><span class="line">    - 字符串类型，格式必须为逗号分割的数字</span><br><span class="line"></span><br><span class="line">UUIDField(Field)</span><br><span class="line">    - 字符串类型，Django Admin以及ModelForm中提供对UUID格式的验证</span><br><span class="line"></span><br><span class="line">FilePathField(Field)</span><br><span class="line">    - 字符串，Django Admin以及ModelForm中提供读取文件夹下文件的功能</span><br><span class="line">    - 参数：</span><br><span class="line">            path,                      文件夹路径</span><br><span class="line">            match=<span class="literal">None</span>,                正则匹配</span><br><span class="line">            recursive=<span class="literal">False</span>,           递归下面的文件夹</span><br><span class="line">            allow_files=<span class="literal">True</span>,          允许文件</span><br><span class="line">            allow_folders=<span class="literal">False</span>,       允许文件夹</span><br><span class="line"></span><br><span class="line">FileField(Field)</span><br><span class="line">    - 字符串，路径保存在数据库，文件上传到指定目录</span><br><span class="line">    - 参数：</span><br><span class="line">        upload_to = <span class="string">&quot;&quot;</span>      上传文件的保存路径</span><br><span class="line">        storage = <span class="literal">None</span>      存储组件，默认django.core.files.storage.FileSystemStorage</span><br><span class="line"></span><br><span class="line">ImageField(FileField)</span><br><span class="line">    - 字符串，路径保存在数据库，文件上传到指定目录</span><br><span class="line">    - 参数：</span><br><span class="line">        upload_to = <span class="string">&quot;&quot;</span>      上传文件的保存路径</span><br><span class="line">        storage = <span class="literal">None</span>      存储组件，默认django.core.files.storage.FileSystemStorage</span><br><span class="line">        width_field=<span class="literal">None</span>,   上传图片的高度保存的数据库字段名（字符串）</span><br><span class="line">        height_field=<span class="literal">None</span>   上传图片的宽度保存的数据库字段名（字符串）</span><br><span class="line"></span><br><span class="line">DateTimeField(DateField)</span><br><span class="line">    - 日期+时间格式 YYYY-MM-DD HH:MM[:ss[.uuuuuu]][TZ]</span><br><span class="line"></span><br><span class="line">DateField(DateTimeCheckMixin, Field)</span><br><span class="line">    - 日期格式      YYYY-MM-DD</span><br><span class="line"></span><br><span class="line">TimeField(DateTimeCheckMixin, Field)</span><br><span class="line">    - 时间格式      HH:MM[:ss[.uuuuuu]]</span><br><span class="line"></span><br><span class="line">DurationField(Field)</span><br><span class="line">    - 长整数，时间间隔，数据库中按照bigint存储，ORM中获取的值为datetime.timedelta类型</span><br><span class="line"></span><br><span class="line">FloatField(Field)</span><br><span class="line">    - 浮点型</span><br><span class="line"></span><br><span class="line">DecimalField(Field)</span><br><span class="line">    - <span class="number">10</span>进制小数</span><br><span class="line">    - 参数：</span><br><span class="line">        max_digits，小数总长度</span><br><span class="line">        decimal_places，小数位长度</span><br><span class="line"></span><br><span class="line">BinaryField(Field)</span><br><span class="line">    - 二进制类型</span><br></pre></td></tr></table></figure>

<h4 id="3-更多参数"><a href="#3-更多参数" class="headerlink" title="3 更多参数"></a>3 更多参数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>)null</span><br><span class="line"> </span><br><span class="line">如果为<span class="literal">True</span>，Django 将用NULL 来在数据库中存储空值。 默认值是 <span class="literal">False</span>.</span><br><span class="line"> </span><br><span class="line">(<span class="number">1</span>)blank</span><br><span class="line"> </span><br><span class="line">如果为<span class="literal">True</span>，该字段允许不填。默认为<span class="literal">False</span>。</span><br><span class="line">要注意，这与 null 不同。null纯粹是数据库范畴的，而 blank 是数据验证范畴的。</span><br><span class="line">如果一个字段的blank=<span class="literal">True</span>，表单的验证将允许该字段是空值。如果字段的blank=<span class="literal">False</span>，该字段就是必填的。</span><br><span class="line"> </span><br><span class="line">(<span class="number">2</span>)default</span><br><span class="line"> </span><br><span class="line">字段的默认值。可以是一个值或者可调用对象。如果可调用 ，每有新对象被创建它都会被调用。</span><br><span class="line"> </span><br><span class="line">(<span class="number">3</span>)primary_key</span><br><span class="line"> </span><br><span class="line">如果为<span class="literal">True</span>，那么这个字段就是模型的主键。如果你没有指定任何一个字段的primary_key=<span class="literal">True</span>，</span><br><span class="line">Django 就会自动添加一个IntegerField字段做为主键，所以除非你想覆盖默认的主键行为，</span><br><span class="line">否则没必要设置任何一个字段的primary_key=<span class="literal">True</span>。</span><br><span class="line"> </span><br><span class="line">(<span class="number">4</span>)unique</span><br><span class="line"> </span><br><span class="line">如果该值设置为 <span class="literal">True</span>, 这个数据字段的值在整张表中必须是唯一的</span><br><span class="line"> </span><br><span class="line">(<span class="number">5</span>)choices</span><br><span class="line">由二元组组成的一个可迭代对象（例如，列表或元组），用来给字段提供选择项。 如果设置了choices ，默认的表单将是一个选择框而不是标准的文本框，&lt;br&gt;而且这个选择框的选项就是choices 中的选项。</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserInfo</span>(models.Model):</span><br><span class="line">       nid = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">       username = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">       <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">           <span class="comment"># 数据库中生成的表名称 默认 app名称 + 下划线 + 类名</span></span><br><span class="line">           db_table = <span class="string">&quot;table_name&quot;</span></span><br><span class="line"></span><br><span class="line">           <span class="comment"># 联合索引</span></span><br><span class="line">           index_together = [</span><br><span class="line">               (<span class="string">&quot;pub_date&quot;</span>, <span class="string">&quot;deadline&quot;</span>),</span><br><span class="line">           ]</span><br><span class="line"></span><br><span class="line">           <span class="comment"># 联合唯一索引</span></span><br><span class="line">           unique_together = ((<span class="string">&quot;driver&quot;</span>, <span class="string">&quot;restaurant&quot;</span>),)</span><br><span class="line"></span><br><span class="line">           <span class="comment"># admin中显示的表名称</span></span><br><span class="line">           verbose_name</span><br><span class="line"></span><br><span class="line">           <span class="comment"># verbose_name加s</span></span><br><span class="line">           verbose_name_plural</span><br></pre></td></tr></table></figure>

<h4 id="4-settings配置"><a href="#4-settings配置" class="headerlink" title="4 settings配置"></a>4 settings配置</h4><p>若想将模型转为mysql数据库中的表，需要在settings中配置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.mysql&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;lqz&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;USER&#x27;</span>: <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PASSWORD&#x27;</span>: <span class="string">&#x27;123456&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;HOST&#x27;</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PORT&#x27;</span>: <span class="number">3306</span>,</span><br><span class="line">        <span class="string">&#x27;ATOMIC_REQUEST&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&#x27;OPTIONS&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;init_command&quot;</span>: <span class="string">&quot;SET storage_engine=MyISAM&quot;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&#x27;NAME&#x27;:要连接的数据库，连接前需要创建好</span></span><br><span class="line"><span class="string">&#x27;USER&#x27;:连接数据库的用户名</span></span><br><span class="line"><span class="string">&#x27;PASSWORD&#x27;:连接数据库的密码</span></span><br><span class="line"><span class="string">&#x27;HOST&#x27;:连接主机，默认本机</span></span><br><span class="line"><span class="string">&#x27;PORT&#x27;:端口 默认3306</span></span><br><span class="line"><span class="string">&#x27;ATOMIC_REQUEST&#x27;: True,</span></span><br><span class="line"><span class="string">设置为True统一个http请求对应的所有sql都放在一个事务中执行（要么所有都成功，要么所有都失败）。</span></span><br><span class="line"><span class="string">是全局性的配置， 如果要对某个http请求放水（然后自定义事务），可以用non_atomic_requests修饰器 </span></span><br><span class="line"><span class="string">&#x27;OPTIONS&#x27;: &#123;</span></span><br><span class="line"><span class="string">             &quot;init_command&quot;: &quot;SET storage_engine=MyISAM&quot;,</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">设置创建表的存储引擎为MyISAM，INNODB</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>注意1：</strong>NAME即数据库的名字，在mysql连接前该数据库必须已经创建，而上面的sqlite数据库下的db.sqlite3则是项目自动创建 USER和PASSWORD分别是数据库的用户名和密码。设置完后，再启动我们的Django项目前，我们需要激活我们的mysql。然后，启动项目，会报错：no module named MySQLdb 。这是因为django默认你导入的驱动是MySQLdb，可是MySQLdb 对于py3有很大问题，所以我们需要的驱动是PyMySQL 所以，我们只需要找到项目名文件下的<strong>init</strong>,在里面写入：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line">pymysql.install_as_MySQLdb()</span><br></pre></td></tr></table></figure>

<p>最后通过两条数据库迁移命令即可在指定的数据库中创建表 ：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python manage.py makemigrations</span><br><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure>

<p>**注意2:**确保配置文件中的INSTALLED_APPS中写入我们创建的app名称</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">&#x27;django.contrib.admin&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.auth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.contenttypes&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.sessions&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.messages&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.staticfiles&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;book&quot;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>**注意3:**如果报错如下：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">django</span>.core.exceptions.ImproperlyConfigured: mysqlclient <span class="number">1</span>.<span class="number">3</span>.<span class="number">3</span> or newer is required; you have <span class="number">0</span>.<span class="number">7</span>.<span class="number">11</span>.None</span><br></pre></td></tr></table></figure>

<p>MySQLclient目前只支持到python3.4，因此如果使用的更高版本的python，需要修改如下：</p>
<p>通过查找路径C:\Programs\Python\Python36-32\Lib\site-packages\Django-2.0-py3.6.egg\django\db\backends\mysql<br>这个路径里的文件把</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">if</span> version &lt; (<span class="number">1</span>, <span class="number">3</span>, <span class="number">3</span>):</span><br><span class="line">     <span class="attribute">raise</span> ImproperlyConfigured(<span class="string">&quot;mysqlclient 1.3.3 or newer is required; you have %s&quot;</span> % Database.__version__)</span><br></pre></td></tr></table></figure>

<p>注释掉就可以了</p>
<p><strong>注意4:</strong> 如果想打印orm转换过程中的sql，需要在settings中进行如下配置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">LOGGING = &#123;</span><br><span class="line">    <span class="string">&#x27;version&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&#x27;disable_existing_loggers&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;console&#x27;</span>:&#123;</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>:<span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;class&#x27;</span>:<span class="string">&#x27;logging.StreamHandler&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;loggers&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;django.db.backends&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;console&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>:<span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-增加，删除字段"><a href="#5-增加，删除字段" class="headerlink" title="5 增加，删除字段"></a>5 增加，删除字段</h4><p>　　删除，直接注释掉字段，执行数据库迁移命令即可</p>
<p>　　新增字段，在类里直接新增字段，直接执行数据库迁移命令会提示输入默认值，此时需要设置</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">publish = models.CharField(max_length=<span class="number">12</span>,<span class="literal">default</span>=<span class="string">&#x27;人民出版社&#x27;</span>,<span class="literal">null</span>=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<p>　　<strong>1 数据库迁移记录都在 app01下的migrations里</strong></p>
<p>　　<strong>2 使用showmigrations命令可以查看没有执行migrate的文件</strong></p>
<p>　　<strong>3 makemigrations是生成一个文件，migrate是将更改提交到数据库</strong></p>
<h3 id="2-2-添加表纪录"><a href="#2-2-添加表纪录" class="headerlink" title="2.2 添加表纪录"></a>2.2 添加表纪录</h3><p><strong>方式1</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create方法的返回值book_obj就是插入book表中的python葵花宝典这本书籍纪录对象</span></span><br><span class="line">book_obj=Book.objects.create(title=<span class="string">&quot;python葵花宝典&quot;</span>,state=<span class="literal">True</span>,price=<span class="number">100</span>,publish=<span class="string">&quot;苹果出版社&quot;</span>,pub_date=<span class="string">&quot;2012-12-12&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>方式2</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">book_obj=Book(title=<span class="string">&quot;python葵花宝典&quot;</span>,state=<span class="literal">True</span>,price=<span class="number">100</span>,publish=<span class="string">&quot;苹果出版社&quot;</span>,pub_date=<span class="string">&quot;2012-12-12&quot;</span>)</span><br><span class="line">book_obj.save()</span><br></pre></td></tr></table></figure>

<h3 id="2-3-查询表纪录"><a href="#2-3-查询表纪录" class="headerlink" title="2.3 查询表纪录"></a>2.3 查询表纪录</h3><p><strong>查询API</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">&lt;1&gt; all():                  查询所有结果</span><br><span class="line">  </span><br><span class="line">&lt;2&gt; filter(**kwargs):       它包含了与所给筛选条件相匹配的对象</span><br><span class="line">  </span><br><span class="line">&lt;3&gt; get(**kwargs):          返回与所给筛选条件相匹配的对象，返回结果有且只有一个，如果符合筛选条件的对象超过一个或者没有都会抛出错误。</span><br><span class="line">  </span><br><span class="line">&lt;4&gt; exclude(**kwargs):      它包含了与所给筛选条件不匹配的对象</span><br><span class="line"> </span><br><span class="line">&lt;5&gt; order_by(*field):       对查询结果排序(&#x27;-id&#x27;)</span><br><span class="line">  </span><br><span class="line">&lt;6&gt; reverse():              对查询结果反向排序</span><br><span class="line">  </span><br><span class="line">&lt;8&gt; count():                返回数据库中匹配查询(QuerySet)的对象数量。</span><br><span class="line">  </span><br><span class="line">&lt;9&gt; first():                返回第一条记录</span><br><span class="line">  </span><br><span class="line">&lt;10&gt; last():                返回最后一条记录</span><br><span class="line">  </span><br><span class="line">&lt;11&gt; exists():              如果QuerySet包含数据，就返回True，否则返回False</span><br><span class="line"> </span><br><span class="line">&lt;12&gt; values(*field):        返回一个ValueQuerySet——一个特殊的QuerySet，运行后得到的并不是一系列</span><br><span class="line">                            model的实例化对象，而是一个可迭代的字典序列</span><br><span class="line">&lt;13&gt; values_list(*field):   它与values()非常相似，它返回的是一个元组序列，values返回的是一个字典序列</span><br><span class="line"> </span><br><span class="line">&lt;14&gt; distinct():            从返回结果中剔除重复纪录</span><br><span class="line">def index(request):</span><br><span class="line">    # 添加表记录++++++++++++++++++++++++++++++++++</span><br><span class="line">    # 方式一</span><br><span class="line">    # book=Book(name=&#x27;红楼梦&#x27;,pub_data=&#x27;2015-10-12&#x27;,price=88,publish=&#x27;老男孩出版社&#x27;)</span><br><span class="line">    # book.save()</span><br><span class="line">    # 方式二</span><br><span class="line">    # Book.objects.create(name=&#x27;Python红宝书&#x27;,pub_data=&#x27;2010-10-12&#x27;,price=100,publish=&#x27;人民出版社&#x27;)</span><br><span class="line">    # 查询表记录++++++++++++++++++++++++++++++++++</span><br><span class="line">    # QUerySet数据类型（类似于一个列表，里面放着一些对象）</span><br><span class="line">    # 1 方法的返回值是什么</span><br><span class="line">    # 2 方法的调用者</span><br><span class="line">    # (1) all方法 返回一个QuerySet对象</span><br><span class="line">    # book_list=Book.objects.all()</span><br><span class="line">    # print(book_list[1].name)</span><br><span class="line">    # print(book_list)</span><br><span class="line">    # for obj in book_list:</span><br><span class="line">    #     print(obj.name)</span><br><span class="line">    # (2)first last：调用者是queryset对象，返回值是对象</span><br><span class="line">    # book=Book.objects.all().first()</span><br><span class="line">    # book2=Book.objects.all().last()</span><br><span class="line">    # print(book)</span><br><span class="line">    # print(book2)</span><br><span class="line">    # (3) filter  返回值是queryset对象(相当于where语句)</span><br><span class="line">    # 可以加多个过滤条件</span><br><span class="line">    # book=Book.objects.filter(name=&#x27;红楼梦&#x27;).first()</span><br><span class="line">    # print(book)</span><br><span class="line">    # (4)get方法 有且只有一个查询结果才有意义 返回值是一个对象</span><br><span class="line">    # book=Book.objects.get(name=&#x27;红楼梦&#x27;)</span><br><span class="line">    # print(book)</span><br><span class="line">    # 直接报错</span><br><span class="line">    # book = Book.objects.get(name=&#x27;红楼梦eee&#x27;)</span><br><span class="line">    # --------------最常用-----------------</span><br><span class="line">    # (5)exclude 除了查询之外的 返回值也是queryset</span><br><span class="line">    # ret=Book.objects.exclude(name=&#x27;红楼梦&#x27;)</span><br><span class="line">    # print(ret)</span><br><span class="line">    # （6）order_by(默认升序，加个- 就是降序),可以多个过滤条件调用者是queryset返回值也是queryset</span><br><span class="line">    # book_list=Book.objects.all().order_by(&#x27;id&#x27;)</span><br><span class="line">    # book_list=Book.objects.all().order_by(&#x27;-id&#x27;,&#x27;price&#x27;)</span><br><span class="line">    # print(book_list)</span><br><span class="line">    # （7）count() 调用者是queryset，返回值是int</span><br><span class="line">    # ret=Book.objects.all().count()</span><br><span class="line">    # print(ret)</span><br><span class="line">    # (8)exist()判断是是否有值，不能传参数，</span><br><span class="line">    # ret=Book.objects.all().exists()</span><br><span class="line">    # print(ret)</span><br><span class="line">    # （9）values方法</span><br><span class="line">    # 查询所有书籍的名称(里面传的值，前提是表有这个字段)也是queryset但是里面放的是字典</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    values原理</span><br><span class="line">    temp=[]</span><br><span class="line">    for obj in Book.objects.all():</span><br><span class="line">        temp.append(&#123;&#x27;name&#x27;:obj.name&#125;)</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    # ret=Book.objects.all().values(&#x27;name&#x27;)</span><br><span class="line">    # print(ret)</span><br><span class="line">    # 不加.all()也可以,调用是queryset返回值也是queryset</span><br><span class="line">    # ret=Book.objects.values(&#x27;price&#x27;)</span><br><span class="line">    # print(ret)</span><br><span class="line">    # （10）value_list</span><br><span class="line">    # ret=Book.objects.all().values_list(&#x27;price&#x27;,&#x27;name&#x27;)</span><br><span class="line">    # print(ret)</span><br><span class="line">    # (11) distinct  seletc * 的时候没有意义</span><br><span class="line">    # SELECT DISTINCT name from app01_book;</span><br><span class="line">    # 没有任何意义，不要这样么用</span><br><span class="line">    # Book.objects.all().distinct()</span><br><span class="line">    # ret=Book.objects.all().values(&#x27;name&#x27;).distinct()</span><br><span class="line">    # print(ret)</span><br><span class="line"></span><br><span class="line">    # 双下划线模糊查询-----------------------</span><br><span class="line">    # 查询价格大于100的书</span><br><span class="line">    # ret=Book.objects.filter(price__gt=100)</span><br><span class="line">    # print(ret)</span><br><span class="line">    # 查询大于50小于100的书</span><br><span class="line">    # ret=Book.objects.filter(price__gt=50,price__lt=100)</span><br><span class="line">    # print(ret)</span><br><span class="line">    # 查询已红楼开头的书</span><br><span class="line">    # ret=Book.objects.filter(name__startswith=&#x27;红楼&#x27;)</span><br><span class="line">    # print(ret)</span><br><span class="line">    # 查询包含‘红’的书</span><br><span class="line">    # ret= Book.objects.filter(name__contains=&#x27;红&#x27;)</span><br><span class="line">    # print(ret)</span><br><span class="line">    # icontains  不区分大小写</span><br><span class="line">    # 价格在50，88，100 中的</span><br><span class="line">    # ret=Book.objects.filter(price__in=[50,88,100])</span><br><span class="line">    # print(ret)</span><br><span class="line">    # 出版日期在2018年的</span><br><span class="line">    # ret=Book.objects.filter(pub_data__year=2015,pub_data__month=2)</span><br><span class="line">    # print(ret)</span><br><span class="line">    # 删除，修改------------------------</span><br><span class="line">    # delete：调用者可以是queryset也可以是model对象</span><br><span class="line">    # 删除价格为188的书有返回值 (1, &#123;&#x27;app01.Book&#x27;: 1&#125;) 删除的个数，那张表，记录数</span><br><span class="line">    # ret=Book.objects.filter(price=188).delete()</span><br><span class="line">    # print(ret)</span><br><span class="line">    # ret=Book.objects.filter(price=100).first().delete()</span><br><span class="line">    # print(ret)</span><br><span class="line"></span><br><span class="line">    # 修改 update只能queryset来调用 返回值为int</span><br><span class="line">    # ret=Book.objects.filter(name=&#x27;红楼梦1&#x27;).update(name=&#x27;红楼梦&#x27;)</span><br><span class="line">    # print(ret)</span><br><span class="line">    # 报错</span><br><span class="line">    # Book.objects.filter(name=&#x27;红楼梦&#x27;).first().update(name=&#x27;红楼梦1&#x27;)</span><br><span class="line"></span><br><span class="line">    # ret=Book.objects.filter(name=&#x27;红楼梦1&#x27;).first()</span><br><span class="line">    # print(ret.delete())</span><br><span class="line">    # aa=Publish.objects.filter(name=&#x27;人民出版社&#x27;)</span><br><span class="line">    # print(type(aa))</span><br><span class="line">    # aa.delete()</span><br><span class="line"></span><br><span class="line">    return HttpResponse(&#x27;ok&#x27;)</span><br></pre></td></tr></table></figure>

<h3 id="基于双下划线的模糊查询"><a href="#基于双下划线的模糊查询" class="headerlink" title="基于双下划线的模糊查询"></a>基于双下划线的模糊查询</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Book.objects.<span class="built_in">filter</span>(price__in=[<span class="number">100</span>,<span class="number">200</span>,<span class="number">300</span>])</span><br><span class="line">Book.objects.<span class="built_in">filter</span>(price__gt=<span class="number">100</span>)</span><br><span class="line">Book.objects.<span class="built_in">filter</span>(price__lt=<span class="number">100</span>)</span><br><span class="line">Book.objects.<span class="built_in">filter</span>(price__gte=<span class="number">100</span>)</span><br><span class="line">Book.objects.<span class="built_in">filter</span>(price__lte=<span class="number">100</span>)</span><br><span class="line">Book.objects.<span class="built_in">filter</span>(price__range=[<span class="number">100</span>,<span class="number">200</span>])</span><br><span class="line">Book.objects.<span class="built_in">filter</span>(title__contains=<span class="string">&quot;python&quot;</span>)</span><br><span class="line">Book.objects.<span class="built_in">filter</span>(title__icontains=<span class="string">&quot;python&quot;</span>)</span><br><span class="line">Book.objects.<span class="built_in">filter</span>(title__startswith=<span class="string">&quot;py&quot;</span>)</span><br><span class="line">Book.objects.<span class="built_in">filter</span>(pub_date__year=<span class="number">2012</span>)</span><br></pre></td></tr></table></figure>

<h3 id="2-5-删除表纪录"><a href="#2-5-删除表纪录" class="headerlink" title="2.5 删除表纪录"></a>2.5 删除表纪录</h3><p>删除方法就是 delete()。它运行时立即删除对象而不返回任何值。例如：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model_obj.<span class="keyword">delete</span>()</span><br></pre></td></tr></table></figure>

<p>你也可以一次性删除多个对象。每个 QuerySet 都有一个 delete() 方法，它一次性删除 QuerySet 中所有的对象。</p>
<p>例如，下面的代码将删除 pub_date 是2005年的 Entry 对象：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Entry<span class="selector-class">.objects</span><span class="selector-class">.filter</span>(pub_date__year=<span class="number">2005</span>)<span class="selector-class">.delete</span>()</span><br></pre></td></tr></table></figure>

<p>在 Django 删除对象时，会模仿 SQL 约束 ON DELETE CASCADE 的行为，换句话说，删除一个对象时也会删除与它相关联的外键对象。例如：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">b = Blog.objects.<span class="built_in">get</span>(<span class="attribute">pk</span>=1)</span><br><span class="line"><span class="comment"># This will delete the Blog and all of its Entry objects.</span></span><br><span class="line">b.delete()</span><br></pre></td></tr></table></figure>

<p>要注意的是： delete() 方法是 QuerySet 上的方法，但并不适用于 Manager 本身。这是一种保护机制，是为了避免意外地调用 Entry.objects.delete() 方法导致 所有的 记录被误删除。如果你确认要删除所有的对象，那么你必须显式地调用：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Entry<span class="selector-class">.objects</span><span class="selector-class">.all</span>()<span class="selector-class">.delete</span>()</span><br></pre></td></tr></table></figure>

<p>如果不想级联删除，可以设置为:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pubHouse = models.ForeignKey(<span class="attribute">to</span>=<span class="string">&#x27;Publisher&#x27;</span>, <span class="attribute">on_delete</span>=models.SET_NULL, <span class="attribute">blank</span>=<span class="literal">True</span>, <span class="attribute">null</span>=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h3 id="2-6-修改表纪录"><a href="#2-6-修改表纪录" class="headerlink" title="2.6 修改表纪录"></a>2.6 修改表纪录</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Book<span class="selector-class">.objects</span><span class="selector-class">.filter</span>(title__startswith=<span class="string">&quot;py&quot;</span>)<span class="selector-class">.update</span>(price=<span class="number">120</span></span><br></pre></td></tr></table></figure>

<p>此外，update()方法对于任何结果集（QuerySet）均有效，这意味着你可以同时更新多条记录update()方法会返回一个整型数值，表示受影响的记录条数。</p>
<h2 id="三-在Python脚本中调用Django环境"><a href="#三-在Python脚本中调用Django环境" class="headerlink" title="三 在Python脚本中调用Django环境"></a>三 在Python脚本中调用Django环境</h2><figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="built_in">os</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">os</span>.environ.setdefault(<span class="string">&quot;DJANGO_SETTINGS_MODULE&quot;</span>, <span class="string">&quot;untitled15.settings&quot;</span>)</span><br><span class="line">    <span class="keyword">import</span> django</span><br><span class="line">    django.setup()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> app01 <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line">    books = models.Book.objects.all()</span><br><span class="line">    <span class="built_in">print</span>(books)</span><br></pre></td></tr></table></figure>

<h2 id="四-Django终端打印SQL语句"><a href="#四-Django终端打印SQL语句" class="headerlink" title="四 Django终端打印SQL语句"></a>四 Django终端打印SQL语句</h2><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">LOGGING = &#123;</span><br><span class="line">    <span class="symbol">&#x27;version</span>&#x27;: <span class="number">1</span>,</span><br><span class="line">    <span class="symbol">&#x27;disable_existing_loggers</span>&#x27;: <span class="literal">False</span>,</span><br><span class="line">    <span class="symbol">&#x27;handlers</span>&#x27;: &#123;</span><br><span class="line">        <span class="symbol">&#x27;console</span>&#x27;:&#123;</span><br><span class="line">            <span class="symbol">&#x27;level</span><span class="string">&#x27;:&#x27;</span>DEBUG&#x27;,</span><br><span class="line">            <span class="symbol">&#x27;class</span><span class="string">&#x27;:&#x27;</span>logging.StreamHandler&#x27;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="symbol">&#x27;loggers</span>&#x27;: &#123;</span><br><span class="line">        <span class="symbol">&#x27;django.db.backends</span>&#x27;: &#123;</span><br><span class="line">            <span class="symbol">&#x27;handlers</span>&#x27;: [<span class="symbol">&#x27;console</span>&#x27;],</span><br><span class="line">            <span class="symbol">&#x27;propagate</span>&#x27;: <span class="literal">True</span>,</span><br><span class="line">            <span class="symbol">&#x27;level</span><span class="string">&#x27;:&#x27;</span>DEBUG&#x27;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="章节作业"><a href="#章节作业" class="headerlink" title="章节作业"></a>章节作业</h2><h3 id="1-图书管理系统"><a href="#1-图书管理系统" class="headerlink" title="1 图书管理系统"></a>1 图书管理系统</h3><p>实现功能：book单表的增删改查</p>
<h3 id="2-查询操作练习"><a href="#2-查询操作练习" class="headerlink" title="2 查询操作练习"></a>2 查询操作练习</h3><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">1 </span>查询老男孩出版社出版过的价格大于<span class="number">200</span>的书籍</span><br><span class="line"><span class="symbol">2 </span>查询<span class="number">2017</span>年<span class="number">8</span>月出版的所有以py开头的书籍名称 </span><br><span class="line"><span class="symbol">3 </span>查询价格为<span class="number">50</span>,<span class="number">100</span>或者<span class="number">150</span>的所有书籍名称及其出版社名称</span><br><span class="line"><span class="symbol">4 </span>查询价格在<span class="number">100</span>到<span class="number">200</span>之间的所有书籍名称及其价格</span><br><span class="line"><span class="symbol">5 </span>查询所有人民出版社出版的书籍的价格（从高到低排序，去重）</span><br></pre></td></tr></table></figure>

<h1 id="9-模型层-多表操作"><a href="#9-模型层-多表操作" class="headerlink" title="9-模型层-多表操作"></a>9-模型层-多表操作</h1><h2 id="一-创建模型"><a href="#一-创建模型" class="headerlink" title="一 创建模型"></a>一 创建模型</h2><p>实例：我们来假定下面这些概念，字段和关系</p>
<p>作者模型：一个作者有姓名和年龄。</p>
<p>作者详细模型：把作者的详情放到详情表，包含生日，手机号，家庭住址等信息。作者详情模型和作者模型之间是一对一的关系（one-to-one）</p>
<p>出版商模型：出版商有名称，所在城市以及email。</p>
<p>书籍模型： 书籍有书名和出版日期，一本书可能会有多个作者，一个作者也可以写多本书，所以作者和书籍的关系就是多对多的关联关系(many-to-many);一本书只应该由一个出版商出版，所以出版商和书籍是一对多关联关系(one-to-many)。</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line">Book</span><br><span class="line"></span><br><span class="line">   id    title   price  publish    </span><br><span class="line"></span><br><span class="line">   <span class="number">1</span>      php     <span class="number">100</span>   人民出版社  </span><br><span class="line">   <span class="number">2</span>      python  <span class="number">200</span>   老男孩出版社   </span><br><span class="line">   <span class="number">3</span>      go      <span class="number">100</span>   人民出版社  </span><br><span class="line">   <span class="number">4</span>      java    <span class="number">300</span>   人民出版社  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">为了存储出版社的邮箱，地址，在第一个表后面加字段</span><br><span class="line"></span><br><span class="line">Book</span><br><span class="line"></span><br><span class="line">   id    title   price  publish    email    addr    </span><br><span class="line"></span><br><span class="line">   <span class="number">1</span>      php     <span class="number">100</span>   人民出版社   <span class="number">111</span>      北京</span><br><span class="line">   <span class="number">2</span>      python  <span class="number">200</span>   老男孩出版社 <span class="number">222</span>      上海</span><br><span class="line">   <span class="number">3</span>      go      <span class="number">100</span>   人民出版社   <span class="number">111</span>      北京</span><br><span class="line">   <span class="number">4</span>      java    <span class="number">300</span>   人民出版社   <span class="number">111</span>      北京</span><br><span class="line">   </span><br><span class="line">这样会有大量重复的数据，浪费空间</span><br><span class="line"></span><br><span class="line">####################################################################################</span><br><span class="line"></span><br><span class="line">一对多：一个出版社对应多本书（关联信息建在多的一方，也就是book表中）</span><br><span class="line"></span><br><span class="line">Book</span><br><span class="line"></span><br><span class="line">   id    title   price     publish_id   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="number">1</span>      php     <span class="number">100</span>         <span class="number">1</span></span><br><span class="line">   <span class="number">2</span>      python  <span class="number">200</span>         <span class="number">1</span></span><br><span class="line">   <span class="number">3</span>      go      <span class="number">100</span>         <span class="number">2</span>  </span><br><span class="line">   <span class="number">4</span>      java    <span class="number">300</span>         <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Publish</span><br><span class="line"></span><br><span class="line">    id    name       email    addr    </span><br><span class="line">     <span class="number">1</span>    人民出版社   <span class="number">111</span>      北京       </span><br><span class="line">     <span class="number">2</span>    沙河出版社   <span class="number">222</span>      沙河</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">总结：一旦确定表关系是一对多：在多对应的表中创建关联字段（在多的表里创建关联字段）  ，publish_id</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">查询python这本书的出版社的邮箱(子查询)</span><br><span class="line"></span><br><span class="line">   select publish_id <span class="keyword">from</span> Book <span class="keyword">where</span> title=“python”</span><br><span class="line">   select email <span class="keyword">from</span> Publish <span class="keyword">where</span> id=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">####################################################################################</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">多对多：一本书有多个作者，一个作者出多本书</span><br><span class="line"></span><br><span class="line">Book</span><br><span class="line"></span><br><span class="line">   id    title   price     publish_id    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="number">1</span>      php     <span class="number">100</span>         <span class="number">1</span>               </span><br><span class="line">   <span class="number">2</span>      python  <span class="number">200</span>         <span class="number">1</span></span><br><span class="line">   <span class="number">3</span>      go      <span class="number">100</span>         <span class="number">2</span>  </span><br><span class="line">   <span class="number">4</span>      java    <span class="number">300</span>         <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Author</span><br><span class="line">         id  name  age   addr</span><br><span class="line"></span><br><span class="line">         <span class="number">1</span>    alex  <span class="number">34</span>   beijing</span><br><span class="line">         <span class="number">2</span>    egon  <span class="number">55</span>   nanjing</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Book2Author</span><br><span class="line"></span><br><span class="line">    id    book_id  author_id</span><br><span class="line">     <span class="number">1</span>       <span class="number">2</span>         <span class="number">1</span></span><br><span class="line">     <span class="number">2</span>       <span class="number">2</span>         <span class="number">2</span></span><br><span class="line"></span><br><span class="line">     <span class="number">3</span>       <span class="number">3</span>         <span class="number">2</span></span><br><span class="line"></span><br><span class="line">总结：一旦确定表关系是多对多：创建第三张关系表（创建中间表，中间表就三个字段，自己的id，书籍id和作者id） ：</span><br><span class="line">          </span><br><span class="line">          id      book_id   author_id</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># lqz出版过的书籍名称(子查询)</span><br><span class="line"></span><br><span class="line">select id <span class="keyword">from</span> Author <span class="keyword">where</span> name=<span class="string">&#x27;lqz&#x27;</span></span><br><span class="line"></span><br><span class="line">select book_id <span class="keyword">from</span> Book2Author <span class="keyword">where</span>  author_id=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">select title <span class="keyword">from</span> Book <span class="keyword">where</span> id =book_id</span><br><span class="line"></span><br><span class="line">####################################################################################</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">一对一：对作者详细信息的扩展（作者表和作者详情表）</span><br><span class="line"></span><br><span class="line">Author</span><br><span class="line">         id  name  age     ad_id(UNIQUE) </span><br><span class="line"></span><br><span class="line">         <span class="number">1</span>    lqz  <span class="number">34</span>       <span class="number">1</span>     </span><br><span class="line">         <span class="number">2</span>    egon  <span class="number">55</span>       <span class="number">2</span>     </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">AuthorDetail</span><br><span class="line"></span><br><span class="line">   id    addr      gender    tel   gf_name   author_id(UNIQUE)</span><br><span class="line">    <span class="number">1</span>   beijing    male      <span class="number">110</span>   小花           <span class="number">1</span></span><br><span class="line">    <span class="number">2</span>   nanjing    male      <span class="number">911</span>   杠娘           <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">总结： 一旦确定是一对一的关系：在两张表中的任意一张表中建立关联字段＋Unique</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">====================================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Publish  </span><br><span class="line">Book</span><br><span class="line">Author</span><br><span class="line">AuthorDetail</span><br><span class="line">Book2Author</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE publish(</span><br><span class="line">                id INT PRIMARY KEY auto_increment ,</span><br><span class="line">                name VARCHAR (<span class="number">20</span>)</span><br><span class="line">              );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE book(</span><br><span class="line">                id INT PRIMARY KEY auto_increment ,</span><br><span class="line">                title VARCHAR (<span class="number">20</span>),</span><br><span class="line">                price DECIMAL (<span class="number">8</span>,<span class="number">2</span>),</span><br><span class="line">                pub_date DATE ,</span><br><span class="line">                publish_id INT ,</span><br><span class="line">                FOREIGN KEY (publish_id) REFERENCES publish(id)</span><br><span class="line">              );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE authordetail(</span><br><span class="line">                id INT PRIMARY KEY auto_increment ,</span><br><span class="line">                tel VARCHAR (<span class="number">20</span>)</span><br><span class="line">              );</span><br><span class="line"></span><br><span class="line">CREATE TABLE author(</span><br><span class="line">                id INT PRIMARY KEY auto_increment ,</span><br><span class="line">                name VARCHAR (<span class="number">20</span>),</span><br><span class="line">                age INT,</span><br><span class="line">                authordetail_id INT UNIQUE ,</span><br><span class="line">                FOREIGN KEY (authordetail_id) REFERENCES authordetail(id)</span><br><span class="line">              );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE  TABLE book2author(</span><br><span class="line">       id INT PRIMARY KEY auto_increment ,</span><br><span class="line">       book_id INT ,</span><br><span class="line">       author_id INT ,</span><br><span class="line">       FOREIGN KEY (book_id) REFERENCES book(id),</span><br><span class="line">       FOREIGN KEY (author_id) REFERENCES author(id)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>注意：关联字段与外键约束没有必然的联系（建管理字段是为了进行查询，建约束是为了不出现脏数据）</strong></p>
<p>在Models创建如下模型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Book</span>(models.Model):</span><br><span class="line">    nid = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    price = models.DecimalField(max_digits=<span class="number">5</span>, decimal_places=<span class="number">2</span>)</span><br><span class="line">    publish_date = models.DateField()</span><br><span class="line">    <span class="comment"># 阅读数</span></span><br><span class="line">    <span class="comment"># reat_num=models.IntegerField(default=0)</span></span><br><span class="line">    <span class="comment"># 评论数</span></span><br><span class="line">    <span class="comment"># commit_num=models.IntegerField(default=0)</span></span><br><span class="line"></span><br><span class="line">    publish = models.ForeignKey(to=<span class="string">&#x27;Publish&#x27;</span>,to_field=<span class="string">&#x27;nid&#x27;</span>,on_delete=models.CASCADE)</span><br><span class="line">    authors=models.ManyToManyField(to=<span class="string">&#x27;Author&#x27;</span>)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Author</span>(models.Model):</span><br><span class="line">    nid = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    age = models.IntegerField()</span><br><span class="line">    author_detail = models.OneToOneField(to=<span class="string">&#x27;AuthorDatail&#x27;</span>,to_field=<span class="string">&#x27;nid&#x27;</span>,unique=<span class="literal">True</span>,on_delete=models.CASCADE)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AuthorDatail</span>(models.Model):</span><br><span class="line">    nid = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    telephone = models.BigIntegerField()</span><br><span class="line">    birthday = models.DateField()</span><br><span class="line">    addr = models.CharField(max_length=<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Publish</span>(models.Model):</span><br><span class="line">    nid = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    city = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    email = models.EmailField()</span><br></pre></td></tr></table></figure>

<p>生成的表如下：</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gj6qcrj0acj30q80pygqi.jpg" alt="image-20200928222403872"></p>
<p>注意事项：</p>
<ul>
<li>表的名称<code>myapp_modelName</code>，是根据 模型中的元数据自动生成的，也可以覆写为别的名称　　</li>
<li><code>id</code> 字段是自动添加的</li>
<li>对于外键字段，Django 会在字段名上添加<code>&quot;_id&quot;</code> 来创建数据库中的列名</li>
<li>这个例子中的<code>CREATE TABLE</code> SQL 语句使用PostgreSQL 语法格式，要注意的是Django 会根据settings 中指定的数据库类型来使用相应的SQL 语句。</li>
<li>定义好模型之后，你需要告诉Django _使用_这些模型。你要做的就是修改配置文件中的INSTALL_APPSZ中设置，在其中添加<code>models.py</code>所在应用的名称。</li>
<li>外键字段 ForeignKey 有一个 null=True 的设置(它允许外键接受空值 NULL)，你可以赋给它空值 None 。</li>
</ul>
<h2 id="二-添加表记录"><a href="#二-添加表记录" class="headerlink" title="二 添加表记录"></a>二 添加表记录</h2><h3 id="一对多的"><a href="#一对多的" class="headerlink" title="一对多的"></a>一对多的</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">方式<span class="number">1</span>:</span><br><span class="line">   publish_obj=Publish.objects.get(nid=<span class="number">1</span>)</span><br><span class="line">   book_obj=Book.objects.create(title=<span class="string">&quot;&quot;</span>,publishDate=<span class="string">&quot;2012-12-12&quot;</span>,price=<span class="number">100</span>,publish=publish_obj)</span><br><span class="line">  </span><br><span class="line">方式<span class="number">2</span>:</span><br><span class="line">   book_obj=Book.objects.create(title=<span class="string">&quot;&quot;</span>,publishDate=<span class="string">&quot;2012-12-12&quot;</span>,price=<span class="number">100</span>,publish_id=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>核心：book_obj.publish与book_obj.publish_id是什么？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">关键点:</span><br><span class="line"></span><br><span class="line"> 一 book_obj.publish=Publish.objects.<span class="built_in">filter</span>(<span class="built_in">id</span>=book_obj.publish_id).first()</span><br><span class="line"></span><br><span class="line"> 二 book_obj.authors.<span class="built_in">all</span>()</span><br><span class="line">    关键点:book.authors.<span class="built_in">all</span>()  <span class="comment"># 与这本书关联的作者集合</span></span><br><span class="line"></span><br><span class="line">     <span class="number">1</span> book.<span class="built_in">id</span>=<span class="number">3</span></span><br><span class="line">     <span class="number">2</span> book_authors</span><br><span class="line">         <span class="built_in">id</span>  book_id  author_ID</span><br><span class="line">         <span class="number">3</span>      <span class="number">3</span>             <span class="number">1</span></span><br><span class="line">         <span class="number">4</span>      <span class="number">3</span>             <span class="number">2</span></span><br><span class="line"></span><br><span class="line">     <span class="number">3</span>  author</span><br><span class="line">        <span class="built_in">id</span>   name</span><br><span class="line">        <span class="number">1</span>   lqz</span><br><span class="line">        <span class="number">2</span>   egon</span><br><span class="line"></span><br><span class="line"> book_obj.authors.<span class="built_in">all</span>()    -------&gt;   [lqz,egon]</span><br><span class="line"><span class="comment"># -----一对多添加</span></span><br><span class="line">pub=Publish.objects.create(name=<span class="string">&#x27;egon出版社&#x27;</span>,email=<span class="string">&#x27;445676@qq.com&#x27;</span>,city=<span class="string">&#x27;山东&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(pub)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为book表绑定和publish的关系</span></span><br><span class="line"><span class="keyword">import</span> datetime,time</span><br><span class="line">now=datetime.datetime.now().__str__()</span><br><span class="line">now = datetime.datetime.now().strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(now))</span><br><span class="line"><span class="built_in">print</span>(now)</span><br><span class="line"><span class="comment"># 日期类型必须是日期对象或者字符串形式的2018-09-12（2018-9-12），其它形式不行</span></span><br><span class="line">Book.objects.create(name=<span class="string">&#x27;海燕3&#x27;</span>,price=<span class="number">333.123</span>,publish_date=now,publish_id=<span class="number">2</span>)</span><br><span class="line">Book.objects.create(name=<span class="string">&#x27;海3燕3&#x27;</span>,price=<span class="number">35.123</span>,publish_date=<span class="string">&#x27;2018/02/28&#x27;</span>,publish=pub)</span><br><span class="line">pub=Publish.objects.<span class="built_in">filter</span>(nid=<span class="number">1</span>).first()</span><br><span class="line">book=Book.objects.create(name=<span class="string">&#x27;测试书籍&#x27;</span>,price=<span class="number">33</span>,publish_date=<span class="string">&#x27;2018-7-28&#x27;</span>,publish=pub)</span><br><span class="line"><span class="built_in">print</span>(book.publish.name)</span><br><span class="line"><span class="comment"># 查询出版了红楼梦这本书出版社的邮箱</span></span><br><span class="line">book=Book.objects.<span class="built_in">filter</span>(name=<span class="string">&#x27;红楼梦&#x27;</span>).first()</span><br><span class="line"><span class="built_in">print</span>(book.publish.email)</span><br></pre></td></tr></table></figure>

<h3 id="多对多"><a href="#多对多" class="headerlink" title="多对多"></a>多对多</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 当前生成的书籍对象</span></span><br><span class="line">  book_obj=Book.objects.create(title=<span class="string">&quot;追风筝的人&quot;</span>,price=<span class="number">200</span>,publishDate=<span class="string">&quot;2012-11-12&quot;</span>,publish_id=<span class="number">1</span>)</span><br><span class="line">  <span class="comment"># 为书籍绑定的做作者对象</span></span><br><span class="line">  yuan=Author.objects.<span class="built_in">filter</span>(name=<span class="string">&quot;yuan&quot;</span>).first() <span class="comment"># 在Author表中主键为2的纪录</span></span><br><span class="line">  egon=Author.objects.<span class="built_in">filter</span>(name=<span class="string">&quot;alex&quot;</span>).first() <span class="comment"># 在Author表中主键为1的纪录</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 绑定多对多关系,即向关系表book_authors中添加纪录</span></span><br><span class="line">  book_obj.authors.add(yuan,egon)    <span class="comment">#  将某些特定的 model 对象添加到被关联对象集合中。   =======    book_obj.authors.add(*[])</span></span><br><span class="line">book = Book.objects.<span class="built_in">filter</span>(name=<span class="string">&#x27;红楼梦&#x27;</span>).first()</span><br><span class="line">egon=Author.objects.<span class="built_in">filter</span>(name=<span class="string">&#x27;egon&#x27;</span>).first()</span><br><span class="line">lqz=Author.objects.<span class="built_in">filter</span>(name=<span class="string">&#x27;lqz&#x27;</span>).first()</span><br><span class="line"><span class="comment"># 1 没有返回值，直接传对象</span></span><br><span class="line">book.authors.add(lqz,egon)</span><br><span class="line"><span class="comment"># 2 直接传作者id</span></span><br><span class="line">book.authors.add(<span class="number">1</span>,<span class="number">3</span>)</span><br><span class="line"><span class="comment"># 3 直接传列表,会打散</span></span><br><span class="line">book.authors.add(*[<span class="number">1</span>,<span class="number">2</span>])</span><br><span class="line"><span class="comment"># 解除多对多关系</span></span><br><span class="line">book = Book.objects.<span class="built_in">filter</span>(name=<span class="string">&#x27;红楼梦&#x27;</span>).first()</span><br><span class="line"><span class="comment"># 1 传作者id</span></span><br><span class="line">book.authors.remove(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 2 传作者对象</span></span><br><span class="line">egon = Author.objects.<span class="built_in">filter</span>(name=<span class="string">&#x27;egon&#x27;</span>).first()</span><br><span class="line">book.authors.remove(egon)</span><br><span class="line"><span class="comment">#3 传*列表</span></span><br><span class="line">book.authors.remove(*[<span class="number">1</span>,<span class="number">2</span>])</span><br><span class="line"><span class="comment">#4 删除所有</span></span><br><span class="line">book.authors.clear()</span><br><span class="line"><span class="comment"># 5 拿到与 这本书关联的所有作者，结果是queryset对象，作者列表</span></span><br><span class="line">ret=book.authors.<span class="built_in">all</span>()</span><br><span class="line"><span class="comment"># print(ret)</span></span><br><span class="line"><span class="comment"># 6 queryset对象，又可以继续点（查询红楼梦这本书所有作者的名字）</span></span><br><span class="line">ret=book.authors.<span class="built_in">all</span>().values(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(ret)</span><br><span class="line"><span class="comment"># 以上总结：</span></span><br><span class="line"><span class="comment"># （1）</span></span><br><span class="line"><span class="comment"># book=Book.objects.filter(name=&#x27;红楼梦&#x27;).first()</span></span><br><span class="line"><span class="comment"># print(book)</span></span><br><span class="line"><span class="comment"># 在点publish的时候，其实就是拿着publish_id又去app01_publish这个表里查数据了</span></span><br><span class="line"><span class="comment"># print(book.publish)</span></span><br><span class="line"><span class="comment"># （2）book.authors.all()</span></span><br></pre></td></tr></table></figure>

<p>核心:book_obj.authors.all()是什么？</p>
<p><strong>多对多关系其它常用API：</strong></p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">book_obj.authors.remove() </span>     <span class="comment"># 将某个特定的对象从被关联对象集合中去除。    ======   book_obj.authors.remove(*[])</span></span><br><span class="line"><span class="keyword">book_obj.authors.clear() </span>      <span class="comment">#清空被关联对象集合</span></span><br><span class="line"><span class="keyword">book_obj.authors.set() </span>        <span class="comment">#先清空再设置</span></span><br></pre></td></tr></table></figure>

<h2 id="三-基于对象的跨表查询"><a href="#三-基于对象的跨表查询" class="headerlink" title="三 基于对象的跨表查询"></a>三 基于对象的跨表查询</h2><h3 id="一对多查询（publish与book）"><a href="#一对多查询（publish与book）" class="headerlink" title="一对多查询（publish与book）"></a>一对多查询（publish与book）</h3><p>正向查询（按字段：publish）</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询主键为1的书籍的出版社所在的城市</span></span><br><span class="line"><span class="attribute">book_obj</span>=Book.objects.filter(pk=1).first()</span><br><span class="line"><span class="comment"># book_obj.publish 是主键为1的书籍对象关联的出版社对象</span></span><br><span class="line"><span class="built_in">print</span>(book_obj.publish.city)</span><br></pre></td></tr></table></figure>

<p>反向查询（按表名：book_set）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">publish=Publish.objects.get(name=<span class="string">&quot;苹果出版社&quot;</span>)</span><br><span class="line"><span class="comment">#publish.book_set.all() : 与苹果出版社关联的所有书籍对象集合</span></span><br><span class="line">book_list=publish.book_set.<span class="built_in">all</span>()    </span><br><span class="line"><span class="keyword">for</span> book_obj <span class="keyword">in</span> book_list:</span><br><span class="line">       <span class="built_in">print</span>(book_obj.title)</span><br><span class="line"><span class="comment"># 一对多正向查询</span></span><br><span class="line"> book=Book.objects.<span class="built_in">filter</span>(name=<span class="string">&#x27;红楼梦&#x27;</span>).first()</span><br><span class="line"> <span class="built_in">print</span>(book.publish)<span class="comment">#与这本书关联的出版社对象</span></span><br><span class="line"> <span class="built_in">print</span>(book.publish.name)</span><br><span class="line"> <span class="comment"># 一对多反向查询</span></span><br><span class="line"> <span class="comment"># 人民出版社出版过的书籍名称</span></span><br><span class="line"> pub=Publish.objects.<span class="built_in">filter</span>(name=<span class="string">&#x27;人民出版社&#x27;</span>).first()</span><br><span class="line"> ret=pub.book_set.<span class="built_in">all</span>()</span><br><span class="line"> <span class="built_in">print</span>(ret)</span><br></pre></td></tr></table></figure>

<h3 id="一对一查询（Author-与-AuthorDetail）"><a href="#一对一查询（Author-与-AuthorDetail）" class="headerlink" title="一对一查询（Author 与 AuthorDetail）"></a>一对一查询（Author 与 AuthorDetail）</h3><p>正向查询(按字段：authorDetail)：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">egon=Author.objects.<span class="built_in">filter</span>(name=<span class="string">&quot;egon&quot;</span>).first()</span><br><span class="line"><span class="built_in">print</span>(egon.authorDetail.telephone)</span><br></pre></td></tr></table></figure>

<p>反向查询(按表名：author)：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询所有住址在北京的作者的姓名</span></span><br><span class="line"> </span><br><span class="line">authorDetail_list=AuthorDetail.objects.<span class="built_in">filter</span>(addr=<span class="string">&quot;beijing&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> obj <span class="keyword">in</span> authorDetail_list:</span><br><span class="line">     <span class="built_in">print</span>(obj.author.name)</span><br><span class="line"><span class="comment"># 一对一正向查询</span></span><br><span class="line"><span class="comment"># lqz的手机号</span></span><br><span class="line">lqz=Author.objects.<span class="built_in">filter</span>(name=<span class="string">&#x27;lqz&#x27;</span>).first()</span><br><span class="line">tel=lqz.author_detail.telephone</span><br><span class="line"><span class="built_in">print</span>(tel)</span><br><span class="line"><span class="comment"># 一对一反向查询</span></span><br><span class="line"><span class="comment"># 地址在北京的作者姓名</span></span><br><span class="line">author_detail=AuthorDatail.objects.<span class="built_in">filter</span>(addr=<span class="string">&#x27;北京&#x27;</span>).first()</span><br><span class="line">name=author_detail.author.name</span><br><span class="line"><span class="built_in">print</span>(name)</span><br></pre></td></tr></table></figure>

<h3 id="多对多查询-Author-与-Book"><a href="#多对多查询-Author-与-Book" class="headerlink" title="多对多查询 (Author 与 Book)"></a>多对多查询 (Author 与 Book)</h3><p>正向查询(按字段：authors)：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 眉所有作者的名字以及手机号</span></span><br><span class="line"> </span><br><span class="line">book_obj=Book.objects.<span class="built_in">filter</span>(title=<span class="string">&quot;眉&quot;</span>).first()</span><br><span class="line">authors=book_obj.authors.<span class="built_in">all</span>()</span><br><span class="line"><span class="keyword">for</span> author_obj <span class="keyword">in</span> authors:</span><br><span class="line">     <span class="built_in">print</span>(author_obj.name,author_obj.authorDetail.telephone)</span><br></pre></td></tr></table></figure>

<p>反向查询(按表名：book_set)：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询egon出过的所有书籍的名字</span></span><br><span class="line">  author_obj=Author.objects.get(name=<span class="string">&quot;egon&quot;</span>)</span><br><span class="line">  book_list=author_obj.book_set.<span class="built_in">all</span>()        <span class="comment">#与egon作者相关的所有书籍</span></span><br><span class="line">  <span class="keyword">for</span> book_obj <span class="keyword">in</span> book_list:</span><br><span class="line">    <span class="built_in">print</span>(book_obj.title)</span><br><span class="line"><span class="comment"># 正向查询----查询红楼梦所有作者名称</span></span><br><span class="line">book=Book.objects.<span class="built_in">filter</span>(name=<span class="string">&#x27;红楼梦&#x27;</span>).first()</span><br><span class="line">ret=book.authors.<span class="built_in">all</span>()</span><br><span class="line"><span class="built_in">print</span>(ret)</span><br><span class="line"><span class="keyword">for</span> auth <span class="keyword">in</span> ret:</span><br><span class="line"><span class="built_in">print</span>(auth.name)</span><br><span class="line"><span class="comment"># 反向查询 查询lqz这个作者写的所有书</span></span><br><span class="line">author=Author.objects.<span class="built_in">filter</span>(name=<span class="string">&#x27;lqz&#x27;</span>).first()</span><br><span class="line">ret=author.book_set.<span class="built_in">all</span>()</span><br><span class="line"><span class="built_in">print</span>(ret)</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong></p>
<p>你可以通过在 ForeignKey() 和ManyToManyField的定义中设置 related_name 的值来覆写 FOO_set 的名称。例如，如果 Article model 中做一下更改：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">publish</span> = ForeignKey(Book, related_name=<span class="string">&#x27;bookList&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>那么接下来就会如我们看到这般:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询 人民出版社出版过的所有书籍</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">publish</span>=Publish.objects.get(name=<span class="string">&quot;人民出版社&quot;</span>)</span><br><span class="line"><span class="attr">book_list</span>=publish.bookList.all()  <span class="comment"># 与人民出版社关联的所有书籍对象集合</span></span><br></pre></td></tr></table></figure>

<h2 id="四-基于双下划线的跨表查询"><a href="#四-基于双下划线的跨表查询" class="headerlink" title="四 基于双下划线的跨表查询"></a>四 基于双下划线的跨表查询</h2><p>Django 还提供了一种直观而高效的方式在查询(lookups)中表示关联关系，它能自动确认 SQL JOIN 联系。要做跨关系查询，就使用两个下划线来链接模型(model)间关联字段的名称，直到最终链接到你想要的model 为止。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">正向查询按字段,反向查询按表名小写用来告诉ORM引擎join哪张表</span><br><span class="line">&#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="一对多查询"><a href="#一对多查询" class="headerlink" title="一对多查询"></a>一对多查询</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 练习:  查询苹果出版社出版过的所有书籍的名字与价格(一对多)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 正向查询 按字段:publish</span></span><br><span class="line"></span><br><span class="line">queryResult=Book.objects.<span class="built_in">filter</span>(publish__name=<span class="string">&quot;苹果出版社&quot;</span>).values_list(<span class="string">&quot;title&quot;</span>,<span class="string">&quot;price&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 反向查询 按表名:book</span></span><br><span class="line">queryResult=Publish.objects.<span class="built_in">filter</span>(name=<span class="string">&quot;苹果出版社&quot;</span>).values_list(<span class="string">&quot;book__title&quot;</span>,<span class="string">&quot;book__price&quot;</span>)</span><br><span class="line">查询的本质一样，就是select <span class="keyword">from</span>的表不一样</span><br><span class="line"><span class="comment"># 正向查询按字段，反向查询按表名小写</span></span><br><span class="line"><span class="comment"># 查询红楼梦这本书出版社的名字</span></span><br><span class="line"><span class="comment"># select * from app01_book inner join app01_publish</span></span><br><span class="line"><span class="comment"># on app01_book.publish_id=app01_publish.nid</span></span><br><span class="line">ret=Book.objects.<span class="built_in">filter</span>(name=<span class="string">&#x27;红楼梦&#x27;</span>).values(<span class="string">&#x27;publish__name&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(ret)</span><br><span class="line">ret=Publish.objects.<span class="built_in">filter</span>(book__name=<span class="string">&#x27;红楼梦&#x27;</span>).values(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(ret)</span><br></pre></td></tr></table></figure>

<h3 id="多对多查询"><a href="#多对多查询" class="headerlink" title="多对多查询"></a>多对多查询</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 练习: 查询lqz出过的所有书籍的名字(多对多)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 正向查询 按字段:authors:</span></span><br><span class="line">queryResult=Book.objects.<span class="built_in">filter</span>(authors__name=<span class="string">&quot;lqz&quot;</span>).values_list(<span class="string">&quot;title&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 反向查询 按表名:book</span></span><br><span class="line">queryResult=Author.objects.<span class="built_in">filter</span>(name=<span class="string">&quot;lqz&quot;</span>).values_list(<span class="string">&quot;book__title&quot;</span>,<span class="string">&quot;book__price&quot;</span>)</span><br><span class="line"><span class="comment"># 正向查询按字段，反向查询按表名小写</span></span><br><span class="line"><span class="comment"># 查询红楼梦这本书出版社的名字</span></span><br><span class="line"><span class="comment"># select * from app01_book inner join app01_publish</span></span><br><span class="line"><span class="comment"># on app01_book.publish_id=app01_publish.nid</span></span><br><span class="line">ret=Book.objects.<span class="built_in">filter</span>(name=<span class="string">&#x27;红楼梦&#x27;</span>).values(<span class="string">&#x27;publish__name&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(ret)</span><br><span class="line">ret=Publish.objects.<span class="built_in">filter</span>(book__name=<span class="string">&#x27;红楼梦&#x27;</span>).values(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(ret)</span><br><span class="line"><span class="comment"># sql 语句就是from的表不一样</span></span><br><span class="line"><span class="comment"># -------多对多正向查询</span></span><br><span class="line"><span class="comment"># 查询红楼梦所有的作者</span></span><br><span class="line">ret=Book.objects.<span class="built_in">filter</span>(name=<span class="string">&#x27;红楼梦&#x27;</span>).values(<span class="string">&#x27;authors__name&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(ret)</span><br><span class="line"><span class="comment"># ---多对多反向查询</span></span><br><span class="line">ret=Author.objects.<span class="built_in">filter</span>(book__name=<span class="string">&#x27;红楼梦&#x27;</span>).values(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">ret=Author.objects.<span class="built_in">filter</span>(book__name=<span class="string">&#x27;红楼梦&#x27;</span>).values(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;author_detail__addr&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(ret)</span><br></pre></td></tr></table></figure>

<h3 id="一对一查询"><a href="#一对一查询" class="headerlink" title="一对一查询"></a>一对一查询</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询alex的手机号</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 正向查询</span></span><br><span class="line">ret=Author.objects.<span class="built_in">filter</span>(name=<span class="string">&quot;lqz&quot;</span>).values(<span class="string">&quot;authordetail__telephone&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 反向查询</span></span><br><span class="line">ret=AuthorDetail.objects.<span class="built_in">filter</span>(author__name=<span class="string">&quot;lqz&quot;</span>).values(<span class="string">&quot;telephone&quot;</span>)</span><br><span class="line"><span class="comment"># 查询lqz的手机号</span></span><br><span class="line"><span class="comment"># 正向查</span></span><br><span class="line">ret=Author.objects.<span class="built_in">filter</span>(name=<span class="string">&#x27;lqz&#x27;</span>).values(<span class="string">&#x27;author_detail__telephone&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(ret)</span><br><span class="line"><span class="comment"># 反向查</span></span><br><span class="line">ret= AuthorDatail.objects.<span class="built_in">filter</span>(author__name=<span class="string">&#x27;lqz&#x27;</span>).values(<span class="string">&#x27;telephone&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(ret)</span><br></pre></td></tr></table></figure>

<h3 id="进阶练习-连续跨表"><a href="#进阶练习-连续跨表" class="headerlink" title="进阶练习(连续跨表)"></a>进阶练习(连续跨表)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 练习: 查询人民出版社出版过的所有书籍的名字以及作者的姓名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 正向查询</span></span><br><span class="line">queryResult=Book.objects.<span class="built_in">filter</span>(publish__name=<span class="string">&quot;人民出版社&quot;</span>).values_list(<span class="string">&quot;title&quot;</span>,<span class="string">&quot;authors__name&quot;</span>)</span><br><span class="line"><span class="comment"># 反向查询</span></span><br><span class="line">queryResult=Publish.objects.<span class="built_in">filter</span>(name=<span class="string">&quot;人民出版社&quot;</span>).values_list(<span class="string">&quot;book__title&quot;</span>,<span class="string">&quot;book__authors__age&quot;</span>,<span class="string">&quot;book__authors__name&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 练习: 手机号以151开头的作者出版过的所有书籍名称以及出版社名称</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式1:</span></span><br><span class="line">queryResult=Book.objects.<span class="built_in">filter</span>(authors__authorDetail__telephone__regex=<span class="string">&quot;151&quot;</span>).values_list(<span class="string">&quot;title&quot;</span>,<span class="string">&quot;publish__name&quot;</span>)</span><br><span class="line"><span class="comment"># 方式2:    </span></span><br><span class="line">ret=Author.objects.<span class="built_in">filter</span>(authordetail__telephone__startswith=<span class="string">&quot;151&quot;</span>).values(<span class="string">&quot;book__title&quot;</span>,<span class="string">&quot;book__publish__name&quot;</span>)</span><br><span class="line"><span class="comment"># ----进阶练习，连续跨表</span></span><br><span class="line"><span class="comment"># 查询手机号以33开头的作者出版过的书籍名称以及书籍出版社名称</span></span><br><span class="line"><span class="comment"># author_datail author book publish</span></span><br><span class="line"><span class="comment"># 基于authorDatail表</span></span><br><span class="line"></span><br><span class="line">ret=AuthorDatail.objects.<span class="built_in">filter</span>(telephone__startswith=<span class="string">&#x27;33&#x27;</span>).values(<span class="string">&#x27;author__book__name&#x27;</span>,<span class="string">&#x27;author__book__publish__name&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(ret)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基于Author表</span></span><br><span class="line"> ret=Author.objects.<span class="built_in">filter</span>(author_detail__telephone__startswith=<span class="number">33</span>).values(<span class="string">&#x27;book__name&#x27;</span>,<span class="string">&#x27;book__publish__name&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(ret)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基于Book表</span></span><br><span class="line">ret=Book.objects.<span class="built_in">filter</span>(authors__author_detail__telephone__startswith=<span class="string">&#x27;33&#x27;</span>).values(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;publish__name&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(ret)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基于Publish表  </span></span><br><span class="line">ret=Publish.objects.<span class="built_in">filter</span>(book__authors__author_detail__telephone__startswith=<span class="string">&#x27;33&#x27;</span>).values(<span class="string">&#x27;book__name&#x27;</span>,<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(ret)</span><br></pre></td></tr></table></figure>

<h3 id="related-name"><a href="#related-name" class="headerlink" title="related_name"></a>related_name</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">publish = ForeignKey(Blog, related_name=<span class="string">&#x27;bookList&#x27;</span>)</span><br><span class="line"><span class="comment"># 练习: 查询人民出版社出版过的所有书籍的名字与价格(一对多)</span></span><br><span class="line"><span class="comment"># 反向查询 不再按表名:book,而是related_name:bookList</span></span><br><span class="line">queryResult=Publish.objects.<span class="built_in">filter</span>(name=<span class="string">&quot;人民出版社&quot;</span>).values_list(<span class="string">&quot;bookList__title&quot;</span>,<span class="string">&quot;bookList__price&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>反向查询时，如果定义了related_name ，则用related_name替换表名</p>
<h2 id="五-聚合查询与分组查询"><a href="#五-聚合查询与分组查询" class="headerlink" title="五 聚合查询与分组查询"></a>五 聚合查询与分组查询</h2><h3 id="聚合"><a href="#聚合" class="headerlink" title="聚合"></a>聚合</h3><p><code>aggregate</code>(*args, **kwargs)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 计算所有图书的平均价格</span></span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Avg</span><br><span class="line">Book.objects.<span class="built_in">all</span>().aggregate(Avg(<span class="string">&#x27;price&#x27;</span>))</span><br><span class="line"><span class="comment">#&#123;&#x27;price__avg&#x27;: 34.35&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>aggregate()</code>是<code>QuerySet</code> 的一个终止子句，意思是说，它返回一个包含一些键值对的字典。键的名称是聚合值的标识符，值是计算出来的聚合值。键的名称是按照字段和聚合函数的名称自动生成出来的。如果你想要为聚合值指定一个名称，可以向聚合子句提供它。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Book.objects.aggregate(average_price=Avg(<span class="string">&#x27;price&#x27;</span>))</span><br><span class="line"><span class="comment">#&#123;&#x27;average_price&#x27;: 34.35&#125;</span></span><br></pre></td></tr></table></figure>

<p>如果你希望生成不止一个聚合，你可以向<code>aggregate()</code>子句中添加另一个参数。所以，如果你也想知道所有图书价格的最大值和最小值，可以这样查询：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Avg, Max, Min</span><br><span class="line">Book.objects.aggregate(Avg(<span class="string">&#x27;price&#x27;</span>), Max(<span class="string">&#x27;price&#x27;</span>), Min(<span class="string">&#x27;price&#x27;</span>))</span><br><span class="line"><span class="comment">#&#123;&#x27;price__avg&#x27;: 34.35, &#x27;price__max&#x27;: Decimal(&#x27;81.20&#x27;), &#x27;price__min&#x27;: Decimal(&#x27;12.99&#x27;)&#125;</span></span><br><span class="line"><span class="comment"># 查询所有书籍的平均价格</span></span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Avg,Count,Max,Min</span><br><span class="line">ret=Book.objects.<span class="built_in">all</span>().aggregate(Avg(<span class="string">&#x27;price&#x27;</span>))</span><br><span class="line"><span class="comment"># &#123;&#x27;price__avg&#x27;: 202.896&#125;</span></span><br><span class="line"><span class="comment"># 可以改名字</span></span><br><span class="line">ret=Book.objects.<span class="built_in">all</span>().aggregate(avg_price=Avg(<span class="string">&#x27;price&#x27;</span>))</span><br><span class="line"><span class="comment"># 统计平均价格和最大价格</span></span><br><span class="line">ret=Book.objects.<span class="built_in">all</span>().aggregate(avg_price=Avg(<span class="string">&#x27;price&#x27;</span>),max_price=Max(<span class="string">&#x27;price&#x27;</span>))</span><br><span class="line"><span class="comment"># 统计最小价格</span></span><br><span class="line">ret = Book.objects.<span class="built_in">all</span>().aggregate(avg_price=Avg(<span class="string">&#x27;price&#x27;</span>), min_price=Min(<span class="string">&#x27;price&#x27;</span>))</span><br><span class="line"><span class="comment"># 统计个数和平均价格</span></span><br><span class="line">ret = Book.objects.<span class="built_in">all</span>().aggregate(avg_price=Avg(<span class="string">&#x27;price&#x27;</span>), max_price=Max(<span class="string">&#x27;price&#x27;</span>),count=Count(<span class="string">&#x27;price&#x27;</span>))</span><br><span class="line">ret = Book.objects.<span class="built_in">all</span>().aggregate(avg_price=Avg(<span class="string">&#x27;price&#x27;</span>), max_price=Max(<span class="string">&#x27;price&#x27;</span>),count=Count(<span class="string">&#x27;nid&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(ret)</span><br></pre></td></tr></table></figure>

<h3 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h3><p>annotate()为调用的<code>QuerySet</code>中每一个对象都生成一个独立的统计值（统计方法用聚合函数）。</p>
<p>总结 ：跨表分组查询本质就是将关联表join成一张表，再按单表的思路进行分组查询。　</p>
<h3 id="查询练习"><a href="#查询练习" class="headerlink" title="查询练习"></a>查询练习</h3><p>练习：统计每一本书作者个数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Avg, Max, Sum, Min, Max, Count</span><br><span class="line">book_list = models.Book.objects.<span class="built_in">all</span>().annotate(author_num=Count(<span class="string">&quot;authors&quot;</span>))</span><br><span class="line"><span class="keyword">for</span> book <span class="keyword">in</span> book_list:</span><br><span class="line">     <span class="built_in">print</span>(book.name)</span><br><span class="line">     <span class="built_in">print</span>(book.author_num)</span><br><span class="line">book_list = models.Book.objects.<span class="built_in">all</span>().annotate(author_num=Count(<span class="string">&quot;authors&quot;</span>)).values(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;author_num&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(book_list)</span><br></pre></td></tr></table></figure>

<p>练习：统计每一个出版社的最便宜的书</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">publishList=Publish.objects.annotate(MinPrice=Min(<span class="string">&quot;book__price&quot;</span>))</span><br><span class="line"><span class="keyword">for</span> publish_obj <span class="keyword">in</span> publishList:</span><br><span class="line">    <span class="built_in">print</span>(publish_obj.name,publish_obj.MinPrice)</span><br></pre></td></tr></table></figure>

<p>annotate的返回值是querySet，如果不想遍历对象，可以用上valuelist：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">queryResult= Publish.objects.annotate(MinPrice=Min(<span class="string">&quot;book__price&quot;</span>)).values_list(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;MinPrice&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(queryResult)</span><br></pre></td></tr></table></figure>

<p>练习：统计每一本以py开头的书籍的作者个数：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">queryResult=Book<span class="selector-class">.objects</span><span class="selector-class">.filter</span>(title__startswith=<span class="string">&quot;Py&quot;</span>)<span class="selector-class">.annotate</span>(num_authors=<span class="built_in">Count</span>(<span class="string">&#x27;authors&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>练习：统计不止一个作者的图书：（作者数量大于一）</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ret=models<span class="selector-class">.Book</span><span class="selector-class">.objects</span><span class="selector-class">.annotate</span>(author_num=<span class="built_in">Count</span>(<span class="string">&quot;authors&quot;</span>))<span class="selector-class">.filter</span>(author_num__gt=<span class="number">1</span>)<span class="selector-class">.values</span>(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;author_num&#x27;</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(ret)</span></span></span><br></pre></td></tr></table></figure>

<p>练习：根据一本图书作者数量的多少对查询集 <code>QuerySet</code>进行排序:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Book<span class="selector-class">.objects</span><span class="selector-class">.annotate</span>(num_authors=<span class="built_in">Count</span>(<span class="string">&#x27;authors&#x27;</span>))<span class="selector-class">.order_by</span>(<span class="string">&#x27;num_authors&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>练习：查询各个作者出的书的总价格:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ret=models<span class="selector-class">.Author</span><span class="selector-class">.objects</span><span class="selector-class">.annotate</span>(sum_price=<span class="built_in">Sum</span>(<span class="string">&quot;book__price&quot;</span>))<span class="selector-class">.values</span>(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;sum_price&quot;</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(ret)</span></span></span><br></pre></td></tr></table></figure>

<p>练习：查询每个出版社的名称和书籍个数</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">ret=models.Publish.objects.<span class="keyword">all</span>().annotate(c=Count(<span class="string">&#x27;book__name&#x27;</span>)).<span class="keyword">values</span>(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">print(ret)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">       查询每一个部门名称以及对应的员工数</span></span><br><span class="line"><span class="string">       book:</span></span><br><span class="line"><span class="string">       id  name   price      publish</span></span><br><span class="line"><span class="string">        1   金品   11.2        1</span></span><br><span class="line"><span class="string">        2   西游   14.2        2</span></span><br><span class="line"><span class="string">        3   东游   16.2        2</span></span><br><span class="line"><span class="string">        4   北邮   19.2        3</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    # 示例一：查询每一个出版社id，以及出书平均价格</span><br><span class="line">    # <span class="keyword">select</span> publish_id,avg(price) <span class="keyword">from</span> app01_book <span class="keyword">group</span> <span class="keyword">by</span> publish_id;</span><br><span class="line">    # annotate</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    #  annotate() 内写聚合函数</span><br><span class="line">    #  <span class="keyword">values</span>在前表示<span class="keyword">group</span> <span class="keyword">by</span>的字段</span><br><span class="line">    #  <span class="keyword">values</span>在后表示取某几个字段</span><br><span class="line">    #  <span class="keyword">filter</span>在前表示<span class="keyword">where</span></span><br><span class="line">    #  <span class="keyword">filter</span>在后表示<span class="keyword">having</span></span><br><span class="line">    # <span class="keyword">from</span> django.db.models <span class="keyword">import</span> Avg, Count, Max, Min</span><br><span class="line">    # ret=models.Book.objects.<span class="keyword">values</span>(<span class="string">&#x27;publish_id&#x27;</span>).annotate(avg=Avg(<span class="string">&#x27;price&#x27;</span>)).<span class="keyword">values</span>(<span class="string">&#x27;publish_id&#x27;</span>,<span class="string">&#x27;avg&#x27;</span>)</span><br><span class="line">    # print(ret)</span><br><span class="line"></span><br><span class="line">    # 查询出版社id大于<span class="number">1</span>的出版社id，以及出书平均价格</span><br><span class="line">    #<span class="keyword">select</span> publish_id,avg(price) <span class="keyword">from</span> app01_book <span class="keyword">where</span> publish_id&gt;<span class="number">1</span> <span class="keyword">group</span> <span class="keyword">by</span> publish_id;</span><br><span class="line"></span><br><span class="line">    # ret=models.Book.objects.<span class="keyword">values</span>(<span class="string">&#x27;publish_id&#x27;</span>).<span class="keyword">filter</span>(publish_id__gt=<span class="number">1</span>).annotate(avg=Avg(<span class="string">&#x27;price&#x27;</span>)).<span class="keyword">values</span>(<span class="string">&#x27;publish_id&#x27;</span>,<span class="string">&#x27;avg&#x27;</span>)</span><br><span class="line">    # print(ret)</span><br><span class="line"></span><br><span class="line">    # 查询出版社id大于<span class="number">1</span>的出版社id，以及出书平均价格大于<span class="number">30</span>的</span><br><span class="line">    # <span class="keyword">select</span> publish_id,avg(price)<span class="keyword">as</span> aaa <span class="keyword">from</span> app01_book <span class="keyword">where</span> publish_id&gt;<span class="number">1</span> <span class="keyword">group</span> <span class="keyword">by</span> publish_id <span class="keyword">HAVING</span> aaa&gt;<span class="number">30</span>;</span><br><span class="line">    # ret = models.Book.objects.<span class="keyword">values</span>(<span class="string">&#x27;publish_id&#x27;</span>).<span class="keyword">filter</span>(publish_id__gt=<span class="number">1</span>).annotate(avg=Avg(<span class="string">&#x27;price&#x27;</span>)).<span class="keyword">filter</span>(avg__gt=<span class="number">30</span>).<span class="keyword">values</span>(</span><br><span class="line">    #     <span class="string">&#x27;publish_id&#x27;</span>, <span class="string">&#x27;avg&#x27;</span>)</span><br><span class="line">    # print(ret)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ## 查询每一个出版社出版的书籍个数</span><br><span class="line">    # pk 代指主键</span><br><span class="line"></span><br><span class="line">    # ret=models.Book.objects.<span class="keyword">get</span>(pk=<span class="number">1</span>)</span><br><span class="line">    # print(ret.name)</span><br><span class="line">    # ret=models.Publish.objects.<span class="keyword">values</span>(<span class="string">&#x27;pk&#x27;</span>).annotate(count=Count(<span class="string">&#x27;book__id&#x27;</span>)).<span class="keyword">values</span>(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;count&#x27;</span>)</span><br><span class="line">    # print(ret)</span><br><span class="line">    # 如果没有指定<span class="keyword">group</span> <span class="keyword">by</span>的字段，默认就用基表（Publish）主键字段作为<span class="keyword">group</span> <span class="keyword">by</span>的字段</span><br><span class="line">    # ret=models.Publish.objects.annotate(count=Count(<span class="string">&#x27;book__id&#x27;</span>)).<span class="keyword">values</span>(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;count&#x27;</span>)</span><br><span class="line">    # print(ret)</span><br><span class="line"></span><br><span class="line">    # 另一种方式实现</span><br><span class="line">    # ret=models.Book.objects.<span class="keyword">values</span>(<span class="string">&#x27;publish&#x27;</span>).annotate(count=Count(<span class="string">&#x27;id&#x27;</span>)).<span class="keyword">values</span>(<span class="string">&#x27;publish__name&#x27;</span>,<span class="string">&#x27;count&#x27;</span>)</span><br><span class="line">    # print(ret)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    #查询每个作者的名字，以及出版过书籍的最高价格(建议使用分组的表作为基表)</span><br><span class="line">    # 如果不用分组的表作为基表，数据不完整可能会出现问题</span><br><span class="line">    # ret=models.Author.objects.<span class="keyword">values</span>(<span class="string">&#x27;pk&#x27;</span>).annotate(max=Max(<span class="string">&#x27;book__price&#x27;</span>)).<span class="keyword">values</span>(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;max&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    # ret = models.Author.objects.annotate(max=Max(<span class="string">&#x27;book__price&#x27;</span>)).<span class="keyword">values</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;max&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    # ret= models.Book.objects.<span class="keyword">values</span>(<span class="string">&#x27;authors__id&#x27;</span>).annotate(max=Max(<span class="string">&#x27;price&#x27;</span>)).<span class="keyword">values</span>(<span class="string">&#x27;authors__name&#x27;</span>,<span class="string">&#x27;max&#x27;</span>)</span><br><span class="line">    # print(ret)</span><br><span class="line"></span><br><span class="line">    #查询每一个书籍的名称，以及对应的作者个数</span><br><span class="line"></span><br><span class="line">    # ret=models.Book.objects.<span class="keyword">values</span>(<span class="string">&#x27;pk&#x27;</span>).annotate(count=Count(<span class="string">&#x27;authors__id&#x27;</span>)).<span class="keyword">values</span>(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;count&#x27;</span>)</span><br><span class="line">    # ret=models.Book.objects.annotate(count=Count(<span class="string">&#x27;authors__id&#x27;</span>)).<span class="keyword">values</span>(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;count&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    # ret=models.Author.objects.<span class="keyword">values</span>(<span class="string">&#x27;book__id&#x27;</span>).annotate(count=Count(<span class="string">&#x27;id&#x27;</span>)).<span class="keyword">values</span>(<span class="string">&#x27;book__name&#x27;</span>,<span class="string">&#x27;count&#x27;</span>)</span><br><span class="line">    #</span><br><span class="line">    # print(ret)</span><br><span class="line"></span><br><span class="line">    #统计不止一个作者的图书</span><br><span class="line">    # ret=models.Book.objects.<span class="keyword">values</span>(<span class="string">&#x27;pk&#x27;</span>).annotate(count=Count(<span class="string">&#x27;authors__id&#x27;</span>)).<span class="keyword">filter</span>(count__gt=<span class="number">1</span>).<span class="keyword">values</span>(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;count&#x27;</span>)</span><br><span class="line">    # ret = models.Author.objects.<span class="keyword">values</span>(<span class="string">&#x27;book__id&#x27;</span>).annotate(count=Count(<span class="string">&#x27;id&#x27;</span>)).<span class="keyword">filter</span>(count__gt=<span class="number">1</span>).<span class="keyword">values</span>(<span class="string">&#x27;book__name&#x27;</span>, <span class="string">&#x27;count&#x27;</span>)</span><br><span class="line">    # print(ret)</span><br><span class="line"></span><br><span class="line">    # 统计价格数大于<span class="number">10</span>元，作者的图书</span><br><span class="line">    ret = models.Book.objects.<span class="keyword">values</span>(<span class="string">&#x27;pk&#x27;</span>).<span class="keyword">filter</span>(price__gt=<span class="number">10</span>).annotate(count=Count(<span class="string">&#x27;authors__id&#x27;</span>)).<span class="keyword">values</span>(<span class="string">&#x27;name&#x27;</span>,</span><br><span class="line">                                                                                                           <span class="string">&#x27;count&#x27;</span>)</span><br><span class="line">    print(ret)</span><br><span class="line"></span><br><span class="line">    #统计价格数大于<span class="number">10</span>元，作者个数大于<span class="number">1</span>的图书</span><br><span class="line">    ret = models.Book.objects.<span class="keyword">values</span>(<span class="string">&#x27;pk&#x27;</span>).<span class="keyword">filter</span>(price__gt=<span class="number">10</span>).annotate(count=Count(<span class="string">&#x27;authors__id&#x27;</span>)).<span class="keyword">filter</span>(count__gt=<span class="number">1</span>).<span class="keyword">values</span>(<span class="string">&#x27;name&#x27;</span>,                                                                                                    <span class="string">&#x27;count&#x27;</span>)</span><br><span class="line">    print(ret)</span><br></pre></td></tr></table></figure>

<h2 id="六-F查询与Q查询"><a href="#六-F查询与Q查询" class="headerlink" title="六 F查询与Q查询"></a>六 F查询与Q查询</h2><h3 id="F查询"><a href="#F查询" class="headerlink" title="F查询"></a>F查询</h3><p>在上面所有的例子中，我们构造的过滤器都只是将字段值与某个常量做比较。如果我们要对两个字段的值做比较，那该怎么做呢？</p>
<p>Django 提供 F() 来做这样的比较。F() 的实例可以在查询中引用字段，来比较同一个 model 实例中两个不同字段的值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询评论数大于收藏数的书籍</span></span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> F</span><br><span class="line">Book.objects.<span class="built_in">filter</span>(commnetNum__lt=F(<span class="string">&#x27;keepNum&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>Django 支持 F() 对象之间以及 F() 对象和常数之间的加减乘除和取模的操作。</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询评论数大于收藏数2倍的书籍</span></span><br><span class="line">Book.objects.<span class="built_in">filter</span>(commnetNum__lt=F(<span class="string">&#x27;keepNum&#x27;</span>)*<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p>修改操作也可以使用F函数,比如将每一本书的价格提高30元：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Book<span class="selector-class">.objects</span><span class="selector-class">.all</span>()<span class="selector-class">.update</span>(price=<span class="built_in">F</span>(<span class="string">&quot;price&quot;</span>)+<span class="number">30</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Q查询"><a href="#Q查询" class="headerlink" title="Q查询"></a>Q查询</h3><p><code>filter()</code> 等方法中的关键字参数查询都是一起进行“AND” 的。 如果你需要执行更复杂的查询（例如<code>OR</code> 语句），你可以使用<code>Q 对象</code>。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">from django<span class="selector-class">.db</span><span class="selector-class">.models</span> import Q</span><br><span class="line"><span class="function"><span class="title">Q</span><span class="params">(title__startswith=<span class="string">&#x27;Py&#x27;</span>)</span></span></span><br></pre></td></tr></table></figure>

<p><code>Q</code> 对象可以使用<code>&amp;</code> 和<code>|</code> 操作符组合起来。当一个操作符在两个<code>Q</code> 对象上使用时，它产生一个新的<code>Q</code> 对象。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bookList=<span class="module-access"><span class="module"><span class="identifier">Book</span>.</span></span>objects.filter(<span class="constructor">Q(<span class="params">authors__name</span>=<span class="string">&quot;lqz&quot;</span>)</span><span class="pattern-match">|<span class="constructor">Q(<span class="params">authors__name</span>=<span class="string">&quot;egon&quot;</span>)</span>)</span></span><br></pre></td></tr></table></figure>

<p>等同于下面的SQL <code>WHERE</code> 子句：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WHERE</span> <span class="type">name</span> =&quot;lqz&quot; <span class="keyword">OR</span> <span class="type">name</span> =&quot;egon&quot;</span><br></pre></td></tr></table></figure>

<p>你可以组合<code>&amp;</code> 和<code>|</code> 操作符以及使用括号进行分组来编写任意复杂的<code>Q</code> 对象。同时，<code>Q</code> 对象可以使用<code>~</code> 操作符取反，这允许组合正常的查询和取反(<code>NOT</code>) 查询：</p>
<p>查询函数可以混合使用<code>Q 对象</code>和关键字参数。所有提供给查询函数的参数（关键字参数或<code>Q</code> 对象）都将”AND”在一起。但是，如果出现<code>Q</code> 对象，它必须位于所有关键字参数的前面。例如：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">bookList</span>=Book.objects.filter(Q(publishDate__year=2016) | Q(<span class="attribute">publishDate__year</span>=2017), <span class="attribute">title__icontains</span>=<span class="string">&quot;python&quot;</span>)</span><br><span class="line"><span class="comment"># 查询评论数大于阅读数的书籍</span></span><br><span class="line"><span class="keyword">from</span> django.db.models import F,Q</span><br><span class="line"><span class="comment"># select * from book where commit_num&gt;read_num;</span></span><br><span class="line"><span class="comment"># 这样肯定是不行的</span></span><br><span class="line"><span class="comment"># Book.objects.filter(commit_num__gt=read_num)</span></span><br><span class="line"><span class="attribute">ret</span>=Book.objects.filter(commit_num__gt=F(&#x27;reat_num&#x27;))</span><br><span class="line"><span class="built_in">print</span>(ret)</span><br><span class="line"><span class="comment"># 把所有书籍的价格加10</span></span><br><span class="line">Book.objects.all().update(<span class="attribute">price</span>=F(&#x27;price&#x27;)+10)</span><br><span class="line"><span class="comment"># ----Q函数，描述一个与，或，非的关系</span></span><br><span class="line"><span class="comment"># 查询名字叫红楼梦或者价格大于100的书</span></span><br><span class="line"><span class="attribute">ret</span>=Book.objects.filter(Q(name=&#x27;红楼梦&#x27;)|Q(price__gt=100))</span><br><span class="line"><span class="built_in">print</span>(ret)</span><br><span class="line"><span class="comment"># 查询名字叫红楼梦和价格大于100的书</span></span><br><span class="line">ret = Book.objects.filter(Q(<span class="attribute">name</span>=<span class="string">&#x27;红楼梦&#x27;</span>) &amp; Q(<span class="attribute">price__gt</span>=100))</span><br><span class="line"><span class="built_in">print</span>(ret)</span><br><span class="line"><span class="comment"># # 等同于</span></span><br><span class="line"><span class="attribute">ret2</span>=Book.objects.filter(name=&#x27;红楼梦&#x27;,price__gt=100)</span><br><span class="line"><span class="built_in">print</span>(ret2)</span><br><span class="line"><span class="comment"># 也可以Q套Q</span></span><br><span class="line"><span class="comment"># 查询名字叫红楼梦和价格大于100  或者 nid大于2</span></span><br><span class="line"><span class="attribute">ret</span>=Book.objects.filter((Q(name=&#x27;红楼梦&#x27;) &amp; Q(<span class="attribute">price__gt</span>=100))|Q(nid__gt=2))</span><br><span class="line"><span class="built_in">print</span>(ret)</span><br><span class="line"><span class="comment"># ----非</span></span><br><span class="line"><span class="attribute">ret</span>=Book.objects.filter(~Q(name=&#x27;红楼梦&#x27;))</span><br><span class="line"><span class="built_in">print</span>(ret)</span><br><span class="line"><span class="comment"># Q和键值对联合使用，但是键值对必须放在Q的后面(描述的是一个且的关系)</span></span><br><span class="line"><span class="comment"># 查询名字不是红楼梦，并且价格大于100的书</span></span><br><span class="line"><span class="attribute">ret</span>=Book.objects.filter(~Q(name=&#x27;红楼梦&#x27;),price__gt=100)</span><br><span class="line"><span class="built_in">print</span>(ret)</span><br></pre></td></tr></table></figure>

<h2 id="七-查询练习"><a href="#七-查询练习" class="headerlink" title="七 查询练习"></a>七 查询练习</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">查找所有书名里包含红楼的书</span><br><span class="line">查找出版日期是2017年的书</span><br><span class="line">查找出版日期是2017年的书名</span><br><span class="line">查找价格大于10元的书</span><br><span class="line">查找价格大于10元的书名和价格</span><br><span class="line"></span><br><span class="line">查找在北京的出版社</span><br><span class="line">查找名字以沙河开头的出版社</span><br><span class="line"></span><br><span class="line">查找作者名字里面带“小”字的作者</span><br><span class="line">查找年龄大于30岁的作者</span><br><span class="line">查找手机号是155开头的作者</span><br><span class="line">查找手机号是155开头的作者的姓名和年龄</span><br><span class="line"></span><br><span class="line">查找书名是“红楼梦”的书的出版社</span><br><span class="line">查找书名是“红楼梦”的书的出版社所在的城市</span><br><span class="line">查找书名是“红楼梦”的书的出版社的名称</span><br><span class="line"></span><br><span class="line">查找书名是“红楼梦”的书的所有作者</span><br><span class="line">查找书名是“红楼梦”的书的作者的年龄</span><br><span class="line">查找书名是“红楼梦”的书的作者的手机号码</span><br><span class="line"></span><br><span class="line">查找书名是“红楼梦”的书的作者的地址</span><br><span class="line">查找书名是“红楼梦”的书的作者的邮箱</span><br></pre></td></tr></table></figure>

<h1 id="10-模型层常用非常用字段和参数"><a href="#10-模型层常用非常用字段和参数" class="headerlink" title="10-模型层常用非常用字段和参数"></a>10-模型层常用非常用字段和参数</h1><h2 id="1-ORM字段"><a href="#1-ORM字段" class="headerlink" title="1 ORM字段"></a>1 ORM字段</h2><h4 id="AutoField"><a href="#AutoField" class="headerlink" title="AutoField"></a>AutoField</h4><p>int自增列，必须填入参数 primary_key=True。当model中如果没有自增列，则自动会创建一个列名为id的列。</p>
<h4 id="IntegerField"><a href="#IntegerField" class="headerlink" title="IntegerField"></a>IntegerField</h4><p>一个整数类型,范围在 -2147483648 to 2147483647。</p>
<h4 id="CharField"><a href="#CharField" class="headerlink" title="CharField"></a>CharField</h4><p>字符类型，必须提供max_length参数， max_length表示字符长度。</p>
<h4 id="DateField"><a href="#DateField" class="headerlink" title="DateField"></a>DateField</h4><p>日期字段，日期格式 YYYY-MM-DD，相当于Python中的datetime.date()实例。</p>
<h4 id="DateTimeField"><a href="#DateTimeField" class="headerlink" title="DateTimeField"></a>DateTimeField</h4><p>日期时间字段，格式 YYYY-MM-DD HH:MM[:ss[.uuuuuu]][TZ]，相当于Python中的datetime.datetime()实例</p>
<h3 id="常用和非常用字段"><a href="#常用和非常用字段" class="headerlink" title="常用和非常用字段"></a>常用和非常用字段</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">AutoField(Field)</span><br><span class="line">- <span class="type">int</span>自增列，必须填入参数 primary_key=<span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">BigAutoField(AutoField)</span><br><span class="line">- <span class="type">bigint</span>自增列，必须填入参数 primary_key=<span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">注：当model中如果没有自增列，则自动会创建一个列名为id的列</span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> UserInfo(models.Model):</span><br><span class="line"># 自动创建一个列名为id的且为自增的整数列</span><br><span class="line">username = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="keyword">Group</span>(models.Model):</span><br><span class="line"># 自定义自增列</span><br><span class="line">nid = models.AutoField(primary_key=<span class="keyword">True</span>)</span><br><span class="line"><span class="type">name</span> = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">SmallIntegerField(IntegerField):</span><br><span class="line">- 小整数 <span class="number">-32768</span> ～ <span class="number">32767</span></span><br><span class="line"></span><br><span class="line">PositiveSmallIntegerField(PositiveIntegerRelDbTypeMixin, IntegerField)</span><br><span class="line">- 正小整数 <span class="number">0</span> ～ <span class="number">32767</span></span><br><span class="line">IntegerField(Field)</span><br><span class="line">- 整数列(有符号的) <span class="number">-2147483648</span> ～ <span class="number">2147483647</span></span><br><span class="line"></span><br><span class="line">PositiveIntegerField(PositiveIntegerRelDbTypeMixin, IntegerField)</span><br><span class="line">- 正整数 <span class="number">0</span> ～ <span class="number">2147483647</span></span><br><span class="line"></span><br><span class="line">BigIntegerField(IntegerField):</span><br><span class="line">- 长整型(有符号的) <span class="number">-9223372036854775808</span> ～ <span class="number">9223372036854775807</span></span><br><span class="line"></span><br><span class="line">BooleanField(Field)</span><br><span class="line">- 布尔值类型</span><br><span class="line"></span><br><span class="line">NullBooleanField(Field):</span><br><span class="line">- 可以为空的布尔值</span><br><span class="line"></span><br><span class="line">CharField(Field)</span><br><span class="line">- 字符类型</span><br><span class="line">- 必须提供max_length参数， max_length表示字符长度</span><br><span class="line"></span><br><span class="line">TextField(Field)</span><br><span class="line">- 文本类型</span><br><span class="line"></span><br><span class="line">EmailField(CharField)：</span><br><span class="line">- 字符串类型，Django <span class="keyword">Admin</span>以及ModelForm中提供验证机制</span><br><span class="line"></span><br><span class="line">IPAddressField(Field)</span><br><span class="line">- 字符串类型，Django <span class="keyword">Admin</span>以及ModelForm中提供验证 IPV4 机制</span><br><span class="line"></span><br><span class="line">GenericIPAddressField(Field)</span><br><span class="line">- 字符串类型，Django <span class="keyword">Admin</span>以及ModelForm中提供验证 Ipv4和Ipv6</span><br><span class="line">- 参数：</span><br><span class="line">protocol，用于指定Ipv4或Ipv6， <span class="string">&#x27;both&#x27;</span>,&quot;ipv4&quot;,&quot;ipv6&quot;</span><br><span class="line">unpack_ipv4， 如果指定为<span class="keyword">True</span>，则输入::ffff:<span class="number">192.0</span><span class="number">.2</span><span class="number">.1</span>时候，可解析为<span class="number">192.0</span><span class="number">.2</span><span class="number">.1</span>，开启此功能，需要protocol=&quot;both&quot;</span><br><span class="line"></span><br><span class="line">URLField(CharField)</span><br><span class="line">- 字符串类型，Django <span class="keyword">Admin</span>以及ModelForm中提供验证 URL</span><br><span class="line"></span><br><span class="line">SlugField(CharField)</span><br><span class="line">- 字符串类型，Django <span class="keyword">Admin</span>以及ModelForm中提供验证支持 字母、数字、下划线、连接符（减号）</span><br><span class="line"></span><br><span class="line">CommaSeparatedIntegerField(CharField)</span><br><span class="line">- 字符串类型，格式必须为逗号分割的数字</span><br><span class="line"></span><br><span class="line">UUIDField(Field)</span><br><span class="line">- 字符串类型，Django <span class="keyword">Admin</span>以及ModelForm中提供对<span class="type">UUID</span>格式的验证</span><br><span class="line"></span><br><span class="line">FilePathField(Field)</span><br><span class="line">- 字符串，Django <span class="keyword">Admin</span>以及ModelForm中提供读取文件夹下文件的功能</span><br><span class="line">- 参数：</span><br><span class="line"><span class="type">path</span>,                      文件夹路径</span><br><span class="line">match=<span class="keyword">None</span>,                正则匹配</span><br><span class="line"><span class="keyword">recursive</span>=<span class="keyword">False</span>,           递归下面的文件夹</span><br><span class="line">allow_files=<span class="keyword">True</span>,          允许文件</span><br><span class="line">allow_folders=<span class="keyword">False</span>,       允许文件夹</span><br><span class="line"></span><br><span class="line">FileField(Field)</span><br><span class="line">- 字符串，路径保存在数据库，文件上传到指定目录</span><br><span class="line">- 参数：</span><br><span class="line">upload_to = &quot;&quot;      上传文件的保存路径</span><br><span class="line">storage = <span class="keyword">None</span>      存储组件，默认django.core.files.<span class="keyword">storage</span>.FileSystemStorage</span><br><span class="line"></span><br><span class="line">ImageField(FileField)</span><br><span class="line">- 字符串，路径保存在数据库，文件上传到指定目录</span><br><span class="line">- 参数：</span><br><span class="line">upload_to = &quot;&quot;      上传文件的保存路径</span><br><span class="line">storage = <span class="keyword">None</span>      存储组件，默认django.core.files.<span class="keyword">storage</span>.FileSystemStorage</span><br><span class="line">width_field=<span class="keyword">None</span>,   上传图片的高度保存的数据库字段名（字符串）</span><br><span class="line">height_field=<span class="keyword">None</span>   上传图片的宽度保存的数据库字段名（字符串）</span><br><span class="line"></span><br><span class="line">DateTimeField(DateField)</span><br><span class="line">- 日期+时间格式 YYYY-MM-DD HH:MM[:ss[.uuuuuu]][TZ]</span><br><span class="line"></span><br><span class="line">DateField(DateTimeCheckMixin, Field)</span><br><span class="line">- 日期格式      YYYY-MM-DD</span><br><span class="line"></span><br><span class="line">TimeField(DateTimeCheckMixin, Field)</span><br><span class="line">- 时间格式      HH:MM[:ss[.uuuuuu]]</span><br><span class="line"></span><br><span class="line">DurationField(Field)</span><br><span class="line">- 长整数，时间间隔，数据库中按照<span class="type">bigint</span>存储，ORM中获取的值为datetime.timedelta类型</span><br><span class="line"></span><br><span class="line">FloatField(Field)</span><br><span class="line">- 浮点型</span><br><span class="line"></span><br><span class="line">DecimalField(Field)</span><br><span class="line">- <span class="number">10</span>进制小数</span><br><span class="line">- 参数：</span><br><span class="line">max_digits，小数总长度</span><br><span class="line">decimal_places，小数位长度</span><br><span class="line"></span><br><span class="line">BinaryField(Field)</span><br><span class="line">- 二进制类型</span><br><span class="line">对应关系：</span><br><span class="line">    <span class="string">&#x27;AutoField&#x27;</span>: <span class="string">&#x27;integer AUTO_INCREMENT&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BigAutoField&#x27;</span>: <span class="string">&#x27;bigint AUTO_INCREMENT&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BinaryField&#x27;</span>: <span class="string">&#x27;longblob&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BooleanField&#x27;</span>: <span class="string">&#x27;bool&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;CharField&#x27;</span>: <span class="string">&#x27;varchar(%(max_length)s)&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;CommaSeparatedIntegerField&#x27;</span>: <span class="string">&#x27;varchar(%(max_length)s)&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;DateField&#x27;</span>: <span class="string">&#x27;date&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;DateTimeField&#x27;</span>: <span class="string">&#x27;datetime&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;DecimalField&#x27;</span>: <span class="string">&#x27;numeric(%(max_digits)s, %(decimal_places)s)&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;DurationField&#x27;</span>: <span class="string">&#x27;bigint&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;FileField&#x27;</span>: <span class="string">&#x27;varchar(%(max_length)s)&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;FilePathField&#x27;</span>: <span class="string">&#x27;varchar(%(max_length)s)&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;FloatField&#x27;</span>: <span class="string">&#x27;double precision&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;IntegerField&#x27;</span>: <span class="string">&#x27;integer&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BigIntegerField&#x27;</span>: <span class="string">&#x27;bigint&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;IPAddressField&#x27;</span>: <span class="string">&#x27;char(15)&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;GenericIPAddressField&#x27;</span>: <span class="string">&#x27;char(39)&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;NullBooleanField&#x27;</span>: <span class="string">&#x27;bool&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;OneToOneField&#x27;</span>: <span class="string">&#x27;integer&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PositiveIntegerField&#x27;</span>: <span class="string">&#x27;integer UNSIGNED&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PositiveSmallIntegerField&#x27;</span>: <span class="string">&#x27;smallint UNSIGNED&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;SlugField&#x27;</span>: <span class="string">&#x27;varchar(%(max_length)s)&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;SmallIntegerField&#x27;</span>: <span class="string">&#x27;smallint&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;TextField&#x27;</span>: <span class="string">&#x27;longtext&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;TimeField&#x27;</span>: <span class="string">&#x27;time&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;UUIDField&#x27;</span>: <span class="string">&#x27;char(32)&#x27;</span>,</span><br></pre></td></tr></table></figure>

<h2 id="2-ORM字段参数"><a href="#2-ORM字段参数" class="headerlink" title="2 ORM字段参数"></a>2 ORM字段参数</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#### null</span></span><br><span class="line"></span><br><span class="line">用于表示某个字段可以为空。</span><br><span class="line"></span><br><span class="line"><span class="comment">#### **unique**</span></span><br><span class="line"></span><br><span class="line">如果设置为<span class="attribute">unique</span>=<span class="literal">True</span> 则该字段在此表中必须是唯一的 。</span><br><span class="line"></span><br><span class="line"><span class="comment">#### **db_index**</span></span><br><span class="line"></span><br><span class="line">如果<span class="attribute">db_index</span>=<span class="literal">True</span> 则代表着为此字段设置索引。</span><br><span class="line"></span><br><span class="line"><span class="comment">#### **default**</span></span><br><span class="line"></span><br><span class="line">为该字段设置默认值。</span><br><span class="line"></span><br><span class="line"><span class="comment">###  DateField和DateTimeField</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### auto_now_add</span></span><br><span class="line"></span><br><span class="line">配置<span class="attribute">auto_now_add</span>=<span class="literal">True</span>，创建数据记录的时候会把当前时间添加到数据库。</span><br><span class="line"></span><br><span class="line"><span class="comment">#### auto_now</span></span><br><span class="line"></span><br><span class="line">配置上<span class="attribute">auto_now</span>=<span class="literal">True</span>，每次更新数据记录的时候会更新该字段。</span><br><span class="line"><span class="literal">null</span>                数据库中字段是否可以为空</span><br><span class="line">db_column           数据库中字段的列名</span><br><span class="line">db_tablespace<span class="built_in"></span></span><br><span class="line"><span class="built_in">default </span>            数据库中字段的默认值</span><br><span class="line">primary_key         数据库中字段是否为主键</span><br><span class="line">db_index            数据库中字段是否可以建立索引</span><br><span class="line">unique              数据库中字段是否可以建立唯一索引</span><br><span class="line">unique_for_date     数据库中字段【日期】部分是否可以建立唯一索引</span><br><span class="line">unique_for_month    数据库中字段【月】部分是否可以建立唯一索引</span><br><span class="line">unique_for_year     数据库中字段【年】部分是否可以建立唯一索引</span><br><span class="line"></span><br><span class="line">verbose_name        Admin中显示的字段名称</span><br><span class="line">blank               Admin中是否允许用户输入为空</span><br><span class="line">editable            Admin中是否可以编辑</span><br><span class="line">help_text           Admin中该字段的提示信息</span><br><span class="line">choices             Admin中显示选择框的内容，用不变动的数据放在内存中从而避免跨表操作</span><br><span class="line">如：gf = models.IntegerField(choices=[(0, <span class="string">&#x27;何穗&#x27;</span>),(1, <span class="string">&#x27;大表姐&#x27;</span>),],<span class="attribute">default</span>=1)</span><br><span class="line"></span><br><span class="line">error_messages      自定义错误信息（字典类型），从而定制想要显示的错误信息；</span><br><span class="line">字典健：<span class="literal">null</span>, blank, invalid, invalid_choice, unique, <span class="keyword">and</span> unique_for_date</span><br><span class="line">如：&#123;<span class="string">&#x27;null&#x27;</span>: <span class="string">&quot;不能为空.&quot;</span>, <span class="string">&#x27;invalid&#x27;</span>: <span class="string">&#x27;格式错误&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">validators          自定义错误验证（列表类型），从而定制想要的验证规则</span><br><span class="line"><span class="keyword">from</span> django.core.validators import RegexValidator</span><br><span class="line"><span class="keyword">from</span> django.core.validators import EmailValidator,URLValidator,DecimalValidator,\</span><br><span class="line">MaxLengthValidator,MinLengthValidator,MaxValueValidator,MinValueValidator</span><br><span class="line">如：</span><br><span class="line">test = models.CharField(</span><br><span class="line"><span class="attribute">max_length</span>=32,</span><br><span class="line">error_messages=&#123;</span><br><span class="line"><span class="string">&#x27;c1&#x27;</span>: <span class="string">&#x27;优先错信息1&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;c2&#x27;</span>: <span class="string">&#x27;优先错信息2&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;c3&#x27;</span>: <span class="string">&#x27;优先错信息3&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line">validators=[</span><br><span class="line">RegexValidator(<span class="attribute">regex</span>=<span class="string">&#x27;root_\d+&#x27;</span>, <span class="attribute">message</span>=<span class="string">&#x27;错误了&#x27;</span>, <span class="attribute">code</span>=<span class="string">&#x27;c1&#x27;</span>),</span><br><span class="line">RegexValidator(<span class="attribute">regex</span>=<span class="string">&#x27;root_112233\d+&#x27;</span>, <span class="attribute">message</span>=<span class="string">&#x27;又错误了&#x27;</span>, <span class="attribute">code</span>=<span class="string">&#x27;c2&#x27;</span>),</span><br><span class="line">EmailValidator(<span class="attribute">message</span>=<span class="string">&#x27;又错误了&#x27;</span>, <span class="attribute">code</span>=<span class="string">&#x27;c3&#x27;</span>), ]</span><br><span class="line">                            )</span><br></pre></td></tr></table></figure>

<h2 id="3-关系字段"><a href="#3-关系字段" class="headerlink" title="3 关系字段"></a>3 关系字段</h2><h3 id="ForeignKey"><a href="#ForeignKey" class="headerlink" title="ForeignKey"></a>ForeignKey</h3><p>外键类型在ORM中用来表示外键关联关系，一般把ForeignKey字段设置在 ‘一对多’中’多’的一方。</p>
<p>ForeignKey可以和其他表做关联关系同时也可以和自身做关联关系。</p>
<h4 id="to"><a href="#to" class="headerlink" title="to"></a>to</h4><p>设置要关联的表</p>
<h4 id="to-field"><a href="#to-field" class="headerlink" title="to_field"></a>to_field</h4><p>设置要关联的表的字段</p>
<h4 id="related-name-1"><a href="#related-name-1" class="headerlink" title="related_name"></a>related_name</h4><p>反向操作时，使用的字段名，用于代替原反向查询时的’表名_set’。</p>
<p>例如：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="constructor">Classes(<span class="params">models</span>.Model)</span>:</span><br><span class="line">    name = models.<span class="constructor">CharField(<span class="params">max_length</span>=32)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="constructor">Student(<span class="params">models</span>.Model)</span>:</span><br><span class="line">    name = models.<span class="constructor">CharField(<span class="params">max_length</span>=32)</span></span><br><span class="line">    theclass = models.<span class="constructor">ForeignKey(<span class="params">to</span>=<span class="string">&quot;Classes&quot;</span>)</span></span><br></pre></td></tr></table></figure>

<p>当我们要查询某个班级关联的所有学生（反向查询）时，我们会这么写：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">models<span class="selector-class">.Classes</span><span class="selector-class">.objects</span><span class="selector-class">.first</span>()<span class="selector-class">.student_set</span><span class="selector-class">.all</span>()</span><br></pre></td></tr></table></figure>

<p>当我们在ForeignKey字段中添加了参数 related_name 后，</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="constructor">Student(<span class="params">models</span>.Model)</span>:</span><br><span class="line">    name = models.<span class="constructor">CharField(<span class="params">max_length</span>=32)</span></span><br><span class="line">    theclass = models.<span class="constructor">ForeignKey(<span class="params">to</span>=<span class="string">&quot;Classes&quot;</span>, <span class="params">related_name</span>=<span class="string">&quot;students&quot;</span>)</span></span><br></pre></td></tr></table></figure>

<p>当我们要查询某个班级关联的所有学生（反向查询）时，我们会这么写：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">models<span class="selector-class">.Classes</span><span class="selector-class">.objects</span><span class="selector-class">.first</span>()<span class="selector-class">.students</span><span class="selector-class">.all</span>()</span><br></pre></td></tr></table></figure>

<h4 id="related-query-name"><a href="#related-query-name" class="headerlink" title="related_query_name"></a><strong>related_query_name</strong></h4><p>反向查询操作时，使用的连接前缀，用于替换表名。</p>
<h4 id="on-delete"><a href="#on-delete" class="headerlink" title="on_delete"></a><strong>on_delete</strong></h4><p>　　当删除关联表中的数据时，当前表与其关联的行的行为。</p>
<p>　　<strong>models.CASCADE</strong><br>　　删除关联数据，与之关联也删除</p>
<p>　　<strong>models.DO_NOTHING</strong><br>　　删除关联数据，引发错误IntegrityError</p>
<p>　　<strong>models.PROTECT</strong><br>　　删除关联数据，引发错误ProtectedError</p>
<p>　　<strong>models.SET_NULL</strong><br>　　删除关联数据，与之关联的值设置为null（前提FK字段需要设置为可空）</p>
<p>　　<strong>models.SET_DEFAULT</strong><br>　　删除关联数据，与之关联的值设置为默认值（前提FK字段需要设置默认值）</p>
<p>　　<strong>models.SET</strong></p>
<p>　　删除关联数据，<br>　　a. 与之关联的值设置为指定值，设置：models.SET(值)<br>　　b. 与之关联的值设置为可执行对象的返回值，设置：models.SET(可执行对象)</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">def func():</span><br><span class="line">    return 10</span><br><span class="line"></span><br><span class="line">class MyModel(models.Model):</span><br><span class="line">   <span class="built_in"> user </span>= models.ForeignKey(</span><br><span class="line">        <span class="attribute">to</span>=<span class="string">&quot;User&quot;</span>,</span><br><span class="line">        <span class="attribute">to_field</span>=<span class="string">&quot;id&quot;</span>，</span><br><span class="line">        <span class="attribute">on_delete</span>=models.SET(func)</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<h4 id="db-constraint"><a href="#db-constraint" class="headerlink" title="db_constraint"></a>db_constraint</h4><p>是否在数据库中创建外键约束，默认为True。</p>
<h3 id="OneToOneField"><a href="#OneToOneField" class="headerlink" title="OneToOneField"></a>OneToOneField</h3><p>一对一字段。</p>
<p>通常一对一字段用来扩展已有字段。</p>
<p>一对一的关联关系多用在当一张表的不同字段查询频次差距过大的情况下，将本可以存储在一张表的字段拆开放置在两张表中，然后将两张表建立一对一的关联关系。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="constructor">Author(<span class="params">models</span>.Model)</span>:</span><br><span class="line">    name = models.<span class="constructor">CharField(<span class="params">max_length</span>=32)</span></span><br><span class="line">    info = models.<span class="constructor">OneToOneField(<span class="params">to</span>=&#x27;AuthorInfo&#x27;)</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="constructor">AuthorInfo(<span class="params">models</span>.Model)</span>:</span><br><span class="line">    phone = models.<span class="constructor">CharField(<span class="params">max_length</span>=11)</span></span><br><span class="line">    email = models.<span class="constructor">EmailField()</span></span><br></pre></td></tr></table></figure>

<h4 id="to-1"><a href="#to-1" class="headerlink" title="to"></a>to</h4><p>设置要关联的表。</p>
<h4 id="to-field-1"><a href="#to-field-1" class="headerlink" title="to_field"></a>to_field</h4><p>设置要关联的字段。</p>
<h4 id="on-delete-1"><a href="#on-delete-1" class="headerlink" title="on_delete"></a>on_delete</h4><p>同ForeignKey字段。</p>
<h3 id="ManyToManyField"><a href="#ManyToManyField" class="headerlink" title="ManyToManyField"></a>ManyToManyField</h3><p>用于表示多对多的关联关系。在数据库中通过第三张表来建立关联关系</p>
<h4 id="to-2"><a href="#to-2" class="headerlink" title="to"></a>to</h4><p>设置要关联的表</p>
<h4 id="related-name-2"><a href="#related-name-2" class="headerlink" title="related_name"></a>related_name</h4><p>同ForeignKey字段。</p>
<h4 id="related-query-name-1"><a href="#related-query-name-1" class="headerlink" title="related_query_name"></a>related_query_name</h4><p>同ForeignKey字段。</p>
<h4 id="symmetrical"><a href="#symmetrical" class="headerlink" title="symmetrical"></a>symmetrical</h4><p>仅用于多对多自关联时，指定内部是否创建反向操作的字段。默认为True。</p>
<p>举个例子：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="constructor">Person(<span class="params">models</span>.Model)</span>:</span><br><span class="line">    name = models.<span class="constructor">CharField(<span class="params">max_length</span>=16)</span></span><br><span class="line">    friends = models.<span class="constructor">ManyToManyField(<span class="string">&quot;self&quot;</span>)</span></span><br></pre></td></tr></table></figure>

<p>此时，person对象就没有person_set属性。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="constructor">Person(<span class="params">models</span>.Model)</span>:</span><br><span class="line">    name = models.<span class="constructor">CharField(<span class="params">max_length</span>=16)</span></span><br><span class="line">    friends = models.<span class="constructor">ManyToManyField(<span class="string">&quot;self&quot;</span>, <span class="params">symmetrical</span>=False)</span></span><br></pre></td></tr></table></figure>

<p>此时，person对象现在就可以使用person_set属性进行反向查询。</p>
<h4 id="through"><a href="#through" class="headerlink" title="through"></a>through</h4><p>在使用ManyToManyField字段时，Django将自动生成一张表来管理多对多的关联关系。</p>
<p>但我们也可以手动创建第三张表来管理多对多关系，此时就需要通过through来指定第三张表的表名。</p>
<h4 id="through-fields"><a href="#through-fields" class="headerlink" title="through_fields"></a><strong>through_fields</strong></h4><p>设置关联的字段。</p>
<h4 id="db-table"><a href="#db-table" class="headerlink" title="db_table"></a>db_table</h4><p>默认创建第三张表时，数据库中表的名称。</p>
<h2 id="4-多对多关联关系的三种方式"><a href="#4-多对多关联关系的三种方式" class="headerlink" title="4 多对多关联关系的三种方式"></a>4 多对多关联关系的三种方式</h2><h3 id="方式一：自行创建第三张表"><a href="#方式一：自行创建第三张表" class="headerlink" title="方式一：自行创建第三张表"></a>方式一：自行创建第三张表</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="constructor">Book(<span class="params">models</span>.Model)</span>:</span><br><span class="line">    title = models.<span class="constructor">CharField(<span class="params">max_length</span>=32, <span class="params">verbose_name</span>=<span class="string">&quot;书名&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="constructor">Author(<span class="params">models</span>.Model)</span>:</span><br><span class="line">    name = models.<span class="constructor">CharField(<span class="params">max_length</span>=32, <span class="params">verbose_name</span>=<span class="string">&quot;作者姓名&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 自己创建第三张表，分别通过外键关联书和作者</span><br><span class="line"><span class="keyword">class</span> <span class="constructor">Author2Book(<span class="params">models</span>.Model)</span>:</span><br><span class="line">    author = models.<span class="constructor">ForeignKey(<span class="params">to</span>=<span class="string">&quot;Author&quot;</span>)</span></span><br><span class="line">    book = models.<span class="constructor">ForeignKey(<span class="params">to</span>=<span class="string">&quot;Book&quot;</span>)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> Meta:</span><br><span class="line">        unique_together = (<span class="string">&quot;author&quot;</span>, <span class="string">&quot;book&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="方式二：通过ManyToManyField自动创建第三张表"><a href="#方式二：通过ManyToManyField自动创建第三张表" class="headerlink" title="方式二：通过ManyToManyField自动创建第三张表"></a>方式二：通过ManyToManyField自动创建第三张表</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="constructor">Book(<span class="params">models</span>.Model)</span>:</span><br><span class="line">    title = models.<span class="constructor">CharField(<span class="params">max_length</span>=32, <span class="params">verbose_name</span>=<span class="string">&quot;书名&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 通过ORM自带的ManyToManyField自动创建第三张表</span><br><span class="line"><span class="keyword">class</span> <span class="constructor">Author(<span class="params">models</span>.Model)</span>:</span><br><span class="line">    name = models.<span class="constructor">CharField(<span class="params">max_length</span>=32, <span class="params">verbose_name</span>=<span class="string">&quot;作者姓名&quot;</span>)</span></span><br><span class="line">    books = models.<span class="constructor">ManyToManyField(<span class="params">to</span>=<span class="string">&quot;Book&quot;</span>, <span class="params">related_name</span>=<span class="string">&quot;authors&quot;</span>)</span></span><br></pre></td></tr></table></figure>

<h3 id="方式三：设置ManyTomanyField并指定自行创建的第三张表"><a href="#方式三：设置ManyTomanyField并指定自行创建的第三张表" class="headerlink" title="方式三：设置ManyTomanyField并指定自行创建的第三张表"></a>方式三：设置ManyTomanyField并指定自行创建的第三张表</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="constructor">Book(<span class="params">models</span>.Model)</span>:</span><br><span class="line">    title = models.<span class="constructor">CharField(<span class="params">max_length</span>=32, <span class="params">verbose_name</span>=<span class="string">&quot;书名&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 自己创建第三张表，并通过ManyToManyField指定关联</span><br><span class="line"><span class="keyword">class</span> <span class="constructor">Author(<span class="params">models</span>.Model)</span>:</span><br><span class="line">    name = models.<span class="constructor">CharField(<span class="params">max_length</span>=32, <span class="params">verbose_name</span>=<span class="string">&quot;作者姓名&quot;</span>)</span></span><br><span class="line">    books = models.<span class="constructor">ManyToManyField(<span class="params">to</span>=<span class="string">&quot;Book&quot;</span>, <span class="params">through</span>=<span class="string">&quot;Author2Book&quot;</span>, <span class="params">through_fields</span>=(<span class="string">&quot;author&quot;</span>, <span class="string">&quot;book&quot;</span>)</span>)</span><br><span class="line">    # through_fields接受一个<span class="number">2</span>元组（&#x27;field1<span class="character">&#x27;，&#x27;</span>field2&#x27;）：</span><br><span class="line">    # 其中field1是定义ManyToManyField的模型外键的名（author），field2是关联目标模型（book）的外键名。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="constructor">Author2Book(<span class="params">models</span>.Model)</span>:</span><br><span class="line">    author = models.<span class="constructor">ForeignKey(<span class="params">to</span>=<span class="string">&quot;Author&quot;</span>)</span></span><br><span class="line">    book = models.<span class="constructor">ForeignKey(<span class="params">to</span>=<span class="string">&quot;Book&quot;</span>)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> Meta:</span><br><span class="line">        unique_together = (<span class="string">&quot;author&quot;</span>, <span class="string">&quot;book&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<p>当我们需要在第三张关系表中存储额外的字段时，就要使用第三种方式。</p>
<p>但是当我们使用第三种方式创建多对多关联关系时，就无法使用set、add、remove、clear方法来管理多对多的关系了，需要通过第三张表的model来管理多对多关系。</p>
<h2 id="5-元信息"><a href="#5-元信息" class="headerlink" title="5 元信息"></a>5 元信息</h2><p>ORM对应的类里面包含另一个Meta类，而Meta类封装了一些数据库的信息。主要字段如下:</p>
<h4 id="db-table-1"><a href="#db-table-1" class="headerlink" title="db_table"></a><strong>db_table</strong></h4><p>ORM在数据库中的表名默认是 <strong>app_<strong>类名，可以通过</strong>db_table</strong>可以重写表名。</p>
<h4 id="index-together"><a href="#index-together" class="headerlink" title="index_together"></a>index_together</h4><p>联合索引。</p>
<h4 id="unique-together"><a href="#unique-together" class="headerlink" title="unique_together"></a>unique_together</h4><p>联合唯一索引。</p>
<h4 id="ordering"><a href="#ordering" class="headerlink" title="ordering"></a>ordering</h4><p>指定默认按什么字段排序。</p>
<p>只有设置了该属性，我们查询到的结果才可以被reverse()。</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UserInfo</span>(models.Model):</span><br><span class="line">    nid = models.AutoField(primary_key=True)</span><br><span class="line">    username = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        <span class="meta"># 数据库中生成的表名称 默认 app名称 + 下划线 + 类名</span></span><br><span class="line">        db_table = <span class="string">&quot;table_name&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="meta"># 联合索引</span></span><br><span class="line">        index_together = [</span><br><span class="line">            (<span class="string">&quot;pub_date&quot;</span>, <span class="string">&quot;deadline&quot;</span>),</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        <span class="meta"># 联合唯一索引</span></span><br><span class="line">        unique_together = ((<span class="string">&quot;driver&quot;</span>, <span class="string">&quot;restaurant&quot;</span>),)</span><br><span class="line">        </span><br><span class="line">        ordering = (<span class="string">&#x27;name&#x27;</span>,)</span><br><span class="line">        </span><br><span class="line">        <span class="meta"># admin中显示的表名称</span></span><br><span class="line">        verbose_name=<span class="string">&#x27;哈哈&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="meta"># verbose_name加s</span></span><br><span class="line">        verbose_name_plural=verbose_name</span><br></pre></td></tr></table></figure>

<h2 id="6-自定义字段（了解）"><a href="#6-自定义字段（了解）" class="headerlink" title="6 自定义字段（了解）"></a>6 自定义字段（了解）</h2><p>自定义char类型字段：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FixedCharField</span>(models.Field):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    自定义的char类型的字段类</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, max_length, *args, **kwargs</span>):</span><br><span class="line">        self.max_length = max_length</span><br><span class="line">        <span class="built_in">super</span>(FixedCharField, self).__init__(max_length=max_length, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">db_type</span>(<span class="params">self, connection</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        限定生成数据库表的字段类型为char，长度为max_length指定的值</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;char(%s)&#x27;</span> % self.max_length</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Class</span>(models.Model):</span><br><span class="line">    <span class="built_in">id</span> = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    title = models.CharField(max_length=<span class="number">25</span>)</span><br><span class="line">    <span class="comment"># 使用自定义的char类型的字段</span></span><br><span class="line">    cname = FixedCharField(max_length=<span class="number">25</span>)</span><br></pre></td></tr></table></figure>

<h1 id="11-模型层-模型层进阶"><a href="#11-模型层-模型层进阶" class="headerlink" title="11-模型层-模型层进阶"></a>11-模型层-模型层进阶</h1><h2 id="一-QuerySet对象"><a href="#一-QuerySet对象" class="headerlink" title="一 QuerySet对象"></a>一 QuerySet对象</h2><h3 id="1-1可切片"><a href="#1-1可切片" class="headerlink" title="1.1可切片"></a><strong>1.1可切片</strong></h3><p>使用Python 的切片语法来限制<code>查询集</code>记录的数目 。它等同于SQL 的<code>LIMIT</code> 和<code>OFFSET</code> 子句。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Entry.objects.<span class="built_in">all</span>()[:<span class="number">5</span>]      <span class="comment"># (LIMIT 5)</span></span><br><span class="line">Entry.objects.<span class="built_in">all</span>()[<span class="number">5</span>:<span class="number">10</span>]    <span class="comment"># (OFFSET 5 LIMIT 5)</span></span><br></pre></td></tr></table></figure>

<p>不支持负的索引（例如<code>Entry.objects.all()[-1]</code>）。通常，<code>查询集</code> 的切片返回一个新的<code>查询集</code> —— 它不会执行查询。</p>
<h3 id="1-2可迭代"><a href="#1-2可迭代" class="headerlink" title="1.2可迭代"></a><strong>1.2可迭代</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">articleList=models.Article.objects.<span class="built_in">all</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> article <span class="keyword">in</span> articleList:</span><br><span class="line">    <span class="built_in">print</span>(article.title)</span><br></pre></td></tr></table></figure>

<h3 id="1-3惰性查询"><a href="#1-3惰性查询" class="headerlink" title="1.3惰性查询"></a><strong>1.3惰性查询</strong></h3><p><code>查询集</code> 是惰性执行的 —— 创建<code>查询集</code>不会带来任何数据库的访问。你可以将过滤器保持一整天，直到<code>查询集</code> 需要求值时，Django 才会真正运行这个查询。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">queryResult=models.Article.objects.<span class="built_in">all</span>() <span class="comment"># not hits database</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">print</span>(queryResult) <span class="comment"># hits database</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> article <span class="keyword">in</span> queryResult:</span><br><span class="line">    <span class="built_in">print</span>(article.title)    <span class="comment"># hits database</span></span><br></pre></td></tr></table></figure>

<p>一般来说，只有在“请求”<code>查询集</code> 的结果时才会到数据库中去获取它们。当你确实需要结果时，<code>查询集</code> 通过访问数据库来<em>求值</em></p>
<h3 id="1-4缓存机制"><a href="#1-4缓存机制" class="headerlink" title="1.4缓存机制"></a><strong>1.4缓存机制</strong></h3><p>每个<code>查询集</code>都包含一个缓存来最小化对数据库的访问。理解它是如何工作的将让你编写最高效的代码。</p>
<p>在一个新创建的<code>查询集</code>中，缓存为空。首次对<code>查询集</code>进行求值 —— 同时发生数据库查询 ——Django 将保存查询的结果到<code>查询集</code>的缓存中并返回明确请求的结果（例如，如果正在迭代<code>查询集</code>，则返回下一个结果）。接下来对该<code>查询集</code> 的求值将重用缓存的结果。</p>
<p>请牢记这个缓存行为，因为对<code>查询集</code>使用不当的话，它会坑你的。例如，下面的语句创建两个<code>查询集</code>，对它们求值，然后扔掉它们：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">print</span><span class="params">([a.title for a in models.Article.objects.all()</span></span>])</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">([a.create_time for a in models.Article.objects.all()</span></span>])</span><br></pre></td></tr></table></figure>

<p>这意味着相同的数据库查询将执行两次，显然倍增了你的数据库负载。同时，还有可能两个结果列表并不包含相同的数据库记录，因为在两次请求期间有可能有Article被添加进来或删除掉。为了避免这个问题，只需保存<code>查询集</code>并重新使用它：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">queryResult=models<span class="selector-class">.Article</span><span class="selector-class">.objects</span><span class="selector-class">.all</span>()</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">([a.title for a in queryResult])</span></span></span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">([a.create_time for a in queryResult])</span></span></span><br></pre></td></tr></table></figure>

<h4 id="何时查询集不会被缓存"><a href="#何时查询集不会被缓存" class="headerlink" title="何时查询集不会被缓存?"></a>何时查询集不会被缓存?</h4><p>查询集不会永远缓存它们的结果。当只对查询集的部分进行求值时会检查缓存， 如果这个部分不在缓存中，那么接下来查询返回的记录都将不会被缓存。所以，这意味着使用切片或索引来限制查询集将不会填充缓存。</p>
<p>例如，重复获取查询集对象中一个特定的索引将每次都查询数据库：</p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">queryset = Entry.objects.<span class="literal">all</span>()</span><br><span class="line"><span class="literal">print</span> queryset[<span class="number">5</span>] <span class="comment"># Queries the database</span></span><br><span class="line"><span class="literal">print</span> queryset[<span class="number">5</span>] <span class="comment"># Queries the database again</span></span><br></pre></td></tr></table></figure>

<p>然而，如果已经对全部查询集求值过，则将检查缓存：</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">queryset = <span class="built_in">Entry</span>.objects.<span class="built_in">all</span>()</span><br><span class="line">[<span class="built_in">entry</span> for <span class="built_in">entry</span> <span class="keyword">in</span> queryset] # Queries the database</span><br><span class="line"><span class="built_in">print</span> queryset[<span class="number">5</span>] # Uses cache</span><br><span class="line"><span class="built_in">print</span> queryset[<span class="number">5</span>] # Uses cache</span><br></pre></td></tr></table></figure>

<p>下面是一些其它例子，它们会使得全部的查询集被求值并填充到缓存中：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[entry for entry in queryset]</span></span><br><span class="line"><span class="function"><span class="title">bool</span><span class="params">(queryset)</span></span></span><br><span class="line">entry <span class="keyword">in</span> queryset</span><br><span class="line"><span class="function"><span class="title">list</span><span class="params">(queryset)</span></span></span><br></pre></td></tr></table></figure>

<p>注：简单地打印查询集不会填充缓存。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">queryResult</span>=models.Article.objects.all()</span><br><span class="line"><span class="built_in">print</span>(queryResult) #  hits database</span><br><span class="line"><span class="built_in">print</span>(queryResult) #  hits database</span><br></pre></td></tr></table></figure>

<h3 id="1-5-exists-与iterator-方法"><a href="#1-5-exists-与iterator-方法" class="headerlink" title="1.5 exists()与iterator()方法"></a><strong>1.5 exists()与iterator()方法</strong></h3><h4 id="exists："><a href="#exists：" class="headerlink" title="exists："></a>exists：</h4><p>简单的使用if语句进行判断也会完全执行整个queryset并且把数据放入cache，虽然你并不需要这些 数据！为了避免这个，可以用exists()方法来检查是否有数据：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> queryResult.<span class="keyword">exists</span>():</span><br><span class="line">    #<span class="keyword">SELECT</span> (<span class="number">1</span>) <span class="keyword">AS</span> &quot;a&quot; <span class="keyword">FROM</span> &quot;blog_article&quot; <span class="keyword">LIMIT</span> <span class="number">1</span>; args=()</span><br><span class="line">        print(&quot;exists...&quot;)</span><br></pre></td></tr></table></figure>

<h4 id="iterator"><a href="#iterator" class="headerlink" title="iterator:"></a>iterator:</h4><p>当queryset非常巨大时，cache会成为问题。</p>
<p>处理成千上万的记录时，将它们一次装入内存是很浪费的。更糟糕的是，巨大的queryset可能会锁住系统 进程，让你的程序濒临崩溃。要避免在遍历数据的同时产生queryset cache，可以使用iterator()方法 来获取数据，处理完数据就将其丢弃。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">objs = Book.objects.all().iterator()</span><br><span class="line"><span class="comment"># iterator()可以一次只从数据库获取少量数据，这样可以节省内存</span></span><br><span class="line"><span class="keyword">for</span> obj <span class="keyword">in</span> objs:</span><br><span class="line">    <span class="built_in">print</span>(obj.title)</span><br><span class="line"><span class="comment">#BUT,再次遍历没有打印,因为迭代器已经在上一次遍历(next)到最后一次了,没得遍历了</span></span><br><span class="line"><span class="keyword">for</span> obj <span class="keyword">in</span> objs:</span><br><span class="line">    <span class="built_in">print</span>(obj.title)</span><br></pre></td></tr></table></figure>

<p>当然，使用iterator()方法来防止生成cache，意味着遍历同一个queryset时会重复执行查询。所以使 #用iterator()的时候要当心，确保你的代码在操作一个大的queryset时没有重复执行查询。</p>
<p><strong>总结:</strong></p>
<p>queryset的cache是用于减少程序对数据库的查询，在通常的使用下会保证只有在需要的时候才会查询数据库。 使用exists()和iterator()方法可以优化程序对内存的使用。不过，由于它们并不会生成queryset cache，可能 会造成额外的数据库查询。</p>
<h2 id="二-中介模型"><a href="#二-中介模型" class="headerlink" title="二 中介模型"></a>二 中介模型</h2><p>处理类似搭配 pizza 和 topping 这样简单的多对多关系时，使用标准的<code>ManyToManyField</code> 就可以了。但是，有时你可能需要关联数据到两个模型之间的关系上。</p>
<p>例如，有这样一个应用，它记录音乐家所属的音乐小组。我们可以用一个<code>ManyToManyField</code> 表示小组和成员之间的多对多关系。但是，有时你可能想知道更多成员关系的细节，比如成员是何时加入小组的。</p>
<p>对于这些情况，Django 允许你指定一个中介模型来定义多对多关系。 你可以将其他字段放在中介模型里面。源模型的<code>ManyToManyField</code> 字段将使用<code>through</code> 参数指向中介模型。对于上面的音乐小组的例子，代码如下：</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="class"> </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="type">Person</span>(<span class="title">models</span>.<span class="type">Model</span>):</span></span><br><span class="line"><span class="class">    name = models.<span class="type">CharField</span>(<span class="title">max_length</span>=128)</span></span><br><span class="line"><span class="class"> </span></span><br><span class="line"><span class="class">    def __str__(<span class="title">self</span>):              # __unicode__ on <span class="type">Python</span> 2</span></span><br><span class="line"><span class="class">        return self.name</span></span><br><span class="line"><span class="class"> </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="type">Group</span>(<span class="title">models</span>.<span class="type">Model</span>):</span></span><br><span class="line"><span class="class">    name = models.<span class="type">CharField</span>(<span class="title">max_length</span>=128)</span></span><br><span class="line"><span class="class">    members = models.<span class="type">ManyToManyField</span>(<span class="type">Person</span>, <span class="title">through</span>=&#x27;<span class="type">Membership</span>&#x27;)</span></span><br><span class="line"><span class="class"> </span></span><br><span class="line"><span class="class">    def __str__(<span class="title">self</span>):              # __unicode__ on <span class="type">Python</span> 2</span></span><br><span class="line"><span class="class">        return self.name</span></span><br><span class="line"><span class="class"> </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="type">Membership</span>(<span class="title">models</span>.<span class="type">Model</span>):</span></span><br><span class="line"><span class="class">    person = models.<span class="type">ForeignKey</span>(<span class="type">Person</span>)</span></span><br><span class="line"><span class="class">    group = models.<span class="type">ForeignKey</span>(<span class="type">Group</span>)</span></span><br><span class="line"><span class="class">    date_joined = models.<span class="type">DateField</span>()</span></span><br><span class="line"><span class="class">    invite_reason = models.<span class="type">CharField</span>(<span class="title">max_length</span>=64)</span></span><br></pre></td></tr></table></figure>

<p>既然你已经设置好<code>ManyToManyField</code> 来使用中介模型（在这个例子中就是<code>Membership</code>），接下来你要开始创建多对多关系。你要做的就是创建中介模型的实例：</p>
<figure class="highlight python-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">ringo = Person.objects.create(name=<span class="string">&quot;Ringo Starr&quot;</span>)</span></span><br><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">paul = Person.objects.create(name=<span class="string">&quot;Paul McCartney&quot;</span>)</span></span><br><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">beatles = Group.objects.create(name=<span class="string">&quot;The Beatles&quot;</span>)</span></span><br><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">m1 = Membership(person=ringo, group=beatles,</span></span><br><span class="line"><span class="meta prompt_">...</span> <span class="language-python">    date_joined=date(<span class="number">1962</span>, <span class="number">8</span>, <span class="number">16</span>),</span></span><br><span class="line"><span class="meta prompt_">...</span> <span class="language-python">    invite_reason=<span class="string">&quot;Needed a new drummer.&quot;</span>)</span></span><br><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">m1.save()</span></span><br><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">beatles.members.<span class="built_in">all</span>()</span></span><br><span class="line">[&lt;Person: Ringo Starr&gt;]</span><br><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">ringo.group_set.<span class="built_in">all</span>()</span></span><br><span class="line">[&lt;Group: The Beatles&gt;]</span><br><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">m2 = Membership.objects.create(person=paul, group=beatles,</span></span><br><span class="line"><span class="meta prompt_">...</span> <span class="language-python">    date_joined=date(<span class="number">1960</span>, <span class="number">8</span>, <span class="number">1</span>),</span></span><br><span class="line"><span class="meta prompt_">...</span> <span class="language-python">    invite_reason=<span class="string">&quot;Wanted to form a band.&quot;</span>)</span></span><br><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">beatles.members.<span class="built_in">all</span>()</span></span><br><span class="line">[&lt;Person: Ringo Starr&gt;, &lt;Person: Paul McCartney&gt;]</span><br></pre></td></tr></table></figure>

<p>与普通的多对多字段不同，你不能使用<code>add</code>、 <code>create</code>和赋值语句（比如，<code>beatles.members = [...]</code>）来创建关系：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># THIS WILL NOT WORK</span></span><br><span class="line">&gt;&gt;&gt; beatles.members.<span class="built_in">add</span>(john)</span><br><span class="line"><span class="comment"># NEITHER WILL THIS</span></span><br><span class="line">&gt;&gt;&gt; beatles.members.create(<span class="attribute">name</span>=<span class="string">&quot;George Harrison&quot;</span>)</span><br><span class="line"><span class="comment"># AND NEITHER WILL THIS</span></span><br><span class="line">&gt;&gt;&gt; beatles.members = [john, paul, ringo, george]</span><br></pre></td></tr></table></figure>

<p>为什么不能这样做？ 这是因为你不能只创建 <code>Person</code>和 <code>Group</code>之间的关联关系，你还要指定 <code>Membership</code>模型中所需要的所有信息；而简单的<code>add</code>、<code>create</code> 和赋值语句是做不到这一点的。所以它们不能在使用中介模型的多对多关系中使用。此时，唯一的办法就是创建中介模型的实例。</p>
<p><code>remove()</code>方法被禁用也是出于同样的原因。但是<code>clear()</code> 方法却是可用的。它可以清空某个实例所有的多对多关系：</p>
<figure class="highlight python-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python"><span class="comment"># Beatles have broken up</span></span></span><br><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">beatles.members.clear()</span></span><br><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python"><span class="comment"># Note that this deletes the intermediate model instances</span></span></span><br><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">Membership.objects.<span class="built_in">all</span>()</span></span><br><span class="line">[]</span><br></pre></td></tr></table></figure>

<h2 id="三-查询优化"><a href="#三-查询优化" class="headerlink" title="三 查询优化"></a>三 查询优化</h2><h3 id="3-1表数据"><a href="#3-1表数据" class="headerlink" title="3.1表数据"></a>3.1表数据</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">class UserInfo(AbstractUser):</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    用户信息</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    nid = models.BigAutoField(<span class="attribute">primary_key</span>=<span class="literal">True</span>)</span><br><span class="line">    nickname = models.CharField(<span class="attribute">verbose_name</span>=<span class="string">&#x27;昵称&#x27;</span>, <span class="attribute">max_length</span>=32)</span><br><span class="line">    telephone = models.CharField(<span class="attribute">max_length</span>=11, <span class="attribute">blank</span>=<span class="literal">True</span>, <span class="attribute">null</span>=<span class="literal">True</span>, <span class="attribute">unique</span>=<span class="literal">True</span>, <span class="attribute">verbose_name</span>=<span class="string">&#x27;手机号码&#x27;</span>)</span><br><span class="line">    avatar = models.FileField(<span class="attribute">verbose_name</span>=<span class="string">&#x27;头像&#x27;</span>,upload_to = <span class="string">&#x27;avatar/&#x27;</span>,<span class="attribute">default</span>=<span class="string">&quot;/avatar/default.png&quot;</span>)</span><br><span class="line">    create_time = models.DateTimeField(<span class="attribute">verbose_name</span>=<span class="string">&#x27;创建时间&#x27;</span>, <span class="attribute">auto_now_add</span>=<span class="literal">True</span>)</span><br><span class="line"> </span><br><span class="line">    fans = models.ManyToManyField(<span class="attribute">verbose_name</span>=<span class="string">&#x27;粉丝们&#x27;</span>,</span><br><span class="line">                                  <span class="attribute">to</span>=<span class="string">&#x27;UserInfo&#x27;</span>,</span><br><span class="line">                                  <span class="attribute">through</span>=<span class="string">&#x27;UserFans&#x27;</span>,</span><br><span class="line">                                  <span class="attribute">related_name</span>=<span class="string">&#x27;f&#x27;</span>,</span><br><span class="line">                                  through_fields=(<span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;follower&#x27;</span>))</span><br><span class="line"> </span><br><span class="line">    def __str__(self):</span><br><span class="line">        return self.username</span><br><span class="line"> </span><br><span class="line">class UserFans(models.Model):</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    互粉关系表</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    nid = models.AutoField(<span class="attribute">primary_key</span>=<span class="literal">True</span>)</span><br><span class="line">   <span class="built_in"> user </span>= models.ForeignKey(<span class="attribute">verbose_name</span>=<span class="string">&#x27;博主&#x27;</span>, <span class="attribute">to</span>=<span class="string">&#x27;UserInfo&#x27;</span>, <span class="attribute">to_field</span>=<span class="string">&#x27;nid&#x27;</span>, <span class="attribute">related_name</span>=<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">    follower = models.ForeignKey(<span class="attribute">verbose_name</span>=<span class="string">&#x27;粉丝&#x27;</span>, <span class="attribute">to</span>=<span class="string">&#x27;UserInfo&#x27;</span>, <span class="attribute">to_field</span>=<span class="string">&#x27;nid&#x27;</span>, <span class="attribute">related_name</span>=<span class="string">&#x27;followers&#x27;</span>)</span><br><span class="line"> </span><br><span class="line">class Blog(models.Model):</span><br><span class="line"> </span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    博客信息</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    nid = models.BigAutoField(<span class="attribute">primary_key</span>=<span class="literal">True</span>)</span><br><span class="line">    title = models.CharField(<span class="attribute">verbose_name</span>=<span class="string">&#x27;个人博客标题&#x27;</span>, <span class="attribute">max_length</span>=64)</span><br><span class="line">    site = models.CharField(<span class="attribute">verbose_name</span>=<span class="string">&#x27;个人博客后缀&#x27;</span>, <span class="attribute">max_length</span>=32, <span class="attribute">unique</span>=<span class="literal">True</span>)</span><br><span class="line">    theme = models.CharField(<span class="attribute">verbose_name</span>=<span class="string">&#x27;博客主题&#x27;</span>, <span class="attribute">max_length</span>=32)</span><br><span class="line">   <span class="built_in"> user </span>= models.OneToOneField(<span class="attribute">to</span>=<span class="string">&#x27;UserInfo&#x27;</span>, <span class="attribute">to_field</span>=<span class="string">&#x27;nid&#x27;</span>)</span><br><span class="line">    def __str__(self):</span><br><span class="line">        return self.title</span><br><span class="line"> </span><br><span class="line">class Category(models.Model):</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    博主个人文章分类表</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    nid = models.AutoField(<span class="attribute">primary_key</span>=<span class="literal">True</span>)</span><br><span class="line">    title = models.CharField(<span class="attribute">verbose_name</span>=<span class="string">&#x27;分类标题&#x27;</span>, <span class="attribute">max_length</span>=32)</span><br><span class="line"> </span><br><span class="line">    blog = models.ForeignKey(<span class="attribute">verbose_name</span>=<span class="string">&#x27;所属博客&#x27;</span>, <span class="attribute">to</span>=<span class="string">&#x27;Blog&#x27;</span>, <span class="attribute">to_field</span>=<span class="string">&#x27;nid&#x27;</span>)</span><br><span class="line"> </span><br><span class="line">class Article(models.Model):</span><br><span class="line"> </span><br><span class="line">    nid = models.BigAutoField(<span class="attribute">primary_key</span>=<span class="literal">True</span>)</span><br><span class="line">    title = models.CharField(<span class="attribute">max_length</span>=50, <span class="attribute">verbose_name</span>=<span class="string">&#x27;文章标题&#x27;</span>)</span><br><span class="line">    desc = models.CharField(<span class="attribute">max_length</span>=255, <span class="attribute">verbose_name</span>=<span class="string">&#x27;文章描述&#x27;</span>)</span><br><span class="line">    read_count = models.IntegerField(<span class="attribute">default</span>=0)</span><br><span class="line">    comment_count= models.IntegerField(<span class="attribute">default</span>=0)</span><br><span class="line">    up_count = models.IntegerField(<span class="attribute">default</span>=0)</span><br><span class="line">    down_count = models.IntegerField(<span class="attribute">default</span>=0)</span><br><span class="line">    category = models.ForeignKey(<span class="attribute">verbose_name</span>=<span class="string">&#x27;文章类型&#x27;</span>, <span class="attribute">to</span>=<span class="string">&#x27;Category&#x27;</span>, <span class="attribute">to_field</span>=<span class="string">&#x27;nid&#x27;</span>, <span class="attribute">null</span>=<span class="literal">True</span>)</span><br><span class="line">    create_time = models.DateField(<span class="attribute">verbose_name</span>=<span class="string">&#x27;创建时间&#x27;</span>)</span><br><span class="line">    blog = models.ForeignKey(<span class="attribute">verbose_name</span>=<span class="string">&#x27;所属博客&#x27;</span>, <span class="attribute">to</span>=<span class="string">&#x27;Blog&#x27;</span>, <span class="attribute">to_field</span>=<span class="string">&#x27;nid&#x27;</span>)</span><br><span class="line">    tags = models.ManyToManyField(</span><br><span class="line">        <span class="attribute">to</span>=<span class="string">&quot;Tag&quot;</span>,</span><br><span class="line">        <span class="attribute">through</span>=<span class="string">&#x27;Article2Tag&#x27;</span>,</span><br><span class="line">        through_fields=(<span class="string">&#x27;article&#x27;</span>, <span class="string">&#x27;tag&#x27;</span>),</span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">class ArticleDetail(models.Model):</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    文章详细表</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    nid = models.AutoField(<span class="attribute">primary_key</span>=<span class="literal">True</span>)</span><br><span class="line">    content = models.TextField(<span class="attribute">verbose_name</span>=<span class="string">&#x27;文章内容&#x27;</span>, )</span><br><span class="line"> </span><br><span class="line">    article = models.OneToOneField(<span class="attribute">verbose_name</span>=<span class="string">&#x27;所属文章&#x27;</span>, <span class="attribute">to</span>=<span class="string">&#x27;Article&#x27;</span>, <span class="attribute">to_field</span>=<span class="string">&#x27;nid&#x27;</span>)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">class Comment(models.Model):</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    评论表</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    nid = models.BigAutoField(<span class="attribute">primary_key</span>=<span class="literal">True</span>)</span><br><span class="line">    article = models.ForeignKey(<span class="attribute">verbose_name</span>=<span class="string">&#x27;评论文章&#x27;</span>, <span class="attribute">to</span>=<span class="string">&#x27;Article&#x27;</span>, <span class="attribute">to_field</span>=<span class="string">&#x27;nid&#x27;</span>)</span><br><span class="line">    content = models.CharField(<span class="attribute">verbose_name</span>=<span class="string">&#x27;评论内容&#x27;</span>, <span class="attribute">max_length</span>=255)</span><br><span class="line">    create_time = models.DateTimeField(<span class="attribute">verbose_name</span>=<span class="string">&#x27;创建时间&#x27;</span>, <span class="attribute">auto_now_add</span>=<span class="literal">True</span>)</span><br><span class="line"> </span><br><span class="line">    parent_comment = models.ForeignKey(<span class="string">&#x27;self&#x27;</span>, <span class="attribute">blank</span>=<span class="literal">True</span>, <span class="attribute">null</span>=<span class="literal">True</span>, <span class="attribute">verbose_name</span>=<span class="string">&#x27;父级评论&#x27;</span>)</span><br><span class="line">   <span class="built_in"> user </span>= models.ForeignKey(<span class="attribute">verbose_name</span>=<span class="string">&#x27;评论者&#x27;</span>, <span class="attribute">to</span>=<span class="string">&#x27;UserInfo&#x27;</span>, <span class="attribute">to_field</span>=<span class="string">&#x27;nid&#x27;</span>)</span><br><span class="line"> </span><br><span class="line">    up_count = models.IntegerField(<span class="attribute">default</span>=0)</span><br><span class="line"> </span><br><span class="line">    def __str__(self):</span><br><span class="line">        return self.content</span><br><span class="line"> </span><br><span class="line">class ArticleUpDown(models.Model):</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    点赞表</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    nid = models.AutoField(<span class="attribute">primary_key</span>=<span class="literal">True</span>)</span><br><span class="line">   <span class="built_in"> user </span>= models.ForeignKey(<span class="string">&#x27;UserInfo&#x27;</span>, <span class="attribute">null</span>=<span class="literal">True</span>)</span><br><span class="line">    article = models.ForeignKey(<span class="string">&quot;Article&quot;</span>, <span class="attribute">null</span>=<span class="literal">True</span>)</span><br><span class="line">    models.BooleanField(<span class="attribute">verbose_name</span>=<span class="string">&#x27;是否赞&#x27;</span>)</span><br><span class="line"> </span><br><span class="line">class CommentUp(models.Model):</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    点赞表</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    nid = models.AutoField(<span class="attribute">primary_key</span>=<span class="literal">True</span>)</span><br><span class="line">   <span class="built_in"> user </span>= models.ForeignKey(<span class="string">&#x27;UserInfo&#x27;</span>, <span class="attribute">null</span>=<span class="literal">True</span>)</span><br><span class="line">    comment = models.ForeignKey(<span class="string">&quot;Comment&quot;</span>, <span class="attribute">null</span>=<span class="literal">True</span>)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">class Tag(models.Model):</span><br><span class="line">    nid = models.AutoField(<span class="attribute">primary_key</span>=<span class="literal">True</span>)</span><br><span class="line">    title = models.CharField(<span class="attribute">verbose_name</span>=<span class="string">&#x27;标签名称&#x27;</span>, <span class="attribute">max_length</span>=32)</span><br><span class="line">    blog = models.ForeignKey(<span class="attribute">verbose_name</span>=<span class="string">&#x27;所属博客&#x27;</span>, <span class="attribute">to</span>=<span class="string">&#x27;Blog&#x27;</span>, <span class="attribute">to_field</span>=<span class="string">&#x27;nid&#x27;</span>)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">class Article2Tag(models.Model):</span><br><span class="line">    nid = models.AutoField(<span class="attribute">primary_key</span>=<span class="literal">True</span>)</span><br><span class="line">    article = models.ForeignKey(<span class="attribute">verbose_name</span>=<span class="string">&#x27;文章&#x27;</span>, <span class="attribute">to</span>=<span class="string">&quot;Article&quot;</span>, <span class="attribute">to_field</span>=<span class="string">&#x27;nid&#x27;</span>)</span><br><span class="line">    tag = models.ForeignKey(<span class="attribute">verbose_name</span>=<span class="string">&#x27;标签&#x27;</span>, <span class="attribute">to</span>=<span class="string">&quot;Tag&quot;</span>, <span class="attribute">to_field</span>=<span class="string">&#x27;nid&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="3-2-select-related"><a href="#3-2-select-related" class="headerlink" title="3.2 select_related"></a>3.2 select_related</h3><h4 id="3-2-1简单使用"><a href="#3-2-1简单使用" class="headerlink" title="3.2.1简单使用"></a><strong>3.2.1简单使用</strong></h4><p>对于一对一字段（OneToOneField）和外键字段（ForeignKey），可以使用select_related 来对QuerySet进行优化。</p>
<p>select_related 返回一个<code>QuerySet</code>，当执行它的查询时它沿着外键关系查询关联的对象的数据。它会生成一个复杂的查询并引起性能的损耗，但是在以后使用外键关系时将不需要数据库查询。</p>
<p>简单说，在对QuerySet使用select_related()函数后，Django会获取相应外键对应的对象，从而在之后需要的时候不必再查询数据库了。</p>
<p>下面的例子解释了普通查询和<code>select_related()</code> 查询的区别。</p>
<p>查询id=2的文章的分类名称,下面是一个标准的查询：</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># Hits the database.</span><br><span class="line">article=models.Article.objects.<span class="keyword">get</span>(nid=<span class="number">2</span>)</span><br><span class="line"> </span><br><span class="line"># Hits the database again <span class="keyword">to</span> <span class="keyword">get</span> the related Blog <span class="type">object</span>.</span><br><span class="line">print(article.category.title)</span><br><span class="line"><span class="comment">&#x27;&#x27;&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;nid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;title&quot;</span>,</span><br><span class="line">    <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;desc&quot;</span>,</span><br><span class="line">    <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;read_count&quot;</span>,</span><br><span class="line">    <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;comment_count&quot;</span>,</span><br><span class="line">    <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;up_count&quot;</span>,</span><br><span class="line">    <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;down_count&quot;</span>,</span><br><span class="line">    <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;category_id&quot;</span>,</span><br><span class="line">    <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;create_time&quot;</span>,</span><br><span class="line">     <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;blog_id&quot;</span>,</span><br><span class="line">     <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;article_type_id&quot;</span></span><br><span class="line">             <span class="keyword">FROM</span> <span class="string">&quot;blog_article&quot;</span></span><br><span class="line">             <span class="keyword">WHERE</span> <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;nid&quot;</span> = <span class="number">2</span>; args=(<span class="number">2</span>,)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">     <span class="string">&quot;blog_category&quot;</span>.<span class="string">&quot;nid&quot;</span>,</span><br><span class="line">     <span class="string">&quot;blog_category&quot;</span>.<span class="string">&quot;title&quot;</span>,</span><br><span class="line">     <span class="string">&quot;blog_category&quot;</span>.<span class="string">&quot;blog_id&quot;</span></span><br><span class="line">              <span class="keyword">FROM</span> <span class="string">&quot;blog_category&quot;</span></span><br><span class="line">              <span class="keyword">WHERE</span> <span class="string">&quot;blog_category&quot;</span>.<span class="string">&quot;nid&quot;</span> = <span class="number">4</span>; args=(<span class="number">4</span>,)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>如果我们使用select_related()函数：</p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">articleList=models.Article.objects.select_related(<span class="string">&quot;category&quot;</span>).<span class="literal">all</span>()</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    for article_obj in articleList:</span><br><span class="line">        <span class="comment">#  Doesn&#x27;t hit the database, because article_obj.category</span></span><br><span class="line">        <span class="comment">#  has been prepopulated in the previous query.</span></span><br><span class="line">        <span class="comment">#不再查询数据库，因为第一次查询，数据已经填充进去了</span></span><br><span class="line">        <span class="literal">print</span>(article_obj.category.title)</span><br><span class="line">SELECT</span><br><span class="line">     <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;nid&quot;</span>,</span><br><span class="line">     <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;title&quot;</span>,</span><br><span class="line">     <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;desc&quot;</span>,</span><br><span class="line">     <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;read_count&quot;</span>,</span><br><span class="line">     <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;comment_count&quot;</span>,</span><br><span class="line">     <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;up_count&quot;</span>,</span><br><span class="line">     <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;down_count&quot;</span>,</span><br><span class="line">     <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;category_id&quot;</span>,</span><br><span class="line">     <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;create_time&quot;</span>,</span><br><span class="line">     <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;blog_id&quot;</span>,</span><br><span class="line">     <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;article_type_id&quot;</span>,</span><br><span class="line"> </span><br><span class="line">     <span class="string">&quot;blog_category&quot;</span>.<span class="string">&quot;nid&quot;</span>,</span><br><span class="line">     <span class="string">&quot;blog_category&quot;</span>.<span class="string">&quot;title&quot;</span>,</span><br><span class="line">     <span class="string">&quot;blog_category&quot;</span>.<span class="string">&quot;blog_id&quot;</span></span><br><span class="line"> </span><br><span class="line">FROM <span class="string">&quot;blog_article&quot;</span></span><br><span class="line"><span class="literal">LEFT</span> OUTER JOIN <span class="string">&quot;blog_category&quot;</span> <span class="literal">ON</span> (<span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;category_id&quot;</span> = <span class="string">&quot;blog_category&quot;</span>.<span class="string">&quot;nid&quot;</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-2-2-多外键查询"><a href="#3-2-2-多外键查询" class="headerlink" title="**3.2.2 多外键查询 **"></a>**3.2.2 多外键查询 **</h4><p>这是针对category的外键查询，如果是另外一个外键呢？让我们一起看下：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">article=models<span class="selector-class">.Article</span><span class="selector-class">.objects</span><span class="selector-class">.select_related</span>(<span class="string">&quot;category&quot;</span>)<span class="selector-class">.get</span>(nid=<span class="number">1</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(article.articledetail)</span></span></span><br></pre></td></tr></table></figure>

<p>观察logging结果，发现依然需要查询两次，所以需要改为：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">article=models<span class="selector-class">.Article</span><span class="selector-class">.objects</span><span class="selector-class">.select_related</span>(<span class="string">&quot;category&quot;</span>,<span class="string">&quot;articledetail&quot;</span>)<span class="selector-class">.get</span>(nid=<span class="number">1</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(article.articledetail)</span></span></span><br></pre></td></tr></table></figure>

<p>或者：1.7以后支持链式操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">article<span class="operator">=</span>models.Article.objects</span><br><span class="line">　　　　　　　　　　　　　.select_related(&quot;category&quot;)</span><br><span class="line">　　　　　　　　　　　　　.select_related(&quot;articledetail&quot;)</span><br><span class="line">　　　　　　　　　　　　　.<span class="keyword">get</span>(nid<span class="operator">=</span><span class="number">1</span>)  # django <span class="number">1.7</span> 支持链式操作</span><br><span class="line">print(article.articledetail)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line"> </span><br><span class="line">    &quot;blog_article&quot;.&quot;nid&quot;,</span><br><span class="line">    &quot;blog_article&quot;.&quot;title&quot;,</span><br><span class="line">    ......</span><br><span class="line"> </span><br><span class="line">    &quot;blog_category&quot;.&quot;nid&quot;,</span><br><span class="line">    &quot;blog_category&quot;.&quot;title&quot;,</span><br><span class="line">    &quot;blog_category&quot;.&quot;blog_id&quot;,</span><br><span class="line"> </span><br><span class="line">    &quot;blog_articledetail&quot;.&quot;nid&quot;,</span><br><span class="line">    &quot;blog_articledetail&quot;.&quot;content&quot;,</span><br><span class="line">    &quot;blog_articledetail&quot;.&quot;article_id&quot;</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">FROM</span> &quot;blog_article&quot;</span><br><span class="line">   <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> &quot;blog_category&quot; <span class="keyword">ON</span> (&quot;blog_article&quot;.&quot;category_id&quot; <span class="operator">=</span> &quot;blog_category&quot;.&quot;nid&quot;)</span><br><span class="line">   <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> &quot;blog_articledetail&quot; <span class="keyword">ON</span> (&quot;blog_article&quot;.&quot;nid&quot; <span class="operator">=</span> &quot;blog_articledetail&quot;.&quot;article_id&quot;)</span><br><span class="line">   <span class="keyword">WHERE</span> &quot;blog_article&quot;.&quot;nid&quot; <span class="operator">=</span> <span class="number">1</span>; args<span class="operator">=</span>(<span class="number">1</span>,)</span><br></pre></td></tr></table></figure>

<h4 id="3-2-3-深层查询"><a href="#3-2-3-深层查询" class="headerlink" title="3.2.3 深层查询"></a><strong>3.2.3 深层查询</strong></h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询id=1的文章的用户姓名</span></span><br><span class="line"> </span><br><span class="line">    <span class="attribute">article</span>=models.Article.objects.select_related(&quot;blog&quot;).get(nid=1)</span><br><span class="line">    <span class="built_in">print</span>(article.blog.user.username)</span><br></pre></td></tr></table></figure>

<p>依然需要查询两次：</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;nid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;title&quot;</span>,</span><br><span class="line">    <span class="params">...</span><span class="params">...</span></span><br><span class="line"> </span><br><span class="line">     <span class="string">&quot;blog_blog&quot;</span>.<span class="string">&quot;nid&quot;</span>,</span><br><span class="line">     <span class="string">&quot;blog_blog&quot;</span>.<span class="string">&quot;title&quot;</span>,</span><br><span class="line"> </span><br><span class="line">   FROM <span class="string">&quot;blog_article&quot;</span> INNER <span class="keyword">JOIN</span> <span class="string">&quot;blog_blog&quot;</span> <span class="keyword">ON</span> (<span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;blog_id&quot;</span> = <span class="string">&quot;blog_blog&quot;</span>.<span class="string">&quot;nid&quot;</span>)</span><br><span class="line">   <span class="keyword">WHERE</span> <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;nid&quot;</span> = <span class="number">1</span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="string">&quot;blog_userinfo&quot;</span>.<span class="string">&quot;password&quot;</span>,</span><br><span class="line">    <span class="string">&quot;blog_userinfo&quot;</span>.<span class="string">&quot;last_login&quot;</span>,</span><br><span class="line">    <span class="params">...</span><span class="params">...</span></span><br><span class="line"> </span><br><span class="line">FROM <span class="string">&quot;blog_userinfo&quot;</span></span><br><span class="line"><span class="keyword">WHERE</span> <span class="string">&quot;blog_userinfo&quot;</span>.<span class="string">&quot;nid&quot;</span> = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>这是因为第一次查询没有query到userInfo表，所以，修改如下：</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">article=models.Article.objects.select_related(<span class="string">&quot;blog__user&quot;</span>).get(nid=<span class="number">1</span>)</span><br><span class="line">print(article.blog.user.username)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line"> </span><br><span class="line"><span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;nid&quot;</span>, <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;title&quot;</span>,</span><br><span class="line"><span class="params">...</span><span class="params">...</span></span><br><span class="line"> </span><br><span class="line"> <span class="string">&quot;blog_blog&quot;</span>.<span class="string">&quot;nid&quot;</span>, <span class="string">&quot;blog_blog&quot;</span>.<span class="string">&quot;title&quot;</span>,</span><br><span class="line"><span class="params">...</span><span class="params">...</span></span><br><span class="line"> </span><br><span class="line"> <span class="string">&quot;blog_userinfo&quot;</span>.<span class="string">&quot;password&quot;</span>, <span class="string">&quot;blog_userinfo&quot;</span>.<span class="string">&quot;last_login&quot;</span>,</span><br><span class="line"><span class="params">...</span><span class="params">...</span></span><br><span class="line"> </span><br><span class="line">FROM <span class="string">&quot;blog_article&quot;</span></span><br><span class="line"> </span><br><span class="line">INNER <span class="keyword">JOIN</span> <span class="string">&quot;blog_blog&quot;</span> <span class="keyword">ON</span> (<span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;blog_id&quot;</span> = <span class="string">&quot;blog_blog&quot;</span>.<span class="string">&quot;nid&quot;</span>)</span><br><span class="line"> </span><br><span class="line">INNER <span class="keyword">JOIN</span> <span class="string">&quot;blog_userinfo&quot;</span> <span class="keyword">ON</span> (<span class="string">&quot;blog_blog&quot;</span>.<span class="string">&quot;user_id&quot;</span> = <span class="string">&quot;blog_userinfo&quot;</span>.<span class="string">&quot;nid&quot;</span>)</span><br><span class="line"><span class="keyword">WHERE</span> <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;nid&quot;</span> = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-4-总结"><a href="#3-2-4-总结" class="headerlink" title="3.2.4 总结"></a><strong>3.2.4 总结</strong></h4><ol>
<li>select_related主要针一对一和多对一关系进行优化。</li>
<li>select_related使用SQL的JOIN语句进行优化，通过减少SQL查询的次数来进行优化、提高性能。</li>
<li>可以通过可变长参数指定需要select_related的字段名。也可以通过使用双下划线“__”连接字段名来实现指定的递归查询。</li>
<li>没有指定的字段不会缓存，没有指定的深度不会缓存，如果要访问的话Django会再次进行SQL查询。</li>
<li>也可以通过depth参数指定递归的深度，Django会自动缓存指定深度内所有的字段。如果要访问指定深度外的字段，Django会再次进行SQL查询。</li>
<li>也接受无参数的调用，Django会尽可能深的递归查询所有的字段。但注意有Django递归的限制和性能的浪费。</li>
<li>Django &gt;= 1.7，链式调用的select_related相当于使用可变长参数。Django &lt; 1.7，链式调用会导致前边的select_related失效，只保留最后一个。</li>
</ol>
<h3 id="3-3-prefetch-related"><a href="#3-3-prefetch-related" class="headerlink" title="3.3 prefetch_related()"></a>3.3 <strong>prefetch_related()</strong></h3><p>对于多对多字段（ManyToManyField）和一对多字段，可以使用prefetch_related()来进行优化。</p>
<p>prefetch_related()和select_related()的设计目的很相似，都是为了减少SQL查询的数量，但是实现的方式不一样。后者是通过JOIN语句，在SQL查询内解决问题。但是对于多对多关系，使用SQL语句解决就显得有些不太明智，因为JOIN得到的表将会很长，会导致SQL语句运行时间的增加和内存占用的增加。若有n个对象，每个对象的多对多字段对应Mi条，就会生成Σ(n)Mi 行的结果表。</p>
<p>prefetch_related()的解决方法是，分别查询每个表，然后用Python处理他们之间的关系。</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询所有文章关联的所有标签</span></span><br><span class="line">    <span class="attribute">article_obj</span>=models.Article.objects.<span class="literal">all</span>()</span><br><span class="line">    <span class="attribute">for</span> i in article_obj:</span><br><span class="line"> </span><br><span class="line">        <span class="attribute">print</span>(i.tags.<span class="literal">all</span>())  #<span class="number">4</span>篇文章: hits database <span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>改为prefetch_related：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询所有文章关联的所有标签</span></span><br><span class="line">    <span class="attribute">article_obj</span>=models.Article.objects.prefetch_related(&quot;tags&quot;).all()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> article_obj:</span><br><span class="line"> </span><br><span class="line">        <span class="built_in">print</span>(i.tags.all())  #4篇文章: hits database 2</span><br><span class="line">SELECT <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;nid&quot;</span>,</span><br><span class="line">               <span class="string">&quot;blog_article&quot;</span>.<span class="string">&quot;title&quot;</span>,</span><br><span class="line">               <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">FROM</span> <span class="string">&quot;blog_article&quot;</span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">SELECT</span><br><span class="line">  (<span class="string">&quot;blog_article2tag&quot;</span>.<span class="string">&quot;article_id&quot;</span>) AS <span class="string">&quot;_prefetch_related_val_article_id&quot;</span>,</span><br><span class="line">  <span class="string">&quot;blog_tag&quot;</span>.<span class="string">&quot;nid&quot;</span>,</span><br><span class="line">  <span class="string">&quot;blog_tag&quot;</span>.<span class="string">&quot;title&quot;</span>,</span><br><span class="line">  <span class="string">&quot;blog_tag&quot;</span>.<span class="string">&quot;blog_id&quot;</span></span><br><span class="line">   <span class="keyword">FROM</span> <span class="string">&quot;blog_tag&quot;</span></span><br><span class="line">  INNER JOIN <span class="string">&quot;blog_article2tag&quot;</span> ON (<span class="string">&quot;blog_tag&quot;</span>.<span class="string">&quot;nid&quot;</span> = <span class="string">&quot;blog_article2tag&quot;</span>.<span class="string">&quot;tag_id&quot;</span>)</span><br><span class="line">  WHERE <span class="string">&quot;blog_article2tag&quot;</span>.<span class="string">&quot;article_id&quot;</span> <span class="keyword">IN</span> (1, 2, 3, 4);</span><br><span class="line">def select_related(self, <span class="number">*f</span>ields)</span><br><span class="line">     性能相关：表之间进行join连表操作，一次性获取关联的数据。</span><br><span class="line">     model.tb.objects.all().select_related()</span><br><span class="line">     model.tb.objects.all().select_related(<span class="string">&#x27;外键字段&#x27;</span>)</span><br><span class="line">     model.tb.objects.all().select_related(<span class="string">&#x27;外键字段__外键字段&#x27;</span>)</span><br><span class="line"></span><br><span class="line">def prefetch_related(self, *lookups)</span><br><span class="line">    性能相关：多表连表操作时速度会慢，使用其执行多次SQL查询在Python代码中实现连表操作。</span><br><span class="line">            # 获取所有用户表</span><br><span class="line">            # 获取用户类型表where id <span class="keyword">in</span> (用户表中的查到的所有用户ID)</span><br><span class="line">            models.UserInfo.objects.prefetch_related(<span class="string">&#x27;外键字段&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">from</span> django.db.models import Count, Case, When, IntegerField</span><br><span class="line">            Article.objects.annotate(</span><br><span class="line">                <span class="attribute">numviews</span>=Count(Case(</span><br><span class="line">                    When(<span class="attribute">readership__what_time__lt</span>=treshold, <span class="attribute">then</span>=1),</span><br><span class="line">                    <span class="attribute">output_field</span>=CharField(),</span><br><span class="line">                ))</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            students = Student.objects.all().annotate(<span class="attribute">num_excused_absences</span>=models.Sum(</span><br><span class="line">                models.Case(</span><br><span class="line">                    models.When(<span class="attribute">absence__type</span>=<span class="string">&#x27;Excused&#x27;</span>, <span class="attribute">then</span>=1),</span><br><span class="line">                <span class="attribute">default</span>=0,</span><br><span class="line">                <span class="attribute">output_field</span>=models.IntegerField()</span><br><span class="line">            )))</span><br><span class="line">  # 加select_related 主动做链表，相当于直接链表把数据全取出来了，</span><br><span class="line">    # 不加：<span class="keyword">for</span>循环几次，就再次查几次数据库</span><br><span class="line">    # select_related(<span class="string">&#x27;author_detail&#x27;</span>)参数是fk的字段，可能有多个外键，所以可以写多个</span><br><span class="line">    <span class="attribute">ret</span>=models.Author.objects.all().select_related(&#x27;author_detail&#x27;)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> ret:</span><br><span class="line">        <span class="built_in">print</span>(i.author_detail.addr)</span><br><span class="line">    ret = models.Author.objects.all()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> ret:</span><br><span class="line">        <span class="built_in">print</span>(i.author_detail.addr)</span><br><span class="line"></span><br><span class="line"><span class="comment">#     用了fk,但是不做链表，做多次查询,把结果集都放到对象中</span></span><br><span class="line"><span class="comment">#     两次查询，相当于select * from author_detail where nid in [1,2]</span></span><br><span class="line">    <span class="attribute">ret</span>=models.Author.objects.all().prefetch_related(&#x27;author_detail&#x27;)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> ret:</span><br><span class="line">        <span class="built_in">print</span>(i.author_detail.addr)</span><br><span class="line"><span class="comment"># 总结：数据量少，可以用select_related</span></span><br><span class="line"><span class="comment">#     数据量比较多用prefetch_related</span></span><br></pre></td></tr></table></figure>

<h2 id="四-extra"><a href="#四-extra" class="headerlink" title="四 extra"></a>四 extra</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">extra(<span class="attribute">select</span>=None, <span class="attribute">where</span>=None, <span class="attribute">params</span>=None, </span><br><span class="line">      <span class="attribute">tables</span>=None, <span class="attribute">order_by</span>=None, <span class="attribute">select_params</span>=None)</span><br></pre></td></tr></table></figure>

<p>有些情况下，Django的查询语法难以简单的表达复杂的 <code>WHERE</code> 子句，对于这种情况, Django 提供了 <code>extra()</code> <code>QuerySet</code>修改机制 — 它能在 <code>QuerySet</code>生成的SQL从句中注入新子句</p>
<p>extra可以指定一个或多个 <code>参数</code>,例如 <code>select</code>, <code>where</code> or <code>tables</code>. 这些参数都不是必须的，但是你至少要使用一个!要注意这些额外的方式对不同的数据库引擎可能存在移植性问题.(因为你在显式的书写SQL语句),除非万不得已,尽量避免这样做</p>
<h3 id="4-1参数之select"><a href="#4-1参数之select" class="headerlink" title="4.1参数之select"></a>4.1参数之select</h3><p>The <code>select</code> 参数可以让你在 <code>SELECT</code> 从句中添加其他字段信息，它应该是一个字典，存放着属性名到 SQL 从句的映射。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">queryResult=models<span class="selector-class">.Article</span></span><br><span class="line">　　　　　　　　　　　<span class="selector-class">.objects</span><span class="selector-class">.extra</span>(select=&#123;<span class="string">&#x27;is_recent&#x27;</span>: <span class="string">&quot;create_time &gt; &#x27;2017-09-05&#x27;&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>结果集中每个 Entry 对象都有一个额外的属性is_recent, 它是一个布尔值，表示 Article对象的create_time 是否晚于2017-09-05.</p>
<p>练习：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># in sqlite:</span></span><br><span class="line">    <span class="attribute">article_obj</span>=models.Article.objects</span><br><span class="line">　　　　　　　　　　　　　　.filter(<span class="attribute">nid</span>=1)</span><br><span class="line">　　　　　　　　　　　　　　.extra(select=&#123;<span class="string">&quot;standard_time&quot;</span>:<span class="string">&quot;strftime(&#x27;%%Y-%%m-%%d&#x27;,create_time)&quot;</span>&#125;)</span><br><span class="line">　　　　　　　　　　　　　　.values(<span class="string">&quot;standard_time&quot;</span>,<span class="string">&quot;nid&quot;</span>,<span class="string">&quot;title&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(article_obj)</span><br><span class="line">    # &lt;QuerySet [&#123;<span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;MongoDb 入门教程&#x27;</span>, <span class="string">&#x27;standard_time&#x27;</span>: <span class="string">&#x27;2017-09-03&#x27;</span>, <span class="string">&#x27;nid&#x27;</span>: 1&#125;]&gt;</span><br></pre></td></tr></table></figure>

<h3 id="4-2参数之where-tables"><a href="#4-2参数之where-tables" class="headerlink" title="4.2参数之where / tables"></a>4.2参数之<code>where</code> / <code>tables</code></h3><p>您可以使用<code>where</code>定义显式SQL <code>WHERE</code>子句 - 也许执行非显式连接。您可以使用<code>tables</code>手动将表添加到SQL <code>FROM</code>子句。</p>
<p><code>where</code>和<code>tables</code>都接受字符串列表。所有<code>where</code>参数均为“与”任何其他搜索条件。</p>
<p>举例来讲：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">queryResult=models.Article</span><br><span class="line">　　　　　　　　　　　.objects.extra(<span class="keyword">where</span>=[<span class="string">&#x27;nid in (1,3) OR title like &quot;py%&quot; &#x27;</span>,<span class="string">&#x27;nid&gt;2&#x27;</span>])</span><br><span class="line">extra, 额外查询条件以及相关表，排序</span><br><span class="line">            </span><br><span class="line">                models.UserInfo.objects.<span class="keyword">filter</span>(id__gt=<span class="number">1</span>)</span><br><span class="line">                models.UserInfo.objects.<span class="keyword">all</span>() </span><br><span class="line">                # id <span class="type">name</span> age ut_id</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">                models.UserInfo.objects.extra(self, <span class="keyword">select</span>=<span class="keyword">None</span>, <span class="keyword">where</span>=<span class="keyword">None</span>, params=<span class="keyword">None</span>, <span class="keyword">tables</span>=<span class="keyword">None</span>, order_by=<span class="keyword">None</span>, select_params=<span class="keyword">None</span>)</span><br><span class="line">                # a. 映射</span><br><span class="line">                    # <span class="keyword">select</span> </span><br><span class="line">                    # select_params=<span class="keyword">None</span></span><br><span class="line">                    # <span class="keyword">select</span> 此处 <span class="keyword">from</span> 表</span><br><span class="line">                </span><br><span class="line">                # b. 条件</span><br><span class="line">                    # <span class="keyword">where</span>=<span class="keyword">None</span></span><br><span class="line">                    # params=<span class="keyword">None</span>,</span><br><span class="line">                    # <span class="keyword">select</span> * <span class="keyword">from</span> 表 <span class="keyword">where</span> 此处</span><br><span class="line">                </span><br><span class="line">                # c. 表</span><br><span class="line">                    # <span class="keyword">tables</span></span><br><span class="line">                    # <span class="keyword">select</span> * <span class="keyword">from</span> 表,此处</span><br><span class="line">                    </span><br><span class="line">                # c. 排序</span><br><span class="line">                    # order_by=<span class="keyword">None</span></span><br><span class="line">                    # <span class="keyword">select</span> * <span class="keyword">from</span> 表 <span class="keyword">order</span> <span class="keyword">by</span> 此处</span><br><span class="line">                </span><br><span class="line">                </span><br><span class="line">                models.UserInfo.objects.extra(</span><br><span class="line">                    <span class="keyword">select</span>=&#123;<span class="string">&#x27;newid&#x27;</span>:<span class="string">&#x27;select count(1) from app01_usertype where id&gt;%s&#x27;</span>&#125;,</span><br><span class="line">                    select_params=[<span class="number">1</span>,],</span><br><span class="line">                    <span class="keyword">where</span> = [<span class="string">&#x27;age&gt;%s&#x27;</span>],</span><br><span class="line">                    params=[<span class="number">18</span>,],</span><br><span class="line">                    order_by=[<span class="string">&#x27;-age&#x27;</span>],</span><br><span class="line">                    <span class="keyword">tables</span>=[<span class="string">&#x27;app01_usertype&#x27;</span>]</span><br><span class="line">                )</span><br><span class="line">                &quot;&quot;&quot;</span><br><span class="line">                select </span><br><span class="line">                    app01_userinfo.id,</span><br><span class="line">                    (select count(1) from app01_usertype where id&gt;1) as newid</span><br><span class="line">                from app01_userinfo,app01_usertype</span><br><span class="line">                where </span><br><span class="line">                    app01_userinfo.age &gt; 18</span><br><span class="line">                order by </span><br><span class="line">                    app01_userinfo.age desc</span><br><span class="line">                &quot;&quot;&quot;</span><br><span class="line">                </span><br><span class="line">                result = models.UserInfo.objects.<span class="keyword">filter</span>(id__gt=<span class="number">1</span>).extra(</span><br><span class="line">                    <span class="keyword">where</span>=[<span class="string">&#x27;app01_userinfo.id &lt; %s&#x27;</span>],</span><br><span class="line">                    params=[<span class="number">100</span>,],</span><br><span class="line">                    <span class="keyword">tables</span>=[<span class="string">&#x27;app01_usertype&#x27;</span>],</span><br><span class="line">                    order_by=[<span class="string">&#x27;-app01_userinfo.id&#x27;</span>],</span><br><span class="line">                    <span class="keyword">select</span>=&#123;<span class="string">&#x27;uid&#x27;</span>:<span class="number">1</span>,<span class="string">&#x27;sw&#x27;</span>:&quot;select count(1) from app01_userinfo&quot;&#125;</span><br><span class="line">                )</span><br><span class="line">                print(result.query)</span><br><span class="line">                # <span class="keyword">SELECT</span> (<span class="number">1</span>) <span class="keyword">AS</span> &quot;uid&quot;, (<span class="keyword">select</span> count(<span class="number">1</span>) <span class="keyword">from</span> app01_userinfo) <span class="keyword">AS</span> &quot;sw&quot;, &quot;app01_userinfo&quot;.&quot;id&quot;, &quot;app01_userinfo&quot;.&quot;name&quot;, &quot;app01_userinfo&quot;.&quot;age&quot;, &quot;app01_userinfo&quot;.&quot;ut_id&quot; <span class="keyword">FROM</span> &quot;app01_userinfo&quot; , &quot;app01_usertype&quot; <span class="keyword">WHERE</span> (&quot;app01_userinfo&quot;.&quot;id&quot; &gt; <span class="number">1</span> <span class="keyword">AND</span> (app01_userinfo.id &lt; <span class="number">100</span>)) <span class="keyword">ORDER</span> <span class="keyword">BY</span> (&quot;app01_userinfo&quot;.id) <span class="keyword">DESC</span></span><br><span class="line"># 在对象中加入字段</span><br><span class="line">ret=models.Author.objects.<span class="keyword">all</span>().<span class="keyword">filter</span>(nid__gt=<span class="number">1</span>).extra(<span class="keyword">select</span>=&#123;<span class="string">&#x27;n&#x27;</span>:<span class="string">&#x27;select count(*) from app01_book where nid&gt;%s&#x27;</span>&#125;,select_params=[<span class="number">1</span>])</span><br><span class="line">print(ret[<span class="number">0</span>].n)</span><br><span class="line">print(ret.query)</span><br><span class="line"># 给字段重命名</span><br><span class="line">ret=models.Author.objects.<span class="keyword">all</span>().<span class="keyword">filter</span>(author_detail__telephone=<span class="number">132234556</span>).extra(<span class="keyword">select</span>=&#123;<span class="string">&#x27;bb&#x27;</span>:&quot;app01_authordatail.telephone&quot;&#125;).<span class="keyword">values</span>(<span class="string">&#x27;bb&#x27;</span>)</span><br><span class="line">print(ret)</span><br><span class="line">print(ret.query)</span><br></pre></td></tr></table></figure>

<h2 id="五-原生sql"><a href="#五-原生sql" class="headerlink" title="五 原生sql"></a>五 原生sql</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">from django.db import connection, connections</span><br><span class="line"></span><br><span class="line"><span class="built_in">cursor</span> = connection.<span class="built_in">cursor</span>() # connection=default数据</span><br><span class="line"><span class="built_in">cursor</span> = connections[<span class="string">&#x27;db2&#x27;</span>].<span class="built_in">cursor</span>()</span><br><span class="line"></span><br><span class="line"><span class="built_in">cursor</span>.<span class="keyword">execute</span>(<span class="string">&quot;&quot;</span><span class="string">&quot;SELECT * from auth_user where id = %s&quot;</span><span class="string">&quot;&quot;</span>, [<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">row = <span class="built_in">cursor</span>.fetchone()</span><br><span class="line">row = <span class="built_in">cursor</span>.fetchall()</span><br><span class="line"><span class="keyword">ret</span> = models.Author.objects.raw(<span class="string">&#x27;select * from app01_author where nid&gt;1&#x27;</span>)</span><br><span class="line"><span class="keyword">print</span>(<span class="keyword">ret</span>)</span><br><span class="line"><span class="keyword">for</span> i in <span class="keyword">ret</span>:</span><br><span class="line">    <span class="keyword">print</span>(i)</span><br><span class="line"><span class="keyword">print</span>(<span class="keyword">ret</span>.query)</span><br><span class="line"># 会把book的字段放到author对象中</span><br><span class="line"><span class="keyword">ret</span> = models.Author.objects.raw(<span class="string">&#x27;select * from app01_book where nid&gt;1&#x27;</span>)</span><br><span class="line"><span class="keyword">print</span>(<span class="keyword">ret</span>)</span><br><span class="line"><span class="keyword">for</span> i in <span class="keyword">ret</span>:</span><br><span class="line">    <span class="keyword">print</span>(i.price)</span><br><span class="line">    <span class="keyword">print</span>(<span class="built_in">type</span>(i))</span><br></pre></td></tr></table></figure>

<h2 id="六-整体插入"><a href="#六-整体插入" class="headerlink" title="六 整体插入"></a>六 整体插入</h2><p>创建对象时，尽可能使用bulk_create()来减少SQL查询的数量。例如：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Entry.objects.bulk_create([</span><br><span class="line">    Entry(<span class="attribute">headline</span>=<span class="string">&quot;Python 3.0 Released&quot;</span>),</span><br><span class="line">    Entry(<span class="attribute">headline</span>=<span class="string">&quot;Python 3.1 Planned&quot;</span>)</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<p>…更优于：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Entry.objects.create(<span class="attribute">headline</span>=<span class="string">&quot;Python 3.0 Released&quot;</span>)</span><br><span class="line">Entry.objects.create(<span class="attribute">headline</span>=<span class="string">&quot;Python 3.1 Planned&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>注意该方法有很多注意事项，所以确保它适用于你的情况。</p>
<p>这也可以用在ManyToManyFields中，所以：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my_band.members.<span class="built_in">add</span>(me, my_friend)</span><br></pre></td></tr></table></figure>

<p>…更优于：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">my_band.members.<span class="built_in">add</span>(me)</span><br><span class="line">my_band.members.<span class="built_in">add</span>(my_friend)</span><br></pre></td></tr></table></figure>

<p>…其中Bands和Artists具有多对多关联。</p>
<h2 id="七-事务操作"><a href="#七-事务操作" class="headerlink" title="七 事务操作"></a>七 事务操作</h2><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 事务操作</span></span><br><span class="line"><span class="keyword">from</span> django.db import <span class="keyword">transaction</span></span><br><span class="line"><span class="keyword">with</span> <span class="keyword">transaction</span>.atomic():</span><br></pre></td></tr></table></figure>

<h2 id="八-defer和only"><a href="#八-defer和only" class="headerlink" title="八 defer和only"></a>八 defer和only</h2><p>defer(‘id’,’name’):取出对象，字段除了id和name都有<br>only(‘id’,’name’):取的对象，只有id和name<br>如果点，依然能点出其它列，但是不要点了，因为取没有的列，会再次查询数据库</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ret</span>=models.Author.objects.<span class="keyword">only</span>(<span class="string">&#x27;nid&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i in <span class="keyword">ret</span>:</span><br><span class="line">    # 查询不在的字段，会再次查询数据库，造成数据库压力大</span><br><span class="line">    <span class="keyword">print</span>(i.name)</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer"><div class="post-widgets">
      <div id="needsharebutton-postbottom">
        <span class="btn">
          <i class="fa fa-share-alt" aria-hidden="true"></i>
        </span>
      </div>
    </div>
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.jpeg" alt="Michaeldong 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.jpeg" alt="Michaeldong 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/Python/" rel="tag"># Python</a>
              <a href="/tags/Django/" rel="tag"># Django</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2018/05/18/25.Django%E7%AC%AC%E4%BA%8C%E5%A4%A9/" rel="prev" title="Django第二天">
                  <i class="fa fa-chevron-left"></i> Django第二天
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2018/05/20/4.Django%E9%AB%98%E7%BA%A7-Djano%E4%B8%8Eajax/" rel="next" title="Django高级-Django与ajax">
                  Django高级-Django与ajax <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Michaeldong</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">1.2m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">18:09</span>
  </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>
<script class="next-config" data-name="chatra" type="application/json">{"enable":true,"async":true,"id":"9D92XKxDbxTrStQPr"}</script>
<script src="/js/third-party/chat/chatra.js"></script>
<script async src="https://call.chatra.io/chatra.js"></script>





  





  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1/needsharebutton.min.js"></script>
  <script>
      pbOptions = {};
        pbOptions.iconStyle = "box";
        pbOptions.boxForm = "horizontal";
        pbOptions.position = "bottomCenter";
        pbOptions.networks = "Wechat,QQZone,Weibo,Douban,Twitter,Facebook";
      new needShareButton('#needsharebutton-postbottom', pbOptions);
  </script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":200,"height":300,"vOffset":300},"mobile":{"show":true},"dialog":{"enable":true,"hitokoto":true}});</script></body>
</html>
